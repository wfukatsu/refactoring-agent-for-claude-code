<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scalar Auditor for BOX - リファクタリング分析レポート</title>
    <script src="https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        
        :root {
            --bg-color: #ffffff;
            --text-color: #333333;
            --heading-color: #1a1a2e;
            --link-color: #1976d2;
            --border-color: #e0e0e0;
            --code-bg: #f5f5f5;
            --table-header-bg: #f0f0f0;
            --sidebar-bg: #fafafa;
        }
    

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            line-height: 1.6;
            color: var(--text-color);
            background-color: var(--bg-color);
            margin: 0;
            padding: 0;
            display: flex;
        }

        /* サイドバー */
        .sidebar {
            width: 280px;
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: var(--sidebar-bg);
            border-right: 1px solid var(--border-color);
            overflow-y: auto;
            padding: 20px;
        }

        .sidebar h2 {
            font-size: 1.1rem;
            margin-bottom: 15px;
            color: var(--heading-color);
        }

        .sidebar ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .sidebar li {
            margin: 5px 0;
        }

        .sidebar a {
            color: var(--link-color);
            text-decoration: none;
            font-size: 0.9rem;
            display: block;
            padding: 5px 0;
        }

        .sidebar a:hover {
            text-decoration: underline;
        }

        .sidebar .section-title {
            font-weight: bold;
            margin-top: 15px;
            color: var(--heading-color);
        }

        /* メインコンテンツ */
        .main-content {
            margin-left: 280px;
            padding: 40px 60px;
            max-width: 1200px;
            width: calc(100% - 280px);
        }

        /* ヘッダー */
        .report-header {
            text-align: center;
            padding: 40px 0;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 40px;
        }

        .report-header h1 {
            font-size: 2.5rem;
            color: var(--heading-color);
            margin-bottom: 10px;
        }

        .report-header .meta {
            color: var(--text-color);
            opacity: 0.7;
        }

        /* セクション */
        section {
            margin-bottom: 60px;
            padding-bottom: 40px;
            border-bottom: 1px solid var(--border-color);
        }

        h1 {
            font-size: 2rem;
            color: var(--heading-color);
            border-bottom: 2px solid var(--link-color);
            padding-bottom: 10px;
            margin-top: 40px;
        }

        h2 {
            font-size: 1.5rem;
            color: var(--heading-color);
            margin-top: 30px;
        }

        h3 {
            font-size: 1.25rem;
            color: var(--heading-color);
            margin-top: 25px;
        }

        h4 {
            font-size: 1.1rem;
            color: var(--heading-color);
        }

        /* テーブル */
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 0.9rem;
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border: 1px solid var(--border-color);
        }

        th {
            background-color: var(--table-header-bg);
            font-weight: 600;
        }

        tr:nth-child(even) {
            background-color: rgba(0,0,0,0.02);
        }

        /* コード */
        pre {
            background-color: var(--code-bg);
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
            font-size: 0.9rem;
        }

        code {
            font-family: 'Fira Code', 'Consolas', monospace;
            background-color: var(--code-bg);
            padding: 2px 6px;
            border-radius: 3px;
            font-size: 0.9em;
        }

        pre code {
            padding: 0;
            background: none;
        }

        /* Mermaid */
        .mermaid {
            text-align: center;
            margin: 20px 0;
            background: white;
            padding: 20px;
            border-radius: 8px;
        }

        /* リスト */
        ul, ol {
            margin: 15px 0;
            padding-left: 25px;
        }

        li {
            margin: 8px 0;
        }

        /* リンク */
        a {
            color: var(--link-color);
        }

        /* 引用 */
        blockquote {
            border-left: 4px solid var(--link-color);
            margin: 20px 0;
            padding: 10px 20px;
            background: rgba(0,0,0,0.03);
        }

        /* 印刷用 */
        @media print {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-left: 0;
                width: 100%;
            }
            section {
                page-break-inside: avoid;
            }
        }

        /* レスポンシブ */
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-left: 0;
                width: 100%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <nav class="sidebar">
        <h2>目次</h2>
        <ul>
<li class="section-title">エグゼクティブサマリー</li>
<li><a href="#summary-executive-summary">Executive Summary</a></li>
<li class="section-title">システム分析</li>
<li><a href="#analysis-system-overview">System Overview</a></li>
<li><a href="#analysis-ubiquitous-language">Ubiquitous Language</a></li>
<li><a href="#analysis-actors-roles-permissions">Actors Roles Permissions</a></li>
<li><a href="#analysis-domain-code-mapping">Domain Code Mapping</a></li>
<li class="section-title">MMI評価</li>
<li><a href="#evaluation-mmi-overview">Mmi Overview</a></li>
<li><a href="#evaluation-mmi-by-module">Mmi By Module</a></li>
<li><a href="#evaluation-mmi-improvement-plan">Mmi Improvement Plan</a></li>
<li class="section-title">設計</li>
<li><a href="#design-domain-analysis">Domain Analysis</a></li>
<li><a href="#design-context-map">Context Map</a></li>
<li><a href="#design-system-mapping">System Mapping</a></li>
<li><a href="#design-target-architecture">Target Architecture</a></li>
<li><a href="#design-transformation-plan">Transformation Plan</a></li>
<li><a href="#design-operations-plan">Operations Plan</a></li>
<li><a href="#design-scalardb-architecture">Scalardb Architecture</a></li>
<li><a href="#design-scalardb-schema">Scalardb Schema</a></li>
<li><a href="#design-scalardb-transaction">Scalardb Transaction</a></li>
<li><a href="#design-scalardb-migration">Scalardb Migration</a></li>
<li class="section-title">ドメインストーリー</li>
<li><a href="#stories-domain-stories">Domain Stories</a></li>
<li class="section-title">ナレッジグラフ</li>
<li><a href="#graph-schema">Schema</a></li>
<li><a href="#graph-statistics">Statistics</a></li>
<li><a href="#graph-interactive">Interactive Viewer</a></li>
</ul>
</nav>

    <main class="main-content">
        <header class="report-header">
            <h1>Scalar Auditor for BOX - リファクタリング分析レポート</h1>
            <p class="meta">Generated: 2025-12-26 11:46:59</p>
        </header>
    
<section id="summary">
<h1>エグゼクティブサマリー</h1>
<article id="summary-executive-summary">
<h1 id="executive-summary">Executive Summary<a class="headerlink" href="#executive-summary" title="Permanent link">&para;</a></h1>
<h2 id="scalar-auditor-for-box-">Scalar Auditor for BOX - マイクロサービス化計画<a class="headerlink" href="#scalar-auditor-for-box-" title="Permanent link">&para;</a></h2>
<hr />
<h2 id="1">1. プロジェクト概要<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 対象システム<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>項目</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>システム名</strong></td>
<td>Scalar Auditor for BOX</td>
</tr>
<tr>
<td><strong>目的</strong></td>
<td>BOXファイルの監査・改ざん検証システム</td>
</tr>
<tr>
<td><strong>技術スタック</strong></td>
<td>Spring Boot 3.2.1, React 18, Vite</td>
</tr>
<tr>
<td><strong>構成</strong></td>
<td>モノリシックアーキテクチャ（モノレポ）</td>
</tr>
</tbody>
</table>
<h3 id="12">1.2 分析範囲<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<ul>
<li>Javaバックエンド（Spring Boot）</li>
<li>Reactフロントエンド</li>
<li>ScalarDB/ScalarDL連携</li>
</ul>
<hr />
<h2 id="2">2. 現状分析結果<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 システム構造<a class="headerlink" href="#21" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code>┌─────────────────────────────────────────────────────────┐
│                    現在のアーキテクチャ                    │
├─────────────────────────────────────────────────────────┤
│  Controller層 (9)  │  Service層 (12)  │  Repository層 (22)  │
├─────────────────────────────────────────────────────────┤
│                    Entity/Model (20)                     │
├─────────────────────────────────────────────────────────┤
│        ScalarDB Cluster    │    BOX Platform API        │
└─────────────────────────────────────────────────────────┘
</code></pre>

<h3 id="22-mmi">2.2 MMI評価結果<a class="headerlink" href="#22-mmi" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>指標</th>
<th>スコア</th>
<th>評価</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>総合スコア</strong></td>
<td>48.6/100</td>
<td>低中成熟</td>
</tr>
<tr>
<td>Cohesion (凝集度)</td>
<td>2.2/5</td>
<td>サービス肥大化</td>
</tr>
<tr>
<td>Coupling (結合度)</td>
<td>2.0/5</td>
<td>高結合</td>
</tr>
<tr>
<td>Independence (独立性)</td>
<td>2.5/5</td>
<td>分離不足</td>
</tr>
<tr>
<td>Reusability (再利用性)</td>
<td>2.7/5</td>
<td>改善余地あり</td>
</tr>
</tbody>
</table>
<h3 id="23">2.3 主要課題<a class="headerlink" href="#23" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>課題</th>
<th>影響</th>
<th>優先度</th>
</tr>
</thead>
<tbody>
<tr>
<td>UserService肥大化（1116行）</td>
<td>保守性・テスタビリティ低下</td>
<td><strong>高</strong></td>
</tr>
<tr>
<td>JSONフィールドによるデータ保存</td>
<td>クエリ性能・整合性問題</td>
<td><strong>中</strong></td>
</tr>
<tr>
<td>BOX API直接依存</td>
<td>テスト困難・障害伝播</td>
<td><strong>中</strong></td>
</tr>
<tr>
<td>貧血ドメインモデル</td>
<td>ビジネスロジック分散</td>
<td><strong>中</strong></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3">3. ドメイン設計<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 境界づけられたコンテキスト<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "Core Domains"
        AM[Audit Management<br/>監査管理]
        ET[Event Tracking<br/>イベント追跡]
        IV[Integrity Verification<br/>整合性検証]
    end

    subgraph "Supporting Domains"
        IA[Identity & Access<br/>認証・アクセス]
        FM[File Management<br/>ファイル管理]
    end

    subgraph "Integration"
        BI[BOX Integration<br/>BOX連携]
    end

    IA --> AM
    AM --> FM
    AM --> ET
    FM --> BI
    AM --> IV
</div>

<h3 id="32">3.2 コンテキスト関係パターン<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>関係</th>
<th>パターン</th>
</tr>
</thead>
<tbody>
<tr>
<td>Audit ↔ File</td>
<td>Partnership</td>
</tr>
<tr>
<td>File → BOX Integration</td>
<td>Anti-corruption Layer</td>
</tr>
<tr>
<td>Identity → All</td>
<td>Customer-Supplier</td>
</tr>
<tr>
<td>Verification → ScalarDL</td>
<td>Open Host Service</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="4">4. ターゲットアーキテクチャ<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 マイクロサービス構成<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code>┌─────────────────────────────────────────────────────────────────┐
│                        API Gateway (Kong)                        │
├─────────────────────────────────────────────────────────────────┤
│  Identity  │  Audit   │  File    │  Event   │ Verification │ BOX │
│  Service   │  Service │  Service │  Service │   Service    │Adapter│
├─────────────────────────────────────────────────────────────────┤
│                     ScalarDB Cluster (3 nodes)                   │
├─────────────────────────────────────────────────────────────────┤
│     PostgreSQL        │    Cassandra    │     ScalarDL          │
│  (Identity/Audit/File)│    (Events)     │   (Verification)      │
└─────────────────────────────────────────────────────────────────┘
</code></pre>

<h3 id="42">4.2 サービス仕様<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>サービス</th>
<th>責務</th>
<th>主要API</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Identity Service</strong></td>
<td>認証・認可・ユーザー管理</td>
<td>/auth, /users, /roles</td>
</tr>
<tr>
<td><strong>Audit Service</strong></td>
<td>監査セット・グループ管理</td>
<td>/audit-sets, /audit-groups</td>
</tr>
<tr>
<td><strong>File Service</strong></td>
<td>ファイルメタデータ管理</td>
<td>/files, /folders, /items</td>
</tr>
<tr>
<td><strong>Event Service</strong></td>
<td>イベントログ収集・検索</td>
<td>/events, /webhooks</td>
</tr>
<tr>
<td><strong>Verification Service</strong></td>
<td>改ざん検証・証跡管理</td>
<td>/verify, /proofs</td>
</tr>
<tr>
<td><strong>BOX Adapter</strong></td>
<td>BOX API連携・Anti-corruption</td>
<td>(内部)</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="5">5. データアーキテクチャ<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<h3 id="51-scalardb">5.1 ScalarDB構成<a class="headerlink" href="#51-scalardb" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>設定</th>
<th>選択</th>
<th>理由</th>
</tr>
</thead>
<tbody>
<tr>
<td>デプロイモード</td>
<td>ScalarDB Cluster</td>
<td>マイクロサービス対応、高可用性</td>
</tr>
<tr>
<td>トランザクション</td>
<td>Consensus Commit</td>
<td>分散ACID必須</td>
</tr>
<tr>
<td>ストレージ戦略</td>
<td>Multi-storage</td>
<td>コンテキスト別最適化</td>
</tr>
<tr>
<td>分離レベル</td>
<td>SERIALIZABLE</td>
<td>監査データ完全性保証</td>
</tr>
</tbody>
</table>
<h3 id="52-namespace">5.2 Namespace設計<a class="headerlink" href="#52-namespace" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Namespace</th>
<th>ストレージ</th>
<th>テーブル数</th>
</tr>
</thead>
<tbody>
<tr>
<td>identity</td>
<td>PostgreSQL</td>
<td>5</td>
</tr>
<tr>
<td>audit</td>
<td>PostgreSQL</td>
<td>5</td>
</tr>
<tr>
<td>file</td>
<td>PostgreSQL</td>
<td>4</td>
</tr>
<tr>
<td>event</td>
<td>Cassandra</td>
<td>4</td>
</tr>
<tr>
<td>coordinator</td>
<td>PostgreSQL</td>
<td>1</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6">6. 変換計画<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 フェーズ概要<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<div class="mermaid">
gantt
    title マイクロサービス変換ロードマップ
    dateFormat YYYY-MM

    section Phase 0
    インフラ準備          :2025-01, 3M

    section Phase 1
    Identity Service     :2025-04, 2M
    BOX Adapter          :2025-04, 2M

    section Phase 2
    File Service         :2025-06, 2M
    Event Service        :2025-06, 2M

    section Phase 3
    Audit Service        :2025-08, 2M
    Verification Service :2025-10, 1M

    section Phase 4
    最適化・完了         :2025-11, 2M
</div>

<h3 id="62">6.2 フェーズ詳細<a class="headerlink" href="#62" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Phase</th>
<th>期間</th>
<th>内容</th>
<th>成果物</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>0: 基盤構築</strong></td>
<td>3ヶ月</td>
<td>Kubernetes、ScalarDB Cluster、CI/CD</td>
<td>インフラ環境</td>
</tr>
<tr>
<td><strong>1: 認証・BOX連携</strong></td>
<td>4ヶ月</td>
<td>Identity Service、BOX Adapter分離</td>
<td>認証基盤</td>
</tr>
<tr>
<td><strong>2: ファイル・イベント</strong></td>
<td>4ヶ月</td>
<td>File Service、Event Service分離</td>
<td>コア機能</td>
</tr>
<tr>
<td><strong>3: 監査・検証</strong></td>
<td>3ヶ月</td>
<td>Audit Service、Verification Service</td>
<td>監査機能完成</td>
</tr>
<tr>
<td><strong>4: 最適化</strong></td>
<td>2ヶ月</td>
<td>性能チューニング、モノリス廃止</td>
<td>本番移行</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7">7. リスクと対策<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 技術リスク<a class="headerlink" href="#71" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>リスク</th>
<th>影響</th>
<th>対策</th>
</tr>
</thead>
<tbody>
<tr>
<td>分散トランザクション失敗</td>
<td>データ不整合</td>
<td>Saga パターン、補償トランザクション</td>
</tr>
<tr>
<td>BOX API障害</td>
<td>サービス停止</td>
<td>サーキットブレーカー、リトライ</td>
</tr>
<tr>
<td>移行中のサービス停止</td>
<td>ビジネス影響</td>
<td>Strangler Fig、段階的切替</td>
</tr>
</tbody>
</table>
<h3 id="72">7.2 組織リスク<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>リスク</th>
<th>影響</th>
<th>対策</th>
</tr>
</thead>
<tbody>
<tr>
<td>スキル不足</td>
<td>品質低下</td>
<td>トレーニング、ペアプログラミング</td>
</tr>
<tr>
<td>スコープ拡大</td>
<td>スケジュール遅延</td>
<td>厳格な変更管理</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8">8. 期待効果<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 定量効果<a class="headerlink" href="#81" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>指標</th>
<th>現状</th>
<th>目標</th>
<th>改善率</th>
</tr>
</thead>
<tbody>
<tr>
<td>デプロイ頻度</td>
<td>月1回</td>
<td>週1回+</td>
<td>400%+</td>
</tr>
<tr>
<td>MTTR</td>
<td>2時間</td>
<td>30分</td>
<td>75%短縮</td>
</tr>
<tr>
<td>テストカバレッジ</td>
<td>30%</td>
<td>80%</td>
<td>167%+</td>
</tr>
<tr>
<td>MMIスコア</td>
<td>48.6</td>
<td>75+</td>
<td>54%+</td>
</tr>
</tbody>
</table>
<h3 id="82">8.2 定性効果<a class="headerlink" href="#82" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>開発生産性向上</strong>: サービス単位の独立開発</li>
<li><strong>障害影響局所化</strong>: 障害がサービス内に限定</li>
<li><strong>スケーラビリティ</strong>: サービス単位の水平スケール</li>
<li><strong>技術刷新容易化</strong>: サービス単位の技術選択</li>
</ul>
<hr />
<h2 id="9">9. 推奨事項<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<h3 id="91-phase-0">9.1 即時対応（Phase 0開始前）<a class="headerlink" href="#91-phase-0" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>UserService分割設計の詳細化</strong></li>
<li><strong>ScalarDB Cluster検証環境構築</strong></li>
<li><strong>チームスキル評価とトレーニング計画</strong></li>
</ol>
<h3 id="92">9.2 継続的改善<a class="headerlink" href="#92" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Domain Event導入</strong>による疎結合化</li>
<li><strong>CQRS パターン</strong>によるクエリ最適化</li>
<li><strong>Feature Flag</strong>による段階的リリース</li>
</ol>
<hr />
<h2 id="10">10. 付録<a class="headerlink" href="#10" title="Permanent link">&para;</a></h2>
<h3 id="101">10.1 生成ドキュメント一覧<a class="headerlink" href="#101" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>カテゴリ</th>
<th>ファイル</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>分析</strong></td>
<td>system-overview.md</td>
<td>システム概要</td>
</tr>
<tr>
<td></td>
<td>ubiquitous-language.md</td>
<td>ユビキタス言語集</td>
</tr>
<tr>
<td></td>
<td>actors-roles-permissions.md</td>
<td>アクター・ロール・権限</td>
</tr>
<tr>
<td></td>
<td>domain-code-mapping.md</td>
<td>ドメイン-コード対応表</td>
</tr>
<tr>
<td><strong>評価</strong></td>
<td>mmi-overview.md</td>
<td>MMI評価概要</td>
</tr>
<tr>
<td></td>
<td>mmi-by-module.md</td>
<td>モジュール別MMI</td>
</tr>
<tr>
<td></td>
<td>mmi-improvement-plan.md</td>
<td>改善計画</td>
</tr>
<tr>
<td><strong>設計</strong></td>
<td>domain-analysis.md</td>
<td>ドメイン分析</td>
</tr>
<tr>
<td></td>
<td>context-map.md</td>
<td>コンテキストマップ</td>
</tr>
<tr>
<td></td>
<td>target_architecture.md</td>
<td>ターゲットアーキテクチャ</td>
</tr>
<tr>
<td></td>
<td>transformation_plan.md</td>
<td>変換計画</td>
</tr>
<tr>
<td></td>
<td>operations_plan.md</td>
<td>運用計画</td>
</tr>
<tr>
<td></td>
<td>scalardb_*.md</td>
<td>ScalarDB設計（4ファイル）</td>
</tr>
<tr>
<td><strong>ストーリー</strong></td>
<td>domain-stories.md</td>
<td>ドメインストーリー集</td>
</tr>
<tr>
<td><strong>グラフ</strong></td>
<td>schema.md</td>
<td>GraphDBスキーマ</td>
</tr>
<tr>
<td></td>
<td>statistics.md</td>
<td>グラフ統計情報</td>
</tr>
</tbody>
</table>
<h3 id="102">10.2 ナレッジグラフ<a class="headerlink" href="#102" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>ノード数</strong>: 106</li>
<li><strong>リレーション数</strong>: 130</li>
<li><strong>データベース</strong>: knowledge.ryugraph</li>
</ul>
<pre class="codehilite"><code class="language-bash"># クエリ実行例
python scripts/query_graph.py --db-path ./knowledge.ryugraph \
  --query &quot;監査セットに関連するクラス&quot;
</code></pre>

<hr />
<p><strong>生成日</strong>: 2025-12-26
<strong>プロジェクト</strong>: Scalar Auditor for BOX
<strong>バージョン</strong>: 1.0.0</p>
<hr />
<p><em>このドキュメントはClaude Codeのリファクタリングエージェントにより自動生成されました。</em></p>
</article>
</section>
<section id="analysis">
<h1>システム分析</h1>
<article id="analysis-system-overview">
<h1 id="scalar-auditor-for-box-">Scalar Auditor for BOX - システム分析レポート<a class="headerlink" href="#scalar-auditor-for-box-" title="Permanent link">&para;</a></h1>
<p><strong>分析日</strong>: 2025-12-26
<strong>対象</strong>: scalar-event-log-fetcher-main</p>
<hr />
<h2 id="1">1. プロジェクト概要<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 目的<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<p>BOXアプリケーションと連携し、ユーザーイベントログをBOX外部に保存・管理するシステム。ファイルの改ざん検出機能を備え、外部監査人が重要ファイルを監査可能にする。</p>
<h3 id="12">1.2 主要機能<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>#</th>
<th>機能</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>イベントログ保存・表示</td>
<td>日時/タイプ/ユーザーでフィルタリング可能</td>
</tr>
<tr>
<td>2</td>
<td>ファイル詳細表示</td>
<td>メタデータ、バージョン、SHA1ハッシュ重複確認</td>
</tr>
<tr>
<td>3</td>
<td>ファイルバージョン管理</td>
<td>全バージョンの履歴表示</td>
</tr>
<tr>
<td>4</td>
<td>組織ユーザーロール管理</td>
<td>Audit Admin / General User</td>
</tr>
<tr>
<td>5</td>
<td>外部監査人管理</td>
<td>作成・更新・削除</td>
</tr>
<tr>
<td>6</td>
<td>Audit Set管理</td>
<td>ファイル/フォルダのグループ化</td>
</tr>
<tr>
<td>7</td>
<td>Audit Group管理</td>
<td>監査人のグループ化</td>
</tr>
<tr>
<td>8</td>
<td>ファイル改ざん検出</td>
<td>ScalarDL連携による検証</td>
</tr>
<tr>
<td>9</td>
<td>外部監査人操作ログ</td>
<td>アクセスログの閲覧</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="2">2. 技術スタック<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21-backend">2.1 Backend<a class="headerlink" href="#21-backend" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>項目</th>
<th>技術</th>
</tr>
</thead>
<tbody>
<tr>
<td>フレームワーク</td>
<td>Spring Boot 3.2.1</td>
</tr>
<tr>
<td>Java Version</td>
<td>17</td>
</tr>
<tr>
<td>ビルドツール</td>
<td>Gradle</td>
</tr>
<tr>
<td>認証</td>
<td>Spring Security + JWT</td>
</tr>
<tr>
<td>API文書</td>
<td>OpenAPI (springdoc)</td>
</tr>
</tbody>
</table>
<h3 id="22-frontend">2.2 Frontend<a class="headerlink" href="#22-frontend" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>項目</th>
<th>技術</th>
</tr>
</thead>
<tbody>
<tr>
<td>フレームワーク</td>
<td>React 18</td>
</tr>
<tr>
<td>ビルドツール</td>
<td>Vite 5</td>
</tr>
<tr>
<td>状態管理</td>
<td>Redux Toolkit + Redux Persist</td>
</tr>
<tr>
<td>UIライブラリ</td>
<td>MUI (Material-UI) v5</td>
</tr>
<tr>
<td>スタイリング</td>
<td>Tailwind CSS</td>
</tr>
<tr>
<td>国際化</td>
<td>i18next</td>
</tr>
<tr>
<td>Box SDK</td>
<td>box-ui-elements v19</td>
</tr>
</tbody>
</table>
<h3 id="23-database-infrastructure">2.3 Database / Infrastructure<a class="headerlink" href="#23-database-infrastructure" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>項目</th>
<th>技術</th>
</tr>
</thead>
<tbody>
<tr>
<td>Database</td>
<td>Cassandra</td>
</tr>
<tr>
<td>Transaction管理</td>
<td>ScalarDB Cluster 3.14.0</td>
</tr>
<tr>
<td>改ざん検出</td>
<td>ScalarDL 3.10.0</td>
</tr>
<tr>
<td>コンテナ</td>
<td>Kubernetes</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3">3. サブプロジェクト構成<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<pre class="codehilite"><code>scalar-event-log-fetcher-main/
├── Scalar-Box-Event-Log-Tool/       # Spring Boot Backend
│   ├── src/main/java/               # Javaソースコード
│   ├── src/main/resources/          # 設定ファイル
│   ├── schema-loader/               # ScalarDBスキーマ
│   └── build.gradle                 # ビルド設定
├── Scalar-Box-WebApp/               # React Frontend（メイン）
│   ├── src/pages/                   # ページコンポーネント
│   ├── src/redux/                   # 状態管理
│   └── src/api/                     # API呼び出し
├── Scalar-WebApp-Integration-Menu/  # React Frontend（統合メニュー）
├── K8s-scalardb-cluster/            # Kubernetes設定
│   └── scalardb-cluster-custom-values.yaml
├── ScalarDL-Event-Log-Fetcher-Setup/
├── Scalar-Box-Event-Log-Tool-Setup/
└── Documentation/                   # ドキュメント
</code></pre>

<hr />
<h2 id="4-backend">4. Backendアーキテクチャ<a class="headerlink" href="#4-backend" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 パッケージ構成<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code>com.scalar.events_log_tool.application/
├── controller/     # REST API エンドポイント (9クラス)
├── service/        # ビジネスロジック (10クラス)
├── business/       # Controller-Service間レイヤー (8クラス)
├── repository/     # データアクセス層 (19クラス)
├── model/          # エンティティ (17クラス)
├── dto/            # Data Transfer Objects (47クラス)
├── responsedto/    # レスポンス用DTO (17クラス)
├── config/         # 設定クラス
├── security/       # JWT認証・Spring Security
├── constant/       # 定数・Enum (11クラス)
├── exception/      # カスタム例外
└── utility/        # ユーティリティ (4クラス)
</code></pre>

<h3 id="42">4.2 主要コントローラー<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>コントローラー</th>
<th>責務</th>
</tr>
</thead>
<tbody>
<tr>
<td>UserController</td>
<td>ユーザー認証・管理</td>
</tr>
<tr>
<td>AuditSetController</td>
<td>監査セットCRUD</td>
</tr>
<tr>
<td>AuditSetItemController</td>
<td>監査セットアイテム管理</td>
</tr>
<tr>
<td>AuditSetCollaboratorController</td>
<td>コラボレーター管理</td>
</tr>
<tr>
<td>AuditGroupController</td>
<td>監査グループ管理</td>
</tr>
<tr>
<td>EventLogController</td>
<td>イベントログ取得</td>
</tr>
<tr>
<td>FileController</td>
<td>ファイル操作・改ざん検証</td>
</tr>
<tr>
<td>FolderController</td>
<td>フォルダ操作</td>
</tr>
<tr>
<td>ItemController</td>
<td>アイテム共通操作</td>
</tr>
</tbody>
</table>
<h3 id="43">4.3 主要サービス<a class="headerlink" href="#43" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>サービス</th>
<th>責務</th>
<th>主要メソッド</th>
</tr>
</thead>
<tbody>
<tr>
<td>UserService</td>
<td>ユーザー認証・管理</td>
<td>login, createUser, deleteUser</td>
</tr>
<tr>
<td>AuditSetService</td>
<td>監査セット管理</td>
<td>createAuditSet, deleteAuditSet, updateCollaborators</td>
</tr>
<tr>
<td>AuditGroupService</td>
<td>グループ管理</td>
<td>-</td>
</tr>
<tr>
<td>EventLogService</td>
<td>ログ検索</td>
<td>getEventsByDateRange, getEventsByDateRangeAndUser</td>
</tr>
<tr>
<td>FileService</td>
<td>ファイル詳細</td>
<td>getFileDetails, getFileCopies, getFileVersions</td>
</tr>
<tr>
<td>AssetService</td>
<td>ScalarDL連携</td>
<td>addAsset, getTamperingStatus</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="5-frontend">5. Frontendアーキテクチャ<a class="headerlink" href="#5-frontend" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 ページ構成<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>ディレクトリ</th>
<th>機能</th>
</tr>
</thead>
<tbody>
<tr>
<td>auth/</td>
<td>認証（ログイン、パスワードリセット）</td>
</tr>
<tr>
<td>AuditSet/</td>
<td>監査セット管理</td>
</tr>
<tr>
<td>AuditorsAndGroups/</td>
<td>監査人・グループ管理</td>
</tr>
<tr>
<td>ViewAllEventHistory/</td>
<td>イベント履歴表示</td>
</tr>
<tr>
<td>ViewItemsUnderAudit/</td>
<td>監査対象アイテム表示</td>
</tr>
<tr>
<td>ExternalAuditorPage/</td>
<td>外部監査人用ページ</td>
</tr>
<tr>
<td>UserRole/</td>
<td>ユーザーロール管理</td>
</tr>
<tr>
<td>ApplicationSetting/</td>
<td>アプリケーション設定</td>
</tr>
</tbody>
</table>
<h3 id="52">5.2 状態管理<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<ul>
<li>Redux Toolkit使用</li>
<li>Redux Persistによる永続化</li>
<li>redux-loggerによるデバッグ</li>
</ul>
<hr />
<h2 id="6">6. データベース設計<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="61-15">6.1 テーブル一覧（15テーブル）<a class="headerlink" href="#61-15" title="Permanent link">&para;</a></h3>
<h4 id="_1">イベント関連<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>テーブル</th>
<th>パーティションキー</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>events</td>
<td>yyyy_mm_dd</td>
<td>BOXイベントログ（日付パーティション）</td>
</tr>
<tr>
<td>item_events</td>
<td>item_id</td>
<td>アイテム別イベント</td>
</tr>
<tr>
<td>auditor_logs</td>
<td>audit_set_id</td>
<td>外部監査人操作ログ</td>
</tr>
</tbody>
</table>
<h4 id="_2">ユーザー関連<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>テーブル</th>
<th>パーティションキー</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>user</td>
<td>user_email</td>
<td>ユーザーマスタ</td>
</tr>
<tr>
<td>role_user</td>
<td>role_name</td>
<td>ロール別ユーザー</td>
</tr>
<tr>
<td>user_token</td>
<td>user_email</td>
<td>JWT/OAuth2トークン</td>
</tr>
<tr>
<td>user_otp</td>
<td>user_email</td>
<td>ワンタイムパスワード</td>
</tr>
<tr>
<td>organization</td>
<td>org_id</td>
<td>組織マスタ</td>
</tr>
</tbody>
</table>
<h4 id="_3">監査関連<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>テーブル</th>
<th>パーティションキー</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>audit_set</td>
<td>audit_set_id</td>
<td>監査セット</td>
</tr>
<tr>
<td>audit_set_collaborators</td>
<td>user_email</td>
<td>監査セット協力者</td>
</tr>
<tr>
<td>audit_group</td>
<td>audit_group_id</td>
<td>監査グループ</td>
</tr>
<tr>
<td>user_audit_group</td>
<td>user_email</td>
<td>ユーザー別グループ</td>
</tr>
<tr>
<td>audit_grp_audit_set_mapping</td>
<td>audit_group_id</td>
<td>グループ-セット関連</td>
</tr>
<tr>
<td>auditset_folder_file_mapping</td>
<td>audit_set_id</td>
<td>セット-ファイル関連</td>
</tr>
</tbody>
</table>
<h4 id="_4">ファイル関連<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>テーブル</th>
<th>パーティションキー</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>item_status</td>
<td>item_id</td>
<td>改ざん検証ステータス</td>
</tr>
<tr>
<td>items_by_sha1</td>
<td>sha1_hash</td>
<td>SHA1ハッシュ別ファイル</td>
</tr>
<tr>
<td>position_tracker</td>
<td>user_id</td>
<td>イベント取得位置</td>
</tr>
</tbody>
</table>
<h3 id="62-er">6.2 ER図（概念）<a class="headerlink" href="#62-er" title="Permanent link">&para;</a></h3>
<div class="mermaid">
erDiagram
    USER ||--o{ ROLE_USER : has
    USER ||--o{ USER_TOKEN : has
    USER ||--o{ USER_OTP : has
    USER }o--|| ORGANIZATION : belongs_to

    AUDIT_SET ||--o{ AUDIT_SET_COLLABORATORS : has
    AUDIT_SET ||--o{ AUDITSET_FOLDER_FILE_MAPPING : contains
    AUDIT_SET ||--o{ AUDITOR_LOGS : has

    AUDIT_GROUP ||--o{ USER_AUDIT_GROUP : has
    AUDIT_GROUP ||--o{ AUDIT_GRP_AUDIT_SET_MAPPING : maps

    EVENTS ||--o{ ITEM_EVENTS : relates
    ITEM_STATUS ||--o{ ITEMS_BY_SHA1 : identifies
</div>

<hr />
<h2 id="7">7. 外部システム連携<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71-box-api">7.1 Box API連携<a class="headerlink" href="#71-box-api" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>認証方式</strong>: OAuth 2.0（Client Credentials Grant）</li>
<li><strong>SDK</strong>: Box Java SDK 4.4.0</li>
<li><strong>イベント取得</strong>: Enterprise Event API</li>
<li><strong>ファイル操作</strong>: Files/Folders API</li>
</ul>
<h3 id="72-scalardl">7.2 ScalarDL連携<a class="headerlink" href="#72-scalardl" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>目的</strong>: ファイル改ざん検出</li>
<li><strong>契約</strong>: クライアント証明書ベース</li>
<li><strong>機能</strong>: Asset登録、改ざん検証</li>
</ul>
<hr />
<h2 id="8">8. セキュリティ<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 認証・認可<a class="headerlink" href="#81" title="Permanent link">&para;</a></h3>
<ul>
<li>JWT (JSON Web Token) ベース認証</li>
<li>Spring Security統合</li>
<li>ロールベースアクセス制御（RBAC）</li>
</ul>
<h3 id="82">8.2 ユーザーロール<a class="headerlink" href="#82" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>ロール</th>
<th>権限</th>
</tr>
</thead>
<tbody>
<tr>
<td>Audit Admin</td>
<td>全機能へのアクセス</td>
</tr>
<tr>
<td>General User</td>
<td>閲覧・限定的な操作</td>
</tr>
<tr>
<td>External Auditor</td>
<td>割り当てられたAudit Setのみ</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="9">9. 国際化対応<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<ul>
<li>日本語 (<code>messages_ja.properties</code>)</li>
<li>英語 (<code>messages.properties</code>)</li>
<li>Frontend: i18next使用</li>
</ul>
<hr />
<h2 id="10">10. まとめ<a class="headerlink" href="#10" title="Permanent link">&para;</a></h2>
<h3 id="101">10.1 強み<a class="headerlink" href="#101" title="Permanent link">&para;</a></h3>
<ul>
<li>ScalarDB/ScalarDLによる信頼性の高いデータ管理</li>
<li>Box連携による既存ワークフローとの統合</li>
<li>ファイル改ざん検出機能</li>
<li>多言語対応</li>
</ul>
<h3 id="102">10.2 技術的特徴<a class="headerlink" href="#102" title="Permanent link">&para;</a></h3>
<ul>
<li>モノレポ構成（Backend + 複数Frontend）</li>
<li>マイクロサービス対応基盤（ScalarDB Cluster）</li>
<li>Kubernetes対応</li>
</ul>
<hr />
<h2 id="11_1">11. サービス層詳細分析<a class="headerlink" href="#11_1" title="Permanent link">&para;</a></h2>
<h3 id="111">11.1 サービスクラス一覧（コード行数順）<a class="headerlink" href="#111" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>サービス</th>
<th>行数</th>
<th>責務</th>
<th>複雑度</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>UserService</code></td>
<td>1116</td>
<td>ユーザー認証・管理、BOX連携、トークン管理</td>
<td>高</td>
</tr>
<tr>
<td><code>AuditSetItemService</code></td>
<td>899</td>
<td>監査セットアイテム管理、検証、監視ステータス管理</td>
<td>高</td>
</tr>
<tr>
<td><code>AuditSetService</code></td>
<td>845</td>
<td>監査セットCRUD、コラボレーター管理</td>
<td>中</td>
</tr>
<tr>
<td><code>FileService</code></td>
<td>554</td>
<td>ファイル詳細取得、バージョン管理、BOX連携</td>
<td>中</td>
</tr>
<tr>
<td><code>AuditGroupService</code></td>
<td>438</td>
<td>監査グループCRUD、メンバー管理</td>
<td>中</td>
</tr>
<tr>
<td><code>AuditSetCollaboratorService</code></td>
<td>286</td>
<td>コラボレーター権限管理、オーナー変更</td>
<td>低</td>
</tr>
<tr>
<td><code>EventLogService</code></td>
<td>220</td>
<td>イベントログ検索、フィルタリング</td>
<td>低</td>
</tr>
<tr>
<td><code>AssetService</code></td>
<td>197</td>
<td>ScalarDL資産管理、改ざん検証</td>
<td>中</td>
</tr>
<tr>
<td><code>FolderService</code></td>
<td>113</td>
<td>BOXフォルダ操作</td>
<td>低</td>
</tr>
<tr>
<td><code>CommonService</code></td>
<td>31</td>
<td>共通ユーティリティ（Owner/CoOwner判定）</td>
<td>低</td>
</tr>
</tbody>
</table>
<h3 id="112-22">11.2 リポジトリ層詳細（22クラス）<a class="headerlink" href="#112-22" title="Permanent link">&para;</a></h3>
<h4 id="_5">コアリポジトリ<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>リポジトリ</th>
<th>テーブル</th>
<th>主要操作</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>UserRepository</code></td>
<td>user</td>
<td>create, getByUserEmail, getUserList, createAndDelete</td>
</tr>
<tr>
<td><code>AuditSetRepository</code></td>
<td>audit_set</td>
<td>create, get, getAuditSetList, getMyAuditSetList</td>
</tr>
<tr>
<td><code>EventsRepository</code></td>
<td>events</td>
<td>create, getAllEvents, getEventsByDate</td>
</tr>
<tr>
<td><code>AuditGroupRepository</code></td>
<td>audit_group</td>
<td>create, getgroupList, getAuditGroup, update</td>
</tr>
</tbody>
</table>
<h4 id="_6">関連テーブルリポジトリ<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>リポジトリ</th>
<th>テーブル</th>
<th>関連</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AuditSetCollaboratorsRepository</code></td>
<td>audit_set_collaborators</td>
<td>AuditSet-User</td>
</tr>
<tr>
<td><code>AuditSetItemRepository</code></td>
<td>audit_set_item</td>
<td>AuditSet-Item</td>
</tr>
<tr>
<td><code>AuditGrpAuditSetMappingRepository</code></td>
<td>audit_grp_audit_set_mapping</td>
<td>AuditGroup-AuditSet</td>
</tr>
<tr>
<td><code>UserAuditGroupRepository</code></td>
<td>user_audit_group</td>
<td>User-AuditGroup</td>
</tr>
</tbody>
</table>
<h4 id="_7">ファイル/イベント関連<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>リポジトリ</th>
<th>テーブル</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>ItemEventsRepository</code></td>
<td>item_events</td>
<td>アイテム別イベント</td>
</tr>
<tr>
<td><code>ItemStatusRepository</code></td>
<td>item_status</td>
<td>改ざん検証ステータス</td>
</tr>
<tr>
<td><code>ItemsBySha1Repository</code></td>
<td>items_by_sha1</td>
<td>ハッシュ重複検出</td>
</tr>
<tr>
<td><code>AuditorLogsRepository</code></td>
<td>auditor_logs</td>
<td>外部監査人ログ</td>
</tr>
<tr>
<td><code>ScalardlRepository</code></td>
<td>(ScalarDL)</td>
<td>台帳操作</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="12_1">12. アーキテクチャ図<a class="headerlink" href="#12_1" title="Permanent link">&para;</a></h2>
<h3 id="121">12.1 システム全体構成<a class="headerlink" href="#121" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "Frontend"
        WebApp[Scalar-Box-WebApp<br/>React 18]
        IntMenu[Integration Menu<br/>React]
    end

    subgraph "Backend"
        API[Spring Boot API<br/>Scalar-Box-Event-Log-Tool]

        subgraph "Application Layer"
            Controller[Controllers<br/>9クラス]
            Business[Business Layer<br/>8クラス]
            Service[Service Layer<br/>12クラス]
            Repository[Repository Layer<br/>22クラス]
        end
    end

    subgraph "Data Layer"
        ScalarDB[(ScalarDB Cluster<br/>3.14.0)]
        ScalarDL[ScalarDL<br/>3.10.0]
        Cassandra[(Cassandra)]
    end

    subgraph "External"
        BoxAPI[BOX API<br/>OAuth 2.0]
    end

    WebApp --> API
    IntMenu --> API
    Controller --> Business
    Business --> Service
    Service --> Repository
    Repository --> ScalarDB
    Service --> ScalarDL
    ScalarDB --> Cassandra
    Service --> BoxAPI
</div>

<h3 id="122">12.2 改ざん検出フロー<a class="headerlink" href="#122" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant User
    participant FileController
    participant AssetService
    participant ScalardlRepository
    participant ScalarDL
    participant BoxAPI as BOX

    User->>FileController: checkTamperingStatus(itemId)
    FileController->>BoxAPI: getFileInfo()
    BoxAPI-->>FileController: SHA-1ハッシュ
    FileController->>AssetService: getTamperingStatus()
    AssetService->>ScalardlRepository: validateLedger()
    ScalardlRepository->>ScalarDL: validateLedger()
    ScalarDL-->>ScalardlRepository: ValidationResult
    ScalardlRepository-->>AssetService: 検証結果
    AssetService-->>FileController: TamperingStatusType
    FileController-->>User: TAMPERED/NOT_TAMPERED
</div>

<hr />
<h2 id="13">13. 課題と技術的負債<a class="headerlink" href="#13" title="Permanent link">&para;</a></h2>
<h3 id="131">13.1 アーキテクチャ上の課題<a class="headerlink" href="#131" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>課題</th>
<th>影響</th>
<th>優先度</th>
</tr>
</thead>
<tbody>
<tr>
<td>巨大なServiceクラス（UserService: 1116行）</td>
<td>保守性・可読性低下</td>
<td>高</td>
</tr>
<tr>
<td>Controller-Business-Service層の責務境界曖昧</td>
<td>重複コード、テスト困難</td>
<td>中</td>
</tr>
<tr>
<td>トランザクション管理の分散</td>
<td>データ整合性リスク</td>
<td>高</td>
</tr>
<tr>
<td>BOX API依存の強結合</td>
<td>テスト困難、変更影響大</td>
<td>中</td>
</tr>
<tr>
<td>DTO/ResponseDTOの増大（64クラス）</td>
<td>メンテナンス負荷</td>
<td>低</td>
</tr>
</tbody>
</table>
<h3 id="132">13.2 推奨される改善<a class="headerlink" href="#132" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>サービス分割</strong></li>
<li>UserService → UserAuthService, UserProfileService, BoxIntegrationService</li>
<li>
<p>AuditSetService → AuditSetCoreService, AuditSetCollaboratorService</p>
</li>
<li>
<p><strong>ドメイン境界の明確化</strong></p>
</li>
<li>DDDに基づくBounded Context分割</li>
<li>
<p>Audit, User, Event, Integrationドメインの分離</p>
</li>
<li>
<p><strong>外部連携の抽象化</strong></p>
</li>
<li>BOX API用アダプタ層（Port/Adapter）導入</li>
<li>
<p>Mock対応によるテスタビリティ向上</p>
</li>
<li>
<p><strong>イベント駆動化の検討</strong></p>
</li>
<li>非同期処理の導入</li>
<li>イベントソーシング検討（ScalarDL活用）</li>
</ol>
<hr />
<p><em>Generated: 2025-12-26</em>
<em>Analysis Tool: Refactoring Agent v1.0</em>
<em>Source: scalar-event-log-fetcher-main</em></p>
</article>
<article id="analysis-ubiquitous-language">
<h1 id="ubiquitous-language">ユビキタス言語（Ubiquitous Language）<a class="headerlink" href="#ubiquitous-language" title="Permanent link">&para;</a></h1>
<h2 id="_1">監査ドメイン<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>用語</th>
<th>英語</th>
<th>定義</th>
</tr>
</thead>
<tbody>
<tr>
<td>監査セット</td>
<td>Audit Set</td>
<td>監査対象としてグループ化されたファイル/フォルダの集合</td>
</tr>
<tr>
<td>監査グループ</td>
<td>Audit Group</td>
<td>監査人をグループ化したもの</td>
</tr>
<tr>
<td>コラボレーター</td>
<td>Collaborator</td>
<td>監査セットにアクセス権を持つユーザー</td>
</tr>
<tr>
<td>レビュアー</td>
<td>Reviewer</td>
<td>監査セットを閲覧・検証できる外部監査人</td>
</tr>
<tr>
<td>監査管理者</td>
<td>Audit Admin</td>
<td>システムの管理権限を持つユーザー</td>
</tr>
<tr>
<td>一般ユーザー</td>
<td>General User</td>
<td>基本的な操作のみ可能なユーザー</td>
</tr>
<tr>
<td>外部監査人</td>
<td>External Auditor</td>
<td>組織外から監査を行うユーザー</td>
</tr>
</tbody>
</table>
<h2 id="_2">ファイルドメイン<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>用語</th>
<th>英語</th>
<th>定義</th>
</tr>
</thead>
<tbody>
<tr>
<td>アイテム</td>
<td>Item</td>
<td>ファイルまたはフォルダの総称</td>
</tr>
<tr>
<td>アセット</td>
<td>Asset</td>
<td>ScalarDLに登録されたファイルのレコード</td>
</tr>
<tr>
<td>改ざん検証</td>
<td>Tampering Verification</td>
<td>ファイルが改ざんされていないか確認する処理</td>
</tr>
<tr>
<td>ファイルコピー</td>
<td>File Copy</td>
<td>同一SHA1ハッシュを持つファイル群</td>
</tr>
<tr>
<td>ファイルバージョン</td>
<td>File Version</td>
<td>ファイルの履歴バージョン</td>
</tr>
<tr>
<td>SHA1ハッシュ</td>
<td>SHA1 Hash</td>
<td>ファイル内容の一意識別子</td>
</tr>
</tbody>
</table>
<h2 id="_3">イベントドメイン<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>用語</th>
<th>英語</th>
<th>定義</th>
</tr>
</thead>
<tbody>
<tr>
<td>イベントログ</td>
<td>Event Log</td>
<td>BOXで発生したユーザー操作の記録</td>
</tr>
<tr>
<td>エンタープライズイベント</td>
<td>Enterprise Event</td>
<td>BOX Enterprise全体のイベント</td>
</tr>
<tr>
<td>イベントタイプ</td>
<td>Event Type</td>
<td>操作の種類（UPLOAD, DOWNLOAD等）</td>
</tr>
<tr>
<td>位置トラッカー</td>
<td>Position Tracker</td>
<td>イベント取得の継続位置を記録</td>
</tr>
</tbody>
</table>
<h2 id="_4">認証・セキュリティドメイン<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>用語</th>
<th>英語</th>
<th>定義</th>
</tr>
</thead>
<tbody>
<tr>
<td>OTP</td>
<td>One-Time Password</td>
<td>パスワードリセット用の一時パスワード</td>
</tr>
<tr>
<td>リフレッシュトークン</td>
<td>Refresh Token</td>
<td>アクセストークン更新用トークン</td>
</tr>
<tr>
<td>アクセストークン</td>
<td>Access Token</td>
<td>API認証用トークン</td>
</tr>
</tbody>
</table>
<h2 id="_5">組織ドメイン<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>用語</th>
<th>英語</th>
<th>定義</th>
</tr>
</thead>
<tbody>
<tr>
<td>組織</td>
<td>Organization</td>
<td>BOX Enterpriseの組織単位</td>
</tr>
<tr>
<td>Box管理者</td>
<td>Box Admin</td>
<td>BOX側の管理権限を持つユーザー</td>
</tr>
</tbody>
</table>
<h2 id="_6">ステータス値<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<h3 id="tamperingstatustype">改ざん検証ステータス (TamperingStatusType)<a class="headerlink" href="#tamperingstatustype" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>VALID</td>
<td>改ざんなし（正常）</td>
</tr>
<tr>
<td>TAMPERED</td>
<td>改ざん検出</td>
</tr>
<tr>
<td>NOT_VERIFIED</td>
<td>未検証</td>
</tr>
</tbody>
</table>
<h3 id="accessstatus">アクセスステータス (AccessStatus)<a class="headerlink" href="#accessstatus" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>ACTIVE</td>
<td>アクティブ</td>
</tr>
<tr>
<td>PENDING</td>
<td>保留中</td>
</tr>
<tr>
<td>REVOKED</td>
<td>取り消し済み</td>
</tr>
</tbody>
</table>
<h3 id="collaboratoruserroles">コラボレーターロール (CollaboratorUserRoles)<a class="headerlink" href="#collaboratoruserroles" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>OWNER</td>
<td>オーナー（全権限）</td>
</tr>
<tr>
<td>CO_OWNER</td>
<td>共同オーナー（編集・メンバー管理）</td>
</tr>
<tr>
<td>MEMBER</td>
<td>メンバー（閲覧・アイテム追加）</td>
</tr>
<tr>
<td>REVIEWER</td>
<td>レビュアー（閲覧のみ）</td>
</tr>
</tbody>
</table>
<h3 id="userroles">ユーザーロール (UserRoles)<a class="headerlink" href="#userroles" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>AUDIT_ADMIN</td>
<td>監査管理者（全システム管理権限）</td>
</tr>
<tr>
<td>GENERAL_USER</td>
<td>一般ユーザー（監査セット作成・管理）</td>
</tr>
<tr>
<td>EXTERNAL_AUDITOR</td>
<td>外部監査人（招待された監査セットの閲覧）</td>
</tr>
</tbody>
</table>
<h3 id="eventtype">イベントタイプ (EventType)<a class="headerlink" href="#eventtype" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>ITEM_UPLOAD</td>
<td>ファイルアップロード</td>
</tr>
<tr>
<td>ITEM_MOVE</td>
<td>ファイル移動</td>
</tr>
<tr>
<td>ITEM_COPY</td>
<td>ファイルコピー</td>
</tr>
<tr>
<td>ITEM_TRASH</td>
<td>ゴミ箱移動</td>
</tr>
<tr>
<td>ITEM_UNDELETE_VIA_TRASH</td>
<td>ゴミ箱から復元</td>
</tr>
<tr>
<td>ITEM_RENAME</td>
<td>名前変更</td>
</tr>
<tr>
<td>ITEM_MODIFY</td>
<td>内容変更</td>
</tr>
</tbody>
</table>
<h3 id="tamperingstatustype-">改ざん検証ステータス (TamperingStatusType) - 更新版<a class="headerlink" href="#tamperingstatustype-" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>値</th>
<th>意味</th>
</tr>
</thead>
<tbody>
<tr>
<td>NOT_MONITORED</td>
<td>監視対象外</td>
</tr>
<tr>
<td>MONITORED</td>
<td>監視中（登録済み）</td>
</tr>
<tr>
<td>NOT_TAMPERED</td>
<td>改ざんなし（検証済み）</td>
</tr>
<tr>
<td>TAMPERED</td>
<td>改ざん検出</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_7">コード由来の用語<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<h3 id="_8">サービス層の概念<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>用語</th>
<th>クラス</th>
<th>定義</th>
</tr>
</thead>
<tbody>
<tr>
<td>監査セットアイテム</td>
<td>AuditSetItem</td>
<td>監査セットに登録されたファイル/フォルダ</td>
</tr>
<tr>
<td>監査セットコラボレーター</td>
<td>AuditSetCollaborator</td>
<td>監査セットへのアクセス権を持つユーザー</td>
</tr>
<tr>
<td>監査ログ</td>
<td>AuditorLog</td>
<td>外部監査人のアクセス履歴</td>
</tr>
<tr>
<td>アイテムステータス</td>
<td>ItemStatus</td>
<td>ファイルの監視・検証状態</td>
</tr>
<tr>
<td>SHA1別アイテム</td>
<td>ItemsBySha1</td>
<td>同一ハッシュを持つファイルのグループ</td>
</tr>
</tbody>
</table>
<h3 id="_9">リポジトリ層の概念<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>テーブル</th>
<th>用語</th>
<th>役割</th>
</tr>
</thead>
<tbody>
<tr>
<td>audit_set</td>
<td>監査セット</td>
<td>監査対象のコンテナ</td>
</tr>
<tr>
<td>audit_group</td>
<td>監査グループ</td>
<td>ユーザーのグループ化</td>
</tr>
<tr>
<td>audit_grp_audit_set_mapping</td>
<td>グループ-セット関連</td>
<td>多対多関連テーブル</td>
</tr>
<tr>
<td>user_audit_group</td>
<td>ユーザー-グループ関連</td>
<td>グループメンバーシップ</td>
</tr>
<tr>
<td>position_tracker</td>
<td>位置トラッカー</td>
<td>イベント取得の継続位置</td>
</tr>
</tbody>
</table>
<h3 id="_10">外部連携の概念<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>用語</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>BOX API Connection</td>
<td>BOX APIへの接続管理</td>
</tr>
<tr>
<td>Enterprise ID</td>
<td>BOX Enterprise識別子</td>
</tr>
<tr>
<td>Service Account</td>
<td>BOX APIアクセス用サービスアカウント</td>
</tr>
<tr>
<td>Client Credentials</td>
<td>OAuth2クライアント認証情報</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="_11">ドメイン間の関係<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h2>
<div class="mermaid">
graph LR
    subgraph "ユーザードメイン"
        User[ユーザー]
        Role[ロール]
        Org[組織]
    end

    subgraph "監査ドメイン"
        AuditSet[監査セット]
        AuditGroup[監査グループ]
        AuditSetItem[監査セットアイテム]
    end

    subgraph "ファイルドメイン"
        Item[アイテム]
        ItemStatus[アイテムステータス]
        Asset[アセット]
    end

    subgraph "イベントドメイン"
        Event[イベント]
        AuditorLog[監査ログ]
    end

    User --> Role
    User --> Org
    User --> AuditSet
    User --> AuditGroup
    AuditSet --> AuditSetItem
    AuditSetItem --> Item
    Item --> ItemStatus
    Item --> Asset
    Item --> Event
    User --> AuditorLog
</div>

<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: scalar-event-log-fetcher-main</em></p>
</article>
<article id="analysis-actors-roles-permissions">
<h1 id="_1">アクター・ロール・権限マトリクス<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<h2 id="1">1. アクター一覧<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 内部アクター<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>アクター</th>
<th>説明</th>
<th>主な責務</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>監査管理者 (Audit Admin)</strong></td>
<td>システム全体の管理者</td>
<td>ユーザー管理、全監査セットへのアクセス</td>
</tr>
<tr>
<td><strong>一般ユーザー (General User)</strong></td>
<td>BOX組織内の通常ユーザー</td>
<td>監査セット作成・管理、イベントログ閲覧</td>
</tr>
<tr>
<td><strong>外部監査人 (External Auditor)</strong></td>
<td>組織外の監査担当者</td>
<td>招待された監査セットの閲覧・検証</td>
</tr>
</tbody>
</table>
<h3 id="12">1.2 外部システム<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>アクター</th>
<th>説明</th>
<th>連携内容</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>BOX Platform</strong></td>
<td>クラウドストレージサービス</td>
<td>ファイル情報、イベントログ、認証</td>
</tr>
<tr>
<td><strong>ScalarDB Cluster</strong></td>
<td>分散トランザクションDB</td>
<td>データ永続化、トランザクション管理</td>
</tr>
<tr>
<td><strong>ScalarDL</strong></td>
<td>台帳サービス</td>
<td>ファイル改ざん検出</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="2">2. システムロール<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21-userroles">2.1 ユーザーロール (UserRoles)<a class="headerlink" href="#21-userroles" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>ロール</th>
<th>コード値</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>監査管理者</td>
<td><code>AUDIT_ADMIN</code></td>
<td>システム全体の管理権限</td>
</tr>
<tr>
<td>一般ユーザー</td>
<td><code>GENERAL_USER</code></td>
<td>標準操作権限</td>
</tr>
<tr>
<td>外部監査人</td>
<td><code>EXTERNAL_AUDITOR</code></td>
<td>制限付き閲覧権限</td>
</tr>
</tbody>
</table>
<h3 id="22-collaboratoruserroles">2.2 コラボレーターロール (CollaboratorUserRoles)<a class="headerlink" href="#22-collaboratoruserroles" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>ロール</th>
<th>コード値</th>
<th>監査セット内での権限</th>
</tr>
</thead>
<tbody>
<tr>
<td>オーナー</td>
<td><code>OWNER</code></td>
<td>全権限（削除、オーナー変更含む）</td>
</tr>
<tr>
<td>共同オーナー</td>
<td><code>CO_OWNER</code></td>
<td>編集、メンバー管理</td>
</tr>
<tr>
<td>メンバー</td>
<td><code>MEMBER</code></td>
<td>閲覧、アイテム追加</td>
</tr>
<tr>
<td>レビュアー</td>
<td><code>REVIEWER</code></td>
<td>閲覧のみ</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3">3. 権限マトリクス<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 システム機能 × ユーザーロール<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>機能</th>
<th style="text-align: center;">Audit Admin</th>
<th style="text-align: center;">General User</th>
<th style="text-align: center;">External Auditor</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ユーザー管理</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>ユーザー作成</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>ユーザー削除</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>ロール変更</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>ユーザー一覧取得</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td><strong>監査セット</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>作成</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>削除</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅ (自分の)</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>一覧表示</td>
<td style="text-align: center;">✅ (全て)</td>
<td style="text-align: center;">✅ (関連のみ)</td>
<td style="text-align: center;">✅ (招待のみ)</td>
</tr>
<tr>
<td><strong>イベントログ</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>閲覧</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅ (限定)</td>
</tr>
<tr>
<td>フィルタリング</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
</tr>
<tr>
<td><strong>ファイル操作</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>詳細表示</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
</tr>
<tr>
<td>改ざん検証</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
</tr>
<tr>
<td><strong>監査グループ</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>作成</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>管理</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅ (自分の)</td>
<td style="text-align: center;">❌</td>
</tr>
</tbody>
</table>
<h3 id="32">3.2 監査セット機能 × コラボレーターロール<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>機能</th>
<th style="text-align: center;">Owner</th>
<th style="text-align: center;">Co-Owner</th>
<th style="text-align: center;">Member</th>
<th style="text-align: center;">Reviewer</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>基本操作</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>監査セット閲覧</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
</tr>
<tr>
<td>アイテム一覧</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
</tr>
<tr>
<td>アイテム詳細</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
</tr>
<tr>
<td>改ざん検証</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
</tr>
<tr>
<td><strong>編集操作</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>アイテム追加</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>アイテム削除</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>情報編集</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td><strong>管理操作</strong></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
<td style="text-align: center;"></td>
</tr>
<tr>
<td>コラボレーター追加</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>コラボレーター削除</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>オーナー変更</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">❌</td>
</tr>
<tr>
<td>監査セット削除</td>
<td style="text-align: center;">✅</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">❌</td>
<td style="text-align: center;">❌</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="4-api">4. API エンドポイント × 権限<a class="headerlink" href="#4-api" title="Permanent link">&para;</a></h2>
<h3 id="41-usercontroller">4.1 UserController<a class="headerlink" href="#41-usercontroller" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>エンドポイント</th>
<th>メソッド</th>
<th>必要ロール</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/api/user/create</code></td>
<td>POST</td>
<td>AUDIT_ADMIN</td>
</tr>
<tr>
<td><code>/api/user/delete/{userId}</code></td>
<td>DELETE</td>
<td>AUDIT_ADMIN</td>
</tr>
<tr>
<td><code>/api/user/update-role</code></td>
<td>PUT</td>
<td>AUDIT_ADMIN</td>
</tr>
<tr>
<td><code>/api/user/managed</code></td>
<td>GET</td>
<td>AUDIT_ADMIN</td>
</tr>
<tr>
<td><code>/api/user/external-auditors</code></td>
<td>GET</td>
<td>AUDIT_ADMIN, GENERAL_USER</td>
</tr>
<tr>
<td><code>/api/user/login</code></td>
<td>POST</td>
<td>認証不要</td>
</tr>
<tr>
<td><code>/api/user/token</code></td>
<td>POST</td>
<td>認証済み</td>
</tr>
</tbody>
</table>
<h3 id="42-auditsetcontroller">4.2 AuditSetController<a class="headerlink" href="#42-auditsetcontroller" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>エンドポイント</th>
<th>メソッド</th>
<th>必要権限</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/api/audit-set/create</code></td>
<td>POST</td>
<td>GENERAL_USER以上</td>
</tr>
<tr>
<td><code>/api/audit-set/delete/{id}</code></td>
<td>DELETE</td>
<td>OWNER</td>
</tr>
<tr>
<td><code>/api/audit-set/list</code></td>
<td>GET</td>
<td>認証済み（フィルタリング）</td>
</tr>
<tr>
<td><code>/api/audit-set/update</code></td>
<td>PUT</td>
<td>OWNER, CO_OWNER</td>
</tr>
<tr>
<td><code>/api/audit-set/verify/{id}</code></td>
<td>POST</td>
<td>任意のコラボレーター</td>
</tr>
</tbody>
</table>
<h3 id="43-auditsetitemcontroller">4.3 AuditSetItemController<a class="headerlink" href="#43-auditsetitemcontroller" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>エンドポイント</th>
<th>メソッド</th>
<th>必要権限</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/api/audit-set-item/add</code></td>
<td>POST</td>
<td>MEMBER以上</td>
</tr>
<tr>
<td><code>/api/audit-set-item/view/{auditSetId}</code></td>
<td>GET</td>
<td>任意のコラボレーター</td>
</tr>
<tr>
<td><code>/api/audit-set-item/get/{auditSetId}/{itemId}</code></td>
<td>GET</td>
<td>任意のコラボレーター</td>
</tr>
</tbody>
</table>
<h3 id="44-filecontroller">4.4 FileController<a class="headerlink" href="#44-filecontroller" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>エンドポイント</th>
<th>メソッド</th>
<th>必要権限</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/api/file/details/{fileId}</code></td>
<td>GET</td>
<td>認証済み</td>
</tr>
<tr>
<td><code>/api/file/versions/{fileId}</code></td>
<td>GET</td>
<td>認証済み</td>
</tr>
<tr>
<td><code>/api/file/copies/{sha1}</code></td>
<td>GET</td>
<td>認証済み</td>
</tr>
<tr>
<td><code>/api/file/tampering/{itemId}</code></td>
<td>GET</td>
<td>認証済み</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="5">5. ロール階層と継承<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<div class="mermaid">
graph TD
    subgraph "システムロール"
        AA[Audit Admin]
        GU[General User]
        EA[External Auditor]
    end

    subgraph "監査セットロール"
        OW[Owner]
        CO[Co-Owner]
        ME[Member]
        RE[Reviewer]
    end

    AA --> GU
    GU --> EA
    OW --> CO
    CO --> ME
    ME --> RE

    AA -.-> OW
    GU -.-> OW
    GU -.-> CO
    GU -.-> ME
    EA -.-> RE
</div>

<p><strong>説明:</strong>
- 矢印は権限の包含関係を示す
- 点線は割り当て可能な関係を示す</p>
<hr />
<h2 id="6">6. 認証・認可フロー<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 認証フロー<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant User
    participant Frontend
    participant Backend
    participant BoxAPI as BOX

    User->>Frontend: BOXログインクリック
    Frontend->>BoxAPI: OAuth認証リクエスト
    BoxAPI->>User: 認証画面表示
    User->>BoxAPI: 認証情報入力
    BoxAPI->>Frontend: Authorization Code
    Frontend->>Backend: トークン交換リクエスト
    Backend->>BoxAPI: Access Token取得
    BoxAPI->>Backend: Access Token + Refresh Token
    Backend->>Backend: ユーザー情報保存
    Backend->>Frontend: JWT発行
    Frontend->>User: ログイン完了
</div>

<h3 id="62">6.2 認可チェックフロー<a class="headerlink" href="#62" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant Client
    participant Controller
    participant Security
    participant Service

    Client->>Controller: API Request + JWT
    Controller->>Security: JWT検証
    Security->>Security: ロール確認
    alt 権限あり
        Security->>Controller: 認可OK
        Controller->>Service: ビジネスロジック実行
        Service->>Controller: 結果
        Controller->>Client: 200 OK
    else 権限なし
        Security->>Controller: 認可NG
        Controller->>Client: 403 Forbidden
    end
</div>

<hr />
<h2 id="7">7. 特殊なケース<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 監査グループによるアクセス<a class="headerlink" href="#71" title="Permanent link">&para;</a></h3>
<p>監査グループに所属するユーザーは、グループに割り当てられた監査セットへのアクセス権を自動的に取得します。</p>
<table>
<thead>
<tr>
<th>条件</th>
<th>アクセス権</th>
</tr>
</thead>
<tbody>
<tr>
<td>グループメンバー + グループが監査セットに割り当て</td>
<td>グループに付与された権限</td>
</tr>
<tr>
<td>グループ特権レベル</td>
<td>VIEWER, EDITOR, ADMIN</td>
</tr>
</tbody>
</table>
<h3 id="72">7.2 お気に入り機能<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<p>コラボレーターは監査セットをお気に入りとしてマークでき、一覧表示時のフィルタリングに使用されます。</p>
<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: scalar-event-log-fetcher-main</em></p>
</article>
<article id="analysis-domain-code-mapping">
<h1 id="-">ドメイン-コード対応表<a class="headerlink" href="#-" title="Permanent link">&para;</a></h1>
<h2 id="1">1. ドメイン概要<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 識別されたドメイン<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>ドメイン</th>
<th>説明</th>
<th>ビジネス価値</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>ユーザードメイン</strong></td>
<td>ユーザー認証・認可、組織管理</td>
<td>システムアクセス制御の基盤</td>
</tr>
<tr>
<td><strong>監査セットドメイン</strong></td>
<td>監査対象のグループ化と管理</td>
<td>コア機能 - 監査対象の整理</td>
</tr>
<tr>
<td><strong>監査グループドメイン</strong></td>
<td>監査人のグループ化</td>
<td>アクセス管理の効率化</td>
</tr>
<tr>
<td><strong>アイテムドメイン</strong></td>
<td>ファイル・フォルダの管理</td>
<td>BOX連携の中核</td>
</tr>
<tr>
<td><strong>イベントドメイン</strong></td>
<td>イベントログの収集・表示</td>
<td>監査証跡の提供</td>
</tr>
<tr>
<td><strong>改ざん検証ドメイン</strong></td>
<td>ScalarDLによる検証</td>
<td>データ完全性の保証</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="2">2. パッケージ構造<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 レイヤードアーキテクチャ<a class="headerlink" href="#21" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code>com.scalar.events_log_tool.application/
├── controller/     # プレゼンテーション層（REST API）
├── business/       # ユースケース層（ビジネスロジック）
├── service/        # アプリケーションサービス層
├── repository/     # データアクセス層
├── model/          # ドメインモデル
├── dto/            # データ転送オブジェクト
├── responsedto/    # レスポンス用DTO
├── constant/       # 定数・列挙型
├── config/         # 設定クラス
├── security/       # セキュリティ関連
├── exception/      # 例外クラス
└── utility/        # ユーティリティ
</code></pre>

<hr />
<h2 id="3">3. ドメイン別コード対応<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 ユーザードメイン<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<h4 id="_1">エンティティ<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>クラス</th>
<th>ファイル</th>
<th>フィールド数</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>User</code></td>
<td>model/User.java</td>
<td>14</td>
<td>ユーザーエンティティ</td>
</tr>
<tr>
<td><code>UserToken</code></td>
<td>model/UserToken.java</td>
<td>-</td>
<td>トークン管理</td>
</tr>
<tr>
<td><code>UserOtp</code></td>
<td>model/UserOtp.java</td>
<td>-</td>
<td>OTP管理</td>
</tr>
<tr>
<td><code>Organization</code></td>
<td>model/Organization.java</td>
<td>-</td>
<td>組織エンティティ</td>
</tr>
<tr>
<td><code>RoleUser</code></td>
<td>model/RoleUser.java</td>
<td>-</td>
<td>ロール関連</td>
</tr>
</tbody>
</table>
<h4 id="user">Userモデル詳細<a class="headerlink" href="#user" title="Permanent link">&para;</a></h4>
<pre class="codehilite"><code class="language-java">public class User {
    private String userEmail;      // メールアドレス（識別子）
    private Long id;               // BOX User ID
    private String name;           // 表示名
    private String password;       // パスワード（外部監査人用）
    private String roleJson;       // ロールJSON
    private String orgId;          // 組織ID
    private String organizationName;
    private String imageUrl;
    private Boolean isDeleted;
    private Boolean isBoxAdmin;    // BOX管理者フラグ
    private String refreshToken;   // BOXリフレッシュトークン
    private Long refreshTokenExpiry;
    private String languageCode;
}
</code></pre>

<h4 id="_2">コンポーネント対応<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>コンポーネント</th>
<th>クラス</th>
<th>主な責務</th>
</tr>
</thead>
<tbody>
<tr>
<td>Controller</td>
<td><code>UserController</code></td>
<td>REST API（9エンドポイント）</td>
</tr>
<tr>
<td>Business</td>
<td><code>UserBusiness</code></td>
<td>ユースケース実装</td>
</tr>
<tr>
<td>Service</td>
<td><code>UserService</code> (1116行)</td>
<td>認証、BOX連携、CRUD</td>
</tr>
<tr>
<td>Repository</td>
<td><code>UserRepository</code>, <code>UserTokenRepository</code>, <code>UserOptRepository</code>, <code>RoleUserRepository</code>, <code>OrganizationRepository</code></td>
<td>データアクセス</td>
</tr>
</tbody>
</table>
<h4 id="api">API エンドポイント<a class="headerlink" href="#api" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>メソッド</th>
<th>パス</th>
<th>機能</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td><code>/api/user/login</code></td>
<td>ログイン</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/user/token</code></td>
<td>トークン発行</td>
</tr>
<tr>
<td>POST</td>
<td><code>/api/user/create</code></td>
<td>ユーザー作成</td>
</tr>
<tr>
<td>DELETE</td>
<td><code>/api/user/delete/{userId}</code></td>
<td>ユーザー削除</td>
</tr>
<tr>
<td>PUT</td>
<td><code>/api/user/update-role</code></td>
<td>ロール更新</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/user/managed</code></td>
<td>管理対象ユーザー一覧</td>
</tr>
<tr>
<td>GET</td>
<td><code>/api/user/external-auditors</code></td>
<td>外部監査人一覧</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="32">3.2 監査セットドメイン<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<h4 id="_3">エンティティ<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>クラス</th>
<th>ファイル</th>
<th>フィールド数</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AuditSet</code></td>
<td>model/AuditSet.java</td>
<td>10</td>
<td>監査セットエンティティ</td>
</tr>
<tr>
<td><code>AuditSetItem</code></td>
<td>model/AuditSetItem.java</td>
<td>8</td>
<td>監査セットアイテム</td>
</tr>
<tr>
<td><code>AuditSetCollaborators</code></td>
<td>model/AuditSetCollaborators.java</td>
<td>-</td>
<td>コラボレーター管理</td>
</tr>
</tbody>
</table>
<h4 id="auditset">AuditSetモデル詳細<a class="headerlink" href="#auditset" title="Permanent link">&para;</a></h4>
<pre class="codehilite"><code class="language-java">public class AuditSet {
    private String auditSetId;     // UUID
    private String auditSetName;   // 監査セット名
    private String description;    // 説明
    private Long ownerId;          // オーナーのBOX ID
    private String ownerName;      // オーナー名
    private String ownerEmail;     // オーナーメール
    private String aclJson;        // ACL設定（JSON）
    private Boolean isDeleted;     // 削除フラグ
    private Long createdAt;        // 作成日時
    private String auditGroupListJson; // 関連グループリスト
}
</code></pre>

<h4 id="auditsetitem">AuditSetItemモデル詳細<a class="headerlink" href="#auditsetitem" title="Permanent link">&para;</a></h4>
<pre class="codehilite"><code class="language-java">public class AuditSetItem {
    private String auditSetId;     // 監査セットID
    private Long itemId;           // BOXアイテムID
    private String itemName;       // アイテム名
    private String itemType;       // file/folder
    private String accessList;     // アクセスリスト
    private String listJson;       // 詳細情報JSON
    private Long createdAt;        // 追加日時
    private Long assignedByUserId; // 追加者ID
}
</code></pre>

<h4 id="_4">コンポーネント対応<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>コンポーネント</th>
<th>クラス</th>
<th>主な責務</th>
</tr>
</thead>
<tbody>
<tr>
<td>Controller</td>
<td><code>AuditSetController</code>, <code>AuditSetItemController</code>, <code>AuditSetCollaboratorController</code></td>
<td>REST API</td>
</tr>
<tr>
<td>Business</td>
<td><code>AuditSetBusiness</code>, <code>AuditSetItemBusiness</code>, <code>AuditSetCollaboratorBusiness</code></td>
<td>ユースケース</td>
</tr>
<tr>
<td>Service</td>
<td><code>AuditSetService</code> (845行), <code>AuditSetItemService</code> (899行), <code>AuditSetCollaboratorService</code></td>
<td>ビジネスロジック</td>
</tr>
<tr>
<td>Repository</td>
<td><code>AuditSetRepository</code>, <code>AuditSetItemRepository</code>, <code>AuditSetCollaboratorsRepository</code></td>
<td>データアクセス</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="33">3.3 監査グループドメイン<a class="headerlink" href="#33" title="Permanent link">&para;</a></h3>
<h4 id="_5">エンティティ<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>クラス</th>
<th>ファイル</th>
<th>フィールド数</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>AuditGroup</code></td>
<td>model/AuditGroup.java</td>
<td>10</td>
<td>監査グループ</td>
</tr>
<tr>
<td><code>UserAuditGroup</code></td>
<td>model/UserAuditGroup.java</td>
<td>-</td>
<td>ユーザー-グループ関連</td>
</tr>
<tr>
<td><code>AuditGrpAuditSetMapping</code></td>
<td>model/AuditGrpAuditSetMapping.java</td>
<td>-</td>
<td>グループ-セット関連</td>
</tr>
</tbody>
</table>
<h4 id="auditgroup">AuditGroupモデル詳細<a class="headerlink" href="#auditgroup" title="Permanent link">&para;</a></h4>
<pre class="codehilite"><code class="language-java">public class AuditGroup {
    private String userEmail;      // 作成者メール
    private String auditGroupId;   // UUID
    private String auditGroupName; // グループ名
    private String description;    // 説明
    private Long ownerId;          // オーナーID
    private String ownerName;      // オーナー名
    private String memberListJson; // メンバーリストJSON
    private Long createdAt;        // 作成日時
    private Boolean isDeleted;     // 削除フラグ
}
</code></pre>

<h4 id="_6">コンポーネント対応<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>コンポーネント</th>
<th>クラス</th>
<th>主な責務</th>
</tr>
</thead>
<tbody>
<tr>
<td>Controller</td>
<td><code>AuditGroupController</code></td>
<td>REST API</td>
</tr>
<tr>
<td>Business</td>
<td><code>AuditGroupBusiness</code></td>
<td>ユースケース</td>
</tr>
<tr>
<td>Service</td>
<td><code>AuditGroupService</code></td>
<td>グループ管理</td>
</tr>
<tr>
<td>Repository</td>
<td><code>AuditGroupRepository</code>, <code>UserAuditGroupRepository</code>, <code>AuditGrpAuditSetMappingRepository</code></td>
<td>データアクセス</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="34">3.4 アイテムドメイン<a class="headerlink" href="#34" title="Permanent link">&para;</a></h3>
<h4 id="_7">エンティティ<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>クラス</th>
<th>ファイル</th>
<th>フィールド数</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Item</code></td>
<td>model/Item.java</td>
<td>10</td>
<td>ファイル/フォルダ基本情報</td>
</tr>
<tr>
<td><code>ItemStatus</code></td>
<td>model/ItemStatus.java</td>
<td>-</td>
<td>監視・検証ステータス</td>
</tr>
<tr>
<td><code>ItemEvents</code></td>
<td>model/ItemEvents.java</td>
<td>-</td>
<td>アイテム関連イベント</td>
</tr>
<tr>
<td><code>ItemsBySha1</code></td>
<td>model/ItemsBySha1.java</td>
<td>-</td>
<td>SHA1ハッシュ別アイテム</td>
</tr>
</tbody>
</table>
<h4 id="item">Itemモデル詳細<a class="headerlink" href="#item" title="Permanent link">&para;</a></h4>
<pre class="codehilite"><code class="language-java">public class Item {
    private String itemId;         // BOXアイテムID
    private String itemType;       // file/folder
    private String itemHash;       // SHA1ハッシュ
    private Boolean isDeleted;     // 削除フラグ
    private Long size;             // ファイルサイズ
    private String auditedBy;      // 監査者
    private Long auditedAt;        // 監査日時
    private Integer auditStatus;   // 監査ステータス
    private String storageProvider; // ストレージプロバイダ
}
</code></pre>

<h4 id="_8">コンポーネント対応<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>コンポーネント</th>
<th>クラス</th>
<th>主な責務</th>
</tr>
</thead>
<tbody>
<tr>
<td>Controller</td>
<td><code>FileController</code>, <code>FolderController</code>, <code>ItemController</code></td>
<td>REST API</td>
</tr>
<tr>
<td>Business</td>
<td><code>FileBusiness</code>, <code>FolderBusiness</code></td>
<td>ユースケース</td>
</tr>
<tr>
<td>Service</td>
<td><code>FileService</code>, <code>FolderService</code>, <code>CommonService</code>, <code>AssetService</code></td>
<td>BOX連携、詳細取得</td>
</tr>
<tr>
<td>Repository</td>
<td><code>ItemRepository</code>, <code>ItemStatusRepository</code>, <code>ItemEventsRepository</code>, <code>ItemsBySha1Repository</code></td>
<td>データアクセス</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="35">3.5 イベントドメイン<a class="headerlink" href="#35" title="Permanent link">&para;</a></h3>
<h4 id="_9">エンティティ<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>クラス</th>
<th>ファイル</th>
<th>フィールド数</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>Events</code></td>
<td>model/Events.java</td>
<td>17</td>
<td>イベントログ</td>
</tr>
<tr>
<td><code>EnterpriseEventLogs</code></td>
<td>model/EnterpriseEventLogs.java</td>
<td>-</td>
<td>エンタープライズイベント</td>
</tr>
<tr>
<td><code>PositionTracker</code></td>
<td>model/PositionTracker.java</td>
<td>-</td>
<td>取得位置トラッカー</td>
</tr>
<tr>
<td><code>AuditorLogs</code></td>
<td>model/AuditorLogs.java</td>
<td>-</td>
<td>監査人アクセスログ</td>
</tr>
<tr>
<td><code>SystemEventDates</code></td>
<td>model/SystemEventDates.java</td>
<td>-</td>
<td>システムイベント日付</td>
</tr>
</tbody>
</table>
<h4 id="events">Eventsモデル詳細<a class="headerlink" href="#events" title="Permanent link">&para;</a></h4>
<pre class="codehilite"><code class="language-java">public class Events {
    private String yyyyMMdd;       // 日付パーティション
    private String eventId;        // イベントID
    private String timestamp;      // タイムスタンプ
    private Long userId;           // ユーザーID
    private String userName;       // ユーザー名
    private String userEmail;      // ユーザーメール
    private String assetId;        // アセットID
    private Integer assetAge;      // アセットエイジ
    private Long itemId;           // アイテムID
    private Long itemVersionId;    // バージョンID
    private String sha1Hash;       // SHA1ハッシュ
    private String eventType;      // イベントタイプ
    private Long createdAt;        // 作成日時
    private String eventOccuredOn; // 発生日
    private Long parentFolderId;   // 親フォルダID
    private String sourceJson;     // ソースJSON
}
</code></pre>

<h4 id="_10">コンポーネント対応<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>コンポーネント</th>
<th>クラス</th>
<th>主な責務</th>
</tr>
</thead>
<tbody>
<tr>
<td>Controller</td>
<td><code>EventLogController</code></td>
<td>REST API</td>
</tr>
<tr>
<td>Business</td>
<td><code>EventLogBusiness</code></td>
<td>ユースケース</td>
</tr>
<tr>
<td>Service</td>
<td><code>EventLogService</code></td>
<td>イベント取得・フィルタリング</td>
</tr>
<tr>
<td>Repository</td>
<td><code>EventsRepository</code>, <code>EnterpriseEventLogsRepository</code>, <code>PositionTrackerRepository</code>, <code>AuditorLogsRepository</code>, <code>SystemEventDatesRepository</code></td>
<td>データアクセス</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="36">3.6 改ざん検証ドメイン<a class="headerlink" href="#36" title="Permanent link">&para;</a></h3>
<h4 id="_11">コンポーネント対応<a class="headerlink" href="#_11" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>コンポーネント</th>
<th>クラス</th>
<th>主な責務</th>
</tr>
</thead>
<tbody>
<tr>
<td>Service</td>
<td><code>AssetService</code></td>
<td>ScalarDL連携</td>
</tr>
<tr>
<td>Repository</td>
<td><code>ScalardlRepository</code></td>
<td>ScalarDL操作</td>
</tr>
</tbody>
</table>
<h4 id="_12">外部連携<a class="headerlink" href="#_12" title="Permanent link">&para;</a></h4>
<ul>
<li><strong>ScalarDL Auditor</strong>: 改ざん検証</li>
<li><strong>ScalarDL Ledger</strong>: 台帳管理</li>
</ul>
<hr />
<h2 id="4">4. 外部システム連携<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="41-box-platform">4.1 BOX Platform連携<a class="headerlink" href="#41-box-platform" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>コンポーネント</th>
<th>役割</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>BoxUtility</code></td>
<td>API接続管理、SDK初期化</td>
</tr>
<tr>
<td><code>FileService</code></td>
<td>ファイル詳細・バージョン取得</td>
</tr>
<tr>
<td><code>FolderService</code></td>
<td>フォルダ詳細・アイテム一覧</td>
</tr>
<tr>
<td><code>EventLogService</code></td>
<td>エンタープライズイベント取得</td>
</tr>
<tr>
<td><code>UserService</code></td>
<td>OAuth認証、ユーザー情報取得</td>
</tr>
</tbody>
</table>
<h3 id="42-scalardb-cluster">4.2 ScalarDB Cluster連携<a class="headerlink" href="#42-scalardb-cluster" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>テーブル</th>
<th>対応リポジトリ</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>user</code></td>
<td><code>UserRepository</code></td>
</tr>
<tr>
<td><code>user_token</code></td>
<td><code>UserTokenRepository</code></td>
</tr>
<tr>
<td><code>user_otp</code></td>
<td><code>UserOptRepository</code></td>
</tr>
<tr>
<td><code>organization</code></td>
<td><code>OrganizationRepository</code></td>
</tr>
<tr>
<td><code>audit_set</code></td>
<td><code>AuditSetRepository</code></td>
</tr>
<tr>
<td><code>audit_set_item</code></td>
<td><code>AuditSetItemRepository</code></td>
</tr>
<tr>
<td><code>audit_set_collaborators</code></td>
<td><code>AuditSetCollaboratorsRepository</code></td>
</tr>
<tr>
<td><code>audit_group</code></td>
<td><code>AuditGroupRepository</code></td>
</tr>
<tr>
<td><code>user_audit_group</code></td>
<td><code>UserAuditGroupRepository</code></td>
</tr>
<tr>
<td><code>audit_grp_audit_set_mapping</code></td>
<td><code>AuditGrpAuditSetMappingRepository</code></td>
</tr>
<tr>
<td><code>item</code></td>
<td><code>ItemRepository</code></td>
</tr>
<tr>
<td><code>item_status</code></td>
<td><code>ItemStatusRepository</code></td>
</tr>
<tr>
<td><code>item_events</code></td>
<td><code>ItemEventsRepository</code></td>
</tr>
<tr>
<td><code>items_by_sha1</code></td>
<td><code>ItemsBySha1Repository</code></td>
</tr>
<tr>
<td><code>events</code></td>
<td><code>EventsRepository</code></td>
</tr>
<tr>
<td><code>enterprise_event_logs</code></td>
<td><code>EnterpriseEventLogsRepository</code></td>
</tr>
<tr>
<td><code>position_tracker</code></td>
<td><code>PositionTrackerRepository</code></td>
</tr>
<tr>
<td><code>auditor_logs</code></td>
<td><code>AuditorLogsRepository</code></td>
</tr>
<tr>
<td><code>system_event_dates</code></td>
<td><code>SystemEventDatesRepository</code></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="5">5. ドメイン間の依存関係<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<div class="mermaid">
graph TD
    subgraph "ユーザードメイン"
        U[User]
        UT[UserToken]
        UO[UserOtp]
        ORG[Organization]
    end

    subgraph "監査セットドメイン"
        AS[AuditSet]
        ASI[AuditSetItem]
        ASC[AuditSetCollaborators]
    end

    subgraph "監査グループドメイン"
        AG[AuditGroup]
        UAG[UserAuditGroup]
        AGRAM[AuditGrpAuditSetMapping]
    end

    subgraph "アイテムドメイン"
        I[Item]
        IS[ItemStatus]
        IE[ItemEvents]
        ISHA[ItemsBySha1]
    end

    subgraph "イベントドメイン"
        E[Events]
        EEL[EnterpriseEventLogs]
        PT[PositionTracker]
        AL[AuditorLogs]
    end

    U --> ORG
    U --> UT
    U --> UO
    AS --> U
    ASI --> AS
    ASI --> I
    ASC --> AS
    ASC --> U
    AG --> U
    UAG --> U
    UAG --> AG
    AGRAM --> AG
    AGRAM --> AS
    I --> IS
    I --> IE
    I --> ISHA
    E --> U
    E --> I
    AL --> U
</div>

<hr />
<h2 id="6">6. コード行数サマリー<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 サービス層<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>サービス</th>
<th>行数</th>
<th>ドメイン</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>UserService</code></td>
<td>1116</td>
<td>ユーザー</td>
</tr>
<tr>
<td><code>AuditSetItemService</code></td>
<td>899</td>
<td>監査セット</td>
</tr>
<tr>
<td><code>AuditSetService</code></td>
<td>845</td>
<td>監査セット</td>
</tr>
<tr>
<td><code>FileService</code></td>
<td>500+</td>
<td>アイテム</td>
</tr>
<tr>
<td><code>EventLogService</code></td>
<td>400+</td>
<td>イベント</td>
</tr>
<tr>
<td><code>AuditGroupService</code></td>
<td>300+</td>
<td>監査グループ</td>
</tr>
<tr>
<td><code>FolderService</code></td>
<td>300+</td>
<td>アイテム</td>
</tr>
<tr>
<td><code>AuditSetCollaboratorService</code></td>
<td>200+</td>
<td>監査セット</td>
</tr>
<tr>
<td><code>CommonService</code></td>
<td>150+</td>
<td>共通</td>
</tr>
<tr>
<td><code>AssetService</code></td>
<td>100+</td>
<td>改ざん検証</td>
</tr>
</tbody>
</table>
<h3 id="62">6.2 コントローラ層<a class="headerlink" href="#62" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>コントローラ</th>
<th>エンドポイント数</th>
<th>ドメイン</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>UserController</code></td>
<td>9</td>
<td>ユーザー</td>
</tr>
<tr>
<td><code>AuditSetController</code></td>
<td>6</td>
<td>監査セット</td>
</tr>
<tr>
<td><code>AuditSetItemController</code></td>
<td>5</td>
<td>監査セット</td>
</tr>
<tr>
<td><code>EventLogController</code></td>
<td>4</td>
<td>イベント</td>
</tr>
<tr>
<td><code>FileController</code></td>
<td>4</td>
<td>アイテム</td>
</tr>
<tr>
<td><code>AuditGroupController</code></td>
<td>4</td>
<td>監査グループ</td>
</tr>
<tr>
<td><code>FolderController</code></td>
<td>3</td>
<td>アイテム</td>
</tr>
<tr>
<td><code>AuditSetCollaboratorController</code></td>
<td>3</td>
<td>監査セット</td>
</tr>
<tr>
<td><code>ItemController</code></td>
<td>2</td>
<td>アイテム</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7">7. 技術的負債と改善機会<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 識別された課題<a class="headerlink" href="#71" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>課題</th>
<th>ドメイン</th>
<th>影響</th>
<th>優先度</th>
</tr>
</thead>
<tbody>
<tr>
<td>UserService肥大化</td>
<td>ユーザー</td>
<td>保守性低下</td>
<td>高</td>
</tr>
<tr>
<td>JSON文字列でのデータ保存</td>
<td>全般</td>
<td>クエリ性能低下</td>
<td>中</td>
</tr>
<tr>
<td>BOX API依存の分離不足</td>
<td>アイテム</td>
<td>テスタビリティ低下</td>
<td>中</td>
</tr>
<tr>
<td>ドメインモデル貧血症</td>
<td>全般</td>
<td>ビジネスロジック分散</td>
<td>中</td>
</tr>
</tbody>
</table>
<h3 id="72">7.2 リファクタリング候補<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>UserServiceの分割</strong></li>
<li><code>AuthenticationService</code> - 認証処理</li>
<li><code>BoxUserService</code> - BOX連携</li>
<li>
<p><code>UserManagementService</code> - ユーザー管理</p>
</li>
<li>
<p><strong>JSONフィールドの正規化</strong></p>
</li>
<li><code>aclJson</code> → 別テーブル化</li>
<li><code>memberListJson</code> → 関連テーブル化</li>
<li>
<p><code>roleJson</code> → Enum化</p>
</li>
<li>
<p><strong>BOX API連携の抽象化</strong></p>
</li>
<li><code>BoxApiClient</code>インターフェース導入</li>
<li>モック可能な設計へ</li>
</ol>
<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: scalar-event-log-fetcher-main</em></p>
</article>
</section>
<section id="evaluation">
<h1>MMI評価</h1>
<article id="evaluation-mmi-overview">
<h1 id="mmi-modularity-maturity-index-overview">MMI評価概要 (Modularity Maturity Index Overview)<a class="headerlink" href="#mmi-modularity-maturity-index-overview" title="Permanent link">&para;</a></h1>
<h2 id="1">1. エグゼクティブサマリー<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 総合評価<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>指標</th>
<th>値</th>
<th>評価</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>総合MMIスコア</strong></td>
<td><strong>48.6</strong></td>
<td>低中成熟</td>
</tr>
<tr>
<td>成熟度レベル</td>
<td>Level 2</td>
<td>大幅なリファクタリングが必要</td>
</tr>
<tr>
<td>マイクロサービス化準備度</td>
<td>中</td>
<td>段階的な分離が推奨</td>
</tr>
</tbody>
</table>
<h3 id="12">1.2 軸別サマリー<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>評価軸</th>
<th>重み</th>
<th>平均スコア (0-5)</th>
<th>加重スコア</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cohesion（凝集度）</td>
<td>30%</td>
<td>2.2</td>
<td>13.2</td>
</tr>
<tr>
<td>Coupling（結合度）</td>
<td>30%</td>
<td>2.0</td>
<td>12.0</td>
</tr>
<tr>
<td>Independence（独立性）</td>
<td>20%</td>
<td>2.5</td>
<td>10.0</td>
</tr>
<tr>
<td>Reusability（再利用性）</td>
<td>20%</td>
<td>2.7</td>
<td>10.8</td>
</tr>
<tr>
<td><strong>合計</strong></td>
<td>100%</td>
<td>-</td>
<td><strong>46.0/100</strong></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="2">2. スコア分布<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21-mmi">2.1 モジュール別MMIスコア分布<a class="headerlink" href="#21-mmi" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code>高成熟 (80-100): ████ 0個 (0%)
中成熟 (60-80):  ████████ 2個 (20%)
低中成熟 (40-60): ████████████████ 5個 (50%)
未成熟 (0-40):   ████████████ 3個 (30%)
</code></pre>

<h3 id="22">2.2 ヒストグラム<a class="headerlink" href="#22" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code>100 |
 90 |
 80 |
 70 | ▓▓
 60 | ▓▓ ▓▓
 50 | ▓▓ ▓▓ ▓▓ ▓▓
 40 | ▓▓ ▓▓ ▓▓ ▓▓ ▓▓ ▓▓
 30 | ▓▓ ▓▓ ▓▓ ▓▓ ▓▓ ▓▓ ▓▓
 20 | ▓▓ ▓▓ ▓▓ ▓▓ ▓▓ ▓▓ ▓▓ ▓▓ ▓▓
 10 | ▓▓ ▓▓ ▓▓ ▓▓ ▓▓ ▓▓ ▓▓ ▓▓ ▓▓ ▓▓
  0 +------------------------------------
     US  ASI ASS FS  AGS ASC ELS AstS FoS CS

    US=UserService, ASI=AuditSetItemService, ASS=AuditSetService
    FS=FileService, AGS=AuditGroupService, ASC=AuditSetCollaboratorService
    ELS=EventLogService, AstS=AssetService, FoS=FolderService, CS=CommonService
</code></pre>

<hr />
<h2 id="3">3. 軸別詳細分析<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31-cohesion">3.1 Cohesion（凝集度）分析<a class="headerlink" href="#31-cohesion" title="Permanent link">&para;</a></h3>
<p><strong>平均スコア: 2.2 / 5.0</strong></p>
<table>
<thead>
<tr>
<th>カテゴリ</th>
<th>該当モジュール数</th>
<th>課題</th>
</tr>
</thead>
<tbody>
<tr>
<td>高凝集 (4-5)</td>
<td>2</td>
<td>-</td>
</tr>
<tr>
<td>中凝集 (2-3)</td>
<td>5</td>
<td>複数責務の混在</td>
</tr>
<tr>
<td>低凝集 (0-1)</td>
<td>3</td>
<td>責務の肥大化</td>
</tr>
</tbody>
</table>
<p><strong>主な問題点:</strong>
- <code>UserService</code> (1116行): 認証、BOX連携、ユーザー管理、メール送信など多数の責務が集中
- <code>AuditSetItemService</code> (899行): アイテム管理、検証、監視ステータス管理が混在
- <code>AuditSetService</code> (845行): CRUD、コラボレーター管理、グループ管理が一体化</p>
<h3 id="32-coupling">3.2 Coupling（結合度）分析<a class="headerlink" href="#32-coupling" title="Permanent link">&para;</a></h3>
<p><strong>平均スコア: 2.0 / 5.0</strong></p>
<table>
<thead>
<tr>
<th>結合パターン</th>
<th>発生数</th>
<th>影響</th>
</tr>
</thead>
<tbody>
<tr>
<td>循環依存</td>
<td>2</td>
<td>高</td>
</tr>
<tr>
<td>多重依存（5+）</td>
<td>4</td>
<td>中</td>
</tr>
<tr>
<td>共有状態</td>
<td>3</td>
<td>中</td>
</tr>
</tbody>
</table>
<p><strong>依存関係の問題:</strong>
- <code>UserService</code> → 10+ リポジトリへの依存
- <code>AuditSetItemService</code> ↔ <code>AuditSetService</code> の相互参照
- <code>FileService</code> → <code>UserService</code> への直接依存
- 全サービスが <code>ObjectMapper</code> を直接利用</p>
<h3 id="33-independence">3.3 Independence（独立性）分析<a class="headerlink" href="#33-independence" title="Permanent link">&para;</a></h3>
<p><strong>平均スコア: 2.5 / 5.0</strong></p>
<table>
<thead>
<tr>
<th>依存タイプ</th>
<th>該当モジュール</th>
<th>独立デプロイ可否</th>
</tr>
</thead>
<tbody>
<tr>
<td>DB共有</td>
<td>全モジュール</td>
<td>不可</td>
</tr>
<tr>
<td>外部API共有</td>
<td>7モジュール</td>
<td>条件付き可</td>
</tr>
<tr>
<td>設定共有</td>
<td>全モジュール</td>
<td>不可</td>
</tr>
</tbody>
</table>
<p><strong>独立性の障壁:</strong>
- 単一のScalarDB Clusterへの依存
- BOX API接続の共有（<code>BoxUtility</code>経由）
- 共通の認証・セキュリティ設定</p>
<h3 id="34-reusability">3.4 Reusability（再利用性）分析<a class="headerlink" href="#34-reusability" title="Permanent link">&para;</a></h3>
<p><strong>平均スコア: 2.7 / 5.0</strong></p>
<table>
<thead>
<tr>
<th>再利用レベル</th>
<th>該当数</th>
<th>例</th>
</tr>
</thead>
<tbody>
<tr>
<td>高再利用性</td>
<td>2</td>
<td><code>CommonService</code>, <code>EventLogService</code></td>
</tr>
<tr>
<td>中再利用性</td>
<td>4</td>
<td><code>AssetService</code>, <code>FileService</code></td>
</tr>
<tr>
<td>低再利用性</td>
<td>4</td>
<td><code>UserService</code>, <code>AuditSetService</code></td>
</tr>
</tbody>
</table>
<p><strong>再利用性の制約:</strong>
- BOX Platform固有のロジックが多数埋め込み
- ハードコードされた定数（エンタープライズID等）
- ドメイン固有のビジネスルールの混在</p>
<hr />
<h2 id="4">4. 主要課題<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="41-critical">4.1 最優先課題（Critical）<a class="headerlink" href="#41-critical" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>#</th>
<th>課題</th>
<th>影響度</th>
<th>対象モジュール</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>UserServiceの肥大化</td>
<td>高</td>
<td>UserService</td>
</tr>
<tr>
<td>2</td>
<td>サービス間の循環依存</td>
<td>高</td>
<td>AuditSetItemService, AuditSetService</td>
</tr>
<tr>
<td>3</td>
<td>多重リポジトリ依存</td>
<td>中</td>
<td>UserService, AuditSetService</td>
</tr>
</tbody>
</table>
<h3 id="42-high">4.2 重要課題（High）<a class="headerlink" href="#42-high" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>#</th>
<th>課題</th>
<th>影響度</th>
<th>対象モジュール</th>
</tr>
</thead>
<tbody>
<tr>
<td>4</td>
<td>BOX API連携の分散</td>
<td>中</td>
<td>FileService, FolderService, UserService</td>
</tr>
<tr>
<td>5</td>
<td>トランザクション管理の複雑さ</td>
<td>中</td>
<td>複数サービス</td>
</tr>
<tr>
<td>6</td>
<td>ドメインモデル貧血症</td>
<td>中</td>
<td>全モデルクラス</td>
</tr>
</tbody>
</table>
<h3 id="43-medium">4.3 改善課題（Medium）<a class="headerlink" href="#43-medium" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>#</th>
<th>課題</th>
<th>影響度</th>
<th>対象モジュール</th>
</tr>
</thead>
<tbody>
<tr>
<td>7</td>
<td>JSON文字列での関連データ保存</td>
<td>低</td>
<td>AuditSet, AuditGroup, User</td>
</tr>
<tr>
<td>8</td>
<td>エラーハンドリングの不統一</td>
<td>低</td>
<td>全サービス</td>
</tr>
<tr>
<td>9</td>
<td>ログ出力の非標準化</td>
<td>低</td>
<td>全サービス</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="5">5. 推奨アクション<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<h3 id="51-quick-wins">5.1 即時改善（Quick Wins）<a class="headerlink" href="#51-quick-wins" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>UserServiceの責務分離</strong></li>
<li><code>AuthenticationService</code> - 認証処理</li>
<li><code>BoxUserService</code> - BOX API連携</li>
<li>
<p><code>UserManagementService</code> - ユーザーCRUD</p>
</li>
<li>
<p><strong>循環依存の解消</strong></p>
</li>
<li>インターフェース導入による依存逆転</li>
<li>イベント駆動への変更</li>
</ol>
<h3 id="52-1-3">5.2 短期改善（1-3ヶ月）<a class="headerlink" href="#52-1-3" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>BOX連携層の抽象化</strong></li>
<li><code>BoxApiClient</code>インターフェース導入</li>
<li>
<p>モック可能な設計へ</p>
</li>
<li>
<p><strong>リポジトリ層の整理</strong></p>
</li>
<li>Aggregate Rootパターンの適用</li>
<li>不要なリポジトリ依存の削減</li>
</ol>
<h3 id="53-3-6">5.3 中期改善（3-6ヶ月）<a class="headerlink" href="#53-3-6" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>ドメイン駆動設計の適用</strong></li>
<li>値オブジェクトの導入</li>
<li>
<p>エンティティへのビジネスロジック移行</p>
</li>
<li>
<p><strong>データベース分離準備</strong></p>
</li>
<li>スキーマの論理分割</li>
<li>トランザクション境界の明確化</li>
</ol>
<hr />
<h2 id="6-mmi">6. MMI改善目標<a class="headerlink" href="#6-mmi" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 フェーズ別目標<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>フェーズ</th>
<th>期間</th>
<th>目標MMI</th>
<th>主な施策</th>
</tr>
</thead>
<tbody>
<tr>
<td>Phase 1</td>
<td>0-3ヶ月</td>
<td>55</td>
<td>UserService分割、循環依存解消</td>
</tr>
<tr>
<td>Phase 2</td>
<td>3-6ヶ月</td>
<td>65</td>
<td>BOX連携抽象化、リポジトリ整理</td>
</tr>
<tr>
<td>Phase 3</td>
<td>6-12ヶ月</td>
<td>75</td>
<td>DDD適用、データ分離準備</td>
</tr>
<tr>
<td>Phase 4</td>
<td>12ヶ月以降</td>
<td>80+</td>
<td>マイクロサービス化実行</td>
</tr>
</tbody>
</table>
<h3 id="62">6.2 軸別改善目標<a class="headerlink" href="#62" title="Permanent link">&para;</a></h3>
<div class="mermaid">
xychart-beta
    title "MMI軸別改善目標"
    x-axis ["Cohesion", "Coupling", "Independence", "Reusability"]
    y-axis "スコア" 0 --> 5
    bar [2.2, 2.0, 2.5, 2.7]
    line [3.5, 3.0, 3.5, 3.5]
    line [4.0, 4.0, 4.0, 4.0]
</div>

<table>
<thead>
<tr>
<th>軸</th>
<th>現状</th>
<th>Phase 2目標</th>
<th>最終目標</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cohesion</td>
<td>2.2</td>
<td>3.5</td>
<td>4.0</td>
</tr>
<tr>
<td>Coupling</td>
<td>2.0</td>
<td>3.0</td>
<td>4.0</td>
</tr>
<tr>
<td>Independence</td>
<td>2.5</td>
<td>3.5</td>
<td>4.0</td>
</tr>
<tr>
<td>Reusability</td>
<td>2.7</td>
<td>3.5</td>
<td>4.0</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7">7. リスク評価<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 リファクタリングリスク<a class="headerlink" href="#71" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>リスク</th>
<th>確率</th>
<th>影響</th>
<th>緩和策</th>
</tr>
</thead>
<tbody>
<tr>
<td>機能退行</td>
<td>高</td>
<td>高</td>
<td>テストカバレッジ向上</td>
</tr>
<tr>
<td>スケジュール遅延</td>
<td>中</td>
<td>中</td>
<td>段階的リリース</td>
</tr>
<tr>
<td>チーム習熟度</td>
<td>中</td>
<td>低</td>
<td>トレーニング実施</td>
</tr>
</tbody>
</table>
<h3 id="72">7.2 技術的負債の定量化<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>カテゴリ</th>
<th>推定工数</th>
<th>優先度</th>
</tr>
</thead>
<tbody>
<tr>
<td>コード重複</td>
<td>40h</td>
<td>高</td>
</tr>
<tr>
<td>設計負債</td>
<td>120h</td>
<td>高</td>
</tr>
<tr>
<td>テスト負債</td>
<td>80h</td>
<td>中</td>
</tr>
<tr>
<td>ドキュメント負債</td>
<td>20h</td>
<td>低</td>
</tr>
<tr>
<td><strong>合計</strong></td>
<td><strong>260h</strong></td>
<td>-</td>
</tr>
</tbody>
</table>
<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: scalar-event-log-fetcher-main</em>
<em>Methodology: Modularity Maturity Index (MMI) v1.0</em></p>
</article>
<article id="evaluation-mmi-by-module">
<h1 id="mmi-mmi-by-module">モジュール別MMI評価 (MMI by Module)<a class="headerlink" href="#mmi-mmi-by-module" title="Permanent link">&para;</a></h1>
<h2 id="1">1. スコアサマリー<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 全モジュール一覧<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>モジュール</th>
<th>行数</th>
<th>メソッド数</th>
<th style="text-align: center;">Cohesion</th>
<th style="text-align: center;">Coupling</th>
<th style="text-align: center;">Independence</th>
<th style="text-align: center;">Reusability</th>
<th style="text-align: center;"><strong>MMI</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>UserService</td>
<td>1116</td>
<td>29</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">1</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;"><strong>28</strong></td>
</tr>
<tr>
<td>AuditSetItemService</td>
<td>899</td>
<td>11</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;"><strong>40</strong></td>
</tr>
<tr>
<td>AuditSetService</td>
<td>845</td>
<td>14</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;"><strong>40</strong></td>
</tr>
<tr>
<td>FileService</td>
<td>555</td>
<td>11</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;"><strong>48</strong></td>
</tr>
<tr>
<td>AuditGroupService</td>
<td>439</td>
<td>8</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;"><strong>54</strong></td>
</tr>
<tr>
<td>AuditSetCollaboratorService</td>
<td>288</td>
<td>7</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;"><strong>60</strong></td>
</tr>
<tr>
<td>EventLogService</td>
<td>222</td>
<td>6</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;"><strong>68</strong></td>
</tr>
<tr>
<td>AssetService</td>
<td>199</td>
<td>5</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">2</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;"><strong>54</strong></td>
</tr>
<tr>
<td>FolderService</td>
<td>115</td>
<td>2</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;">3</td>
<td style="text-align: center;"><strong>60</strong></td>
</tr>
<tr>
<td>CommonService</td>
<td>33</td>
<td>3</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;">4</td>
<td style="text-align: center;"><strong>80</strong></td>
</tr>
<tr>
<td><strong>平均</strong></td>
<td>-</td>
<td>-</td>
<td style="text-align: center;"><strong>2.2</strong></td>
<td style="text-align: center;"><strong>2.0</strong></td>
<td style="text-align: center;"><strong>2.5</strong></td>
<td style="text-align: center;"><strong>2.7</strong></td>
<td style="text-align: center;"><strong>48.6</strong></td>
</tr>
</tbody>
</table>
<h3 id="12-mmi">1.2 MMI計算式<a class="headerlink" href="#12-mmi" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code>MMI = ((0.3 × Cohesion + 0.3 × Coupling + 0.2 × Independence + 0.2 × Reusability) / 5) × 100
</code></pre>

<hr />
<h2 id="2">2. 個別モジュール評価<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21-userservice">2.1 UserService<a class="headerlink" href="#21-userservice" title="Permanent link">&para;</a></h3>
<p><strong>基本情報</strong></p>
<table>
<thead>
<tr>
<th>項目</th>
<th>値</th>
</tr>
</thead>
<tbody>
<tr>
<td>ファイル</td>
<td><code>service/UserService.java</code></td>
</tr>
<tr>
<td>行数</td>
<td>1116</td>
</tr>
<tr>
<td>メソッド数</td>
<td>29</td>
</tr>
<tr>
<td>フィールド数</td>
<td>22</td>
</tr>
<tr>
<td><strong>MMI</strong></td>
<td><strong>28</strong> (未成熟)</td>
</tr>
</tbody>
</table>
<p><strong>スコア詳細</strong></p>
<table>
<thead>
<tr>
<th>軸</th>
<th style="text-align: center;">スコア</th>
<th>根拠</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cohesion</td>
<td style="text-align: center;">1</td>
<td>認証、BOX連携、ユーザー管理、メール送信、トークン管理など多数の責務が集中</td>
</tr>
<tr>
<td>Coupling</td>
<td style="text-align: center;">1</td>
<td>10+リポジトリへの依存、他サービスとの双方向依存</td>
</tr>
<tr>
<td>Independence</td>
<td style="text-align: center;">2</td>
<td>BOX API、ScalarDBへの強依存</td>
</tr>
<tr>
<td>Reusability</td>
<td style="text-align: center;">2</td>
<td>BOX Platform固有ロジックが多く他システムでの再利用困難</td>
</tr>
</tbody>
</table>
<p><strong>主な責務（問題）</strong></p>
<ol>
<li>ユーザー認証・認可</li>
<li>BOX OAuth連携</li>
<li>ユーザーCRUD</li>
<li>パスワードリセット・OTP</li>
<li>メール送信</li>
<li>トークン管理</li>
<li>ロール管理</li>
<li>言語設定</li>
</ol>
<p><strong>改善提案</strong></p>
<pre class="codehilite"><code>UserService (1116行)
    ↓ 分割
├── AuthenticationService (~300行)
│   └── ログイン、JWT発行、パスワード検証
├── BoxUserService (~350行)
│   └── BOX OAuth、トークン更新、ユーザー情報取得
├── UserManagementService (~300行)
│   └── CRUD、ロール管理、一覧取得
└── PasswordResetService (~150行)
    └── OTP生成、メール送信、パスワード変更
</code></pre>

<hr />
<h3 id="22-auditsetitemservice">2.2 AuditSetItemService<a class="headerlink" href="#22-auditsetitemservice" title="Permanent link">&para;</a></h3>
<p><strong>基本情報</strong></p>
<table>
<thead>
<tr>
<th>項目</th>
<th>値</th>
</tr>
</thead>
<tbody>
<tr>
<td>ファイル</td>
<td><code>service/AuditSetItemService.java</code></td>
</tr>
<tr>
<td>行数</td>
<td>899</td>
</tr>
<tr>
<td>メソッド数</td>
<td>11</td>
</tr>
<tr>
<td>フィールド数</td>
<td>11</td>
</tr>
<tr>
<td><strong>MMI</strong></td>
<td><strong>40</strong> (低中成熟)</td>
</tr>
</tbody>
</table>
<p><strong>スコア詳細</strong></p>
<table>
<thead>
<tr>
<th>軸</th>
<th style="text-align: center;">スコア</th>
<th>根拠</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cohesion</td>
<td style="text-align: center;">2</td>
<td>アイテム管理、検証、監視ステータスの3責務が混在</td>
</tr>
<tr>
<td>Coupling</td>
<td style="text-align: center;">2</td>
<td>AuditSetService、AssetServiceへの依存</td>
</tr>
<tr>
<td>Independence</td>
<td style="text-align: center;">2</td>
<td>ScalarDB、ScalarDLへの依存</td>
</tr>
<tr>
<td>Reusability</td>
<td style="text-align: center;">2</td>
<td>監査セット固有のロジック</td>
</tr>
</tbody>
</table>
<p><strong>主な責務</strong></p>
<ol>
<li>アイテム追加・削除</li>
<li>監視ステータス管理</li>
<li>改ざん検証</li>
<li>BOXアイテム情報取得</li>
</ol>
<p><strong>改善提案</strong></p>
<pre class="codehilite"><code>AuditSetItemService (899行)
    ↓ 分割
├── AuditSetItemCrudService (~400行)
│   └── アイテムの追加・削除・一覧
├── ItemMonitoringService (~250行)
│   └── 監視ステータス管理
└── ItemVerificationService (~250行)
    └── 改ざん検証、検証結果管理
</code></pre>

<hr />
<h3 id="23-auditsetservice">2.3 AuditSetService<a class="headerlink" href="#23-auditsetservice" title="Permanent link">&para;</a></h3>
<p><strong>基本情報</strong></p>
<table>
<thead>
<tr>
<th>項目</th>
<th>値</th>
</tr>
</thead>
<tbody>
<tr>
<td>ファイル</td>
<td><code>service/AuditSetService.java</code></td>
</tr>
<tr>
<td>行数</td>
<td>845</td>
</tr>
<tr>
<td>メソッド数</td>
<td>14</td>
</tr>
<tr>
<td>フィールド数</td>
<td>11</td>
</tr>
<tr>
<td><strong>MMI</strong></td>
<td><strong>40</strong> (低中成熟)</td>
</tr>
</tbody>
</table>
<p><strong>スコア詳細</strong></p>
<table>
<thead>
<tr>
<th>軸</th>
<th style="text-align: center;">スコア</th>
<th>根拠</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cohesion</td>
<td style="text-align: center;">2</td>
<td>CRUD、コラボレーター管理、グループ管理が混在</td>
</tr>
<tr>
<td>Coupling</td>
<td style="text-align: center;">2</td>
<td>8つのリポジトリへの依存</td>
</tr>
<tr>
<td>Independence</td>
<td style="text-align: center;">2</td>
<td>複数テーブルへのトランザクション</td>
</tr>
<tr>
<td>Reusability</td>
<td style="text-align: center;">2</td>
<td>監査セット固有のビジネスルール</td>
</tr>
</tbody>
</table>
<p><strong>主な責務</strong></p>
<ol>
<li>監査セットCRUD</li>
<li>コラボレーター管理</li>
<li>監査グループとの関連管理</li>
<li>ACL管理</li>
</ol>
<p><strong>改善提案</strong></p>
<pre class="codehilite"><code>AuditSetService (845行)
    ↓ 分割
├── AuditSetCrudService (~350行)
│   └── 作成・更新・削除・一覧
├── AuditSetAccessService (~250行)
│   └── コラボレーター管理、ACL
└── AuditSetGroupService (~200行)
    └── グループ関連付け
</code></pre>

<hr />
<h3 id="24-fileservice">2.4 FileService<a class="headerlink" href="#24-fileservice" title="Permanent link">&para;</a></h3>
<p><strong>基本情報</strong></p>
<table>
<thead>
<tr>
<th>項目</th>
<th>値</th>
</tr>
</thead>
<tbody>
<tr>
<td>ファイル</td>
<td><code>service/FileService.java</code></td>
</tr>
<tr>
<td>行数</td>
<td>555</td>
</tr>
<tr>
<td>メソッド数</td>
<td>11</td>
</tr>
<tr>
<td>フィールド数</td>
<td>8</td>
</tr>
<tr>
<td><strong>MMI</strong></td>
<td><strong>48</strong> (低中成熟)</td>
</tr>
</tbody>
</table>
<p><strong>スコア詳細</strong></p>
<table>
<thead>
<tr>
<th>軸</th>
<th style="text-align: center;">スコア</th>
<th>根拠</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cohesion</td>
<td style="text-align: center;">2</td>
<td>ファイル詳細、バージョン、コピー、ログの複数責務</td>
</tr>
<tr>
<td>Coupling</td>
<td style="text-align: center;">2</td>
<td>UserService、BoxUtilityへの依存</td>
</tr>
<tr>
<td>Independence</td>
<td style="text-align: center;">3</td>
<td>BOX APIへの外部依存のみ</td>
</tr>
<tr>
<td>Reusability</td>
<td style="text-align: center;">3</td>
<td>ファイル操作は比較的汎用的</td>
</tr>
</tbody>
</table>
<p><strong>改善提案</strong></p>
<ul>
<li><code>FileDetailsService</code>: ファイル詳細・メタデータ</li>
<li><code>FileVersionService</code>: バージョン管理</li>
<li><code>FileCollaboratorService</code>: コラボレーター情報</li>
</ul>
<hr />
<h3 id="25-auditgroupservice">2.5 AuditGroupService<a class="headerlink" href="#25-auditgroupservice" title="Permanent link">&para;</a></h3>
<p><strong>基本情報</strong></p>
<table>
<thead>
<tr>
<th>項目</th>
<th>値</th>
</tr>
</thead>
<tbody>
<tr>
<td>ファイル</td>
<td><code>service/AuditGroupService.java</code></td>
</tr>
<tr>
<td>行数</td>
<td>439</td>
</tr>
<tr>
<td>メソッド数</td>
<td>8</td>
</tr>
<tr>
<td>フィールド数</td>
<td>7</td>
</tr>
<tr>
<td><strong>MMI</strong></td>
<td><strong>54</strong> (低中成熟)</td>
</tr>
</tbody>
</table>
<p><strong>スコア詳細</strong></p>
<table>
<thead>
<tr>
<th>軸</th>
<th style="text-align: center;">スコア</th>
<th>根拠</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cohesion</td>
<td style="text-align: center;">3</td>
<td>グループ管理に集中しているが、メンバー管理も含む</td>
</tr>
<tr>
<td>Coupling</td>
<td style="text-align: center;">2</td>
<td>6つのリポジトリへの依存</td>
</tr>
<tr>
<td>Independence</td>
<td style="text-align: center;">3</td>
<td>比較的独立したドメイン</td>
</tr>
<tr>
<td>Reusability</td>
<td style="text-align: center;">3</td>
<td>グループ概念は汎用的</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="26-auditsetcollaboratorservice">2.6 AuditSetCollaboratorService<a class="headerlink" href="#26-auditsetcollaboratorservice" title="Permanent link">&para;</a></h3>
<p><strong>基本情報</strong></p>
<table>
<thead>
<tr>
<th>項目</th>
<th>値</th>
</tr>
</thead>
<tbody>
<tr>
<td>ファイル</td>
<td><code>service/AuditSetCollaboratorService.java</code></td>
</tr>
<tr>
<td>行数</td>
<td>288</td>
</tr>
<tr>
<td>メソッド数</td>
<td>7</td>
</tr>
<tr>
<td>フィールド数</td>
<td>6</td>
</tr>
<tr>
<td><strong>MMI</strong></td>
<td><strong>60</strong> (中成熟)</td>
</tr>
</tbody>
</table>
<p><strong>スコア詳細</strong></p>
<table>
<thead>
<tr>
<th>軸</th>
<th style="text-align: center;">スコア</th>
<th>根拠</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cohesion</td>
<td style="text-align: center;">3</td>
<td>コラボレーター管理に集中</td>
</tr>
<tr>
<td>Coupling</td>
<td style="text-align: center;">3</td>
<td>5つのリポジトリだが一方向依存</td>
</tr>
<tr>
<td>Independence</td>
<td style="text-align: center;">3</td>
<td>監査セットとの関連のみ</td>
</tr>
<tr>
<td>Reusability</td>
<td style="text-align: center;">3</td>
<td>コラボレーションパターンは汎用的</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="27-eventlogservice">2.7 EventLogService<a class="headerlink" href="#27-eventlogservice" title="Permanent link">&para;</a></h3>
<p><strong>基本情報</strong></p>
<table>
<thead>
<tr>
<th>項目</th>
<th>値</th>
</tr>
</thead>
<tbody>
<tr>
<td>ファイル</td>
<td><code>service/EventLogService.java</code></td>
</tr>
<tr>
<td>行数</td>
<td>222</td>
</tr>
<tr>
<td>メソッド数</td>
<td>6</td>
</tr>
<tr>
<td>フィールド数</td>
<td>2</td>
</tr>
<tr>
<td><strong>MMI</strong></td>
<td><strong>68</strong> (中成熟)</td>
</tr>
</tbody>
</table>
<p><strong>スコア詳細</strong></p>
<table>
<thead>
<tr>
<th>軸</th>
<th style="text-align: center;">スコア</th>
<th>根拠</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cohesion</td>
<td style="text-align: center;">4</td>
<td>イベントログ取得に特化</td>
</tr>
<tr>
<td>Coupling</td>
<td style="text-align: center;">3</td>
<td>2つのリポジトリのみ</td>
</tr>
<tr>
<td>Independence</td>
<td style="text-align: center;">3</td>
<td>イベントデータへの読み取りのみ</td>
</tr>
<tr>
<td>Reusability</td>
<td style="text-align: center;">4</td>
<td>検索・フィルタリングロジックは汎用的</td>
</tr>
</tbody>
</table>
<p><strong>良い点</strong>
- 単一責務に近い設計
- 少ない依存関係
- クエリメソッドが明確</p>
<hr />
<h3 id="28-assetservice">2.8 AssetService<a class="headerlink" href="#28-assetservice" title="Permanent link">&para;</a></h3>
<p><strong>基本情報</strong></p>
<table>
<thead>
<tr>
<th>項目</th>
<th>値</th>
</tr>
</thead>
<tbody>
<tr>
<td>ファイル</td>
<td><code>service/AssetService.java</code></td>
</tr>
<tr>
<td>行数</td>
<td>199</td>
</tr>
<tr>
<td>メソッド数</td>
<td>5</td>
</tr>
<tr>
<td>フィールド数</td>
<td>5</td>
</tr>
<tr>
<td><strong>MMI</strong></td>
<td><strong>54</strong> (低中成熟)</td>
</tr>
</tbody>
</table>
<p><strong>スコア詳細</strong></p>
<table>
<thead>
<tr>
<th>軸</th>
<th style="text-align: center;">スコア</th>
<th>根拠</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cohesion</td>
<td style="text-align: center;">3</td>
<td>ScalarDL連携に集中</td>
</tr>
<tr>
<td>Coupling</td>
<td style="text-align: center;">3</td>
<td>ScalarDL、BoxUtilityへの限定的依存</td>
</tr>
<tr>
<td>Independence</td>
<td style="text-align: center;">2</td>
<td>ScalarDL Auditor/Ledgerへの強依存</td>
</tr>
<tr>
<td>Reusability</td>
<td style="text-align: center;">3</td>
<td>台帳操作は他システムでも利用可能</td>
</tr>
</tbody>
</table>
<p><strong>特記事項</strong>
- ScalarDLコントラクト呼び出しのラッパー
- 改ざん検証のコア機能</p>
<hr />
<h3 id="29-folderservice">2.9 FolderService<a class="headerlink" href="#29-folderservice" title="Permanent link">&para;</a></h3>
<p><strong>基本情報</strong></p>
<table>
<thead>
<tr>
<th>項目</th>
<th>値</th>
</tr>
</thead>
<tbody>
<tr>
<td>ファイル</td>
<td><code>service/FolderService.java</code></td>
</tr>
<tr>
<td>行数</td>
<td>115</td>
</tr>
<tr>
<td>メソッド数</td>
<td>2</td>
</tr>
<tr>
<td>フィールド数</td>
<td>3</td>
</tr>
<tr>
<td><strong>MMI</strong></td>
<td><strong>60</strong> (中成熟)</td>
</tr>
</tbody>
</table>
<p><strong>スコア詳細</strong></p>
<table>
<thead>
<tr>
<th>軸</th>
<th style="text-align: center;">スコア</th>
<th>根拠</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cohesion</td>
<td style="text-align: center;">3</td>
<td>フォルダ操作に集中</td>
</tr>
<tr>
<td>Coupling</td>
<td style="text-align: center;">3</td>
<td>UserService、BoxUtilityへの限定的依存</td>
</tr>
<tr>
<td>Independence</td>
<td style="text-align: center;">3</td>
<td>BOX APIへの外部依存</td>
</tr>
<tr>
<td>Reusability</td>
<td style="text-align: center;">3</td>
<td>フォルダ一覧取得は汎用的</td>
</tr>
</tbody>
</table>
<hr />
<h3 id="210-commonservice">2.10 CommonService<a class="headerlink" href="#210-commonservice" title="Permanent link">&para;</a></h3>
<p><strong>基本情報</strong></p>
<table>
<thead>
<tr>
<th>項目</th>
<th>値</th>
</tr>
</thead>
<tbody>
<tr>
<td>ファイル</td>
<td><code>service/CommonService.java</code></td>
</tr>
<tr>
<td>行数</td>
<td>33</td>
</tr>
<tr>
<td>メソッド数</td>
<td>3</td>
</tr>
<tr>
<td>フィールド数</td>
<td>1</td>
</tr>
<tr>
<td><strong>MMI</strong></td>
<td><strong>80</strong> (高成熟)</td>
</tr>
</tbody>
</table>
<p><strong>スコア詳細</strong></p>
<table>
<thead>
<tr>
<th>軸</th>
<th style="text-align: center;">スコア</th>
<th>根拠</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cohesion</td>
<td style="text-align: center;">4</td>
<td>権限チェックユーティリティに特化</td>
</tr>
<tr>
<td>Coupling</td>
<td style="text-align: center;">4</td>
<td>ObjectMapperのみに依存</td>
</tr>
<tr>
<td>Independence</td>
<td style="text-align: center;">4</td>
<td>完全に独立した判定ロジック</td>
</tr>
<tr>
<td>Reusability</td>
<td style="text-align: center;">4</td>
<td>他コンテキストでも利用可能</td>
</tr>
</tbody>
</table>
<p><strong>良い点</strong>
- 小さく明確な責務
- 最小限の依存
- 純粋関数的な設計</p>
<hr />
<h2 id="3">3. 依存関係マトリクス<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 サービス間依存<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code>                  US  ASI ASS FS  AGS ASC ELS AstS FoS CS
UserService       -
AuditSetItemSvc   X   -   X                   X
AuditSetService   X       -
FileService       X           -
AuditGroupSvc     X               -
AuditSetCollab    X               X   -
EventLogService                           -
AssetService                                  -
FolderService     X                               -
CommonService                                         -

X = 依存あり
</code></pre>

<h3 id="32">3.2 リポジトリ依存数<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>サービス</th>
<th>リポジトリ依存数</th>
<th>詳細</th>
</tr>
</thead>
<tbody>
<tr>
<td>UserService</td>
<td>10</td>
<td>userRepo, roleUserRepo, tokenRepo, otpRepo, orgRepo, auditSetRepo, collaboratorRepo, groupRepo, userGroupRepo, auditorLogsRepo</td>
</tr>
<tr>
<td>AuditSetService</td>
<td>8</td>
<td>auditSetRepo, collaboratorRepo, userRepo, auditorLogsRepo, groupRepo, userGroupRepo, mappingRepo, itemRepo</td>
</tr>
<tr>
<td>AuditSetItemService</td>
<td>6</td>
<td>auditSetRepo, userRepo, itemRepo, assetSvc, statusRepo, collaboratorRepo</td>
</tr>
<tr>
<td>FileService</td>
<td>5</td>
<td>userRepo, statusRepo, auditorLogsRepo, auditSetRepo, sha1Repo</td>
</tr>
<tr>
<td>AuditGroupService</td>
<td>6</td>
<td>groupRepo, auditSetRepo, mappingRepo, userRepo, userGroupRepo</td>
</tr>
<tr>
<td>AuditSetCollaboratorService</td>
<td>4</td>
<td>collaboratorRepo, auditSetRepo, userRepo</td>
</tr>
<tr>
<td>EventLogService</td>
<td>2</td>
<td>eventsRepo, itemEventsRepo</td>
</tr>
<tr>
<td>AssetService</td>
<td>1</td>
<td>scalardlRepo</td>
</tr>
<tr>
<td>FolderService</td>
<td>0</td>
<td>(UserService経由)</td>
</tr>
<tr>
<td>CommonService</td>
<td>0</td>
<td>なし</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="4">4. 改善優先度マトリクス<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<pre class="codehilite"><code>         緊急度 高 ←───────────────→ 低
影響度   ┌─────────────────────────────────┐
  高     │ UserService     │ AuditSetSvc  │
         │ AuditSetItemSvc │ FileService  │
         ├─────────────────┼──────────────┤
  低     │ AuditGroupSvc   │ EventLogSvc  │
         │ AssetService    │ CommonService│
         └─────────────────┴──────────────┘
</code></pre>

<p><strong>優先順位:</strong>
1. UserService - 最優先で分割
2. AuditSetItemService - 循環依存解消
3. AuditSetService - リポジトリ依存削減
4. FileService - BOX連携抽象化
5. AuditGroupService - 標準化
6. AssetService - インターフェース導入
7. 他 - 維持</p>
<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: scalar-event-log-fetcher-main</em></p>
</article>
<article id="evaluation-mmi-improvement-plan">
<h1 id="mmi-mmi-improvement-plan">MMI改善計画 (MMI Improvement Plan)<a class="headerlink" href="#mmi-mmi-improvement-plan" title="Permanent link">&para;</a></h1>
<h2 id="1">1. 改善目標<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 定量目標<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>指標</th>
<th>現状</th>
<th>Phase 1</th>
<th>Phase 2</th>
<th>Phase 3</th>
<th>最終目標</th>
</tr>
</thead>
<tbody>
<tr>
<td>総合MMI</td>
<td>48.6</td>
<td>55</td>
<td>65</td>
<td>75</td>
<td>80+</td>
</tr>
<tr>
<td>Cohesion平均</td>
<td>2.2</td>
<td>2.8</td>
<td>3.5</td>
<td>4.0</td>
<td>4.0+</td>
</tr>
<tr>
<td>Coupling平均</td>
<td>2.0</td>
<td>2.5</td>
<td>3.0</td>
<td>3.5</td>
<td>4.0+</td>
</tr>
<tr>
<td>Independence平均</td>
<td>2.5</td>
<td>3.0</td>
<td>3.5</td>
<td>4.0</td>
<td>4.0+</td>
</tr>
<tr>
<td>Reusability平均</td>
<td>2.7</td>
<td>3.0</td>
<td>3.5</td>
<td>4.0</td>
<td>4.0+</td>
</tr>
</tbody>
</table>
<h3 id="12">1.2 定性目標<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>Phase 1</strong>: 最大のボトルネックである<code>UserService</code>の分割完了</li>
<li><strong>Phase 2</strong>: サービス間の循環依存解消、BOX連携の抽象化</li>
<li><strong>Phase 3</strong>: ドメイン駆動設計の適用、マイクロサービス境界の明確化</li>
<li><strong>最終</strong>: マイクロサービスとして独立デプロイ可能な状態</li>
</ol>
<hr />
<h2 id="2">2. ロードマップ<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 全体タイムライン<a class="headerlink" href="#21" title="Permanent link">&para;</a></h3>
<div class="mermaid">
gantt
    title MMI改善ロードマップ
    dateFormat  YYYY-MM
    section Phase 1
    UserService分割           :p1-1, 2025-01, 2M
    循環依存解消              :p1-2, 2025-02, 1M
    テストカバレッジ向上       :p1-3, 2025-01, 3M
    section Phase 2
    BOX連携抽象化             :p2-1, 2025-04, 2M
    リポジトリ整理            :p2-2, 2025-05, 2M
    エラーハンドリング統一     :p2-3, 2025-06, 1M
    section Phase 3
    DDD適用                   :p3-1, 2025-07, 3M
    データベース分離準備       :p3-2, 2025-09, 2M
    マイクロサービス境界確定   :p3-3, 2025-10, 2M
</div>

<h3 id="22">2.2 フェーズ別概要<a class="headerlink" href="#22" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Phase</th>
<th>期間</th>
<th>主要施策</th>
<th>期待効果</th>
</tr>
</thead>
<tbody>
<tr>
<td>Phase 1</td>
<td>0-3ヶ月</td>
<td>責務分離、依存解消</td>
<td>MMI +7pt</td>
</tr>
<tr>
<td>Phase 2</td>
<td>3-6ヶ月</td>
<td>抽象化、標準化</td>
<td>MMI +10pt</td>
</tr>
<tr>
<td>Phase 3</td>
<td>6-12ヶ月</td>
<td>DDD適用、境界確定</td>
<td>MMI +10pt</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3-phase-1-0-3">3. Phase 1: 責務分離と依存解消（0-3ヶ月）<a class="headerlink" href="#3-phase-1-0-3" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 施策一覧<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>#</th>
<th>施策</th>
<th>対象</th>
<th>優先度</th>
<th>工数</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.1</td>
<td>UserService分割</td>
<td>UserService</td>
<td>最優先</td>
<td>40h</td>
</tr>
<tr>
<td>1.2</td>
<td>循環依存解消</td>
<td>AuditSetItemService, AuditSetService</td>
<td>高</td>
<td>24h</td>
</tr>
<tr>
<td>1.3</td>
<td>テストカバレッジ向上</td>
<td>全サービス</td>
<td>高</td>
<td>60h</td>
</tr>
<tr>
<td>1.4</td>
<td>共通例外処理の導入</td>
<td>全サービス</td>
<td>中</td>
<td>16h</td>
</tr>
</tbody>
</table>
<h3 id="32-userservice">3.2 UserService分割詳細<a class="headerlink" href="#32-userservice" title="Permanent link">&para;</a></h3>
<p><strong>現状構造:</strong></p>
<pre class="codehilite"><code>UserService (1116行, 29メソッド)
├── 認証系: login, loadUserByUsername, getToken, getNewAccessToken
├── BOX連携: registerUserAndSaveToken, updateLatestToken
├── ユーザー管理: createUser, deleteUser, getManagedUsers, editUser
├── ロール管理: updateUserRole, createRoleUser
├── パスワード: sendResetPasswordOTP, forgotPassword
└── その他: updateLanguageForUser, getListOfExternalAuditors
</code></pre>

<p><strong>目標構造:</strong></p>
<pre class="codehilite"><code>com.scalar.events_log_tool.application.service.user/
├── AuthenticationService.java (~300行)
│   ├── login()
│   ├── loadUserByUsername()
│   ├── getToken()
│   └── getNewAccessToken()
├── BoxUserService.java (~350行)
│   ├── registerUserAndSaveToken()
│   ├── updateLatestToken()
│   └── getBoxUserInfo()
├── UserManagementService.java (~300行)
│   ├── createUser()
│   ├── deleteUser()
│   ├── editUser()
│   ├── getManagedUsers()
│   └── updateUserRole()
└── PasswordResetService.java (~150行)
    ├── sendResetPasswordOTP()
    └── forgotPassword()
</code></pre>

<p><strong>依存関係の整理:</strong></p>
<pre class="codehilite"><code>Before:
UserService → [10 repositories + 5 services]

After:
AuthenticationService → UserRepository, JwtHelper
BoxUserService → UserRepository, UserTokenRepository, BoxUtility
UserManagementService → UserRepository, RoleUserRepository
PasswordResetService → UserOptRepository, EmailUtility
</code></pre>

<p><strong>実装手順:</strong>
1. 新パッケージ <code>service.user</code> 作成
2. インターフェース <code>UserServiceFacade</code> 定義（後方互換性）
3. 各サービスクラス作成・テスト
4. 既存呼び出し元の段階的移行
5. 旧<code>UserService</code>の非推奨化・削除</p>
<h3 id="33">3.3 循環依存解消<a class="headerlink" href="#33" title="Permanent link">&para;</a></h3>
<p><strong>現状の問題:</strong></p>
<pre class="codehilite"><code>AuditSetItemService → AuditSetService
AuditSetService → (AuditSetItemRepositoryを直接利用)
</code></pre>

<p><strong>解決策: イベント駆動パターン</strong></p>
<pre class="codehilite"><code>// Before
class AuditSetItemService {
    private AuditSetService auditSetService;

    void addItem() {
        auditSetService.isItemExistInAuditSet(...);
    }
}

// After
class AuditSetItemService {
    private AuditSetRepository auditSetRepository; // 直接参照

    void addItem() {
        auditSetRepository.existsByIdAndItemId(...);
    }
}
</code></pre>

<p><strong>代替案: インターフェース分離</strong></p>
<pre class="codehilite"><code class="language-java">// 共通インターフェース
interface AuditSetQueryService {
    boolean isItemExist(String auditSetId, Long itemId);
}

// 実装は別クラス
class AuditSetQueryServiceImpl implements AuditSetQueryService {
    // AuditSetItemServiceとAuditSetServiceが両方参照
}
</code></pre>

<hr />
<h2 id="4-phase-2-3-6">4. Phase 2: 抽象化と標準化（3-6ヶ月）<a class="headerlink" href="#4-phase-2-3-6" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 施策一覧<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>#</th>
<th>施策</th>
<th>対象</th>
<th>優先度</th>
<th>工数</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.1</td>
<td>BOX連携層の抽象化</td>
<td>BoxUtility, 各Service</td>
<td>高</td>
<td>32h</td>
</tr>
<tr>
<td>2.2</td>
<td>リポジトリ層の整理</td>
<td>全Repository</td>
<td>高</td>
<td>40h</td>
</tr>
<tr>
<td>2.3</td>
<td>エラーハンドリング統一</td>
<td>全Service</td>
<td>中</td>
<td>24h</td>
</tr>
<tr>
<td>2.4</td>
<td>ログ出力標準化</td>
<td>全Service</td>
<td>低</td>
<td>16h</td>
</tr>
</tbody>
</table>
<h3 id="42-box">4.2 BOX連携層の抽象化<a class="headerlink" href="#42-box" title="Permanent link">&para;</a></h3>
<p><strong>現状:</strong></p>
<pre class="codehilite"><code class="language-java">// 各サービスで直接BoxUtilityを使用
class FileService {
    @Lazy
    private BoxAPIConnection connection;

    void getFileDetails() {
        BoxFile file = new BoxFile(connection, fileId);
        file.getInfo(&quot;name&quot;, &quot;size&quot;, &quot;sha1&quot;);
    }
}
</code></pre>

<p><strong>目標:</strong></p>
<pre class="codehilite"><code class="language-java">// インターフェース定義
interface BoxApiClient {
    FileInfo getFileInfo(String fileId, List&lt;String&gt; fields);
    FolderInfo getFolderInfo(String folderId);
    List&lt;EventInfo&gt; getEnterpriseEvents(String streamPosition);
}

// 実装
class BoxApiClientImpl implements BoxApiClient {
    private final BoxAPIConnection connection;

    @Override
    public FileInfo getFileInfo(String fileId, List&lt;String&gt; fields) {
        BoxFile file = new BoxFile(connection, fileId);
        return mapToFileInfo(file.getInfo(fields));
    }
}

// テスト用モック
class MockBoxApiClient implements BoxApiClient {
    // テストデータを返す
}
</code></pre>

<p><strong>利点:</strong>
- テスタビリティ向上
- BOX SDKバージョン変更の影響を限定
- 将来的な他ストレージ対応が容易</p>
<h3 id="43">4.3 リポジトリ層の整理<a class="headerlink" href="#43" title="Permanent link">&para;</a></h3>
<p><strong>現状の問題:</strong>
- 22個のリポジトリが個別に存在
- サービスが多数のリポジトリに直接依存
- トランザクション境界が不明確</p>
<p><strong>Aggregate Root パターン適用:</strong></p>
<pre class="codehilite"><code>Before:
├── AuditSetRepository
├── AuditSetItemRepository
├── AuditSetCollaboratorsRepository
└── AuditGrpAuditSetMappingRepository

After:
├── AuditSetAggregateRepository (Aggregate Root)
│   └── 内部でItem, Collaborator, Mappingを管理
├── AuditSetItemRepository (内部利用のみ)
├── AuditSetCollaboratorsRepository (内部利用のみ)
└── AuditGrpAuditSetMappingRepository (内部利用のみ)
</code></pre>

<hr />
<h2 id="5-phase-3-ddd6-12">5. Phase 3: DDD適用と境界確定（6-12ヶ月）<a class="headerlink" href="#5-phase-3-ddd6-12" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 施策一覧<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>#</th>
<th>施策</th>
<th>対象</th>
<th>優先度</th>
<th>工数</th>
</tr>
</thead>
<tbody>
<tr>
<td>3.1</td>
<td>値オブジェクト導入</td>
<td>Model層</td>
<td>高</td>
<td>40h</td>
</tr>
<tr>
<td>3.2</td>
<td>ドメインサービス整理</td>
<td>Service層</td>
<td>高</td>
<td>48h</td>
</tr>
<tr>
<td>3.3</td>
<td>境界付けられたコンテキスト定義</td>
<td>全体</td>
<td>高</td>
<td>32h</td>
</tr>
<tr>
<td>3.4</td>
<td>データベース論理分割</td>
<td>Repository層</td>
<td>中</td>
<td>40h</td>
</tr>
</tbody>
</table>
<h3 id="52">5.2 値オブジェクト導入例<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">// Before
class User {
    private String userEmail;
    private String roleJson;
}

// After
class User {
    private Email email;
    private UserRole role;
}

// 値オブジェクト
@Value
class Email {
    String value;

    public Email(String value) {
        if (!isValidEmail(value)) {
            throw new InvalidEmailException(value);
        }
        this.value = value;
    }
}

@Value
class UserRole {
    UserRoleType type;
    Set&lt;Permission&gt; permissions;

    public boolean canManageUsers() {
        return type == UserRoleType.AUDIT_ADMIN;
    }
}
</code></pre>

<h3 id="53">5.3 境界付けられたコンテキスト<a class="headerlink" href="#53" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "Identity & Access Context"
        IAC[User Management]
        IAC2[Authentication]
        IAC3[Authorization]
    end

    subgraph "Audit Context"
        AC[Audit Set Management]
        AC2[Collaborator Management]
        AC3[Audit Group Management]
    end

    subgraph "File Context"
        FC[File/Folder Operations]
        FC2[Version Management]
    end

    subgraph "Event Context"
        EC[Event Log]
        EC2[Event Search]
    end

    subgraph "Verification Context"
        VC[Tampering Detection]
        VC2[Asset Management]
    end

    IAC --> AC
    AC --> FC
    FC --> EC
    AC --> VC
</div>

<hr />
<h2 id="6">6. 施策依存関係<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<div class="mermaid">
graph TD
    subgraph "Phase 1"
        P1_1[UserService分割]
        P1_2[循環依存解消]
        P1_3[テストカバレッジ]
    end

    subgraph "Phase 2"
        P2_1[BOX連携抽象化]
        P2_2[リポジトリ整理]
        P2_3[エラーハンドリング]
    end

    subgraph "Phase 3"
        P3_1[値オブジェクト]
        P3_2[境界確定]
        P3_3[データベース分割]
    end

    P1_1 --> P2_1
    P1_2 --> P2_2
    P1_3 --> P2_1
    P1_3 --> P2_2

    P2_1 --> P3_1
    P2_2 --> P3_2
    P2_3 --> P3_1

    P3_1 --> P3_3
    P3_2 --> P3_3
</div>

<hr />
<h2 id="7">7. モニタリング計画<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 メトリクス収集<a class="headerlink" href="#71" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>メトリクス</th>
<th>収集頻度</th>
<th>ツール</th>
<th>目標値</th>
</tr>
</thead>
<tbody>
<tr>
<td>MMIスコア</td>
<td>月次</td>
<td>手動評価</td>
<td>継続的改善</td>
</tr>
<tr>
<td>コードカバレッジ</td>
<td>CI毎</td>
<td>JaCoCo</td>
<td>80%以上</td>
</tr>
<tr>
<td>循環依存数</td>
<td>週次</td>
<td>jdepend</td>
<td>0</td>
</tr>
<tr>
<td>サービスあたり行数</td>
<td>月次</td>
<td>cloc</td>
<td>500行以下</td>
</tr>
</tbody>
</table>
<h3 id="72">7.2 レビューポイント<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>時点</th>
<th>確認内容</th>
<th>判定基準</th>
</tr>
</thead>
<tbody>
<tr>
<td>Phase 1完了</td>
<td>UserService分割完了</td>
<td>新サービス各300行以下</td>
</tr>
<tr>
<td>Phase 2完了</td>
<td>循環依存ゼロ</td>
<td>jdepend警告なし</td>
</tr>
<tr>
<td>Phase 3完了</td>
<td>マイクロサービス準備</td>
<td>MMI 75以上</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="8">8. リスクと緩和策<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 リスク一覧<a class="headerlink" href="#81" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>リスク</th>
<th>確率</th>
<th>影響</th>
<th>緩和策</th>
</tr>
</thead>
<tbody>
<tr>
<td>機能退行</td>
<td>高</td>
<td>高</td>
<td>包括的なテストスイート作成</td>
</tr>
<tr>
<td>スケジュール遅延</td>
<td>中</td>
<td>中</td>
<td>段階的リリース、優先順位付け</td>
</tr>
<tr>
<td>チーム負荷</td>
<td>中</td>
<td>中</td>
<td>リファクタリング専任時間確保</td>
</tr>
<tr>
<td>仕様理解不足</td>
<td>中</td>
<td>低</td>
<td>ドメインエキスパートとの定期MTG</td>
</tr>
</tbody>
</table>
<h3 id="82">8.2 ロールバック計画<a class="headerlink" href="#82" title="Permanent link">&para;</a></h3>
<ul>
<li>各Phase完了時にリリースタグ作成</li>
<li>Feature Flagによる新旧実装切り替え</li>
<li>データベースマイグレーションは後方互換維持</li>
</ul>
<hr />
<h2 id="9">9. 成功基準<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<h3 id="91-phase-1">9.1 Phase 1 成功基準<a class="headerlink" href="#91-phase-1" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] UserServiceが4つ以下のサービスに分割</li>
<li>[ ] 各新サービスが400行以下</li>
<li>[ ] 循環依存が2つ以下に削減</li>
<li>[ ] 単体テストカバレッジ60%以上</li>
</ul>
<h3 id="92-phase-2">9.2 Phase 2 成功基準<a class="headerlink" href="#92-phase-2" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] BoxApiClientインターフェース導入</li>
<li>[ ] リポジトリ依存が各サービス5つ以下</li>
<li>[ ] 統一例外ハンドリング適用</li>
<li>[ ] 循環依存ゼロ</li>
</ul>
<h3 id="93-phase-3">9.3 Phase 3 成功基準<a class="headerlink" href="#93-phase-3" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] 5つの境界付けられたコンテキスト定義</li>
<li>[ ] 主要値オブジェクト10個以上導入</li>
<li>[ ] MMIスコア75以上</li>
<li>[ ] 各コンテキストが独立テスト可能</li>
</ul>
<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: scalar-event-log-fetcher-main</em></p>
</article>
</section>
<section id="design">
<h1>設計</h1>
<article id="design-domain-analysis">
<h1 id="domain-analysis">ドメイン分析 (Domain Analysis)<a class="headerlink" href="#domain-analysis" title="Permanent link">&para;</a></h1>
<h2 id="1">1. ドメイン一覧<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 識別されたドメイン<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>#</th>
<th>ドメイン名</th>
<th>英語名</th>
<th style="text-align: center;">コアドメイン</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>アイデンティティ・アクセス</td>
<td>Identity &amp; Access</td>
<td style="text-align: center;">-</td>
<td>ユーザー認証・認可、組織管理</td>
</tr>
<tr>
<td>2</td>
<td>監査管理</td>
<td>Audit Management</td>
<td style="text-align: center;"><strong>Core</strong></td>
<td>監査セット・グループの管理</td>
</tr>
<tr>
<td>3</td>
<td>ファイル管理</td>
<td>File Management</td>
<td style="text-align: center;">-</td>
<td>BOXファイル・フォルダ操作</td>
</tr>
<tr>
<td>4</td>
<td>イベント追跡</td>
<td>Event Tracking</td>
<td style="text-align: center;"><strong>Core</strong></td>
<td>イベントログの収集・検索</td>
</tr>
<tr>
<td>5</td>
<td>改ざん検証</td>
<td>Integrity Verification</td>
<td style="text-align: center;"><strong>Core</strong></td>
<td>ScalarDLによる改ざん検出</td>
</tr>
<tr>
<td>6</td>
<td>BOX連携</td>
<td>BOX Integration</td>
<td style="text-align: center;">-</td>
<td>BOX Platform API連携</td>
</tr>
</tbody>
</table>
<h3 id="12">1.2 ドメイン階層<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "Core Domains"
        AM[監査管理<br/>Audit Management]
        ET[イベント追跡<br/>Event Tracking]
        IV[改ざん検証<br/>Integrity Verification]
    end

    subgraph "Supporting Domains"
        IA[アイデンティティ・アクセス<br/>Identity & Access]
        FM[ファイル管理<br/>File Management]
    end

    subgraph "Generic Domains"
        BI[BOX連携<br/>BOX Integration]
    end

    IA --> AM
    FM --> AM
    AM --> ET
    AM --> IV
    FM --> IV
    BI --> FM
    BI --> IA
</div>

<hr />
<h2 id="2">2. ドメインタイプ分類（ビジネス構造軸）<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 分類結果<a class="headerlink" href="#21" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>ドメイン</th>
<th>タイプ</th>
<th>理由</th>
</tr>
</thead>
<tbody>
<tr>
<td>アイデンティティ・アクセス</td>
<td><strong>Dialogue</strong></td>
<td>認証フロー、セッション管理、リアルタイム権限チェック</td>
</tr>
<tr>
<td>監査管理</td>
<td><strong>Blackboard</strong></td>
<td>複数ユーザーによる監査セットへの協調的アクセス</td>
</tr>
<tr>
<td>ファイル管理</td>
<td><strong>Pipeline</strong></td>
<td>ファイル情報取得→変換→表示の順次処理</td>
</tr>
<tr>
<td>イベント追跡</td>
<td><strong>Pipeline</strong></td>
<td>イベント収集→保存→検索→表示の順次処理</td>
</tr>
<tr>
<td>改ざん検証</td>
<td><strong>Pipeline</strong></td>
<td>登録→検証→結果取得の順次処理</td>
</tr>
<tr>
<td>BOX連携</td>
<td><strong>Dialogue</strong></td>
<td>BOX API とのリアルタイム通信</td>
</tr>
</tbody>
</table>
<h3 id="22">2.2 タイプ別詳細<a class="headerlink" href="#22" title="Permanent link">&para;</a></h3>
<h4 id="pipeline-domain">Pipeline Domain（順次処理型）<a class="headerlink" href="#pipeline-domain" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>ドメイン</th>
<th>入力</th>
<th>処理フロー</th>
<th>出力</th>
</tr>
</thead>
<tbody>
<tr>
<td>ファイル管理</td>
<td>BOXファイルID</td>
<td>API呼出→変換→整形</td>
<td>ファイル詳細DTO</td>
</tr>
<tr>
<td>イベント追跡</td>
<td>日付範囲・フィルタ</td>
<td>取得→フィルタ→ソート</td>
<td>イベントリスト</td>
</tr>
<tr>
<td>改ざん検証</td>
<td>アイテムID</td>
<td>台帳照会→比較→判定</td>
<td>検証結果</td>
</tr>
</tbody>
</table>
<div class="mermaid">
graph LR
    subgraph "ファイル管理 Pipeline"
        F1[BOX API呼出] --> F2[データ変換]
        F2 --> F3[DTO整形]
        F3 --> F4[レスポンス]
    end

    subgraph "イベント追跡 Pipeline"
        E1[イベント取得] --> E2[フィルタリング]
        E2 --> E3[ソート]
        E3 --> E4[ページング]
    end

    subgraph "改ざん検証 Pipeline"
        V1[ハッシュ取得] --> V2[台帳照会]
        V2 --> V3[比較・判定]
        V3 --> V4[結果返却]
    end
</div>

<h4 id="blackboard-domain">Blackboard Domain（協調型）<a class="headerlink" href="#blackboard-domain" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>ドメイン</th>
<th>共有リソース</th>
<th>競合管理</th>
<th>協調パターン</th>
</tr>
</thead>
<tbody>
<tr>
<td>監査管理</td>
<td>監査セット</td>
<td>ACL・ロール</td>
<td>オーナー/コラボレーター権限</td>
</tr>
</tbody>
</table>
<div class="mermaid">
graph TB
    subgraph "監査管理 Blackboard"
        AS[監査セット<br/>Audit Set]
        Owner[オーナー]
        CoOwner[共同オーナー]
        Member[メンバー]
        Reviewer[レビュアー]

        Owner -->|全権限| AS
        CoOwner -->|編集権限| AS
        Member -->|追加権限| AS
        Reviewer -->|閲覧権限| AS
    end
</div>

<h4 id="dialogue-domain">Dialogue Domain（対話型）<a class="headerlink" href="#dialogue-domain" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>ドメイン</th>
<th>インタラクション</th>
<th>セッション</th>
<th>イベント駆動</th>
</tr>
</thead>
<tbody>
<tr>
<td>アイデンティティ・アクセス</td>
<td>OAuth認証フロー</td>
<td>JWT管理</td>
<td>ログイン/ログアウト</td>
</tr>
<tr>
<td>BOX連携</td>
<td>API呼出・応答</td>
<td>接続プール</td>
<td>トークン更新</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3">3. サービスカテゴリ分類（マイクロサービス境界軸）<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 分類結果<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>ドメイン</th>
<th>カテゴリ</th>
<th>理由</th>
</tr>
</thead>
<tbody>
<tr>
<td>アイデンティティ・アクセス</td>
<td><strong>Supporting</strong></td>
<td>全ドメインから利用される横断的機能</td>
</tr>
<tr>
<td>監査管理</td>
<td><strong>Process</strong></td>
<td>複数ステップのワークフロー、ステート管理</td>
</tr>
<tr>
<td>ファイル管理</td>
<td><strong>Master</strong></td>
<td>ファイル情報のCRUD、参照データ提供</td>
</tr>
<tr>
<td>イベント追跡</td>
<td><strong>Master</strong></td>
<td>イベントデータの蓄積・検索</td>
</tr>
<tr>
<td>改ざん検証</td>
<td><strong>Process</strong></td>
<td>検証ワークフロー、状態遷移管理</td>
</tr>
<tr>
<td>BOX連携</td>
<td><strong>Integration</strong></td>
<td>外部APIアダプタ、プロトコル変換</td>
</tr>
</tbody>
</table>
<h3 id="32">3.2 カテゴリ別詳細<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<h4 id="process-domain">Process Domain（プロセス型）<a class="headerlink" href="#process-domain" title="Permanent link">&para;</a></h4>
<p><strong>監査管理サービス</strong></p>
<pre class="codehilite"><code>状態遷移:
作成 → アイテム追加 → コラボレーター招待 → 検証実行 → 完了

トランザクション境界:
- 監査セット作成 + 初期コラボレーター設定
- アイテム追加 + 監視ステータス更新
- コラボレーター変更 + ACL更新
</code></pre>

<p><strong>改ざん検証サービス</strong></p>
<pre class="codehilite"><code>状態遷移:
未監視 → 監視中 → 検証待ち → 検証済み(正常/改ざん)

トランザクション境界:
- 監視登録 + ScalarDL台帳登録
- 検証実行 + 結果保存
</code></pre>

<h4 id="master-domain">Master Domain（マスタ型）<a class="headerlink" href="#master-domain" title="Permanent link">&para;</a></h4>
<p><strong>ファイル管理サービス</strong></p>
<pre class="codehilite"><code>責務:
- ファイル/フォルダ情報の取得・キャッシュ
- バージョン履歴の管理
- SHA1ベースのファイル重複検出
</code></pre>

<p><strong>イベント追跡サービス</strong></p>
<pre class="codehilite"><code>責務:
- BOXイベントの収集・保存
- 日付/ユーザー/タイプでの検索
- 監査ログの記録
</code></pre>

<h4 id="integration-domain">Integration Domain（統合型）<a class="headerlink" href="#integration-domain" title="Permanent link">&para;</a></h4>
<p><strong>BOX連携サービス</strong></p>
<pre class="codehilite"><code>責務:
- BOX API認証・接続管理
- API呼び出しのラッピング
- レート制限・リトライ処理
- エラー変換
</code></pre>

<h4 id="supporting-domain">Supporting Domain（サポート型）<a class="headerlink" href="#supporting-domain" title="Permanent link">&para;</a></h4>
<p><strong>アイデンティティ・アクセスサービス</strong></p>
<pre class="codehilite"><code>責務:
- ユーザー認証（BOX OAuth / パスワード）
- JWT発行・検証
- ロール・権限管理
- 組織管理
</code></pre>

<hr />
<h2 id="4">4. 境界づけられたコンテキスト<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="41-identity-access-context">4.1 Identity &amp; Access Context<a class="headerlink" href="#41-identity-access-context" title="Permanent link">&para;</a></h3>
<p><strong>概要</strong></p>
<p>ユーザーの認証・認可を担当するコンテキスト。BOX OAuthとパスワード認証の両方をサポート。</p>
<p><strong>ユビキタス言語</strong></p>
<table>
<thead>
<tr>
<th>用語</th>
<th>定義</th>
<th>他コンテキストとの違い</th>
</tr>
</thead>
<tbody>
<tr>
<td>User</td>
<td>システム利用者</td>
<td>監査管理では「コラボレーター」として参照</td>
</tr>
<tr>
<td>Role</td>
<td>システム権限（Admin/General/External）</td>
<td>監査管理では「コラボレーターロール」が別途存在</td>
</tr>
<tr>
<td>Organization</td>
<td>BOX Enterprise組織</td>
<td>-</td>
</tr>
<tr>
<td>Token</td>
<td>認証トークン（JWT/BOX）</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><strong>含まれるエンティティ</strong>
- User
- UserToken
- UserOtp
- Organization
- RoleUser</p>
<p><strong>提供する機能</strong>
- ログイン / ログアウト
- トークン発行・更新
- ユーザーCRUD
- ロール管理
- パスワードリセット</p>
<p><strong>依存するコンテキスト</strong>
- BOX Integration: OAuth認証フロー</p>
<hr />
<h3 id="42-audit-management-context">4.2 Audit Management Context<a class="headerlink" href="#42-audit-management-context" title="Permanent link">&para;</a></h3>
<p><strong>概要</strong></p>
<p>監査セットと監査グループを管理するコアコンテキスト。監査対象のグループ化とアクセス制御を提供。</p>
<p><strong>ユビキタス言語</strong></p>
<table>
<thead>
<tr>
<th>用語</th>
<th>定義</th>
<th>他コンテキストとの違い</th>
</tr>
</thead>
<tbody>
<tr>
<td>AuditSet</td>
<td>監査対象ファイルの集合</td>
<td>-</td>
</tr>
<tr>
<td>AuditSetItem</td>
<td>監査セットに登録されたアイテム</td>
<td>File Mgmtでは「Item」</td>
</tr>
<tr>
<td>Collaborator</td>
<td>監査セットへのアクセス権を持つユーザー</td>
<td>Identityでは「User」</td>
</tr>
<tr>
<td>AuditGroup</td>
<td>ユーザーのグループ</td>
<td>-</td>
</tr>
<tr>
<td>Owner</td>
<td>監査セットの所有者（全権限）</td>
<td>-</td>
</tr>
<tr>
<td>CoOwner</td>
<td>共同所有者（編集権限）</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><strong>含まれるエンティティ</strong>
- AuditSet
- AuditSetItem
- AuditSetCollaborators
- AuditGroup
- UserAuditGroup
- AuditGrpAuditSetMapping</p>
<p><strong>提供する機能</strong>
- 監査セットCRUD
- アイテム追加・削除
- コラボレーター管理
- 監査グループ管理
- アクセス制御</p>
<p><strong>依存するコンテキスト</strong>
- Identity &amp; Access: ユーザー情報取得
- File Management: アイテム詳細取得
- Integrity Verification: 改ざん検証実行</p>
<hr />
<h3 id="43-file-management-context">4.3 File Management Context<a class="headerlink" href="#43-file-management-context" title="Permanent link">&para;</a></h3>
<p><strong>概要</strong></p>
<p>BOXのファイル・フォルダ情報を管理するコンテキスト。BOX APIからのデータ取得と整形を担当。</p>
<p><strong>ユビキタス言語</strong></p>
<table>
<thead>
<tr>
<th>用語</th>
<th>定義</th>
<th>他コンテキストとの違い</th>
</tr>
</thead>
<tbody>
<tr>
<td>Item</td>
<td>ファイルまたはフォルダ</td>
<td>監査管理では「AuditSetItem」としてラップ</td>
</tr>
<tr>
<td>ItemStatus</td>
<td>監視・検証ステータス</td>
<td>-</td>
</tr>
<tr>
<td>FileVersion</td>
<td>ファイルのバージョン履歴</td>
<td>-</td>
</tr>
<tr>
<td>SHA1</td>
<td>ファイル内容のハッシュ</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><strong>含まれるエンティティ</strong>
- Item
- ItemStatus
- ItemEvents
- ItemsBySha1</p>
<p><strong>提供する機能</strong>
- ファイル詳細取得
- フォルダ内容一覧
- バージョン履歴取得
- 同一内容ファイル検索</p>
<p><strong>依存するコンテキスト</strong>
- BOX Integration: BOX API呼び出し
- Identity &amp; Access: アクセストークン取得</p>
<hr />
<h3 id="44-event-tracking-context">4.4 Event Tracking Context<a class="headerlink" href="#44-event-tracking-context" title="Permanent link">&para;</a></h3>
<p><strong>概要</strong></p>
<p>BOXエンタープライズイベントの収集・検索を担当するコンテキスト。監査証跡として機能。</p>
<p><strong>ユビキタス言語</strong></p>
<table>
<thead>
<tr>
<th>用語</th>
<th>定義</th>
<th>他コンテキストとの違い</th>
</tr>
</thead>
<tbody>
<tr>
<td>Event</td>
<td>BOXで発生した操作記録</td>
<td>-</td>
</tr>
<tr>
<td>EnterpriseEvent</td>
<td>エンタープライズ全体のイベント</td>
<td>-</td>
</tr>
<tr>
<td>EventType</td>
<td>イベントの種類（UPLOAD/DOWNLOAD等）</td>
<td>-</td>
</tr>
<tr>
<td>PositionTracker</td>
<td>イベント取得の継続位置</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><strong>含まれるエンティティ</strong>
- Events
- EnterpriseEventLogs
- PositionTracker
- AuditorLogs
- SystemEventDates</p>
<p><strong>提供する機能</strong>
- 日付範囲でのイベント検索
- ユーザー別フィルタリング
- イベントタイプ別フィルタリング
- 外部監査人アクセスログ</p>
<p><strong>依存するコンテキスト</strong>
- BOX Integration: エンタープライズイベント取得
- Identity &amp; Access: ユーザー情報</p>
<hr />
<h3 id="45-integrity-verification-context">4.5 Integrity Verification Context<a class="headerlink" href="#45-integrity-verification-context" title="Permanent link">&para;</a></h3>
<p><strong>概要</strong></p>
<p>ScalarDLを使用したファイル改ざん検証を担当するコンテキスト。台帳ベースの不変記録を提供。</p>
<p><strong>ユビキタス言語</strong></p>
<table>
<thead>
<tr>
<th>用語</th>
<th>定義</th>
<th>他コンテキストとの違い</th>
</tr>
</thead>
<tbody>
<tr>
<td>Asset</td>
<td>ScalarDL台帳に登録されたレコード</td>
<td>-</td>
</tr>
<tr>
<td>TamperingStatus</td>
<td>改ざん検証結果</td>
<td>-</td>
</tr>
<tr>
<td>Contract</td>
<td>ScalarDLスマートコントラクト</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><strong>含まれるエンティティ</strong>
- (ScalarDL内部で管理)</p>
<p><strong>提供する機能</strong>
- ファイルハッシュの台帳登録
- 改ざん検証実行
- 検証ステータス取得</p>
<p><strong>依存するコンテキスト</strong>
- File Management: ファイルハッシュ取得
- (外部) ScalarDL Auditor/Ledger</p>
<hr />
<h3 id="46-box-integration-context">4.6 BOX Integration Context<a class="headerlink" href="#46-box-integration-context" title="Permanent link">&para;</a></h3>
<p><strong>概要</strong></p>
<p>BOX Platform APIとの連携を担当するコンテキスト。API認証、呼び出し、エラーハンドリングを抽象化。</p>
<p><strong>ユビキタス言語</strong></p>
<table>
<thead>
<tr>
<th>用語</th>
<th>定義</th>
<th>他コンテキストとの違い</th>
</tr>
</thead>
<tbody>
<tr>
<td>BoxAPIConnection</td>
<td>BOX APIへの接続</td>
<td>-</td>
</tr>
<tr>
<td>EnterpriseID</td>
<td>BOX Enterprise識別子</td>
<td>-</td>
</tr>
<tr>
<td>ServiceAccount</td>
<td>BOX API用サービスアカウント</td>
<td>-</td>
</tr>
</tbody>
</table>
<p><strong>含まれるエンティティ</strong>
- (外部BOX Platform)</p>
<p><strong>提供する機能</strong>
- OAuth認証フロー
- API接続管理
- ファイル/フォルダAPI呼び出し
- イベントAPI呼び出し</p>
<p><strong>依存するコンテキスト</strong>
- (外部) BOX Platform</p>
<hr />
<h2 id="5">5. コンテキストマップ<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 関係パターン一覧<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>上流</th>
<th>下流</th>
<th>パターン</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>BOX Integration</td>
<td>File Management</td>
<td><strong>Conformist</strong></td>
<td>BOX APIの仕様に従う</td>
</tr>
<tr>
<td>BOX Integration</td>
<td>Event Tracking</td>
<td><strong>Conformist</strong></td>
<td>BOX イベント形式に従う</td>
</tr>
<tr>
<td>BOX Integration</td>
<td>Identity &amp; Access</td>
<td><strong>Conformist</strong></td>
<td>BOX OAuth仕様に従う</td>
</tr>
<tr>
<td>Identity &amp; Access</td>
<td>Audit Management</td>
<td><strong>Customer-Supplier</strong></td>
<td>ユーザー情報を提供</td>
</tr>
<tr>
<td>File Management</td>
<td>Audit Management</td>
<td><strong>Customer-Supplier</strong></td>
<td>アイテム情報を提供</td>
</tr>
<tr>
<td>Audit Management</td>
<td>Integrity Verification</td>
<td><strong>Partnership</strong></td>
<td>検証対象を協調管理</td>
</tr>
<tr>
<td>File Management</td>
<td>Integrity Verification</td>
<td><strong>Customer-Supplier</strong></td>
<td>ハッシュ情報を提供</td>
</tr>
<tr>
<td>Event Tracking</td>
<td>Audit Management</td>
<td><strong>Open Host Service</strong></td>
<td>イベント検索APIを公開</td>
</tr>
</tbody>
</table>
<h3 id="52">5.2 コンテキストマップ図<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "External"
        BOX[BOX Platform]
        SDL[ScalarDL]
    end

    subgraph "Generic"
        BI[BOX Integration<br/>Context]
    end

    subgraph "Supporting"
        IA[Identity & Access<br/>Context]
    end

    subgraph "Core"
        AM[Audit Management<br/>Context]
        FM[File Management<br/>Context]
        ET[Event Tracking<br/>Context]
        IV[Integrity Verification<br/>Context]
    end

    BOX -->|Conformist| BI
    BI -->|Conformist| FM
    BI -->|Conformist| ET
    BI -->|Conformist| IA
    IA -->|Customer-Supplier| AM
    FM -->|Customer-Supplier| AM
    FM -->|Customer-Supplier| IV
    AM <-->|Partnership| IV
    ET -->|Open Host Service| AM
    IV -->|Anti-corruption Layer| SDL
</div>

<h3 id="53">5.3 データフロー<a class="headerlink" href="#53" title="Permanent link">&para;</a></h3>
<div class="mermaid">
flowchart LR
    subgraph "外部"
        BOX[(BOX Platform)]
        SDL[(ScalarDL)]
    end

    subgraph "アプリケーション"
        BI[BOX Integration]
        IA[Identity]
        FM[File Mgmt]
        ET[Event Track]
        AM[Audit Mgmt]
        IV[Integrity]
    end

    subgraph "データストア"
        DB[(ScalarDB)]
    end

    BOX <-->|OAuth/API| BI
    BI --> FM
    BI --> ET
    BI --> IA

    IA --> DB
    FM --> DB
    ET --> DB
    AM --> DB
    IV --> DB

    IV <-->|台帳操作| SDL

    FM --> AM
    IV --> AM
    ET --> AM
</div>

<hr />
<h2 id="6">6. 課題と推奨事項<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 境界の曖昧さ<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>課題</th>
<th>現状</th>
<th>推奨</th>
</tr>
</thead>
<tbody>
<tr>
<td>ユーザーとコラボレーターの二重管理</td>
<td>Userモデルが両コンテキストで使用</td>
<td>Collaboratorを独立エンティティ化</td>
</tr>
<tr>
<td>監査セットアイテムとアイテムの関係</td>
<td>強結合</td>
<td>参照IDのみ保持、イベント駆動更新</td>
</tr>
<tr>
<td>BOX連携の分散</td>
<td>各サービスで直接呼び出し</td>
<td>BOX Integration経由に統一</td>
</tr>
</tbody>
</table>
<h3 id="62">6.2 トランザクション境界の問題<a class="headerlink" href="#62" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>問題</th>
<th>影響</th>
<th>対策</th>
</tr>
</thead>
<tbody>
<tr>
<td>複数コンテキストをまたぐトランザクション</td>
<td>データ整合性リスク</td>
<td>Sagaパターン導入</td>
</tr>
<tr>
<td>ScalarDLとScalarDBの二重書き込み</td>
<td>部分失敗リスク</td>
<td>補償トランザクション設計</td>
</tr>
</tbody>
</table>
<h3 id="63">6.3 推奨アクション<a class="headerlink" href="#63" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>短期（1-3ヶ月）</strong></li>
<li>BOX Integration Contextの明確化</li>
<li>
<p>Collaboratorエンティティの独立化</p>
</li>
<li>
<p><strong>中期（3-6ヶ月）</strong></p>
</li>
<li>コンテキスト間通信のAPI化</li>
<li>
<p>イベント駆動アーキテクチャの部分導入</p>
</li>
<li>
<p><strong>長期（6-12ヶ月）</strong></p>
</li>
<li>各コンテキストのマイクロサービス化</li>
<li>Sagaパターンによる分散トランザクション管理</li>
</ol>
<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: scalar-event-log-fetcher-main</em></p>
</article>
<article id="design-context-map">
<h1 id="context-map">コンテキストマップ (Context Map)<a class="headerlink" href="#context-map" title="Permanent link">&para;</a></h1>
<h2 id="1">1. コンテキスト関係図<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 全体マップ<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "Core Domain"
        AM[Audit Management<br/>監査管理]
        IV[Integrity Verification<br/>整合性検証]
        ET[Event Tracking<br/>イベント追跡]
    end

    subgraph "Supporting Domain"
        IA[Identity & Access<br/>認証認可]
        FM[File Management<br/>ファイル管理]
    end

    subgraph "External"
        BI[BOX Integration<br/>BOX連携]
        BOX[(BOX Platform)]
    end

    %% Core Domain内の関係
    AM -->|Partnership| IV
    AM -->|Customer-Supplier| ET
    IV -->|Customer-Supplier| ET

    %% Supporting → Core
    IA -->|Open Host Service| AM
    IA -->|Open Host Service| FM
    FM -->|Customer-Supplier| AM
    FM -->|Customer-Supplier| ET

    %% Integration → All
    BI -->|Anti-corruption Layer| FM
    BI -->|Anti-corruption Layer| IA
    BI -.->|Conformist| BOX

    style AM fill:#e1f5fe
    style IV fill:#e1f5fe
    style ET fill:#e1f5fe
    style IA fill:#fff3e0
    style FM fill:#fff3e0
    style BI fill:#fce4ec
    style BOX fill:#f5f5f5
</div>

<h3 id="12">1.2 データフロー図<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<div class="mermaid">
flowchart LR
    subgraph External
        BOX[BOX Platform]
    end

    subgraph System["Scalar Auditor for BOX"]
        subgraph Integration
            BI[BOX Integration]
        end

        subgraph Core
            AM[Audit Management]
            IV[Integrity Verification]
            ET[Event Tracking]
        end

        subgraph Supporting
            IA[Identity & Access]
            FM[File Management]
        end
    end

    BOX <-->|OAuth/API| BI
    BI -->|File Info| FM
    BI -->|User Info| IA
    BI -->|Events| ET

    IA -->|Auth Token| AM
    IA -->|Auth Token| FM

    FM -->|File Metadata| AM
    FM -->|File Events| ET

    AM -->|Audit Items| IV
    AM -->|Audit Events| ET

    IV -->|Verification Results| ET
</div>

<hr />
<h2 id="2">2. コンテキスト間関係パターン<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21-partnership">2.1 パートナーシップ (Partnership)<a class="headerlink" href="#21-partnership" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph LR
    AM[Audit Management] <-->|Partnership| IV[Integrity Verification]
</div>

<table>
<thead>
<tr>
<th>項目</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>上流</strong></td>
<td>Audit Management</td>
</tr>
<tr>
<td><strong>下流</strong></td>
<td>Integrity Verification</td>
</tr>
<tr>
<td><strong>関係性</strong></td>
<td>相互依存・協調開発</td>
</tr>
<tr>
<td><strong>統合ポイント</strong></td>
<td>監査アイテムの整合性検証</td>
</tr>
<tr>
<td><strong>共有モデル</strong></td>
<td>AuditSetItem, AssetVerificationResult</td>
</tr>
<tr>
<td><strong>調整方法</strong></td>
<td>共同設計、変更時は両チームで合意</td>
</tr>
</tbody>
</table>
<p><strong>インターフェース定義:</strong></p>
<pre class="codehilite"><code class="language-java">// 共有インターフェース
interface AuditItemVerification {
    VerificationResult verifyItem(AuditSetItem item);
    List&lt;VerificationResult&gt; verifyAuditSet(String auditSetId);
    void registerAsset(AuditSetItem item);
}
</code></pre>

<hr />
<h3 id="22-customer-supplier">2.2 顧客-供給者 (Customer-Supplier)<a class="headerlink" href="#22-customer-supplier" title="Permanent link">&para;</a></h3>
<h4 id="221-audit-management-event-tracking">2.2.1 Audit Management → Event Tracking<a class="headerlink" href="#221-audit-management-event-tracking" title="Permanent link">&para;</a></h4>
<div class="mermaid">
graph LR
    AM[Audit Management<br/>Supplier] -->|Events| ET[Event Tracking<br/>Customer]
</div>

<table>
<thead>
<tr>
<th>項目</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>供給者</strong></td>
<td>Audit Management</td>
</tr>
<tr>
<td><strong>顧客</strong></td>
<td>Event Tracking</td>
</tr>
<tr>
<td><strong>関係性</strong></td>
<td>顧客のニーズに応じてイベントを発行</td>
</tr>
<tr>
<td><strong>契約</strong></td>
<td>監査操作イベントの発行</td>
</tr>
</tbody>
</table>
<p><strong>イベント契約:</strong></p>
<pre class="codehilite"><code class="language-java">// 発行イベント
record AuditSetCreatedEvent(String auditSetId, String userId, Instant createdAt);
record AuditItemAddedEvent(String auditSetId, Long itemId, String itemType);
record AuditItemVerifiedEvent(String auditSetId, Long itemId, VerificationStatus status);
</code></pre>

<h4 id="222-file-management-audit-management">2.2.2 File Management → Audit Management<a class="headerlink" href="#222-file-management-audit-management" title="Permanent link">&para;</a></h4>
<div class="mermaid">
graph LR
    FM[File Management<br/>Supplier] -->|File Info| AM[Audit Management<br/>Customer]
</div>

<table>
<thead>
<tr>
<th>項目</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>供給者</strong></td>
<td>File Management</td>
</tr>
<tr>
<td><strong>顧客</strong></td>
<td>Audit Management</td>
</tr>
<tr>
<td><strong>関係性</strong></td>
<td>ファイルメタデータの提供</td>
</tr>
<tr>
<td><strong>契約</strong></td>
<td>ファイル情報取得API</td>
</tr>
</tbody>
</table>
<p><strong>契約インターフェース:</strong></p>
<pre class="codehilite"><code class="language-java">interface FileInfoProvider {
    FileInfo getFileInfo(String fileId);
    List&lt;FileVersion&gt; getFileVersions(String fileId);
    String getFileSha1(String fileId);
}
</code></pre>

<hr />
<h3 id="23-open-host-service">2.3 オープンホストサービス (Open Host Service)<a class="headerlink" href="#23-open-host-service" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    IA[Identity & Access<br/>Open Host Service]
    IA -->|Public API| AM[Audit Management]
    IA -->|Public API| FM[File Management]
    IA -->|Public API| ET[Event Tracking]
</div>

<table>
<thead>
<tr>
<th>項目</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>提供者</strong></td>
<td>Identity &amp; Access</td>
</tr>
<tr>
<td><strong>消費者</strong></td>
<td>全コンテキスト</td>
</tr>
<tr>
<td><strong>サービス</strong></td>
<td>認証・認可API</td>
</tr>
<tr>
<td><strong>プロトコル</strong></td>
<td>JWT Token, Role-Based Access</td>
</tr>
</tbody>
</table>
<p><strong>公開API:</strong></p>
<pre class="codehilite"><code class="language-java">// 認証サービス
interface AuthenticationService {
    AuthToken authenticate(Credentials credentials);
    AuthToken refreshToken(String refreshToken);
    void logout(String userId);
}

// 認可サービス
interface AuthorizationService {
    boolean hasPermission(String userId, Permission permission);
    Set&lt;Role&gt; getUserRoles(String userId);
    boolean canAccessAuditSet(String userId, String auditSetId);
}
</code></pre>

<hr />
<h3 id="24-anti-corruption-layer">2.4 腐敗防止層 (Anti-corruption Layer)<a class="headerlink" href="#24-anti-corruption-layer" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph LR
    subgraph "Internal Model"
        FM[File Management]
        IA[Identity & Access]
    end

    subgraph "Anti-corruption Layer"
        ACL[ACL Adapter]
    end

    subgraph "External"
        BI[BOX Integration]
        BoxPlatform[(BOX Platform)]
    end

    FM <--> ACL
    IA <--> ACL
    ACL <--> BI
    BI <--> BoxPlatform
</div>

<table>
<thead>
<tr>
<th>項目</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>内部モデル</strong></td>
<td>File, Folder, User (ドメインモデル)</td>
</tr>
<tr>
<td><strong>外部モデル</strong></td>
<td>BoxFile, BoxFolder, BoxUser (BOX SDK)</td>
</tr>
<tr>
<td><strong>変換層</strong></td>
<td>BoxApiClient, BoxModelMapper</td>
</tr>
<tr>
<td><strong>目的</strong></td>
<td>BOX SDK変更からドメインモデルを保護</td>
</tr>
</tbody>
</table>
<p><strong>ACL実装例:</strong></p>
<pre class="codehilite"><code class="language-java">// Anti-corruption Layer
class BoxApiClientAdapter implements ExternalStorageClient {
    private final BoxAPIConnection connection;
    private final BoxModelMapper mapper;

    @Override
    public FileInfo getFileInfo(String fileId) {
        BoxFile boxFile = new BoxFile(connection, fileId);
        BoxFile.Info info = boxFile.getInfo(&quot;name&quot;, &quot;size&quot;, &quot;sha1&quot;, &quot;modified_at&quot;);
        return mapper.toFileInfo(info);  // BOXモデル → ドメインモデル
    }
}

// モデル変換
class BoxModelMapper {
    FileInfo toFileInfo(BoxFile.Info boxInfo) {
        return FileInfo.builder()
            .id(boxInfo.getID())
            .name(boxInfo.getName())
            .size(boxInfo.getSize())
            .sha1(boxInfo.getSha1())
            .modifiedAt(boxInfo.getModifiedAt().toInstant())
            .build();
    }
}
</code></pre>

<hr />
<h3 id="25-conformist">2.5 順応者 (Conformist)<a class="headerlink" href="#25-conformist" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph LR
    BI[BOX Integration] -.->|Conformist| BOX[(BOX Platform API)]
</div>

<table>
<thead>
<tr>
<th>項目</th>
<th>内容</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>順応者</strong></td>
<td>BOX Integration</td>
</tr>
<tr>
<td><strong>上流</strong></td>
<td>BOX Platform</td>
</tr>
<tr>
<td><strong>関係性</strong></td>
<td>BOX APIの変更に完全に従う</td>
</tr>
<tr>
<td><strong>リスク</strong></td>
<td>BOX API変更時の影響大</td>
</tr>
<tr>
<td><strong>緩和策</strong></td>
<td>ACL層での変換・バージョン管理</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3">3. 統合パターン詳細<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 同期統合<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant C as Controller
    participant AM as Audit Management
    participant FM as File Management
    participant BI as BOX Integration
    participant BoxPlatform as BOX Platform

    C->>AM: addItemToAuditSet(fileId)
    AM->>FM: getFileInfo(fileId)
    FM->>BI: fetchFileDetails(fileId)
    BI->>BoxPlatform: GET /files/{fileId}
    BoxPlatform-->>BI: BoxFile.Info
    BI-->>FM: FileInfo
    FM-->>AM: FileInfo
    AM->>AM: createAuditSetItem()
    AM-->>C: AuditSetItem
</div>

<h3 id="32">3.2 イベント駆動統合（目標状態）<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant AM as Audit Management
    participant EB as Event Bus
    participant ET as Event Tracking
    participant IV as Integrity Verification

    AM->>EB: publish(AuditItemAddedEvent)
    par Event Tracking
        EB->>ET: consume(AuditItemAddedEvent)
        ET->>ET: logEvent()
    and Integrity Verification
        EB->>IV: consume(AuditItemAddedEvent)
        IV->>IV: scheduleVerification()
    end
</div>

<hr />
<h2 id="4">4. コンテキスト境界の実装<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 パッケージ構造（目標）<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code>com.scalar.auditor/
├── identity/                    # Identity &amp; Access Context
│   ├── api/
│   ├── application/
│   ├── domain/
│   └── infrastructure/
│
├── audit/                       # Audit Management Context
│   ├── api/
│   ├── application/
│   ├── domain/
│   └── infrastructure/
│
├── file/                        # File Management Context
│   ├── api/
│   ├── application/
│   ├── domain/
│   └── infrastructure/
│
├── event/                       # Event Tracking Context
│   ├── api/
│   ├── application/
│   ├── domain/
│   └── infrastructure/
│
├── verification/                # Integrity Verification Context
│   ├── api/
│   ├── application/
│   ├── domain/
│   └── infrastructure/
│
├── box/                         # BOX Integration Context
│   ├── api/
│   ├── application/
│   └── infrastructure/
│       └── acl/                 # Anti-corruption Layer
│
└── shared/                      # Shared Kernel
    ├── events/
    └── types/
</code></pre>

<h3 id="42">4.2 モジュール間通信<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>通信タイプ</th>
<th>使用箇所</th>
<th>実装方式</th>
</tr>
</thead>
<tbody>
<tr>
<td>同期呼び出し</td>
<td>ファイル情報取得</td>
<td>インターフェース注入</td>
</tr>
<tr>
<td>イベント発行</td>
<td>監査操作通知</td>
<td>Spring Events</td>
</tr>
<tr>
<td>共有カーネル</td>
<td>共通型・ID</td>
<td>共有ライブラリ</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="5">5. 移行戦略<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 フェーズ別移行<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<div class="mermaid">
gantt
    title コンテキスト分離ロードマップ
    dateFormat YYYY-MM
    section Phase 1
    Identity分離      :p1-1, 2025-01, 2M
    BOX ACL構築       :p1-2, 2025-02, 2M
    section Phase 2
    Audit分離         :p2-1, 2025-04, 3M
    File分離          :p2-2, 2025-05, 2M
    section Phase 3
    Event分離         :p3-1, 2025-07, 2M
    Verification分離  :p3-2, 2025-08, 2M
</div>

<h3 id="52">5.2 段階的インターフェース導入<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">// Step 1: インターフェース定義
interface AuditSetOperations {
    AuditSetDto createAuditSet(CreateAuditSetCommand cmd);
    void addItem(AddItemCommand cmd);
}

// Step 2: 既存実装をラップ
class AuditSetOperationsAdapter implements AuditSetOperations {
    private final AuditSetService legacyService;
    // 委譲
}

// Step 3: 新実装に置き換え
class AuditSetApplicationService implements AuditSetOperations {
    // 新規実装
}
</code></pre>

<hr />
<h2 id="6">6. リスクと対策<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>リスク</th>
<th>影響</th>
<th>対策</th>
</tr>
</thead>
<tbody>
<tr>
<td>循環依存の残存</td>
<td>分離困難</td>
<td>依存逆転パターン適用</td>
</tr>
<tr>
<td>共有データベース</td>
<td>独立性低下</td>
<td>スキーマ論理分割</td>
</tr>
<tr>
<td>トランザクション跨ぎ</td>
<td>データ不整合</td>
<td>Sagaパターン検討</td>
</tr>
<tr>
<td>パフォーマンス劣化</td>
<td>応答遅延</td>
<td>キャッシュ・非同期化</td>
</tr>
</tbody>
</table>
<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: scalar-event-log-fetcher-main</em></p>
</article>
<article id="design-system-mapping">
<h1 id="system-mapping">システムマッピング (System Mapping)<a class="headerlink" href="#system-mapping" title="Permanent link">&para;</a></h1>
<h2 id="1">1. 現状システム → ドメイン対応表<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 サービス層マッピング<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>現行サービス</th>
<th>行数</th>
<th>対応ドメイン</th>
<th>対応コンテキスト</th>
<th>分割提案</th>
</tr>
</thead>
<tbody>
<tr>
<td>UserService</td>
<td>1116</td>
<td>Identity &amp; Access, BOX Integration</td>
<td>Identity &amp; Access, BOX Integration</td>
<td>AuthService, BoxUserService, UserMgmtService, PasswordService</td>
</tr>
<tr>
<td>AuditSetService</td>
<td>845</td>
<td>Audit Management</td>
<td>Audit Management</td>
<td>AuditSetCrudService, AuditSetAccessService, AuditSetGroupService</td>
</tr>
<tr>
<td>AuditSetItemService</td>
<td>899</td>
<td>Audit Management, Integrity Verification</td>
<td>Audit Management, Integrity Verification</td>
<td>ItemCrudService, MonitoringService, VerificationService</td>
</tr>
<tr>
<td>AuditSetCollaboratorService</td>
<td>288</td>
<td>Audit Management</td>
<td>Audit Management</td>
<td>維持</td>
</tr>
<tr>
<td>AuditGroupService</td>
<td>439</td>
<td>Audit Management</td>
<td>Audit Management</td>
<td>維持</td>
</tr>
<tr>
<td>FileService</td>
<td>555</td>
<td>File Management</td>
<td>File Management</td>
<td>FileDetailsService, FileVersionService</td>
</tr>
<tr>
<td>FolderService</td>
<td>115</td>
<td>File Management</td>
<td>File Management</td>
<td>維持</td>
</tr>
<tr>
<td>EventLogService</td>
<td>222</td>
<td>Event Tracking</td>
<td>Event Tracking</td>
<td>維持</td>
</tr>
<tr>
<td>AssetService</td>
<td>199</td>
<td>Integrity Verification</td>
<td>Integrity Verification</td>
<td>維持</td>
</tr>
<tr>
<td>CommonService</td>
<td>33</td>
<td>共有カーネル</td>
<td>Shared Kernel</td>
<td>維持</td>
</tr>
</tbody>
</table>
<h3 id="12">1.2 リポジトリ層マッピング<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>現行リポジトリ</th>
<th>対応ドメイン</th>
<th>対応コンテキスト</th>
<th>Aggregate</th>
</tr>
</thead>
<tbody>
<tr>
<td>UserRepository</td>
<td>Identity &amp; Access</td>
<td>Identity &amp; Access</td>
<td>User</td>
</tr>
<tr>
<td>RoleUserRepository</td>
<td>Identity &amp; Access</td>
<td>Identity &amp; Access</td>
<td>User</td>
</tr>
<tr>
<td>UserTokenRepository</td>
<td>Identity &amp; Access, BOX Integration</td>
<td>Identity &amp; Access</td>
<td>User</td>
</tr>
<tr>
<td>UserOptRepository</td>
<td>Identity &amp; Access</td>
<td>Identity &amp; Access</td>
<td>User</td>
</tr>
<tr>
<td>OrganizationRepository</td>
<td>Identity &amp; Access</td>
<td>Identity &amp; Access</td>
<td>Organization</td>
</tr>
<tr>
<td>AuditSetRepository</td>
<td>Audit Management</td>
<td>Audit Management</td>
<td>AuditSet</td>
</tr>
<tr>
<td>AuditSetItemRepository</td>
<td>Audit Management</td>
<td>Audit Management</td>
<td>AuditSet</td>
</tr>
<tr>
<td>AuditSetCollaboratorsRepository</td>
<td>Audit Management</td>
<td>Audit Management</td>
<td>AuditSet</td>
</tr>
<tr>
<td>AuditGroupRepository</td>
<td>Audit Management</td>
<td>Audit Management</td>
<td>AuditGroup</td>
</tr>
<tr>
<td>AuditGrpAuditSetMappingRepository</td>
<td>Audit Management</td>
<td>Audit Management</td>
<td>AuditGroup</td>
</tr>
<tr>
<td>UserAuditGroupMappingRepository</td>
<td>Audit Management</td>
<td>Audit Management</td>
<td>AuditGroup</td>
</tr>
<tr>
<td>EventsRepository</td>
<td>Event Tracking</td>
<td>Event Tracking</td>
<td>Event</td>
</tr>
<tr>
<td>ItemEventsRepository</td>
<td>Event Tracking</td>
<td>Event Tracking</td>
<td>Event</td>
</tr>
<tr>
<td>FileMonitoringStatusRepository</td>
<td>File Management</td>
<td>File Management</td>
<td>FileMonitoring</td>
</tr>
<tr>
<td>AuditorLogsRepository</td>
<td>Event Tracking</td>
<td>Event Tracking</td>
<td>AuditLog</td>
</tr>
<tr>
<td>Sha1Repository</td>
<td>File Management, Integrity Verification</td>
<td>File Management</td>
<td>FileSha1</td>
</tr>
</tbody>
</table>
<h3 id="13">1.3 エンティティ層マッピング<a class="headerlink" href="#13" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>現行エンティティ</th>
<th>ドメイン</th>
<th>コンテキスト</th>
<th>種別</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr>
<td>User</td>
<td>Identity &amp; Access</td>
<td>Identity &amp; Access</td>
<td>Aggregate Root</td>
<td></td>
</tr>
<tr>
<td>RoleUser</td>
<td>Identity &amp; Access</td>
<td>Identity &amp; Access</td>
<td>Entity</td>
<td>User配下</td>
</tr>
<tr>
<td>UserToken</td>
<td>Identity &amp; Access</td>
<td>Identity &amp; Access</td>
<td>Value Object</td>
<td></td>
</tr>
<tr>
<td>UserOpt</td>
<td>Identity &amp; Access</td>
<td>Identity &amp; Access</td>
<td>Entity</td>
<td></td>
</tr>
<tr>
<td>Organization</td>
<td>Identity &amp; Access</td>
<td>Identity &amp; Access</td>
<td>Aggregate Root</td>
<td></td>
</tr>
<tr>
<td>AuditSet</td>
<td>Audit Management</td>
<td>Audit Management</td>
<td>Aggregate Root</td>
<td></td>
</tr>
<tr>
<td>AuditSetItem</td>
<td>Audit Management</td>
<td>Audit Management</td>
<td>Entity</td>
<td>AuditSet配下</td>
</tr>
<tr>
<td>AuditSetCollaborators</td>
<td>Audit Management</td>
<td>Audit Management</td>
<td>Entity</td>
<td>AuditSet配下</td>
</tr>
<tr>
<td>AuditGroup</td>
<td>Audit Management</td>
<td>Audit Management</td>
<td>Aggregate Root</td>
<td></td>
</tr>
<tr>
<td>AuditGrpAuditSetMapping</td>
<td>Audit Management</td>
<td>Audit Management</td>
<td>Value Object</td>
<td></td>
</tr>
<tr>
<td>UserAuditGroupMapping</td>
<td>Audit Management</td>
<td>Audit Management</td>
<td>Value Object</td>
<td></td>
</tr>
<tr>
<td>Events</td>
<td>Event Tracking</td>
<td>Event Tracking</td>
<td>Aggregate Root</td>
<td></td>
</tr>
<tr>
<td>ItemEvents</td>
<td>Event Tracking</td>
<td>Event Tracking</td>
<td>Entity</td>
<td>Events配下</td>
</tr>
<tr>
<td>FileMonitoringStatus</td>
<td>File Management</td>
<td>File Management</td>
<td>Entity</td>
<td></td>
</tr>
<tr>
<td>Sha1</td>
<td>Integrity Verification</td>
<td>Integrity Verification</td>
<td>Value Object</td>
<td></td>
</tr>
</tbody>
</table>
<hr />
<h2 id="2">2. コード配置マッピング<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 現行パッケージ → 目標パッケージ<a class="headerlink" href="#21" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code>【現行構造】                          【目標構造】
com.scalar.events_log_tool/           com.scalar.auditor/
├── application/                      ├── identity/
│   ├── controller/                   │   ├── api/
│   │   ├── UserController            │   │   └── UserController
│   │   ├── AuditSetController        │   ├── application/
│   │   └── ...                       │   │   ├── AuthenticationService
│   └── service/                      │   │   ├── UserManagementService
│       ├── UserService               │   │   └── PasswordResetService
│       ├── AuditSetService           │   ├── domain/
│       └── ...                       │   │   ├── User
├── domain/                           │   │   ├── RoleUser
│   └── model/                        │   │   └── UserRepository
│       ├── User                      │   └── infrastructure/
│       ├── AuditSet                  │       └── JpaUserRepository
│       └── ...                       │
├── infrastructure/                   ├── audit/
│   └── repository/                   │   ├── api/
│       ├── UserRepository            │   │   ├── AuditSetController
│       ├── AuditSetRepository        │   │   └── AuditGroupController
│       └── ...                       │   ├── application/
└── utility/                          │   │   ├── AuditSetService
    └── BoxUtility                    │   │   └── AuditGroupService
                                      │   ├── domain/
                                      │   │   ├── AuditSet
                                      │   │   ├── AuditSetItem
                                      │   │   └── AuditGroup
                                      │   └── infrastructure/
                                      │
                                      ├── file/
                                      │   ├── api/
                                      │   ├── application/
                                      │   ├── domain/
                                      │   └── infrastructure/
                                      │
                                      ├── event/
                                      │   ├── api/
                                      │   ├── application/
                                      │   ├── domain/
                                      │   └── infrastructure/
                                      │
                                      ├── verification/
                                      │   ├── api/
                                      │   ├── application/
                                      │   ├── domain/
                                      │   └── infrastructure/
                                      │
                                      ├── box/
                                      │   ├── application/
                                      │   └── infrastructure/
                                      │       └── acl/
                                      │
                                      └── shared/
                                          ├── events/
                                          └── types/
</code></pre>

<hr />
<h2 id="3-api">3. API エンドポイントマッピング<a class="headerlink" href="#3-api" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 現行エンドポイント → コンテキスト<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>エンドポイント</th>
<th>現行Controller</th>
<th>対応コンテキスト</th>
<th>移行先</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>/api/auth/**</code></td>
<td>UserController</td>
<td>Identity &amp; Access</td>
<td>identity/api/AuthController</td>
</tr>
<tr>
<td><code>/api/users/**</code></td>
<td>UserController</td>
<td>Identity &amp; Access</td>
<td>identity/api/UserController</td>
</tr>
<tr>
<td><code>/api/audit-sets/**</code></td>
<td>AuditSetController</td>
<td>Audit Management</td>
<td>audit/api/AuditSetController</td>
</tr>
<tr>
<td><code>/api/audit-groups/**</code></td>
<td>AuditGroupController</td>
<td>Audit Management</td>
<td>audit/api/AuditGroupController</td>
</tr>
<tr>
<td><code>/api/files/**</code></td>
<td>FileController</td>
<td>File Management</td>
<td>file/api/FileController</td>
</tr>
<tr>
<td><code>/api/folders/**</code></td>
<td>FolderController</td>
<td>File Management</td>
<td>file/api/FolderController</td>
</tr>
<tr>
<td><code>/api/events/**</code></td>
<td>EventLogController</td>
<td>Event Tracking</td>
<td>event/api/EventController</td>
</tr>
<tr>
<td><code>/api/box/**</code></td>
<td>(各Controller内)</td>
<td>BOX Integration</td>
<td>box/api/BoxController</td>
</tr>
</tbody>
</table>
<h3 id="32-api">3.2 API分類<a class="headerlink" href="#32-api" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "Public API"
        A1["/api/auth"]
        A2["/api/users"]
        A3["/api/audit-sets"]
        A4["/api/files"]
        A5["/api/events"]
    end

    subgraph "Internal API"
        I1["/internal/verification"]
        I2["/internal/sync"]
    end

    subgraph "Webhook"
        W1["/webhook/box"]
    end

    subgraph "Context"
        C1[Identity & Access]
        C2[Audit Management]
        C3[File Management]
        C4[Event Tracking]
        C5[BOX Integration]
    end

    A1 --> C1
    A2 --> C1
    A3 --> C2
    A4 --> C3
    A5 --> C4
    I1 --> C2
    I2 --> C5
    W1 --> C5
</div>

<hr />
<h2 id="4">4. データベーススキーママッピング<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 テーブル → コンテキスト<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>テーブル</th>
<th>対応コンテキスト</th>
<th>所有権</th>
<th>共有タイプ</th>
</tr>
</thead>
<tbody>
<tr>
<td>users</td>
<td>Identity &amp; Access</td>
<td>専有</td>
<td>参照のみ許可</td>
</tr>
<tr>
<td>role_user</td>
<td>Identity &amp; Access</td>
<td>専有</td>
<td>なし</td>
</tr>
<tr>
<td>user_tokens</td>
<td>Identity &amp; Access</td>
<td>専有</td>
<td>なし</td>
</tr>
<tr>
<td>user_opt</td>
<td>Identity &amp; Access</td>
<td>専有</td>
<td>なし</td>
</tr>
<tr>
<td>organizations</td>
<td>Identity &amp; Access</td>
<td>専有</td>
<td>参照のみ許可</td>
</tr>
<tr>
<td>audit_sets</td>
<td>Audit Management</td>
<td>専有</td>
<td>なし</td>
</tr>
<tr>
<td>audit_set_items</td>
<td>Audit Management</td>
<td>専有</td>
<td>なし</td>
</tr>
<tr>
<td>audit_set_collaborators</td>
<td>Audit Management</td>
<td>専有</td>
<td>なし</td>
</tr>
<tr>
<td>audit_groups</td>
<td>Audit Management</td>
<td>専有</td>
<td>なし</td>
</tr>
<tr>
<td>audit_grp_audit_set_mapping</td>
<td>Audit Management</td>
<td>専有</td>
<td>なし</td>
</tr>
<tr>
<td>user_audit_group_mapping</td>
<td>Audit Management</td>
<td>専有</td>
<td>なし</td>
</tr>
<tr>
<td>events</td>
<td>Event Tracking</td>
<td>専有</td>
<td>なし</td>
</tr>
<tr>
<td>item_events</td>
<td>Event Tracking</td>
<td>専有</td>
<td>なし</td>
</tr>
<tr>
<td>file_monitoring_status</td>
<td>File Management</td>
<td>専有</td>
<td>なし</td>
</tr>
<tr>
<td>sha1</td>
<td>Integrity Verification</td>
<td>専有</td>
<td>なし</td>
</tr>
<tr>
<td>auditor_logs</td>
<td>Event Tracking</td>
<td>専有</td>
<td>なし</td>
</tr>
</tbody>
</table>
<h3 id="42">4.2 スキーマ分割計画<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "Current: Single Schema"
        DB[(ScalarDB Cluster)]
    end

    subgraph "Phase 1: Logical Separation"
        DB1[(auditor_identity)]
        DB2[(auditor_audit)]
        DB3[(auditor_file)]
        DB4[(auditor_event)]
        DB5[(auditor_verification)]
    end

    subgraph "Phase 2: Physical Separation"
        PDB1[(Identity DB)]
        PDB2[(Audit DB)]
        PDB3[(File DB)]
        PDB4[(Event DB)]
        PDB5[(Verification DB)]
    end

    DB --> DB1
    DB --> DB2
    DB --> DB3
    DB --> DB4
    DB --> DB5

    DB1 -.-> PDB1
    DB2 -.-> PDB2
    DB3 -.-> PDB3
    DB4 -.-> PDB4
    DB5 -.-> PDB5
</div>

<hr />
<h2 id="5">5. 外部連携マッピング<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<h3 id="51-box-api">5.1 BOX API連携<a class="headerlink" href="#51-box-api" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>現行利用箇所</th>
<th>BOX API</th>
<th>対応コンテキスト</th>
<th>ACL経由</th>
</tr>
</thead>
<tbody>
<tr>
<td>UserService.registerUserAndSaveToken</td>
<td>OAuth API</td>
<td>Identity &amp; Access</td>
<td>✓</td>
</tr>
<tr>
<td>FileService.getFileDetails</td>
<td>Files API</td>
<td>File Management</td>
<td>✓</td>
</tr>
<tr>
<td>FolderService.getFolderItems</td>
<td>Folders API</td>
<td>File Management</td>
<td>✓</td>
</tr>
<tr>
<td>EventLogService.getEnterpriseEvents</td>
<td>Events API</td>
<td>Event Tracking</td>
<td>✓</td>
</tr>
<tr>
<td>BoxUtility.getConnection</td>
<td>Connection</td>
<td>BOX Integration</td>
<td>-</td>
</tr>
</tbody>
</table>
<h3 id="52-scalardl">5.2 ScalarDL連携<a class="headerlink" href="#52-scalardl" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>現行利用箇所</th>
<th>ScalarDL API</th>
<th>対応コンテキスト</th>
</tr>
</thead>
<tbody>
<tr>
<td>AssetService.registerAsset</td>
<td>Ledger.register</td>
<td>Integrity Verification</td>
</tr>
<tr>
<td>AssetService.validateAsset</td>
<td>Auditor.validate</td>
<td>Integrity Verification</td>
</tr>
<tr>
<td>AssetService.getAssetHistory</td>
<td>Ledger.scan</td>
<td>Integrity Verification</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="6">6. 依存関係マッピング<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 現行依存関係<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TD
    subgraph "Controllers"
        UC[UserController]
        ASC[AuditSetController]
        FC[FileController]
    end

    subgraph "Services"
        US[UserService]
        ASS[AuditSetService]
        ASIS[AuditSetItemService]
        FS[FileService]
        AS[AssetService]
    end

    subgraph "Repositories"
        UR[UserRepository]
        ASR[AuditSetRepository]
        ASIR[AuditSetItemRepository]
        ER[EventsRepository]
    end

    UC --> US
    ASC --> ASS
    ASC --> ASIS
    FC --> FS

    US --> UR
    US --> ASR
    ASS --> ASR
    ASS --> UR
    ASS --> ASIR
    ASIS --> ASS
    ASIS --> AS
    FS --> US
    FS --> ER
</div>

<h3 id="62">6.2 目標依存関係<a class="headerlink" href="#62" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TD
    subgraph "Identity Context"
        IAC[AuthController]
        IAS[AuthService]
        IUR[UserRepository]
    end

    subgraph "Audit Context"
        AAC[AuditController]
        AAS[AuditSetService]
        AAR[AuditSetRepository]
    end

    subgraph "File Context"
        FAC[FileController]
        FAS[FileService]
        FFR[FileRepository]
    end

    subgraph "Verification Context"
        VAS[VerificationService]
        VAR[AssetRepository]
    end

    subgraph "Shared"
        EB[Event Bus]
        SK[Shared Kernel]
    end

    IAC --> IAS
    IAS --> IUR

    AAC --> AAS
    AAS --> AAR
    AAS --> EB
    AAS -.->|Interface| IAS

    FAC --> FAS
    FAS --> FFR
    FAS -.->|Interface| IAS

    VAS --> VAR
    VAS --> EB

    EB --> SK
</div>

<hr />
<h2 id="7">7. 移行チェックリスト<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71-identity-access-context">7.1 Identity &amp; Access Context<a class="headerlink" href="#71-identity-access-context" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] UserService分割</li>
<li>[ ] AuthenticationService抽出</li>
<li>[ ] UserManagementService抽出</li>
<li>[ ] PasswordResetService抽出</li>
<li>[ ] パッケージ移動</li>
<li>[ ] インターフェース定義</li>
<li>[ ] テスト移行</li>
</ul>
<h3 id="72-audit-management-context">7.2 Audit Management Context<a class="headerlink" href="#72-audit-management-context" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] AuditSetService整理</li>
<li>[ ] AuditSetItemService分割</li>
<li>[ ] 循環依存解消</li>
<li>[ ] パッケージ移動</li>
<li>[ ] テスト移行</li>
</ul>
<h3 id="73-file-management-context">7.3 File Management Context<a class="headerlink" href="#73-file-management-context" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] FileService整理</li>
<li>[ ] FolderService統合検討</li>
<li>[ ] BOX ACL経由に変更</li>
<li>[ ] パッケージ移動</li>
<li>[ ] テスト移行</li>
</ul>
<h3 id="74-event-tracking-context">7.4 Event Tracking Context<a class="headerlink" href="#74-event-tracking-context" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] EventLogService維持</li>
<li>[ ] イベント発行者の整理</li>
<li>[ ] パッケージ移動</li>
<li>[ ] テスト移行</li>
</ul>
<h3 id="75-integrity-verification-context">7.5 Integrity Verification Context<a class="headerlink" href="#75-integrity-verification-context" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] AssetService維持</li>
<li>[ ] 検証ロジック抽出</li>
<li>[ ] ScalarDL連携の抽象化</li>
<li>[ ] パッケージ移動</li>
<li>[ ] テスト移行</li>
</ul>
<h3 id="76-box-integration-context">7.6 BOX Integration Context<a class="headerlink" href="#76-box-integration-context" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] BoxApiClient作成</li>
<li>[ ] ACL層実装</li>
<li>[ ] モデルマッパー作成</li>
<li>[ ] パッケージ移動</li>
<li>[ ] テスト移行</li>
</ul>
<hr />
<h2 id="8">8. 影響分析<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 変更影響マトリクス<a class="headerlink" href="#81" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>変更対象</th>
<th style="text-align: center;">Identity</th>
<th style="text-align: center;">Audit</th>
<th style="text-align: center;">File</th>
<th style="text-align: center;">Event</th>
<th style="text-align: center;">Verification</th>
<th style="text-align: center;">BOX</th>
</tr>
</thead>
<tbody>
<tr>
<td>UserService分割</td>
<td style="text-align: center;">◎</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">○</td>
</tr>
<tr>
<td>AuditSet循環依存解消</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">◎</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">-</td>
</tr>
<tr>
<td>BOX ACL導入</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">◎</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">◎</td>
</tr>
<tr>
<td>スキーマ分割</td>
<td style="text-align: center;">◎</td>
<td style="text-align: center;">◎</td>
<td style="text-align: center;">◎</td>
<td style="text-align: center;">◎</td>
<td style="text-align: center;">◎</td>
<td style="text-align: center;">-</td>
</tr>
</tbody>
</table>
<p>◎: 直接影響, ○: 間接影響, -: 影響なし</p>
<h3 id="82">8.2 リスク評価<a class="headerlink" href="#82" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>マッピング項目</th>
<th style="text-align: center;">リスクレベル</th>
<th>理由</th>
</tr>
</thead>
<tbody>
<tr>
<td>UserService分割</td>
<td style="text-align: center;">高</td>
<td>全コンテキストが依存</td>
</tr>
<tr>
<td>循環依存解消</td>
<td style="text-align: center;">中</td>
<td>Audit内で完結</td>
</tr>
<tr>
<td>BOX ACL導入</td>
<td style="text-align: center;">中</td>
<td>外部API変更リスク</td>
</tr>
<tr>
<td>スキーマ分割</td>
<td style="text-align: center;">高</td>
<td>トランザクション影響</td>
</tr>
</tbody>
</table>
<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: scalar-event-log-fetcher-main</em></p>
</article>
<article id="design-target-architecture">
<h1 id="target-architecture">ターゲットアーキテクチャ (Target Architecture)<a class="headerlink" href="#target-architecture" title="Permanent link">&para;</a></h1>
<h2 id="1">1. アーキテクチャ概要<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 目標アーキテクチャ<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "Client Layer"
        WEB[Web App<br/>React]
        MOBILE[Mobile App]
    end

    subgraph "API Gateway"
        GW[API Gateway<br/>Kong/AWS API Gateway]
    end

    subgraph "Microservices"
        IS[Identity Service]
        AS[Audit Service]
        FS[File Service]
        ES[Event Service]
        VS[Verification Service]
        BS[BOX Integration Service]
    end

    subgraph "Data Layer"
        subgraph "ScalarDB Cluster"
            SDB[ScalarDB]
        end
        subgraph "Storage"
            PG[(PostgreSQL)]
            CS[(Cassandra)]
        end
        SDL[(ScalarDL)]
    end

    subgraph "Infrastructure"
        MQ[Message Queue<br/>RabbitMQ/Kafka]
        CACHE[Cache<br/>Redis]
        LOGS[Logging<br/>ELK Stack]
    end

    WEB --> GW
    MOBILE --> GW

    GW --> IS
    GW --> AS
    GW --> FS
    GW --> ES
    GW --> VS

    IS --> SDB
    AS --> SDB
    FS --> SDB
    ES --> SDB
    VS --> SDB
    VS --> SDL

    AS --> MQ
    ES --> MQ
    VS --> MQ

    IS --> CACHE
    FS --> CACHE

    BS --> IS
    BS --> FS
    BS --> ES

    SDB --> PG
    SDB --> CS
</div>

<h3 id="12">1.2 サービス一覧<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>サービス</th>
<th>責務</th>
<th>技術スタック</th>
<th>チームサイズ</th>
</tr>
</thead>
<tbody>
<tr>
<td>Identity Service</td>
<td>認証・認可・ユーザー管理</td>
<td>Spring Boot, JWT</td>
<td>2-3名</td>
</tr>
<tr>
<td>Audit Service</td>
<td>監査セット・グループ管理</td>
<td>Spring Boot</td>
<td>3-4名</td>
</tr>
<tr>
<td>File Service</td>
<td>ファイル・フォルダ情報管理</td>
<td>Spring Boot</td>
<td>2-3名</td>
</tr>
<tr>
<td>Event Service</td>
<td>イベントログ収集・検索</td>
<td>Spring Boot</td>
<td>2名</td>
</tr>
<tr>
<td>Verification Service</td>
<td>改ざん検証</td>
<td>Spring Boot, ScalarDL</td>
<td>2名</td>
</tr>
<tr>
<td>BOX Integration Service</td>
<td>BOX API連携</td>
<td>Spring Boot</td>
<td>2名</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="2">2. サービス詳細設計<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21-identity-service">2.1 Identity Service<a class="headerlink" href="#21-identity-service" title="Permanent link">&para;</a></h3>
<p><strong>責務:</strong>
- ユーザー認証（BOX OAuth / パスワード）
- JWT発行・検証
- ユーザーCRUD
- ロール・権限管理
- 組織管理</p>
<p><strong>API仕様:</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td>/api/v1/auth/login</td>
<td>ログイン</td>
</tr>
<tr>
<td>POST</td>
<td>/api/v1/auth/token/refresh</td>
<td>トークン更新</td>
</tr>
<tr>
<td>POST</td>
<td>/api/v1/auth/logout</td>
<td>ログアウト</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/users</td>
<td>ユーザー一覧</td>
</tr>
<tr>
<td>POST</td>
<td>/api/v1/users</td>
<td>ユーザー作成</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/users/{id}</td>
<td>ユーザー詳細</td>
</tr>
<tr>
<td>PUT</td>
<td>/api/v1/users/{id}</td>
<td>ユーザー更新</td>
</tr>
<tr>
<td>DELETE</td>
<td>/api/v1/users/{id}</td>
<td>ユーザー削除</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/organizations</td>
<td>組織一覧</td>
</tr>
</tbody>
</table>
<p><strong>データモデル:</strong></p>
<div class="mermaid">
erDiagram
    USERS {
        string user_email PK
        bigint user_id UK
        string name
        string password_hash
        string role
        string org_id FK
        boolean is_deleted
        bigint created_at
    }

    USER_TOKENS {
        string user_email PK
        string token_type PK
        string refresh_token
        bigint expires_at
    }

    ORGANIZATIONS {
        string org_id PK
        string enterprise_id
        string org_name
        boolean is_active
    }

    USERS ||--o{ USER_TOKENS : has
    ORGANIZATIONS ||--o{ USERS : contains
</div>

<p><strong>依存サービス:</strong>
- BOX Integration Service (OAuth)</p>
<hr />
<h3 id="22-audit-service">2.2 Audit Service<a class="headerlink" href="#22-audit-service" title="Permanent link">&para;</a></h3>
<p><strong>責務:</strong>
- 監査セットCRUD
- 監査セットアイテム管理
- コラボレーター管理
- 監査グループ管理
- アクセス制御</p>
<p><strong>API仕様:</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/api/v1/audit-sets</td>
<td>監査セット一覧</td>
</tr>
<tr>
<td>POST</td>
<td>/api/v1/audit-sets</td>
<td>監査セット作成</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/audit-sets/{id}</td>
<td>監査セット詳細</td>
</tr>
<tr>
<td>PUT</td>
<td>/api/v1/audit-sets/{id}</td>
<td>監査セット更新</td>
</tr>
<tr>
<td>DELETE</td>
<td>/api/v1/audit-sets/{id}</td>
<td>監査セット削除</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/audit-sets/{id}/items</td>
<td>アイテム一覧</td>
</tr>
<tr>
<td>POST</td>
<td>/api/v1/audit-sets/{id}/items</td>
<td>アイテム追加</td>
</tr>
<tr>
<td>DELETE</td>
<td>/api/v1/audit-sets/{id}/items/{itemId}</td>
<td>アイテム削除</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/audit-sets/{id}/collaborators</td>
<td>コラボレーター一覧</td>
</tr>
<tr>
<td>POST</td>
<td>/api/v1/audit-sets/{id}/collaborators</td>
<td>コラボレーター招待</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/audit-groups</td>
<td>監査グループ一覧</td>
</tr>
<tr>
<td>POST</td>
<td>/api/v1/audit-groups</td>
<td>監査グループ作成</td>
</tr>
</tbody>
</table>
<p><strong>データモデル:</strong></p>
<div class="mermaid">
erDiagram
    AUDIT_SETS {
        string audit_set_id PK
        string audit_set_name
        string description
        bigint owner_id
        string owner_email
        boolean is_deleted
        bigint created_at
    }

    AUDIT_SET_ITEMS {
        string audit_set_id PK
        bigint item_id PK
        string item_name
        string item_type
        string monitoring_status
        string verification_status
    }

    AUDIT_SET_COLLABORATORS {
        string audit_set_id PK
        string user_email PK
        string collaborator_role
        bigint created_at
    }

    AUDIT_GROUPS {
        string audit_group_id PK
        string audit_group_name
        bigint owner_id
        boolean is_deleted
    }

    AUDIT_SETS ||--o{ AUDIT_SET_ITEMS : contains
    AUDIT_SETS ||--o{ AUDIT_SET_COLLABORATORS : has
    AUDIT_GROUPS ||--o{ AUDIT_SETS : links
</div>

<p><strong>依存サービス:</strong>
- Identity Service (ユーザー情報)
- File Service (アイテム情報)
- Verification Service (検証実行)
- Event Service (イベント発行)</p>
<hr />
<h3 id="23-file-service">2.3 File Service<a class="headerlink" href="#23-file-service" title="Permanent link">&para;</a></h3>
<p><strong>責務:</strong>
- ファイル・フォルダ情報取得
- ファイルバージョン管理
- 監視ステータス管理
- 重複ファイル検出（SHA1）</p>
<p><strong>API仕様:</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/api/v1/files/{id}</td>
<td>ファイル詳細</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/files/{id}/versions</td>
<td>バージョン一覧</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/files/{id}/collaborators</td>
<td>コラボレーター一覧</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/folders/{id}</td>
<td>フォルダ詳細</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/folders/{id}/items</td>
<td>フォルダ内アイテム</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/items/by-sha1/{sha1}</td>
<td>SHA1でアイテム検索</td>
</tr>
<tr>
<td>PUT</td>
<td>/api/v1/items/{id}/monitoring</td>
<td>監視ステータス更新</td>
</tr>
</tbody>
</table>
<p><strong>依存サービス:</strong>
- BOX Integration Service (BOX API呼び出し)
- Identity Service (認証)</p>
<hr />
<h3 id="24-event-service">2.4 Event Service<a class="headerlink" href="#24-event-service" title="Permanent link">&para;</a></h3>
<p><strong>責務:</strong>
- BOXイベント収集
- イベント検索・フィルタリング
- 監査ログ記録
- イベント日付管理</p>
<p><strong>API仕様:</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>GET</td>
<td>/api/v1/events</td>
<td>イベント検索</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/events/dates</td>
<td>利用可能日付一覧</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/events/by-item/{itemId}</td>
<td>アイテム別イベント</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/auditor-logs</td>
<td>監査人ログ一覧</td>
</tr>
<tr>
<td>POST</td>
<td>/api/v1/events/sync</td>
<td>イベント同期実行</td>
</tr>
</tbody>
</table>
<p><strong>依存サービス:</strong>
- BOX Integration Service (エンタープライズイベント取得)
- Identity Service (ユーザー情報)</p>
<hr />
<h3 id="25-verification-service">2.5 Verification Service<a class="headerlink" href="#25-verification-service" title="Permanent link">&para;</a></h3>
<p><strong>責務:</strong>
- ファイルハッシュの台帳登録
- 改ざん検証実行
- 検証ステータス管理</p>
<p><strong>API仕様:</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td>/api/v1/verification/register</td>
<td>台帳登録</td>
</tr>
<tr>
<td>POST</td>
<td>/api/v1/verification/verify</td>
<td>改ざん検証</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/verification/status/{itemId}</td>
<td>検証ステータス</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/verification/history/{itemId}</td>
<td>検証履歴</td>
</tr>
</tbody>
</table>
<p><strong>依存サービス:</strong>
- File Service (ファイルハッシュ取得)
- ScalarDL (台帳操作)</p>
<hr />
<h3 id="26-box-integration-service">2.6 BOX Integration Service<a class="headerlink" href="#26-box-integration-service" title="Permanent link">&para;</a></h3>
<p><strong>責務:</strong>
- BOX OAuth認証フロー
- BOX API接続管理
- ファイル/フォルダAPI呼び出し
- エンタープライズイベント取得
- レート制限・リトライ処理</p>
<p><strong>API仕様:</strong></p>
<table>
<thead>
<tr>
<th>Method</th>
<th>Endpoint</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>POST</td>
<td>/api/v1/box/oauth/authorize</td>
<td>OAuth認可開始</td>
</tr>
<tr>
<td>POST</td>
<td>/api/v1/box/oauth/callback</td>
<td>OAuthコールバック</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/box/files/{id}</td>
<td>BOXファイル取得</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/box/folders/{id}/items</td>
<td>BOXフォルダアイテム</td>
</tr>
<tr>
<td>GET</td>
<td>/api/v1/box/events</td>
<td>BOXイベント取得</td>
</tr>
</tbody>
</table>
<p><strong>外部依存:</strong>
- BOX Platform API</p>
<hr />
<h2 id="3">3. サービス間通信<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31-restgrpc">3.1 同期通信（REST/gRPC）<a class="headerlink" href="#31-restgrpc" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant Client
    participant GW as API Gateway
    participant AS as Audit Service
    participant FS as File Service
    participant BS as BOX Integration

    Client->>GW: POST /audit-sets/{id}/items
    GW->>AS: addItem(auditSetId, itemId)
    AS->>FS: getFileInfo(itemId)
    FS->>BS: fetchFileDetails(itemId)
    BS->>BS: BOX API Call
    BS-->>FS: BoxFile
    FS-->>AS: FileInfo
    AS->>AS: createAuditSetItem()
    AS-->>GW: AuditSetItem
    GW-->>Client: 201 Created
</div>

<h3 id="32">3.2 非同期通信（イベント駆動）<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant AS as Audit Service
    participant MQ as Message Queue
    participant ES as Event Service
    participant VS as Verification Service

    AS->>MQ: publish(ItemAddedEvent)

    par Event Service
        MQ->>ES: consume(ItemAddedEvent)
        ES->>ES: recordAuditLog()
    and Verification Service
        MQ->>VS: consume(ItemAddedEvent)
        VS->>VS: scheduleVerification()
    end
</div>

<h3 id="33">3.3 イベント定義<a class="headerlink" href="#33" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">// ドメインイベント
public record AuditSetCreatedEvent(
    String auditSetId,
    String ownerEmail,
    Instant createdAt
) {}

public record ItemAddedToAuditSetEvent(
    String auditSetId,
    Long itemId,
    String itemType,
    String addedBy,
    Instant addedAt
) {}

public record ItemVerifiedEvent(
    Long itemId,
    String auditSetId,
    VerificationStatus status,
    Instant verifiedAt
) {}

public record CollaboratorInvitedEvent(
    String auditSetId,
    String inviteeEmail,
    String role,
    String invitedBy,
    Instant invitedAt
) {}
</code></pre>

<hr />
<h2 id="4-api-gateway">4. API Gateway設計<a class="headerlink" href="#4-api-gateway" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 ルーティング設定<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-yaml"># Kong Gateway Configuration
services:
  - name: identity-service
    url: http://identity-service:8080
    routes:
      - name: auth-routes
        paths: [&quot;/api/v1/auth&quot;]
      - name: user-routes
        paths: [&quot;/api/v1/users&quot;]
      - name: org-routes
        paths: [&quot;/api/v1/organizations&quot;]

  - name: audit-service
    url: http://audit-service:8080
    routes:
      - name: audit-set-routes
        paths: [&quot;/api/v1/audit-sets&quot;]
      - name: audit-group-routes
        paths: [&quot;/api/v1/audit-groups&quot;]

  - name: file-service
    url: http://file-service:8080
    routes:
      - name: file-routes
        paths: [&quot;/api/v1/files&quot;]
      - name: folder-routes
        paths: [&quot;/api/v1/folders&quot;]
      - name: item-routes
        paths: [&quot;/api/v1/items&quot;]

  - name: event-service
    url: http://event-service:8080
    routes:
      - name: event-routes
        paths: [&quot;/api/v1/events&quot;]
      - name: auditor-log-routes
        paths: [&quot;/api/v1/auditor-logs&quot;]

  - name: verification-service
    url: http://verification-service:8080
    routes:
      - name: verification-routes
        paths: [&quot;/api/v1/verification&quot;]
</code></pre>

<h3 id="42">4.2 認証・認可<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-yaml"># JWT Plugin Configuration
plugins:
  - name: jwt
    config:
      claims_to_verify:
        - exp
      key_claim_name: kid
      secret_is_base64: false

  - name: acl
    config:
      allow:
        - admin
        - user
</code></pre>

<h3 id="43">4.3 レート制限<a class="headerlink" href="#43" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-yaml">plugins:
  - name: rate-limiting
    config:
      second: 100
      minute: 1000
      hour: 10000
      policy: local
</code></pre>

<hr />
<h2 id="5">5. データ整合性<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 分散トランザクション戦略<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>シナリオ</th>
<th>パターン</th>
<th>整合性</th>
</tr>
</thead>
<tbody>
<tr>
<td>監査セット作成</td>
<td>ScalarDB TX</td>
<td>強整合</td>
</tr>
<tr>
<td>アイテム追加</td>
<td>ScalarDB TX + Event</td>
<td>強整合</td>
</tr>
<tr>
<td>コラボレーター招待</td>
<td>ScalarDB TX</td>
<td>強整合</td>
</tr>
<tr>
<td>検証実行</td>
<td>Saga</td>
<td>結果整合</td>
</tr>
<tr>
<td>監査セット削除</td>
<td>Saga</td>
<td>結果整合</td>
</tr>
</tbody>
</table>
<h3 id="52-saga">5.2 Sagaオーケストレーション<a class="headerlink" href="#52-saga" title="Permanent link">&para;</a></h3>
<div class="mermaid">
stateDiagram-v2
    [*] --> AuditSetDeleting
    AuditSetDeleting --> ItemsUnmonitoring: markDeleted
    ItemsUnmonitoring --> VerificationArchiving: removeMonitoring
    VerificationArchiving --> EventLogging: archiveRecords
    EventLogging --> Completed: logDeletion
    Completed --> [*]

    ItemsUnmonitoring --> Compensating: failure
    VerificationArchiving --> Compensating: failure
    Compensating --> AuditSetRestored: compensate
    AuditSetRestored --> [*]
</div>

<hr />
<h2 id="6">6. デプロイメント<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="61-kubernetes">6.1 Kubernetes構成<a class="headerlink" href="#61-kubernetes" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-yaml"># Identity Service Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: identity-service
spec:
  replicas: 3
  selector:
    matchLabels:
      app: identity-service
  template:
    metadata:
      labels:
        app: identity-service
    spec:
      containers:
      - name: identity-service
        image: auditor/identity-service:latest
        ports:
        - containerPort: 8080
        resources:
          requests:
            cpu: &quot;500m&quot;
            memory: &quot;512Mi&quot;
          limits:
            cpu: &quot;1&quot;
            memory: &quot;1Gi&quot;
        env:
        - name: SPRING_PROFILES_ACTIVE
          value: &quot;production&quot;
        - name: SCALARDB_CONFIG
          valueFrom:
            secretKeyRef:
              name: scalardb-config
              key: config
        livenessProbe:
          httpGet:
            path: /actuator/health/liveness
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /actuator/health/readiness
            port: 8080
          initialDelaySeconds: 5
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: identity-service
spec:
  selector:
    app: identity-service
  ports:
  - port: 8080
    targetPort: 8080
</code></pre>

<h3 id="62">6.2 サービスメッシュ<a class="headerlink" href="#62" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-yaml"># Istio VirtualService
apiVersion: networking.istio.io/v1alpha3
kind: VirtualService
metadata:
  name: audit-service
spec:
  hosts:
  - audit-service
  http:
  - match:
    - headers:
        x-canary:
          exact: &quot;true&quot;
    route:
    - destination:
        host: audit-service
        subset: canary
      weight: 100
  - route:
    - destination:
        host: audit-service
        subset: stable
      weight: 100
</code></pre>

<hr />
<h2 id="7">7. 可観測性<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 ログ設計<a class="headerlink" href="#71" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;timestamp&quot;: &quot;2025-01-15T10:30:00.000Z&quot;,
  &quot;level&quot;: &quot;INFO&quot;,
  &quot;service&quot;: &quot;audit-service&quot;,
  &quot;traceId&quot;: &quot;abc123&quot;,
  &quot;spanId&quot;: &quot;def456&quot;,
  &quot;userId&quot;: &quot;user@example.com&quot;,
  &quot;action&quot;: &quot;CREATE_AUDIT_SET&quot;,
  &quot;auditSetId&quot;: &quot;uuid-123&quot;,
  &quot;message&quot;: &quot;Audit set created successfully&quot;,
  &quot;duration&quot;: 150
}
</code></pre>

<h3 id="72">7.2 メトリクス<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-yaml"># Prometheus Metrics
- name: http_requests_total
  type: counter
  labels: [service, method, path, status]

- name: http_request_duration_seconds
  type: histogram
  labels: [service, method, path]

- name: scalardb_transaction_total
  type: counter
  labels: [service, namespace, status]

- name: service_health
  type: gauge
  labels: [service]
</code></pre>

<h3 id="73">7.3 分散トレーシング<a class="headerlink" href="#73" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">@RestController
public class AuditSetController {

    @PostMapping(&quot;/api/v1/audit-sets/{id}/items&quot;)
    public ResponseEntity&lt;AuditSetItem&gt; addItem(
            @PathVariable String id,
            @RequestBody AddItemRequest request,
            @RequestHeader(&quot;X-Trace-Id&quot;) String traceId) {

        try (Scope scope = tracer.buildSpan(&quot;addItem&quot;)
                .withTag(&quot;auditSetId&quot;, id)
                .withTag(&quot;itemId&quot;, request.getItemId())
                .startActive(true)) {

            // ビジネスロジック
            return ResponseEntity.ok(result);
        }
    }
}
</code></pre>

<hr />
<h2 id="8">8. セキュリティ<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 認証フロー<a class="headerlink" href="#81" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant User
    participant GW as API Gateway
    participant IS as Identity Service
    participant BoxPlatform as BOX Platform

    User->>GW: POST /auth/login (BOX OAuth)
    GW->>IS: initiateOAuth()
    IS->>BoxPlatform: OAuth Authorize
    BoxPlatform-->>User: Redirect to login
    User->>BoxPlatform: Login credentials
    BoxPlatform-->>IS: Authorization code
    IS->>BoxPlatform: Exchange for token
    BoxPlatform-->>IS: Access token + Refresh token
    IS->>IS: Create JWT
    IS-->>GW: JWT
    GW-->>User: JWT
</div>

<h3 id="82">8.2 認可マトリクス<a class="headerlink" href="#82" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>ロール</th>
<th style="text-align: center;">監査セット作成</th>
<th style="text-align: center;">アイテム追加</th>
<th style="text-align: center;">コラボレーター招待</th>
<th style="text-align: center;">削除</th>
</tr>
</thead>
<tbody>
<tr>
<td>AUDIT_ADMIN</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">○</td>
</tr>
<tr>
<td>AUDIT_GENERAL</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">-</td>
</tr>
<tr>
<td>EXTERNAL_AUDITOR</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">-</td>
</tr>
<tr>
<td>OWNER</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">○</td>
</tr>
<tr>
<td>CO_OWNER</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">-</td>
</tr>
<tr>
<td>MEMBER</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">-</td>
</tr>
<tr>
<td>REVIEWER</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">-</td>
<td style="text-align: center;">-</td>
</tr>
</tbody>
</table>
<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: scalar-event-log-fetcher-main</em></p>
</article>
<article id="design-transformation-plan">
<h1 id="transformation-plan">変換計画 (Transformation Plan)<a class="headerlink" href="#transformation-plan" title="Permanent link">&para;</a></h1>
<h2 id="1">1. 変換概要<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 現状 → 目標<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph LR
    subgraph "As-Is"
        MONO[Monolithic<br/>Spring Boot App]
        SDB1[(ScalarDB<br/>Single)]
    end

    subgraph "To-Be"
        IS[Identity Service]
        AS[Audit Service]
        FS[File Service]
        ES[Event Service]
        VS[Verification Service]
        BS[BOX Service]
        SDB2[(ScalarDB<br/>Cluster)]
    end

    MONO --> IS
    MONO --> AS
    MONO --> FS
    MONO --> ES
    MONO --> VS
    MONO --> BS
    SDB1 --> SDB2
</div>

<h3 id="12">1.2 変換戦略<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>戦略</th>
<th>適用</th>
<th>理由</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Strangler Fig</strong></td>
<td>サービス分離</td>
<td>段階的移行でリスク軽減</td>
</tr>
<tr>
<td><strong>Branch by Abstraction</strong></td>
<td>DB移行</td>
<td>並行運用可能</td>
</tr>
<tr>
<td><strong>Change Data Capture</strong></td>
<td>データ同期</td>
<td>リアルタイム同期</td>
</tr>
</tbody>
</table>
<h3 id="13">1.3 フェーズ概要<a class="headerlink" href="#13" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Phase</th>
<th>期間</th>
<th>主要タスク</th>
<th>成果物</th>
</tr>
</thead>
<tbody>
<tr>
<td>Phase 1</td>
<td>3ヶ月</td>
<td>インフラ・基盤構築</td>
<td>K8s環境、CI/CD</td>
</tr>
<tr>
<td>Phase 2</td>
<td>4ヶ月</td>
<td>Identity &amp; BOX分離</td>
<td>2サービス稼働</td>
</tr>
<tr>
<td>Phase 3</td>
<td>4ヶ月</td>
<td>File &amp; Event分離</td>
<td>4サービス稼働</td>
</tr>
<tr>
<td>Phase 4</td>
<td>3ヶ月</td>
<td>Audit &amp; Verification分離</td>
<td>6サービス稼働</td>
</tr>
<tr>
<td>Phase 5</td>
<td>2ヶ月</td>
<td>最適化・完全移行</td>
<td>本番運用開始</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="2-phase-1-3">2. Phase 1: インフラ・基盤構築（3ヶ月）<a class="headerlink" href="#2-phase-1-3" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 タスク一覧<a class="headerlink" href="#21" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>#</th>
<th>タスク</th>
<th>担当</th>
<th>工数</th>
</tr>
</thead>
<tbody>
<tr>
<td>1.1</td>
<td>Kubernetes環境構築</td>
<td>Infra</td>
<td>2週間</td>
</tr>
<tr>
<td>1.2</td>
<td>CI/CDパイプライン構築</td>
<td>DevOps</td>
<td>2週間</td>
</tr>
<tr>
<td>1.3</td>
<td>ScalarDB Cluster構築</td>
<td>Infra</td>
<td>2週間</td>
</tr>
<tr>
<td>1.4</td>
<td>監視・ログ基盤構築</td>
<td>DevOps</td>
<td>2週間</td>
</tr>
<tr>
<td>1.5</td>
<td>API Gateway導入</td>
<td>Infra</td>
<td>1週間</td>
</tr>
<tr>
<td>1.6</td>
<td>メッセージキュー導入</td>
<td>Infra</td>
<td>1週間</td>
</tr>
<tr>
<td>1.7</td>
<td>共通ライブラリ作成</td>
<td>Dev</td>
<td>2週間</td>
</tr>
</tbody>
</table>
<h3 id="22-kubernetes">2.2 Kubernetes環境<a class="headerlink" href="#22-kubernetes" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-yaml"># 環境構成
environments:
  development:
    cluster: dev-cluster
    nodes: 3
    resources: small

  staging:
    cluster: stg-cluster
    nodes: 5
    resources: medium

  production:
    cluster: prod-cluster
    nodes: 10
    resources: large
    ha: true
</code></pre>

<h3 id="23-cicd">2.3 CI/CDパイプライン<a class="headerlink" href="#23-cicd" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph LR
    subgraph "CI Pipeline"
        CODE[Code Push] --> BUILD[Build]
        BUILD --> TEST[Unit Test]
        TEST --> SCAN[Security Scan]
        SCAN --> ARTIFACT[Docker Image]
    end

    subgraph "CD Pipeline"
        ARTIFACT --> DEV[Deploy Dev]
        DEV --> STG[Deploy Staging]
        STG --> PROD[Deploy Production]
    end
</div>

<h3 id="24">2.4 共通ライブラリ<a class="headerlink" href="#24" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code>auditor-commons/
├── auditor-common-core/         # 共通ユーティリティ
├── auditor-common-security/     # JWT、認証
├── auditor-common-scalardb/     # ScalarDB設定
├── auditor-common-messaging/    # イベント発行
├── auditor-common-logging/      # ログ設定
└── auditor-common-testing/      # テストユーティリティ
</code></pre>

<h3 id="25">2.5 成果物<a class="headerlink" href="#25" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Kubernetes本番クラスタ稼働</li>
<li>[ ] CI/CDパイプライン稼働</li>
<li>[ ] ScalarDB Cluster稼働</li>
<li>[ ] Prometheus + Grafana稼働</li>
<li>[ ] ELK Stack稼働</li>
<li>[ ] Kong API Gateway稼働</li>
<li>[ ] RabbitMQ稼働</li>
<li>[ ] 共通ライブラリv1.0リリース</li>
</ul>
<hr />
<h2 id="3-phase-2-identity-box4">3. Phase 2: Identity &amp; BOX分離（4ヶ月）<a class="headerlink" href="#3-phase-2-identity-box4" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 分離対象<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<p><strong>現行UserService (1116行) → 2サービスに分割</strong></p>
<div class="mermaid">
graph TB
    subgraph "現行"
        US[UserService<br/>1116行]
    end

    subgraph "目標"
        IS[Identity Service<br/>~500行]
        BS[BOX Integration Service<br/>~400行]
    end

    US --> IS
    US --> BS
</div>

<h3 id="32">3.2 タスク一覧<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>#</th>
<th>タスク</th>
<th>担当</th>
<th>工数</th>
</tr>
</thead>
<tbody>
<tr>
<td>2.1</td>
<td>Identity Serviceプロジェクト作成</td>
<td>Dev</td>
<td>1週間</td>
</tr>
<tr>
<td>2.2</td>
<td>認証機能移行</td>
<td>Dev</td>
<td>2週間</td>
</tr>
<tr>
<td>2.3</td>
<td>ユーザー管理機能移行</td>
<td>Dev</td>
<td>2週間</td>
</tr>
<tr>
<td>2.4</td>
<td>BOX Integration Service作成</td>
<td>Dev</td>
<td>1週間</td>
</tr>
<tr>
<td>2.5</td>
<td>BOX OAuth機能移行</td>
<td>Dev</td>
<td>2週間</td>
</tr>
<tr>
<td>2.6</td>
<td>BOX API連携機能移行</td>
<td>Dev</td>
<td>2週間</td>
</tr>
<tr>
<td>2.7</td>
<td>Anti-corruption Layer実装</td>
<td>Dev</td>
<td>2週間</td>
</tr>
<tr>
<td>2.8</td>
<td>統合テスト</td>
<td>QA</td>
<td>2週間</td>
</tr>
<tr>
<td>2.9</td>
<td>段階的切り替え</td>
<td>DevOps</td>
<td>2週間</td>
</tr>
</tbody>
</table>
<h3 id="33-identity-service">3.3 Identity Service実装<a class="headerlink" href="#33-identity-service" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">// 新Identity Serviceの構造
identity-service/
├── src/main/java/com/scalar/auditor/identity/
│   ├── api/
│   │   ├── AuthController.java
│   │   ├── UserController.java
│   │   └── OrganizationController.java
│   ├── application/
│   │   ├── AuthenticationService.java
│   │   ├── UserManagementService.java
│   │   └── PasswordResetService.java
│   ├── domain/
│   │   ├── User.java
│   │   ├── UserToken.java
│   │   └── Organization.java
│   ├── infrastructure/
│   │   ├── ScalarDbUserRepository.java
│   │   └── JwtTokenProvider.java
│   └── config/
│       └── SecurityConfig.java
└── src/test/
</code></pre>

<h3 id="34-box-integration-service">3.4 BOX Integration Service実装<a class="headerlink" href="#34-box-integration-service" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">// ACL (Anti-corruption Layer) 設計
box-integration-service/
├── src/main/java/com/scalar/auditor/box/
│   ├── api/
│   │   └── BoxController.java
│   ├── application/
│   │   ├── BoxOAuthService.java
│   │   ├── BoxFileService.java
│   │   └── BoxEventService.java
│   ├── infrastructure/
│   │   ├── acl/
│   │   │   ├── BoxApiClient.java      # BOX SDK wrapper
│   │   │   └── BoxModelMapper.java    # BOX → Domain変換
│   │   └── BoxConnectionManager.java
│   └── config/
│       └── BoxConfig.java
</code></pre>

<h3 id="35">3.5 切り替え戦略<a class="headerlink" href="#35" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant LB as Load Balancer
    participant OLD as Monolith (UserService)
    participant NEW_IS as Identity Service
    participant NEW_BS as BOX Service

    Note over LB,NEW_BS: Week 1: 10%トラフィック
    LB->>NEW_IS: 10% /api/auth/*
    LB->>OLD: 90% /api/auth/*

    Note over LB,NEW_BS: Week 2: 50%トラフィック
    LB->>NEW_IS: 50% /api/auth/*
    LB->>OLD: 50% /api/auth/*

    Note over LB,NEW_BS: Week 3: 100%トラフィック
    LB->>NEW_IS: 100% /api/auth/*
    LB->>NEW_BS: 100% /api/box/*
</div>

<h3 id="36">3.6 成果物<a class="headerlink" href="#36" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Identity Service本番稼働</li>
<li>[ ] BOX Integration Service本番稼働</li>
<li>[ ] 旧UserServiceの認証・BOX機能廃止</li>
<li>[ ] API Gateway経由のルーティング</li>
</ul>
<hr />
<h2 id="4-phase-3-file-event4">4. Phase 3: File &amp; Event分離（4ヶ月）<a class="headerlink" href="#4-phase-3-file-event4" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 分離対象<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "現行"
        FS_OLD[FileService<br/>555行]
        FOS_OLD[FolderService<br/>115行]
        ELS_OLD[EventLogService<br/>222行]
    end

    subgraph "目標"
        FS_NEW[File Service<br/>~400行]
        ES_NEW[Event Service<br/>~300行]
    end

    FS_OLD --> FS_NEW
    FOS_OLD --> FS_NEW
    ELS_OLD --> ES_NEW
</div>

<h3 id="42">4.2 タスク一覧<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>#</th>
<th>タスク</th>
<th>担当</th>
<th>工数</th>
</tr>
</thead>
<tbody>
<tr>
<td>3.1</td>
<td>File Serviceプロジェクト作成</td>
<td>Dev</td>
<td>1週間</td>
</tr>
<tr>
<td>3.2</td>
<td>ファイル情報取得機能移行</td>
<td>Dev</td>
<td>2週間</td>
</tr>
<tr>
<td>3.3</td>
<td>フォルダ機能統合</td>
<td>Dev</td>
<td>1週間</td>
</tr>
<tr>
<td>3.4</td>
<td>監視ステータス機能移行</td>
<td>Dev</td>
<td>2週間</td>
</tr>
<tr>
<td>3.5</td>
<td>Event Serviceプロジェクト作成</td>
<td>Dev</td>
<td>1週間</td>
</tr>
<tr>
<td>3.6</td>
<td>イベント検索機能移行</td>
<td>Dev</td>
<td>2週間</td>
</tr>
<tr>
<td>3.7</td>
<td>監査ログ機能移行</td>
<td>Dev</td>
<td>1週間</td>
</tr>
<tr>
<td>3.8</td>
<td>Cassandraへのイベント移行</td>
<td>Dev</td>
<td>2週間</td>
</tr>
<tr>
<td>3.9</td>
<td>統合テスト</td>
<td>QA</td>
<td>2週間</td>
</tr>
<tr>
<td>3.10</td>
<td>段階的切り替え</td>
<td>DevOps</td>
<td>2週間</td>
</tr>
</tbody>
</table>
<h3 id="43-file-service">4.3 File Service実装<a class="headerlink" href="#43-file-service" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">// File Service構造
file-service/
├── src/main/java/com/scalar/auditor/file/
│   ├── api/
│   │   ├── FileController.java
│   │   ├── FolderController.java
│   │   └── ItemController.java
│   ├── application/
│   │   ├── FileInfoService.java
│   │   ├── FileVersionService.java
│   │   └── MonitoringStatusService.java
│   ├── domain/
│   │   ├── Item.java
│   │   ├── ItemMonitoringStatus.java
│   │   └── FileVersion.java
│   └── infrastructure/
│       ├── ScalarDbItemRepository.java
│       └── BoxIntegrationClient.java  # BOX Service呼び出し
</code></pre>

<h3 id="44-event-servicecassandra">4.4 Event Service実装（Cassandra対応）<a class="headerlink" href="#44-event-servicecassandra" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">// Event Service構造
event-service/
├── src/main/java/com/scalar/auditor/event/
│   ├── api/
│   │   ├── EventController.java
│   │   └── AuditorLogController.java
│   ├── application/
│   │   ├── EventSearchService.java
│   │   ├── EventSyncService.java
│   │   └── AuditorLogService.java
│   ├── domain/
│   │   ├── Event.java
│   │   ├── AuditorLog.java
│   │   └── PositionTracker.java
│   └── infrastructure/
│       ├── ScalarDbEventRepository.java  # Cassandra経由
│       └── BoxIntegrationClient.java
</code></pre>

<h3 id="45">4.5 成果物<a class="headerlink" href="#45" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] File Service本番稼働</li>
<li>[ ] Event Service本番稼働（Cassandra）</li>
<li>[ ] イベントデータCassandra移行完了</li>
<li>[ ] 旧サービス機能廃止</li>
</ul>
<hr />
<h2 id="5-phase-4-audit-verification3">5. Phase 4: Audit &amp; Verification分離（3ヶ月）<a class="headerlink" href="#5-phase-4-audit-verification3" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 分離対象<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "現行"
        ASS_OLD[AuditSetService<br/>845行]
        ASIS_OLD[AuditSetItemService<br/>899行]
        ASCS_OLD[AuditSetCollaboratorService<br/>288行]
        AGS_OLD[AuditGroupService<br/>439行]
        AS_OLD[AssetService<br/>199行]
    end

    subgraph "目標"
        AS_NEW[Audit Service<br/>~800行]
        VS_NEW[Verification Service<br/>~300行]
    end

    ASS_OLD --> AS_NEW
    ASIS_OLD --> AS_NEW
    ASCS_OLD --> AS_NEW
    AGS_OLD --> AS_NEW
    AS_OLD --> VS_NEW
</div>

<h3 id="52">5.2 タスク一覧<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>#</th>
<th>タスク</th>
<th>担当</th>
<th>工数</th>
</tr>
</thead>
<tbody>
<tr>
<td>4.1</td>
<td>Audit Serviceプロジェクト作成</td>
<td>Dev</td>
<td>1週間</td>
</tr>
<tr>
<td>4.2</td>
<td>監査セット機能移行</td>
<td>Dev</td>
<td>3週間</td>
</tr>
<tr>
<td>4.3</td>
<td>循環依存解消</td>
<td>Dev</td>
<td>2週間</td>
</tr>
<tr>
<td>4.4</td>
<td>コラボレーター機能移行</td>
<td>Dev</td>
<td>2週間</td>
</tr>
<tr>
<td>4.5</td>
<td>監査グループ機能移行</td>
<td>Dev</td>
<td>2週間</td>
</tr>
<tr>
<td>4.6</td>
<td>Verification Service作成</td>
<td>Dev</td>
<td>1週間</td>
</tr>
<tr>
<td>4.7</td>
<td>ScalarDL連携移行</td>
<td>Dev</td>
<td>2週間</td>
</tr>
<tr>
<td>4.8</td>
<td>Sagaパターン実装</td>
<td>Dev</td>
<td>2週間</td>
</tr>
<tr>
<td>4.9</td>
<td>統合テスト</td>
<td>QA</td>
<td>2週間</td>
</tr>
<tr>
<td>4.10</td>
<td>段階的切り替え</td>
<td>DevOps</td>
<td>2週間</td>
</tr>
</tbody>
</table>
<h3 id="53">5.3 循環依存解消<a class="headerlink" href="#53" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">// Before: 循環依存
AuditSetItemService --&gt; AuditSetService
AuditSetService --&gt; AuditSetItemRepository (直接利用)

// After: インターフェース分離
interface AuditSetQueryPort {
    boolean isItemExist(String auditSetId, Long itemId);
    AuditSet findById(String auditSetId);
}

class AuditSetQueryAdapter implements AuditSetQueryPort {
    // AuditSetRepositoryを直接利用
}

class AuditSetItemService {
    private final AuditSetQueryPort auditSetQuery;  // 依存逆転
}
</code></pre>

<h3 id="54-audit-service">5.4 Audit Service実装<a class="headerlink" href="#54-audit-service" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">// Audit Service構造
audit-service/
├── src/main/java/com/scalar/auditor/audit/
│   ├── api/
│   │   ├── AuditSetController.java
│   │   ├── AuditSetItemController.java
│   │   ├── CollaboratorController.java
│   │   └── AuditGroupController.java
│   ├── application/
│   │   ├── AuditSetService.java
│   │   ├── AuditSetItemService.java
│   │   ├── CollaboratorService.java
│   │   ├── AuditGroupService.java
│   │   └── saga/
│   │       └── AuditSetDeletionSaga.java
│   ├── domain/
│   │   ├── AuditSet.java
│   │   ├── AuditSetItem.java
│   │   ├── Collaborator.java
│   │   └── AuditGroup.java
│   └── infrastructure/
│       ├── ScalarDbAuditSetRepository.java
│       ├── IdentityServiceClient.java
│       ├── FileServiceClient.java
│       └── VerificationServiceClient.java
</code></pre>

<h3 id="55-verification-service">5.5 Verification Service実装<a class="headerlink" href="#55-verification-service" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">// Verification Service構造
verification-service/
├── src/main/java/com/scalar/auditor/verification/
│   ├── api/
│   │   └── VerificationController.java
│   ├── application/
│   │   ├── AssetRegistrationService.java
│   │   ├── TamperDetectionService.java
│   │   └── VerificationHistoryService.java
│   ├── domain/
│   │   ├── Asset.java
│   │   ├── VerificationResult.java
│   │   └── TamperingStatus.java
│   └── infrastructure/
│       ├── ScalarDlClient.java
│       └── FileServiceClient.java
</code></pre>

<h3 id="56">5.6 成果物<a class="headerlink" href="#56" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Audit Service本番稼働</li>
<li>[ ] Verification Service本番稼働</li>
<li>[ ] 循環依存完全解消</li>
<li>[ ] Sagaパターン稼働</li>
</ul>
<hr />
<h2 id="6-phase-5-2">6. Phase 5: 最適化・完全移行（2ヶ月）<a class="headerlink" href="#6-phase-5-2" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 タスク一覧<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>#</th>
<th>タスク</th>
<th>担当</th>
<th>工数</th>
</tr>
</thead>
<tbody>
<tr>
<td>5.1</td>
<td>パフォーマンスチューニング</td>
<td>Dev</td>
<td>2週間</td>
</tr>
<tr>
<td>5.2</td>
<td>セキュリティ監査</td>
<td>Security</td>
<td>1週間</td>
</tr>
<tr>
<td>5.3</td>
<td>負荷テスト</td>
<td>QA</td>
<td>2週間</td>
</tr>
<tr>
<td>5.4</td>
<td>DR訓練</td>
<td>Ops</td>
<td>1週間</td>
</tr>
<tr>
<td>5.5</td>
<td>旧モノリス廃止</td>
<td>DevOps</td>
<td>1週間</td>
</tr>
<tr>
<td>5.6</td>
<td>ドキュメント整備</td>
<td>All</td>
<td>1週間</td>
</tr>
</tbody>
</table>
<h3 id="62">6.2 パフォーマンスチューニング<a class="headerlink" href="#62" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-yaml"># チューニング項目
performance:
  - name: Connection Pool
    current: 50
    target: 100
    tuning: &quot;ScalarDB connection pool max&quot;

  - name: Cache Hit Rate
    current: 60%
    target: 90%
    tuning: &quot;Redis caching for user/file info&quot;

  - name: Query Optimization
    current: P99 500ms
    target: P99 200ms
    tuning: &quot;Secondary index追加、N+1解消&quot;

  - name: Async Processing
    current: Sync
    target: Async
    tuning: &quot;イベント発行の非同期化&quot;
</code></pre>

<h3 id="63">6.3 最終検証<a class="headerlink" href="#63" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>検証項目</th>
<th>基準</th>
<th>結果</th>
</tr>
</thead>
<tbody>
<tr>
<td>レスポンスタイム P99</td>
<td>&lt; 500ms</td>
<td>-</td>
</tr>
<tr>
<td>スループット</td>
<td>&gt; 1000 TPS</td>
<td>-</td>
</tr>
<tr>
<td>可用性</td>
<td>99.9%</td>
<td>-</td>
</tr>
<tr>
<td>エラー率</td>
<td>&lt; 0.1%</td>
<td>-</td>
</tr>
<tr>
<td>データ整合性</td>
<td>100%</td>
<td>-</td>
</tr>
</tbody>
</table>
<h3 id="64">6.4 成果物<a class="headerlink" href="#64" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] 全サービス最適化完了</li>
<li>[ ] セキュリティ監査合格</li>
<li>[ ] 負荷テスト合格</li>
<li>[ ] DR訓練完了</li>
<li>[ ] 旧モノリス廃止</li>
<li>[ ] 運用ドキュメント完成</li>
</ul>
<hr />
<h2 id="7">7. リスク管理<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 リスク一覧<a class="headerlink" href="#71" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>リスク</th>
<th>確率</th>
<th>影響</th>
<th>対策</th>
</tr>
</thead>
<tbody>
<tr>
<td>機能退行</td>
<td>高</td>
<td>高</td>
<td>包括的テスト、段階的移行</td>
</tr>
<tr>
<td>パフォーマンス劣化</td>
<td>中</td>
<td>高</td>
<td>ベンチマーク継続、キャッシュ導入</td>
</tr>
<tr>
<td>データ不整合</td>
<td>中</td>
<td>高</td>
<td>ScalarDB TX、データ検証バッチ</td>
</tr>
<tr>
<td>スケジュール遅延</td>
<td>中</td>
<td>中</td>
<td>バッファ確保、優先順位付け</td>
</tr>
<tr>
<td>チーム習熟度</td>
<td>中</td>
<td>中</td>
<td>トレーニング、ペアプログラミング</td>
</tr>
</tbody>
</table>
<h3 id="72">7.2 ロールバック計画<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<div class="mermaid">
stateDiagram-v2
    [*] --> NewService
    NewService --> Monitoring: Deploy
    Monitoring --> Stable: Health OK
    Monitoring --> Rollback: Error Rate > 5%
    Rollback --> OldService: Feature Flag
    OldService --> [*]
    Stable --> [*]
</div>

<hr />
<h2 id="8">8. タイムライン<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<div class="mermaid">
gantt
    title マイクロサービス変換タイムライン
    dateFormat YYYY-MM
    section Phase 1
    インフラ構築          :p1, 2025-01, 3M

    section Phase 2
    Identity分離          :p2-1, after p1, 2M
    BOX Integration分離   :p2-2, after p1, 2M

    section Phase 3
    File分離              :p3-1, after p2-1, 2M
    Event分離             :p3-2, after p2-1, 2M

    section Phase 4
    Audit分離             :p4-1, after p3-1, 2M
    Verification分離      :p4-2, after p3-1, 1M

    section Phase 5
    最適化                :p5-1, after p4-1, 1M
    完全移行              :p5-2, after p5-1, 1M
</div>

<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: scalar-event-log-fetcher-main</em></p>
</article>
<article id="design-operations-plan">
<h1 id="_1">運用計画書<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<h2 id="1">1. エグゼクティブサマリー<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 運用目標<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>指標</th>
<th>目標値</th>
<th>測定方法</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>可用性</strong></td>
<td>99.9% (月間43分以下のダウンタイム)</td>
<td>Prometheus/Grafana</td>
</tr>
<tr>
<td><strong>レイテンシ P99</strong></td>
<td>&lt; 500ms</td>
<td>APM (Datadog/NewRelic)</td>
</tr>
<tr>
<td><strong>スループット</strong></td>
<td>&gt; 1000 TPS</td>
<td>Load Testing</td>
</tr>
<tr>
<td><strong>MTTR</strong></td>
<td>&lt; 30分</td>
<td>Incident Tracking</td>
</tr>
<tr>
<td><strong>デプロイ頻度</strong></td>
<td>週1回以上</td>
<td>CI/CD Pipeline</td>
</tr>
</tbody>
</table>
<h3 id="12">1.2 運用体制<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "運用チーム"
        SRE[SRE Team<br/>2-3名]
        DEV[Development Team<br/>5-7名]
        SEC[Security Team<br/>1-2名]
    end

    subgraph "オンコール"
        P1[Primary On-Call]
        S1[Secondary On-Call]
    end

    subgraph "エスカレーション"
        L1[L1: 自動対応]
        L2[L2: オンコール対応]
        L3[L3: 開発チーム対応]
    end

    SRE --> P1
    DEV --> S1
    L1 --> L2
    L2 --> L3
</div>

<hr />
<h2 id="2">2. インフラストラクチャ運用<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21-kubernetes">2.1 Kubernetes クラスタ管理<a class="headerlink" href="#21-kubernetes" title="Permanent link">&para;</a></h3>
<h4 id="_2">クラスタ構成<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h4>
<pre class="codehilite"><code class="language-yaml"># 本番環境クラスタ構成
production:
  control_plane:
    nodes: 3
    instance_type: m5.xlarge

  worker_pools:
    - name: general
      nodes: 3-10
      instance_type: m5.2xlarge
      autoscaling: true

    - name: scalardb
      nodes: 3
      instance_type: r5.2xlarge
      taints:
        - key: workload
          value: scalardb
          effect: NoSchedule

    - name: monitoring
      nodes: 2
      instance_type: m5.large
</code></pre>

<h4 id="_3">ノード管理手順<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h4>
<pre class="codehilite"><code class="language-bash"># ノードのドレイン（メンテナンス前）
kubectl drain &lt;node-name&gt; --ignore-daemonsets --delete-emptydir-data

# ノードの復帰
kubectl uncordon &lt;node-name&gt;

# ノードの状態確認
kubectl get nodes -o wide
kubectl describe node &lt;node-name&gt;
</code></pre>

<h3 id="22">2.2 データベース運用<a class="headerlink" href="#22" title="Permanent link">&para;</a></h3>
<h4 id="postgresql">PostgreSQL運用<a class="headerlink" href="#postgresql" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>タスク</th>
<th>頻度</th>
<th>担当</th>
</tr>
</thead>
<tbody>
<tr>
<td>バックアップ確認</td>
<td>日次</td>
<td>自動 + アラート</td>
</tr>
<tr>
<td>VACUUM ANALYZE</td>
<td>週次</td>
<td>自動</td>
</tr>
<tr>
<td>インデックス再構築</td>
<td>月次</td>
<td>手動</td>
</tr>
<tr>
<td>統計情報更新</td>
<td>日次</td>
<td>自動</td>
</tr>
<tr>
<td>レプリカ遅延監視</td>
<td>常時</td>
<td>自動</td>
</tr>
</tbody>
</table>
<pre class="codehilite"><code class="language-sql">-- パフォーマンス監視クエリ
SELECT
    schemaname,
    relname,
    seq_scan,
    idx_scan,
    n_live_tup,
    n_dead_tup,
    last_vacuum,
    last_autovacuum
FROM pg_stat_user_tables
WHERE schemaname IN ('identity', 'audit', 'file')
ORDER BY n_dead_tup DESC;

-- 長時間クエリの検出
SELECT
    pid,
    now() - pg_stat_activity.query_start AS duration,
    query,
    state
FROM pg_stat_activity
WHERE (now() - pg_stat_activity.query_start) &gt; interval '5 minutes';
</code></pre>

<h4 id="cassandra">Cassandra運用<a class="headerlink" href="#cassandra" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>タスク</th>
<th>頻度</th>
<th>担当</th>
</tr>
</thead>
<tbody>
<tr>
<td>nodetool repair</td>
<td>週次</td>
<td>自動</td>
</tr>
<tr>
<td>Compaction監視</td>
<td>常時</td>
<td>自動</td>
</tr>
<tr>
<td>スナップショット</td>
<td>日次</td>
<td>自動</td>
</tr>
<tr>
<td>ガベージコレクション</td>
<td>週次</td>
<td>自動</td>
</tr>
</tbody>
</table>
<pre class="codehilite"><code class="language-bash"># クラスタ状態確認
nodetool status

# リペア実行
nodetool repair -pr event

# Compaction状態
nodetool compactionstats
</code></pre>

<hr />
<h2 id="3">3. 監視・アラート設計<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 監視アーキテクチャ<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "Application Layer"
        IS[Identity Service]
        AS[Audit Service]
        FS[File Service]
        ES[Event Service]
        VS[Verification Service]
    end

    subgraph "Observability Stack"
        PROM[Prometheus]
        GRAF[Grafana]
        LOKI[Loki]
        TEMPO[Tempo]
        ALERT[AlertManager]
    end

    subgraph "Notification"
        SLACK[Slack]
        PD[PagerDuty]
        EMAIL[Email]
    end

    IS -->|metrics| PROM
    AS -->|metrics| PROM
    FS -->|metrics| PROM
    ES -->|metrics| PROM
    VS -->|metrics| PROM

    IS -->|logs| LOKI
    AS -->|logs| LOKI
    FS -->|logs| LOKI
    ES -->|logs| LOKI
    VS -->|logs| LOKI

    IS -->|traces| TEMPO
    AS -->|traces| TEMPO
    FS -->|traces| TEMPO
    ES -->|traces| TEMPO
    VS -->|traces| TEMPO

    PROM --> GRAF
    LOKI --> GRAF
    TEMPO --> GRAF
    PROM --> ALERT

    ALERT --> SLACK
    ALERT --> PD
    ALERT --> EMAIL
</div>

<h3 id="32">3.2 アラートルール<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<h4 id="critical">Critical アラート (即時対応)<a class="headerlink" href="#critical" title="Permanent link">&para;</a></h4>
<pre class="codehilite"><code class="language-yaml">groups:
  - name: critical
    rules:
      - alert: ServiceDown
        expr: up{job=~&quot;identity-service|audit-service|file-service|event-service|verification-service&quot;} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &quot;Service {{ $labels.job }} is down&quot;

      - alert: ScalarDBClusterUnhealthy
        expr: scalardb_cluster_healthy_nodes &lt; 2
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: &quot;ScalarDB Cluster has less than 2 healthy nodes&quot;

      - alert: DatabaseConnectionExhausted
        expr: scalardb_jdbc_connection_pool_active / scalardb_jdbc_connection_pool_max &gt; 0.9
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &quot;Database connection pool is nearly exhausted&quot;

      - alert: TransactionErrorRateHigh
        expr: rate(scalardb_transaction_errors_total[5m]) / rate(scalardb_transactions_total[5m]) &gt; 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: &quot;Transaction error rate exceeds 5%&quot;
</code></pre>

<h4 id="warning-1">Warning アラート (1時間以内対応)<a class="headerlink" href="#warning-1" title="Permanent link">&para;</a></h4>
<pre class="codehilite"><code class="language-yaml">groups:
  - name: warning
    rules:
      - alert: HighLatency
        expr: histogram_quantile(0.99, rate(http_request_duration_seconds_bucket[5m])) &gt; 0.5
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: &quot;P99 latency exceeds 500ms&quot;

      - alert: PodRestartLoop
        expr: increase(kube_pod_container_status_restarts_total[1h]) &gt; 3
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: &quot;Pod {{ $labels.pod }} is in restart loop&quot;

      - alert: DiskSpaceRunningLow
        expr: (node_filesystem_avail_bytes / node_filesystem_size_bytes) * 100 &lt; 20
        for: 30m
        labels:
          severity: warning
        annotations:
          summary: &quot;Disk space is below 20%&quot;
</code></pre>

<h3 id="33">3.3 ダッシュボード<a class="headerlink" href="#33" title="Permanent link">&para;</a></h3>
<h4 id="_4">サービス概要ダッシュボード<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>パネル</th>
<th>メトリクス</th>
<th>閾値</th>
</tr>
</thead>
<tbody>
<tr>
<td>リクエストレート</td>
<td><code>rate(http_requests_total[5m])</code></td>
<td>-</td>
</tr>
<tr>
<td>エラーレート</td>
<td><code>rate(http_requests_total{status=~"5.."}[5m])</code></td>
<td>&lt; 1%</td>
</tr>
<tr>
<td>レイテンシ P50/P99</td>
<td><code>histogram_quantile(0.99, ...)</code></td>
<td>&lt; 500ms</td>
</tr>
<tr>
<td>サービス可用性</td>
<td><code>avg(up{job="..."})</code></td>
<td>&gt; 99.9%</td>
</tr>
<tr>
<td>アクティブコネクション</td>
<td><code>scalardb_jdbc_connection_pool_active</code></td>
<td>&lt; 80%</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="4">4. インシデント管理<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 インシデント分類<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>レベル</th>
<th>影響</th>
<th>対応時間</th>
<th>エスカレーション</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>P1 (Critical)</strong></td>
<td>サービス全停止</td>
<td>15分以内</td>
<td>即時エスカレーション</td>
</tr>
<tr>
<td><strong>P2 (High)</strong></td>
<td>主要機能障害</td>
<td>30分以内</td>
<td>1時間後エスカレーション</td>
</tr>
<tr>
<td><strong>P3 (Medium)</strong></td>
<td>一部機能障害</td>
<td>4時間以内</td>
<td>翌営業日</td>
</tr>
<tr>
<td><strong>P4 (Low)</strong></td>
<td>軽微な問題</td>
<td>翌営業日</td>
<td>なし</td>
</tr>
</tbody>
</table>
<h3 id="42">4.2 インシデント対応フロー<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<div class="mermaid">
stateDiagram-v2
    [*] --> Detected: アラート発報
    Detected --> Triaged: 影響範囲確認
    Triaged --> Investigating: 調査開始
    Investigating --> Identified: 原因特定
    Identified --> Mitigating: 緩和措置実施
    Mitigating --> Resolved: 解決確認
    Resolved --> PostMortem: 振り返り
    PostMortem --> [*]: 完了

    Investigating --> Escalated: エスカレーション
    Escalated --> Identified
</div>

<h3 id="43">4.3 ランブック<a class="headerlink" href="#43" title="Permanent link">&para;</a></h3>
<h4 id="_5">サービス障害時の対応<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h4>
<pre class="codehilite"><code class="language-bash"># 1. Pod状態確認
kubectl get pods -n production -l app=&lt;service-name&gt;

# 2. ログ確認
kubectl logs -n production -l app=&lt;service-name&gt; --tail=100

# 3. イベント確認
kubectl get events -n production --sort-by='.lastTimestamp'

# 4. 強制再起動（必要な場合）
kubectl rollout restart deployment/&lt;service-name&gt; -n production

# 5. ロールバック（必要な場合）
kubectl rollout undo deployment/&lt;service-name&gt; -n production
</code></pre>

<h4 id="scalardb">ScalarDB障害時の対応<a class="headerlink" href="#scalardb" title="Permanent link">&para;</a></h4>
<pre class="codehilite"><code class="language-bash"># 1. クラスタ状態確認
kubectl get pods -n scalardb-system

# 2. Coordinator状態確認
kubectl exec -n scalardb-system scalardb-0 -- \
  curl -s http://localhost:8080/health

# 3. トランザクションログ確認
kubectl logs -n scalardb-system scalardb-0 | grep -i &quot;transaction&quot;

# 4. 強制ロールバック（必要な場合）
# ※ 専門家の判断が必要
</code></pre>

<h4 id="_6">データベース障害時の対応<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h4>
<pre class="codehilite"><code class="language-bash"># PostgreSQL
# 1. 接続確認
psql -h postgres-primary -U admin -c &quot;SELECT 1&quot;

# 2. レプリケーション状態
psql -h postgres-primary -U admin -c &quot;SELECT * FROM pg_stat_replication&quot;

# 3. フェイルオーバー実行（Patroni使用時）
patronictl -c /etc/patroni/patroni.yml failover

# Cassandra
# 1. クラスタ状態
nodetool status

# 2. ノード再起動
sudo systemctl restart cassandra
</code></pre>

<hr />
<h2 id="5">5. デプロイメント運用<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 デプロイメント戦略<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph LR
    subgraph "Blue-Green Deployment"
        LB[Load Balancer]
        BLUE[Blue Environment<br/>Current]
        GREEN[Green Environment<br/>New]
    end

    LB -->|100%| BLUE
    LB -.->|0%| GREEN

    subgraph "Canary Deployment"
        LB2[Load Balancer]
        STABLE[Stable<br/>90%]
        CANARY[Canary<br/>10%]
    end

    LB2 -->|90%| STABLE
    LB2 -->|10%| CANARY
</div>

<h3 id="52">5.2 デプロイチェックリスト<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<h4 id="_7">デプロイ前<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h4>
<ul>
<li>[ ] 全テストがパス</li>
<li>[ ] セキュリティスキャン完了</li>
<li>[ ] パフォーマンステスト完了</li>
<li>[ ] DBマイグレーションレビュー完了</li>
<li>[ ] ロールバック手順確認</li>
<li>[ ] 変更内容のドキュメント化</li>
</ul>
<h4 id="_8">デプロイ中<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h4>
<ul>
<li>[ ] Canary デプロイ実行</li>
<li>[ ] エラーレート監視</li>
<li>[ ] レイテンシ監視</li>
<li>[ ] ログ異常確認</li>
<li>[ ] 10分間の安定性確認</li>
</ul>
<h4 id="_9">デプロイ後<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h4>
<ul>
<li>[ ] フルロールアウト完了</li>
<li>[ ] Smoke Test実行</li>
<li>[ ] アラート確認</li>
<li>[ ] ドキュメント更新</li>
</ul>
<h3 id="53">5.3 ロールバック手順<a class="headerlink" href="#53" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-bash"># 1. 即時ロールバック（Deployment）
kubectl rollout undo deployment/&lt;service-name&gt; -n production

# 2. 特定バージョンへのロールバック
kubectl rollout undo deployment/&lt;service-name&gt; -n production --to-revision=&lt;revision&gt;

# 3. ロールバック状態確認
kubectl rollout status deployment/&lt;service-name&gt; -n production

# 4. DBマイグレーションのロールバック（必要な場合）
flyway -url=jdbc:postgresql://... -user=... -password=... undo
</code></pre>

<hr />
<h2 id="6-dr">6. 災害復旧計画 (DR)<a class="headerlink" href="#6-dr" title="Permanent link">&para;</a></h2>
<h3 id="61-dr">6.1 DR目標<a class="headerlink" href="#61-dr" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>指標</th>
<th>目標値</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>RTO</strong> (Recovery Time Objective)</td>
<td>1時間</td>
</tr>
<tr>
<td><strong>RPO</strong> (Recovery Point Objective)</td>
<td>5分</td>
</tr>
</tbody>
</table>
<h3 id="62">6.2 バックアップ戦略<a class="headerlink" href="#62" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "Primary Region (ap-northeast-1)"
        PG_P[(PostgreSQL<br/>Primary)]
        CS_P[(Cassandra<br/>Cluster)]
        S3_P[S3 Backup]
    end

    subgraph "DR Region (ap-northeast-3)"
        PG_DR[(PostgreSQL<br/>Standby)]
        CS_DR[(Cassandra<br/>Replica)]
        S3_DR[S3 Replica]
    end

    PG_P -->|Streaming Replication| PG_DR
    CS_P -->|Multi-DC Replication| CS_DR
    S3_P -->|Cross-Region Replication| S3_DR
</div>

<h3 id="63">6.3 復旧手順<a class="headerlink" href="#63" title="Permanent link">&para;</a></h3>
<h4 id="_10">リージョン障害時<a class="headerlink" href="#_10" title="Permanent link">&para;</a></h4>
<pre class="codehilite"><code class="language-bash"># 1. DRリージョンへのDNS切り替え
aws route53 change-resource-record-sets \
  --hosted-zone-id $ZONE_ID \
  --change-batch file://dr-dns-switch.json

# 2. PostgreSQL スタンバイ昇格
patronictl -c /etc/patroni/patroni.yml switchover --master &lt;dr-node&gt;

# 3. アプリケーション接続先更新
kubectl set env deployment/identity-service \
  DATABASE_URL=jdbc:postgresql://dr-postgres:5432/scalardb

# 4. 動作確認
curl https://api.dr.example.com/health
</code></pre>

<hr />
<h2 id="7">7. 定期メンテナンス<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 メンテナンススケジュール<a class="headerlink" href="#71" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>タスク</th>
<th>頻度</th>
<th>所要時間</th>
<th>ダウンタイム</th>
</tr>
</thead>
<tbody>
<tr>
<td>セキュリティパッチ適用</td>
<td>月次</td>
<td>2時間</td>
<td>なし (ローリング)</td>
</tr>
<tr>
<td>Kubernetesアップグレード</td>
<td>四半期</td>
<td>4時間</td>
<td>なし (ローリング)</td>
</tr>
<tr>
<td>DBバキューム</td>
<td>週次</td>
<td>1時間</td>
<td>なし</td>
</tr>
<tr>
<td>証明書更新</td>
<td>年次</td>
<td>1時間</td>
<td>なし</td>
</tr>
<tr>
<td>負荷テスト</td>
<td>四半期</td>
<td>4時間</td>
<td>なし (ステージング)</td>
</tr>
</tbody>
</table>
<h3 id="72">7.2 メンテナンスウィンドウ<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<ul>
<li><strong>定期メンテナンス</strong>: 毎月第3日曜日 02:00-06:00 JST</li>
<li><strong>緊急メンテナンス</strong>: 随時（事前通知24時間前）</li>
</ul>
<h3 id="73">7.3 メンテナンス通知テンプレート<a class="headerlink" href="#73" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-markdown">## メンテナンス通知

**日時**: 2025-XX-XX 02:00 - 06:00 (JST)
**対象**: Scalar Auditor for BOX
**影響**: サービスへの影響なし（ローリングアップデート）

### 作業内容
- Kubernetesノードのセキュリティパッチ適用
- データベースの定期メンテナンス

### 問い合わせ先
- Slack: #scalar-auditor-support
- Email: support@example.com
</code></pre>

<hr />
<h2 id="8">8. 容量計画<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 リソース使用量予測<a class="headerlink" href="#81" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>リソース</th>
<th>現在</th>
<th>6ヶ月後</th>
<th>12ヶ月後</th>
</tr>
</thead>
<tbody>
<tr>
<td>CPU</td>
<td>40%</td>
<td>55%</td>
<td>70%</td>
</tr>
<tr>
<td>Memory</td>
<td>50%</td>
<td>65%</td>
<td>80%</td>
</tr>
<tr>
<td>Storage (PostgreSQL)</td>
<td>100GB</td>
<td>200GB</td>
<td>400GB</td>
</tr>
<tr>
<td>Storage (Cassandra)</td>
<td>500GB</td>
<td>1TB</td>
<td>2TB</td>
</tr>
</tbody>
</table>
<h3 id="82">8.2 スケーリングトリガー<a class="headerlink" href="#82" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-yaml"># HPA設定
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: identity-service-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: identity-service
  minReplicas: 3
  maxReplicas: 10
  metrics:
    - type: Resource
      resource:
        name: cpu
        target:
          type: Utilization
          averageUtilization: 70
    - type: Resource
      resource:
        name: memory
        target:
          type: Utilization
          averageUtilization: 80
</code></pre>

<hr />
<h2 id="9">9. セキュリティ運用<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<h3 id="91">9.1 セキュリティ監視<a class="headerlink" href="#91" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>監視項目</th>
<th>ツール</th>
<th>頻度</th>
</tr>
</thead>
<tbody>
<tr>
<td>脆弱性スキャン</td>
<td>Trivy</td>
<td>デプロイ毎</td>
</tr>
<tr>
<td>ランタイムセキュリティ</td>
<td>Falco</td>
<td>リアルタイム</td>
</tr>
<tr>
<td>シークレット監査</td>
<td>Vault Audit</td>
<td>リアルタイム</td>
</tr>
<tr>
<td>ネットワークポリシー</td>
<td>Cilium</td>
<td>リアルタイム</td>
</tr>
</tbody>
</table>
<h3 id="92">9.2 セキュリティインシデント対応<a class="headerlink" href="#92" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TD
    A[セキュリティアラート] --> B{重要度判定}
    B -->|Critical| C[即時隔離]
    B -->|High| D[調査開始]
    B -->|Medium/Low| E[チケット起票]

    C --> F[フォレンジック]
    D --> F
    F --> G[根本原因分析]
    G --> H[是正措置]
    H --> I[報告書作成]
</div>

<hr />
<h2 id="10-slaslo">10. SLA/SLO管理<a class="headerlink" href="#10-slaslo" title="Permanent link">&para;</a></h2>
<h3 id="101-slo">10.1 SLO定義<a class="headerlink" href="#101-slo" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>サービス</th>
<th>SLI</th>
<th>SLO</th>
<th>Error Budget</th>
</tr>
</thead>
<tbody>
<tr>
<td>Identity Service</td>
<td>可用性</td>
<td>99.9%</td>
<td>43分/月</td>
</tr>
<tr>
<td>Audit Service</td>
<td>可用性</td>
<td>99.95%</td>
<td>21分/月</td>
</tr>
<tr>
<td>Verification Service</td>
<td>レイテンシ P99</td>
<td>&lt; 1秒</td>
<td>-</td>
</tr>
<tr>
<td>Event Service</td>
<td>スループット</td>
<td>&gt; 500 TPS</td>
<td>-</td>
</tr>
</tbody>
</table>
<h3 id="102-error-budget">10.2 Error Budget ポリシー<a class="headerlink" href="#102-error-budget" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code>Error Budget残量 &gt; 50%: 通常開発
Error Budget残量 20-50%: 新機能凍結、信頼性改善優先
Error Budget残量 &lt; 20%: インシデント対応のみ
Error Budget枯渇: サービス凍結、全リソース投入
</code></pre>

<hr />
<p><em>Generated: 2025-12-26</em>
<em>Version: 1.0.0</em>
<em>Source: Scalar Auditor for BOX - Microservices Design</em></p>
</article>
<article id="design-scalardb-architecture">
<h1 id="scalardb">ScalarDB アーキテクチャ設計<a class="headerlink" href="#scalardb" title="Permanent link">&para;</a></h1>
<h2 id="1">1. エグゼクティブサマリー<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 設計方針<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>項目</th>
<th>選択</th>
<th>理由</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>デプロイモード</strong></td>
<td>ScalarDB Cluster</td>
<td>マイクロサービス化、高可用性、GraphQL/SQL対応</td>
</tr>
<tr>
<td><strong>トランザクション</strong></td>
<td>Consensus Commit</td>
<td>分散ACIDトランザクション必須</td>
</tr>
<tr>
<td><strong>ストレージ戦略</strong></td>
<td>Multi-storage</td>
<td>コンテキスト別最適化</td>
</tr>
<tr>
<td><strong>整合性レベル</strong></td>
<td>SERIALIZABLE</td>
<td>監査データの完全性保証</td>
</tr>
</tbody>
</table>
<h3 id="12">1.2 アーキテクチャ概要<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "Application Layer"
        IS[Identity Service]
        AS[Audit Service]
        FS[File Service]
        ES[Event Service]
        VS[Verification Service]
    end

    subgraph "ScalarDB Cluster"
        LB[Load Balancer]
        SC1[ScalarDB Node 1]
        SC2[ScalarDB Node 2]
        SC3[ScalarDB Node 3]
        COORD[(Coordinator<br/>PostgreSQL)]
    end

    subgraph "Storage Layer"
        PG[(PostgreSQL<br/>Identity/Audit)]
        CS[(Cassandra<br/>Events)]
        SDL[(ScalarDL<br/>Verification)]
    end

    IS --> LB
    AS --> LB
    FS --> LB
    ES --> LB
    VS --> LB

    LB --> SC1
    LB --> SC2
    LB --> SC3

    SC1 --> COORD
    SC2 --> COORD
    SC3 --> COORD

    SC1 --> PG
    SC1 --> CS
    SC2 --> PG
    SC2 --> CS
    SC3 --> PG
    SC3 --> CS

    VS --> SDL
</div>

<hr />
<h2 id="2">2. デプロイモード決定<a class="headerlink" href="#2" title="Permanent link">&para;</a></h2>
<h3 id="21-scalardb-cluster">2.1 選定: ScalarDB Cluster<a class="headerlink" href="#21-scalardb-cluster" title="Permanent link">&para;</a></h3>
<p><strong>ScalarDB Clusterを選択した理由:</strong></p>
<table>
<thead>
<tr>
<th>要件</th>
<th style="text-align: center;">ScalarDB Core</th>
<th style="text-align: center;">ScalarDB Cluster</th>
<th style="text-align: center;">判定</th>
</tr>
</thead>
<tbody>
<tr>
<td>マイクロサービス対応</td>
<td style="text-align: center;">△</td>
<td style="text-align: center;">◎</td>
<td style="text-align: center;">Cluster</td>
</tr>
<tr>
<td>高可用性</td>
<td style="text-align: center;">×</td>
<td style="text-align: center;">◎</td>
<td style="text-align: center;">Cluster</td>
</tr>
<tr>
<td>GraphQL/SQL対応</td>
<td style="text-align: center;">×</td>
<td style="text-align: center;">◎</td>
<td style="text-align: center;">Cluster</td>
</tr>
<tr>
<td>分散トランザクション</td>
<td style="text-align: center;">○</td>
<td style="text-align: center;">◎</td>
<td style="text-align: center;">Cluster</td>
</tr>
<tr>
<td>運用監視</td>
<td style="text-align: center;">△</td>
<td style="text-align: center;">◎</td>
<td style="text-align: center;">Cluster</td>
</tr>
<tr>
<td>スケーラビリティ</td>
<td style="text-align: center;">△</td>
<td style="text-align: center;">◎</td>
<td style="text-align: center;">Cluster</td>
</tr>
</tbody>
</table>
<h3 id="22">2.2 クラスタ構成<a class="headerlink" href="#22" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-yaml"># ScalarDB Cluster構成
cluster:
  nodes: 3
  replication_factor: 3

  # ノード配置
  topology:
    - zone: ap-northeast-1a
      node: scalardb-1
    - zone: ap-northeast-1c
      node: scalardb-2
    - zone: ap-northeast-1d
      node: scalardb-3

  # リソース
  resources:
    cpu: 4
    memory: 16Gi
    storage: 100Gi
</code></pre>

<h3 id="23-coordinator">2.3 Coordinator設計<a class="headerlink" href="#23-coordinator" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph LR
    subgraph "Primary-Standby"
        CP[(Coordinator<br/>Primary)]
        CS1[(Coordinator<br/>Standby 1)]
        CS2[(Coordinator<br/>Standby 2)]
    end

    CP -->|Sync Replication| CS1
    CP -->|Sync Replication| CS2

    SC[ScalarDB Cluster] --> CP
    SC -.->|Failover| CS1
    SC -.->|Failover| CS2
</div>

<p><strong>Coordinator設定:</strong></p>
<pre class="codehilite"><code class="language-properties"># coordinator.properties
scalar.db.consensus_commit.coordinator.namespace=coordinator
scalar.db.consensus_commit.coordinator.table=state

# Group Commit (高スループット)
scalar.db.consensus_commit.coordinator.group_commit.enabled=true
scalar.db.consensus_commit.coordinator.group_commit.slot_capacity=20
scalar.db.consensus_commit.coordinator.group_commit.group_size_fix_timeout_millis=40
scalar.db.consensus_commit.coordinator.group_commit.delayed_slot_move_timeout_millis=800
scalar.db.consensus_commit.coordinator.group_commit.old_group_abort_timeout_millis=60000

# Parallel Executor
scalar.db.consensus_commit.parallel_executor_count=32
scalar.db.consensus_commit.parallel_preparation_enabled=true
scalar.db.consensus_commit.parallel_validation_enabled=true
scalar.db.consensus_commit.parallel_commit_enabled=true
scalar.db.consensus_commit.parallel_rollback_enabled=true
</code></pre>

<hr />
<h2 id="3">3. ストレージ構成<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31-multi-storage">3.1 Multi-storage設計<a class="headerlink" href="#31-multi-storage" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Namespace</th>
<th>ストレージ</th>
<th>理由</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>identity</code></td>
<td>PostgreSQL</td>
<td>複雑なクエリ、JOIN、トランザクション重視</td>
</tr>
<tr>
<td><code>audit</code></td>
<td>PostgreSQL</td>
<td>ACID保証、複雑なアクセス制御</td>
</tr>
<tr>
<td><code>file</code></td>
<td>PostgreSQL</td>
<td>メタデータ管理、インデックス活用</td>
</tr>
<tr>
<td><code>event</code></td>
<td>Cassandra</td>
<td>高書き込みスループット、時系列データ</td>
</tr>
<tr>
<td><code>coordinator</code></td>
<td>PostgreSQL</td>
<td>トランザクション状態管理</td>
</tr>
</tbody>
</table>
<h3 id="32">3.2 ストレージ別設計<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<h4 id="postgresql-identity-audit-file">PostgreSQL (Identity, Audit, File)<a class="headerlink" href="#postgresql-identity-audit-file" title="Permanent link">&para;</a></h4>
<div class="mermaid">
graph TB
    subgraph "PostgreSQL Cluster"
        PG_P[(Primary)]
        PG_R1[(Replica 1)]
        PG_R2[(Replica 2)]
    end

    subgraph "Namespaces"
        NS_I[identity]
        NS_A[audit]
        NS_F[file]
        NS_C[coordinator]
    end

    PG_P --> NS_I
    PG_P --> NS_A
    PG_P --> NS_F
    PG_P --> NS_C

    PG_P -->|Streaming Replication| PG_R1
    PG_P -->|Streaming Replication| PG_R2
</div>

<p><strong>PostgreSQL設定:</strong></p>
<pre class="codehilite"><code class="language-properties"># postgres-storage.properties
scalar.db.storage=jdbc
scalar.db.contact_points=jdbc:postgresql://postgres-primary:5432/scalardb
scalar.db.username=${DB_USER}
scalar.db.password=${DB_PASSWORD}

# Connection Pool
scalar.db.jdbc.connection_pool.min_idle=10
scalar.db.jdbc.connection_pool.max_idle=50
scalar.db.jdbc.connection_pool.max_total=100
</code></pre>

<h4 id="cassandra-event">Cassandra (Event)<a class="headerlink" href="#cassandra-event" title="Permanent link">&para;</a></h4>
<div class="mermaid">
graph TB
    subgraph "Cassandra Cluster"
        C1[(Node 1<br/>DC1)]
        C2[(Node 2<br/>DC1)]
        C3[(Node 3<br/>DC1)]
    end

    subgraph "Keyspace"
        NS_E[event]
    end

    C1 --> NS_E
    C2 --> NS_E
    C3 --> NS_E

    C1 <-->|Gossip| C2
    C2 <-->|Gossip| C3
    C3 <-->|Gossip| C1
</div>

<p><strong>Cassandra設定:</strong></p>
<pre class="codehilite"><code class="language-properties"># cassandra-storage.properties
scalar.db.storage=cassandra
scalar.db.contact_points=cassandra-1,cassandra-2,cassandra-3
scalar.db.contact_port=9042
scalar.db.username=${CASSANDRA_USER}
scalar.db.password=${CASSANDRA_PASSWORD}

# Consistency
scalar.db.cassandra.local_datacenter=dc1
</code></pre>

<h3 id="33-multi-storage">3.3 Multi-storage統合設定<a class="headerlink" href="#33-multi-storage" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-properties"># scalardb.properties
scalar.db.storage=multi-storage
scalar.db.transaction_manager=consensus-commit

# Storage definitions
scalar.db.multi_storage.storages=postgres,cassandra

# PostgreSQL storage
scalar.db.multi_storage.storages.postgres.storage=jdbc
scalar.db.multi_storage.storages.postgres.contact_points=jdbc:postgresql://postgres:5432/scalardb
scalar.db.multi_storage.storages.postgres.username=${POSTGRES_USER}
scalar.db.multi_storage.storages.postgres.password=${POSTGRES_PASSWORD}

# Cassandra storage
scalar.db.multi_storage.storages.cassandra.storage=cassandra
scalar.db.multi_storage.storages.cassandra.contact_points=cassandra-1,cassandra-2,cassandra-3
scalar.db.multi_storage.storages.cassandra.username=${CASSANDRA_USER}
scalar.db.multi_storage.storages.cassandra.password=${CASSANDRA_PASSWORD}

# Namespace mapping
scalar.db.multi_storage.namespace_mapping=identity:postgres,audit:postgres,file:postgres,event:cassandra,coordinator:postgres
scalar.db.multi_storage.default_storage=postgres
</code></pre>

<hr />
<h2 id="4">4. ネットワーク設計<a class="headerlink" href="#4" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 ネットワークトポロジー<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "Public Subnet"
        ALB[Application<br/>Load Balancer]
    end

    subgraph "Private Subnet - App"
        APP1[App Server 1]
        APP2[App Server 2]
        APP3[App Server 3]
    end

    subgraph "Private Subnet - ScalarDB"
        NLB[Network<br/>Load Balancer]
        SDB1[ScalarDB 1]
        SDB2[ScalarDB 2]
        SDB3[ScalarDB 3]
    end

    subgraph "Private Subnet - Data"
        PG[(PostgreSQL)]
        CS[(Cassandra)]
        SDL[(ScalarDL)]
    end

    Internet -->|HTTPS| ALB
    ALB --> APP1
    ALB --> APP2
    ALB --> APP3

    APP1 --> NLB
    APP2 --> NLB
    APP3 --> NLB

    NLB --> SDB1
    NLB --> SDB2
    NLB --> SDB3

    SDB1 --> PG
    SDB1 --> CS
    SDB2 --> PG
    SDB2 --> CS
    SDB3 --> PG
    SDB3 --> CS

    APP1 --> SDL
    APP2 --> SDL
    APP3 --> SDL
</div>

<h3 id="42">4.2 ポート設計<a class="headerlink" href="#42" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>サービス</th>
<th>ポート</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>ScalarDB Cluster</td>
<td>60053</td>
<td>gRPC (Transaction)</td>
</tr>
<tr>
<td>ScalarDB Cluster</td>
<td>60054</td>
<td>gRPC (Admin)</td>
</tr>
<tr>
<td>ScalarDB Cluster</td>
<td>9080</td>
<td>GraphQL</td>
</tr>
<tr>
<td>ScalarDB Cluster</td>
<td>8080</td>
<td>HTTP/REST</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>5432</td>
<td>Database</td>
</tr>
<tr>
<td>Cassandra</td>
<td>9042</td>
<td>CQL</td>
</tr>
<tr>
<td>ScalarDL</td>
<td>50051</td>
<td>gRPC</td>
</tr>
</tbody>
</table>
<h3 id="43">4.3 セキュリティグループ<a class="headerlink" href="#43" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-yaml"># App -&gt; ScalarDB
app_to_scalardb:
  ingress:
    - port: 60053
      protocol: TCP
      source: app_security_group
    - port: 60054
      protocol: TCP
      source: app_security_group

# ScalarDB -&gt; Storage
scalardb_to_storage:
  ingress:
    - port: 5432
      protocol: TCP
      source: scalardb_security_group
    - port: 9042
      protocol: TCP
      source: scalardb_security_group
</code></pre>

<hr />
<h2 id="5">5. セキュリティ設計<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 認証・認可<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant App as Application
    participant SDB as ScalarDB Cluster
    participant Auth as Auth Provider

    App->>Auth: Request Token
    Auth-->>App: JWT Token
    App->>SDB: gRPC + JWT
    SDB->>SDB: Validate Token
    SDB->>SDB: Check Namespace Permissions
    SDB-->>App: Response
</div>

<h3 id="52">5.2 暗号化<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>レイヤー</th>
<th>暗号化方式</th>
<th>対象</th>
</tr>
</thead>
<tbody>
<tr>
<td>転送中</td>
<td>TLS 1.3</td>
<td>App ↔ ScalarDB ↔ Storage</td>
</tr>
<tr>
<td>保存時</td>
<td>AES-256</td>
<td>PostgreSQL, Cassandra</td>
</tr>
<tr>
<td>キー管理</td>
<td>AWS KMS</td>
<td>暗号化キー</td>
</tr>
</tbody>
</table>
<h3 id="53-namespace">5.3 Namespace別権限<a class="headerlink" href="#53-namespace" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">// Namespace権限設定
public enum NamespacePermission {
    IDENTITY_READ,
    IDENTITY_WRITE,
    AUDIT_READ,
    AUDIT_WRITE,
    EVENT_READ,
    EVENT_WRITE,
    FILE_READ,
    FILE_WRITE
}

// サービス別権限マッピング
Map&lt;Service, Set&lt;NamespacePermission&gt;&gt; servicePermissions = Map.of(
    Service.IDENTITY, Set.of(IDENTITY_READ, IDENTITY_WRITE),
    Service.AUDIT, Set.of(AUDIT_READ, AUDIT_WRITE, IDENTITY_READ, FILE_READ),
    Service.FILE, Set.of(FILE_READ, FILE_WRITE),
    Service.EVENT, Set.of(EVENT_READ, EVENT_WRITE)
);
</code></pre>

<hr />
<h2 id="6">6. 可用性設計<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 高可用性構成<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>コンポーネント</th>
<th>冗長構成</th>
<th>RTO</th>
<th>RPO</th>
</tr>
</thead>
<tbody>
<tr>
<td>ScalarDB Cluster</td>
<td>3ノード Active-Active</td>
<td>30秒</td>
<td>0</td>
</tr>
<tr>
<td>Coordinator DB</td>
<td>Primary-Standby</td>
<td>60秒</td>
<td>0</td>
</tr>
<tr>
<td>PostgreSQL</td>
<td>Primary + 2 Replica</td>
<td>60秒</td>
<td>0</td>
</tr>
<tr>
<td>Cassandra</td>
<td>3ノード RF=3</td>
<td>30秒</td>
<td>0</td>
</tr>
</tbody>
</table>
<h3 id="62">6.2 障害復旧<a class="headerlink" href="#62" title="Permanent link">&para;</a></h3>
<div class="mermaid">
stateDiagram-v2
    [*] --> Normal
    Normal --> NodeFailure: Node Down
    NodeFailure --> Failover: Health Check Failed
    Failover --> Normal: Recovery Complete
    Normal --> CoordinatorFailure: Coordinator Down
    CoordinatorFailure --> StandbyPromotion: Automatic Failover
    StandbyPromotion --> Normal: New Primary Active
</div>

<h3 id="63">6.3 バックアップ戦略<a class="headerlink" href="#63" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>対象</th>
<th>方式</th>
<th>頻度</th>
<th>保持期間</th>
</tr>
</thead>
<tbody>
<tr>
<td>PostgreSQL</td>
<td>pg_dump + WAL Archive</td>
<td>日次フル + 継続的WAL</td>
<td>30日</td>
</tr>
<tr>
<td>Cassandra</td>
<td>Snapshot + Incremental</td>
<td>日次スナップショット</td>
<td>14日</td>
</tr>
<tr>
<td>Coordinator</td>
<td>pg_dump</td>
<td>1時間毎</td>
<td>7日</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="7">7. 監視設計<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 メトリクス<a class="headerlink" href="#71" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-yaml"># ScalarDB Cluster Metrics
scalardb_metrics:
  - name: transaction_latency
    type: histogram
    labels: [namespace, operation]

  - name: transaction_throughput
    type: counter
    labels: [namespace, status]

  - name: connection_pool_active
    type: gauge
    labels: [storage]

  - name: coordinator_group_commit_size
    type: histogram
</code></pre>

<h3 id="72">7.2 アラート設定<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>メトリクス</th>
<th>閾値</th>
<th>重要度</th>
</tr>
</thead>
<tbody>
<tr>
<td>Transaction Latency P99</td>
<td>&gt; 500ms</td>
<td>Warning</td>
</tr>
<tr>
<td>Transaction Latency P99</td>
<td>&gt; 1000ms</td>
<td>Critical</td>
</tr>
<tr>
<td>Error Rate</td>
<td>&gt; 1%</td>
<td>Warning</td>
</tr>
<tr>
<td>Error Rate</td>
<td>&gt; 5%</td>
<td>Critical</td>
</tr>
<tr>
<td>Connection Pool Exhaustion</td>
<td>&gt; 80%</td>
<td>Warning</td>
</tr>
</tbody>
</table>
<h3 id="73">7.3 ダッシュボード<a class="headerlink" href="#73" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "Monitoring Stack"
        PROM[Prometheus]
        GRAF[Grafana]
        ALERT[AlertManager]
    end

    subgraph "ScalarDB Cluster"
        SDB1[Node 1]
        SDB2[Node 2]
        SDB3[Node 3]
    end

    SDB1 -->|/metrics| PROM
    SDB2 -->|/metrics| PROM
    SDB3 -->|/metrics| PROM

    PROM --> GRAF
    PROM --> ALERT
    ALERT -->|Slack/PagerDuty| OPS[Operations Team]
</div>

<hr />
<h2 id="8">8. 性能設計<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 性能目標<a class="headerlink" href="#81" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>指標</th>
<th>目標値</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr>
<td>トランザクションレイテンシ P50</td>
<td>&lt; 50ms</td>
<td>単一DB操作</td>
</tr>
<tr>
<td>トランザクションレイテンシ P99</td>
<td>&lt; 200ms</td>
<td>分散トランザクション</td>
</tr>
<tr>
<td>スループット</td>
<td>&gt; 1000 TPS</td>
<td>ピーク時</td>
</tr>
<tr>
<td>可用性</td>
<td>99.9%</td>
<td>月間</td>
</tr>
</tbody>
</table>
<h3 id="82">8.2 チューニングパラメータ<a class="headerlink" href="#82" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-properties"># Performance Tuning
scalar.db.consensus_commit.parallel_executor_count=32
scalar.db.consensus_commit.parallel_preparation_enabled=true
scalar.db.consensus_commit.parallel_validation_enabled=true
scalar.db.consensus_commit.parallel_commit_enabled=true

# Group Commit (Latency vs Throughput tradeoff)
scalar.db.consensus_commit.coordinator.group_commit.enabled=true
scalar.db.consensus_commit.coordinator.group_commit.slot_capacity=20

# Connection Pool
scalar.db.jdbc.connection_pool.max_total=100
scalar.db.jdbc.connection_pool.max_idle=50
</code></pre>

<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: scalar-event-log-fetcher-main</em>
<em>ScalarDB Version: 3.14.x (Cluster)</em></p>
</article>
<article id="design-scalardb-schema">
<h1 id="scalardb">ScalarDB スキーマ設計<a class="headerlink" href="#scalardb" title="Permanent link">&para;</a></h1>
<h2 id="1-namespace">1. Namespace設計<a class="headerlink" href="#1-namespace" title="Permanent link">&para;</a></h2>
<h3 id="11-namespace">1.1 Namespace一覧<a class="headerlink" href="#11-namespace" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Namespace</th>
<th>説明</th>
<th>ストレージ</th>
<th>テーブル数</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>identity</code></td>
<td>ユーザー・認証管理</td>
<td>PostgreSQL</td>
<td>5</td>
</tr>
<tr>
<td><code>audit</code></td>
<td>監査セット・グループ管理</td>
<td>PostgreSQL</td>
<td>6</td>
</tr>
<tr>
<td><code>file</code></td>
<td>ファイル・フォルダ管理</td>
<td>PostgreSQL</td>
<td>4</td>
</tr>
<tr>
<td><code>event</code></td>
<td>イベントログ管理</td>
<td>Cassandra</td>
<td>5</td>
</tr>
<tr>
<td><code>coordinator</code></td>
<td>トランザクション調整</td>
<td>PostgreSQL</td>
<td>1</td>
</tr>
</tbody>
</table>
<h3 id="12-namespace">1.2 Namespace関係図<a class="headerlink" href="#12-namespace" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "PostgreSQL"
        IDENTITY[identity]
        AUDIT[audit]
        FILE[file]
        COORD[coordinator]
    end

    subgraph "Cassandra"
        EVENT[event]
    end

    AUDIT -->|user_id参照| IDENTITY
    AUDIT -->|item_id参照| FILE
    FILE -->|user_id参照| IDENTITY
    EVENT -->|user_id参照| IDENTITY
    EVENT -->|item_id参照| FILE
</div>

<hr />
<h2 id="2-identity-namespace">2. Identity Namespace<a class="headerlink" href="#2-identity-namespace" title="Permanent link">&para;</a></h2>
<h3 id="21-users">2.1 users テーブル<a class="headerlink" href="#21-users" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;identity&quot;,
  &quot;table&quot;: &quot;users&quot;,
  &quot;partition_key&quot;: [&quot;user_email&quot;],
  &quot;clustering_key&quot;: [],
  &quot;columns&quot;: {
    &quot;user_email&quot;: &quot;TEXT&quot;,
    &quot;user_id&quot;: &quot;BIGINT&quot;,
    &quot;name&quot;: &quot;TEXT&quot;,
    &quot;password_hash&quot;: &quot;TEXT&quot;,
    &quot;role&quot;: &quot;TEXT&quot;,
    &quot;org_id&quot;: &quot;TEXT&quot;,
    &quot;organization_name&quot;: &quot;TEXT&quot;,
    &quot;image_url&quot;: &quot;TEXT&quot;,
    &quot;is_deleted&quot;: &quot;BOOLEAN&quot;,
    &quot;is_box_admin&quot;: &quot;BOOLEAN&quot;,
    &quot;language_code&quot;: &quot;TEXT&quot;,
    &quot;created_at&quot;: &quot;BIGINT&quot;,
    &quot;updated_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: [&quot;user_id&quot;, &quot;org_id&quot;]
}
</code></pre>

<p><strong>Java定義:</strong></p>
<pre class="codehilite"><code class="language-java">TableMetadata usersMetadata = TableMetadata.newBuilder()
    .addPartitionKey(&quot;user_email&quot;)
    .addColumn(&quot;user_email&quot;, DataType.TEXT)
    .addColumn(&quot;user_id&quot;, DataType.BIGINT)
    .addColumn(&quot;name&quot;, DataType.TEXT)
    .addColumn(&quot;password_hash&quot;, DataType.TEXT)
    .addColumn(&quot;role&quot;, DataType.TEXT)
    .addColumn(&quot;org_id&quot;, DataType.TEXT)
    .addColumn(&quot;organization_name&quot;, DataType.TEXT)
    .addColumn(&quot;image_url&quot;, DataType.TEXT)
    .addColumn(&quot;is_deleted&quot;, DataType.BOOLEAN)
    .addColumn(&quot;is_box_admin&quot;, DataType.BOOLEAN)
    .addColumn(&quot;language_code&quot;, DataType.TEXT)
    .addColumn(&quot;created_at&quot;, DataType.BIGINT)
    .addColumn(&quot;updated_at&quot;, DataType.BIGINT)
    .addSecondaryIndex(&quot;user_id&quot;)
    .addSecondaryIndex(&quot;org_id&quot;)
    .build();
</code></pre>

<h3 id="22-user_tokens">2.2 user_tokens テーブル<a class="headerlink" href="#22-user_tokens" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;identity&quot;,
  &quot;table&quot;: &quot;user_tokens&quot;,
  &quot;partition_key&quot;: [&quot;user_email&quot;],
  &quot;clustering_key&quot;: [&quot;token_type&quot;],
  &quot;columns&quot;: {
    &quot;user_email&quot;: &quot;TEXT&quot;,
    &quot;token_type&quot;: &quot;TEXT&quot;,
    &quot;refresh_token&quot;: &quot;TEXT&quot;,
    &quot;access_token&quot;: &quot;TEXT&quot;,
    &quot;expires_at&quot;: &quot;BIGINT&quot;,
    &quot;created_at&quot;: &quot;BIGINT&quot;,
    &quot;updated_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: []
}
</code></pre>

<h3 id="23-user_otps">2.3 user_otps テーブル<a class="headerlink" href="#23-user_otps" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;identity&quot;,
  &quot;table&quot;: &quot;user_otps&quot;,
  &quot;partition_key&quot;: [&quot;user_email&quot;],
  &quot;clustering_key&quot;: [&quot;otp_type&quot;],
  &quot;columns&quot;: {
    &quot;user_email&quot;: &quot;TEXT&quot;,
    &quot;otp_type&quot;: &quot;TEXT&quot;,
    &quot;otp_code&quot;: &quot;TEXT&quot;,
    &quot;expires_at&quot;: &quot;BIGINT&quot;,
    &quot;is_used&quot;: &quot;BOOLEAN&quot;,
    &quot;created_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: []
}
</code></pre>

<h3 id="24-organizations">2.4 organizations テーブル<a class="headerlink" href="#24-organizations" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;identity&quot;,
  &quot;table&quot;: &quot;organizations&quot;,
  &quot;partition_key&quot;: [&quot;org_id&quot;],
  &quot;clustering_key&quot;: [],
  &quot;columns&quot;: {
    &quot;org_id&quot;: &quot;TEXT&quot;,
    &quot;enterprise_id&quot;: &quot;TEXT&quot;,
    &quot;org_name&quot;: &quot;TEXT&quot;,
    &quot;admin_email&quot;: &quot;TEXT&quot;,
    &quot;is_active&quot;: &quot;BOOLEAN&quot;,
    &quot;created_at&quot;: &quot;BIGINT&quot;,
    &quot;updated_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: [&quot;enterprise_id&quot;]
}
</code></pre>

<h3 id="25-role_users">2.5 role_users テーブル<a class="headerlink" href="#25-role_users" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;identity&quot;,
  &quot;table&quot;: &quot;role_users&quot;,
  &quot;partition_key&quot;: [&quot;user_email&quot;],
  &quot;clustering_key&quot;: [],
  &quot;columns&quot;: {
    &quot;user_email&quot;: &quot;TEXT&quot;,
    &quot;role_type&quot;: &quot;TEXT&quot;,
    &quot;permissions&quot;: &quot;TEXT&quot;,
    &quot;assigned_at&quot;: &quot;BIGINT&quot;,
    &quot;assigned_by&quot;: &quot;TEXT&quot;
  },
  &quot;secondary_indexes&quot;: [&quot;role_type&quot;]
}
</code></pre>

<hr />
<h2 id="3-audit-namespace">3. Audit Namespace<a class="headerlink" href="#3-audit-namespace" title="Permanent link">&para;</a></h2>
<h3 id="31-audit_sets">3.1 audit_sets テーブル<a class="headerlink" href="#31-audit_sets" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;audit&quot;,
  &quot;table&quot;: &quot;audit_sets&quot;,
  &quot;partition_key&quot;: [&quot;audit_set_id&quot;],
  &quot;clustering_key&quot;: [],
  &quot;columns&quot;: {
    &quot;audit_set_id&quot;: &quot;TEXT&quot;,
    &quot;audit_set_name&quot;: &quot;TEXT&quot;,
    &quot;description&quot;: &quot;TEXT&quot;,
    &quot;owner_id&quot;: &quot;BIGINT&quot;,
    &quot;owner_email&quot;: &quot;TEXT&quot;,
    &quot;owner_name&quot;: &quot;TEXT&quot;,
    &quot;is_deleted&quot;: &quot;BOOLEAN&quot;,
    &quot;created_at&quot;: &quot;BIGINT&quot;,
    &quot;updated_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: [&quot;owner_id&quot;, &quot;owner_email&quot;]
}
</code></pre>

<p><strong>Java定義:</strong></p>
<pre class="codehilite"><code class="language-java">TableMetadata auditSetsMetadata = TableMetadata.newBuilder()
    .addPartitionKey(&quot;audit_set_id&quot;)
    .addColumn(&quot;audit_set_id&quot;, DataType.TEXT)
    .addColumn(&quot;audit_set_name&quot;, DataType.TEXT)
    .addColumn(&quot;description&quot;, DataType.TEXT)
    .addColumn(&quot;owner_id&quot;, DataType.BIGINT)
    .addColumn(&quot;owner_email&quot;, DataType.TEXT)
    .addColumn(&quot;owner_name&quot;, DataType.TEXT)
    .addColumn(&quot;is_deleted&quot;, DataType.BOOLEAN)
    .addColumn(&quot;created_at&quot;, DataType.BIGINT)
    .addColumn(&quot;updated_at&quot;, DataType.BIGINT)
    .addSecondaryIndex(&quot;owner_id&quot;)
    .addSecondaryIndex(&quot;owner_email&quot;)
    .build();
</code></pre>

<h3 id="32-audit_set_items">3.2 audit_set_items テーブル<a class="headerlink" href="#32-audit_set_items" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;audit&quot;,
  &quot;table&quot;: &quot;audit_set_items&quot;,
  &quot;partition_key&quot;: [&quot;audit_set_id&quot;],
  &quot;clustering_key&quot;: [&quot;item_id&quot;],
  &quot;clustering_key_order&quot;: {&quot;item_id&quot;: &quot;ASC&quot;},
  &quot;columns&quot;: {
    &quot;audit_set_id&quot;: &quot;TEXT&quot;,
    &quot;item_id&quot;: &quot;BIGINT&quot;,
    &quot;item_name&quot;: &quot;TEXT&quot;,
    &quot;item_type&quot;: &quot;TEXT&quot;,
    &quot;monitoring_status&quot;: &quot;TEXT&quot;,
    &quot;verification_status&quot;: &quot;TEXT&quot;,
    &quot;assigned_by_user_id&quot;: &quot;BIGINT&quot;,
    &quot;created_at&quot;: &quot;BIGINT&quot;,
    &quot;updated_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: [&quot;monitoring_status&quot;, &quot;verification_status&quot;]
}
</code></pre>

<p><strong>Java定義:</strong></p>
<pre class="codehilite"><code class="language-java">TableMetadata auditSetItemsMetadata = TableMetadata.newBuilder()
    .addPartitionKey(&quot;audit_set_id&quot;)
    .addClusteringKey(&quot;item_id&quot;, Scan.Ordering.Order.ASC)
    .addColumn(&quot;audit_set_id&quot;, DataType.TEXT)
    .addColumn(&quot;item_id&quot;, DataType.BIGINT)
    .addColumn(&quot;item_name&quot;, DataType.TEXT)
    .addColumn(&quot;item_type&quot;, DataType.TEXT)
    .addColumn(&quot;monitoring_status&quot;, DataType.TEXT)
    .addColumn(&quot;verification_status&quot;, DataType.TEXT)
    .addColumn(&quot;assigned_by_user_id&quot;, DataType.BIGINT)
    .addColumn(&quot;created_at&quot;, DataType.BIGINT)
    .addColumn(&quot;updated_at&quot;, DataType.BIGINT)
    .addSecondaryIndex(&quot;monitoring_status&quot;)
    .addSecondaryIndex(&quot;verification_status&quot;)
    .build();
</code></pre>

<h3 id="33-audit_set_collaborators">3.3 audit_set_collaborators テーブル<a class="headerlink" href="#33-audit_set_collaborators" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;audit&quot;,
  &quot;table&quot;: &quot;audit_set_collaborators&quot;,
  &quot;partition_key&quot;: [&quot;audit_set_id&quot;],
  &quot;clustering_key&quot;: [&quot;user_email&quot;],
  &quot;columns&quot;: {
    &quot;audit_set_id&quot;: &quot;TEXT&quot;,
    &quot;user_email&quot;: &quot;TEXT&quot;,
    &quot;user_id&quot;: &quot;BIGINT&quot;,
    &quot;user_name&quot;: &quot;TEXT&quot;,
    &quot;collaborator_role&quot;: &quot;TEXT&quot;,
    &quot;invited_by&quot;: &quot;TEXT&quot;,
    &quot;created_at&quot;: &quot;BIGINT&quot;,
    &quot;updated_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: [&quot;user_id&quot;, &quot;collaborator_role&quot;]
}
</code></pre>

<h3 id="34-audit_groups">3.4 audit_groups テーブル<a class="headerlink" href="#34-audit_groups" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;audit&quot;,
  &quot;table&quot;: &quot;audit_groups&quot;,
  &quot;partition_key&quot;: [&quot;audit_group_id&quot;],
  &quot;clustering_key&quot;: [],
  &quot;columns&quot;: {
    &quot;audit_group_id&quot;: &quot;TEXT&quot;,
    &quot;audit_group_name&quot;: &quot;TEXT&quot;,
    &quot;description&quot;: &quot;TEXT&quot;,
    &quot;owner_id&quot;: &quot;BIGINT&quot;,
    &quot;owner_email&quot;: &quot;TEXT&quot;,
    &quot;owner_name&quot;: &quot;TEXT&quot;,
    &quot;is_deleted&quot;: &quot;BOOLEAN&quot;,
    &quot;created_at&quot;: &quot;BIGINT&quot;,
    &quot;updated_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: [&quot;owner_id&quot;]
}
</code></pre>

<h3 id="35-audit_group_members">3.5 audit_group_members テーブル<a class="headerlink" href="#35-audit_group_members" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;audit&quot;,
  &quot;table&quot;: &quot;audit_group_members&quot;,
  &quot;partition_key&quot;: [&quot;audit_group_id&quot;],
  &quot;clustering_key&quot;: [&quot;user_email&quot;],
  &quot;columns&quot;: {
    &quot;audit_group_id&quot;: &quot;TEXT&quot;,
    &quot;user_email&quot;: &quot;TEXT&quot;,
    &quot;user_id&quot;: &quot;BIGINT&quot;,
    &quot;member_role&quot;: &quot;TEXT&quot;,
    &quot;added_by&quot;: &quot;TEXT&quot;,
    &quot;created_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: [&quot;user_id&quot;]
}
</code></pre>

<h3 id="36-audit_group_set_mappings">3.6 audit_group_set_mappings テーブル<a class="headerlink" href="#36-audit_group_set_mappings" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;audit&quot;,
  &quot;table&quot;: &quot;audit_group_set_mappings&quot;,
  &quot;partition_key&quot;: [&quot;audit_group_id&quot;],
  &quot;clustering_key&quot;: [&quot;audit_set_id&quot;],
  &quot;columns&quot;: {
    &quot;audit_group_id&quot;: &quot;TEXT&quot;,
    &quot;audit_set_id&quot;: &quot;TEXT&quot;,
    &quot;linked_at&quot;: &quot;BIGINT&quot;,
    &quot;linked_by&quot;: &quot;TEXT&quot;
  },
  &quot;secondary_indexes&quot;: []
}
</code></pre>

<hr />
<h2 id="4-file-namespace">4. File Namespace<a class="headerlink" href="#4-file-namespace" title="Permanent link">&para;</a></h2>
<h3 id="41-items">4.1 items テーブル<a class="headerlink" href="#41-items" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;file&quot;,
  &quot;table&quot;: &quot;items&quot;,
  &quot;partition_key&quot;: [&quot;item_id&quot;],
  &quot;clustering_key&quot;: [],
  &quot;columns&quot;: {
    &quot;item_id&quot;: &quot;BIGINT&quot;,
    &quot;item_type&quot;: &quot;TEXT&quot;,
    &quot;item_name&quot;: &quot;TEXT&quot;,
    &quot;parent_folder_id&quot;: &quot;BIGINT&quot;,
    &quot;sha1_hash&quot;: &quot;TEXT&quot;,
    &quot;size&quot;: &quot;BIGINT&quot;,
    &quot;storage_provider&quot;: &quot;TEXT&quot;,
    &quot;is_deleted&quot;: &quot;BOOLEAN&quot;,
    &quot;created_at&quot;: &quot;BIGINT&quot;,
    &quot;updated_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: [&quot;sha1_hash&quot;, &quot;parent_folder_id&quot;]
}
</code></pre>

<p><strong>Java定義:</strong></p>
<pre class="codehilite"><code class="language-java">TableMetadata itemsMetadata = TableMetadata.newBuilder()
    .addPartitionKey(&quot;item_id&quot;)
    .addColumn(&quot;item_id&quot;, DataType.BIGINT)
    .addColumn(&quot;item_type&quot;, DataType.TEXT)
    .addColumn(&quot;item_name&quot;, DataType.TEXT)
    .addColumn(&quot;parent_folder_id&quot;, DataType.BIGINT)
    .addColumn(&quot;sha1_hash&quot;, DataType.TEXT)
    .addColumn(&quot;size&quot;, DataType.BIGINT)
    .addColumn(&quot;storage_provider&quot;, DataType.TEXT)
    .addColumn(&quot;is_deleted&quot;, DataType.BOOLEAN)
    .addColumn(&quot;created_at&quot;, DataType.BIGINT)
    .addColumn(&quot;updated_at&quot;, DataType.BIGINT)
    .addSecondaryIndex(&quot;sha1_hash&quot;)
    .addSecondaryIndex(&quot;parent_folder_id&quot;)
    .build();
</code></pre>

<h3 id="42-item_monitoring_status">4.2 item_monitoring_status テーブル<a class="headerlink" href="#42-item_monitoring_status" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;file&quot;,
  &quot;table&quot;: &quot;item_monitoring_status&quot;,
  &quot;partition_key&quot;: [&quot;item_id&quot;],
  &quot;clustering_key&quot;: [],
  &quot;columns&quot;: {
    &quot;item_id&quot;: &quot;BIGINT&quot;,
    &quot;monitoring_status&quot;: &quot;TEXT&quot;,
    &quot;last_checked_at&quot;: &quot;BIGINT&quot;,
    &quot;last_version_id&quot;: &quot;BIGINT&quot;,
    &quot;last_sha1_hash&quot;: &quot;TEXT&quot;,
    &quot;created_at&quot;: &quot;BIGINT&quot;,
    &quot;updated_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: [&quot;monitoring_status&quot;]
}
</code></pre>

<h3 id="43-items_by_sha1">4.3 items_by_sha1 テーブル<a class="headerlink" href="#43-items_by_sha1" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;file&quot;,
  &quot;table&quot;: &quot;items_by_sha1&quot;,
  &quot;partition_key&quot;: [&quot;sha1_hash&quot;],
  &quot;clustering_key&quot;: [&quot;item_id&quot;],
  &quot;columns&quot;: {
    &quot;sha1_hash&quot;: &quot;TEXT&quot;,
    &quot;item_id&quot;: &quot;BIGINT&quot;,
    &quot;item_name&quot;: &quot;TEXT&quot;,
    &quot;created_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: []
}
</code></pre>

<h3 id="44-file_versions">4.4 file_versions テーブル<a class="headerlink" href="#44-file_versions" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;file&quot;,
  &quot;table&quot;: &quot;file_versions&quot;,
  &quot;partition_key&quot;: [&quot;item_id&quot;],
  &quot;clustering_key&quot;: [&quot;version_id&quot;],
  &quot;clustering_key_order&quot;: {&quot;version_id&quot;: &quot;DESC&quot;},
  &quot;columns&quot;: {
    &quot;item_id&quot;: &quot;BIGINT&quot;,
    &quot;version_id&quot;: &quot;BIGINT&quot;,
    &quot;version_name&quot;: &quot;TEXT&quot;,
    &quot;sha1_hash&quot;: &quot;TEXT&quot;,
    &quot;size&quot;: &quot;BIGINT&quot;,
    &quot;modified_by_id&quot;: &quot;BIGINT&quot;,
    &quot;modified_by_name&quot;: &quot;TEXT&quot;,
    &quot;created_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: []
}
</code></pre>

<hr />
<h2 id="5-event-namespace-cassandra">5. Event Namespace (Cassandra)<a class="headerlink" href="#5-event-namespace-cassandra" title="Permanent link">&para;</a></h2>
<h3 id="51-events">5.1 events テーブル<a class="headerlink" href="#51-events" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;event&quot;,
  &quot;table&quot;: &quot;events&quot;,
  &quot;partition_key&quot;: [&quot;yyyymmdd&quot;],
  &quot;clustering_key&quot;: [&quot;event_id&quot;],
  &quot;clustering_key_order&quot;: {&quot;event_id&quot;: &quot;DESC&quot;},
  &quot;columns&quot;: {
    &quot;yyyymmdd&quot;: &quot;TEXT&quot;,
    &quot;event_id&quot;: &quot;TEXT&quot;,
    &quot;event_type&quot;: &quot;TEXT&quot;,
    &quot;timestamp&quot;: &quot;BIGINT&quot;,
    &quot;user_id&quot;: &quot;BIGINT&quot;,
    &quot;user_email&quot;: &quot;TEXT&quot;,
    &quot;user_name&quot;: &quot;TEXT&quot;,
    &quot;item_id&quot;: &quot;BIGINT&quot;,
    &quot;item_name&quot;: &quot;TEXT&quot;,
    &quot;item_type&quot;: &quot;TEXT&quot;,
    &quot;sha1_hash&quot;: &quot;TEXT&quot;,
    &quot;parent_folder_id&quot;: &quot;BIGINT&quot;,
    &quot;source_json&quot;: &quot;TEXT&quot;,
    &quot;created_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: [&quot;user_id&quot;, &quot;item_id&quot;, &quot;event_type&quot;]
}
</code></pre>

<p><strong>Java定義:</strong></p>
<pre class="codehilite"><code class="language-java">TableMetadata eventsMetadata = TableMetadata.newBuilder()
    .addPartitionKey(&quot;yyyymmdd&quot;)
    .addClusteringKey(&quot;event_id&quot;, Scan.Ordering.Order.DESC)
    .addColumn(&quot;yyyymmdd&quot;, DataType.TEXT)
    .addColumn(&quot;event_id&quot;, DataType.TEXT)
    .addColumn(&quot;event_type&quot;, DataType.TEXT)
    .addColumn(&quot;timestamp&quot;, DataType.BIGINT)
    .addColumn(&quot;user_id&quot;, DataType.BIGINT)
    .addColumn(&quot;user_email&quot;, DataType.TEXT)
    .addColumn(&quot;user_name&quot;, DataType.TEXT)
    .addColumn(&quot;item_id&quot;, DataType.BIGINT)
    .addColumn(&quot;item_name&quot;, DataType.TEXT)
    .addColumn(&quot;item_type&quot;, DataType.TEXT)
    .addColumn(&quot;sha1_hash&quot;, DataType.TEXT)
    .addColumn(&quot;parent_folder_id&quot;, DataType.BIGINT)
    .addColumn(&quot;source_json&quot;, DataType.TEXT)
    .addColumn(&quot;created_at&quot;, DataType.BIGINT)
    .addSecondaryIndex(&quot;user_id&quot;)
    .addSecondaryIndex(&quot;item_id&quot;)
    .addSecondaryIndex(&quot;event_type&quot;)
    .build();
</code></pre>

<h3 id="52-events_by_item">5.2 events_by_item テーブル（逆引き用）<a class="headerlink" href="#52-events_by_item" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;event&quot;,
  &quot;table&quot;: &quot;events_by_item&quot;,
  &quot;partition_key&quot;: [&quot;item_id&quot;],
  &quot;clustering_key&quot;: [&quot;timestamp&quot;, &quot;event_id&quot;],
  &quot;clustering_key_order&quot;: {&quot;timestamp&quot;: &quot;DESC&quot;, &quot;event_id&quot;: &quot;DESC&quot;},
  &quot;columns&quot;: {
    &quot;item_id&quot;: &quot;BIGINT&quot;,
    &quot;timestamp&quot;: &quot;BIGINT&quot;,
    &quot;event_id&quot;: &quot;TEXT&quot;,
    &quot;event_type&quot;: &quot;TEXT&quot;,
    &quot;user_id&quot;: &quot;BIGINT&quot;,
    &quot;user_name&quot;: &quot;TEXT&quot;,
    &quot;yyyymmdd&quot;: &quot;TEXT&quot;
  },
  &quot;secondary_indexes&quot;: []
}
</code></pre>

<h3 id="53-position_tracker">5.3 position_tracker テーブル<a class="headerlink" href="#53-position_tracker" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;event&quot;,
  &quot;table&quot;: &quot;position_tracker&quot;,
  &quot;partition_key&quot;: [&quot;tracker_type&quot;],
  &quot;clustering_key&quot;: [],
  &quot;columns&quot;: {
    &quot;tracker_type&quot;: &quot;TEXT&quot;,
    &quot;stream_position&quot;: &quot;TEXT&quot;,
    &quot;last_event_id&quot;: &quot;TEXT&quot;,
    &quot;last_synced_at&quot;: &quot;BIGINT&quot;,
    &quot;updated_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: []
}
</code></pre>

<h3 id="54-auditor_logs">5.4 auditor_logs テーブル<a class="headerlink" href="#54-auditor_logs" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;event&quot;,
  &quot;table&quot;: &quot;auditor_logs&quot;,
  &quot;partition_key&quot;: [&quot;yyyymmdd&quot;],
  &quot;clustering_key&quot;: [&quot;log_id&quot;],
  &quot;clustering_key_order&quot;: {&quot;log_id&quot;: &quot;DESC&quot;},
  &quot;columns&quot;: {
    &quot;yyyymmdd&quot;: &quot;TEXT&quot;,
    &quot;log_id&quot;: &quot;TEXT&quot;,
    &quot;user_email&quot;: &quot;TEXT&quot;,
    &quot;user_name&quot;: &quot;TEXT&quot;,
    &quot;action&quot;: &quot;TEXT&quot;,
    &quot;resource_type&quot;: &quot;TEXT&quot;,
    &quot;resource_id&quot;: &quot;TEXT&quot;,
    &quot;ip_address&quot;: &quot;TEXT&quot;,
    &quot;user_agent&quot;: &quot;TEXT&quot;,
    &quot;created_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: [&quot;user_email&quot;]
}
</code></pre>

<h3 id="55-system_event_dates">5.5 system_event_dates テーブル<a class="headerlink" href="#55-system_event_dates" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-json">{
  &quot;namespace&quot;: &quot;event&quot;,
  &quot;table&quot;: &quot;system_event_dates&quot;,
  &quot;partition_key&quot;: [&quot;date_type&quot;],
  &quot;clustering_key&quot;: [&quot;yyyymmdd&quot;],
  &quot;clustering_key_order&quot;: {&quot;yyyymmdd&quot;: &quot;DESC&quot;},
  &quot;columns&quot;: {
    &quot;date_type&quot;: &quot;TEXT&quot;,
    &quot;yyyymmdd&quot;: &quot;TEXT&quot;,
    &quot;event_count&quot;: &quot;BIGINT&quot;,
    &quot;created_at&quot;: &quot;BIGINT&quot;
  },
  &quot;secondary_indexes&quot;: []
}
</code></pre>

<hr />
<h2 id="6">6. パーティション戦略<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 パーティションキー設計原則<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Namespace</th>
<th>テーブル</th>
<th>パーティションキー</th>
<th>理由</th>
</tr>
</thead>
<tbody>
<tr>
<td>identity</td>
<td>users</td>
<td>user_email</td>
<td>ユニーク識別子、均等分散</td>
</tr>
<tr>
<td>audit</td>
<td>audit_sets</td>
<td>audit_set_id</td>
<td>UUID、均等分散</td>
</tr>
<tr>
<td>audit</td>
<td>audit_set_items</td>
<td>audit_set_id</td>
<td>セット単位でのアクセスパターン</td>
</tr>
<tr>
<td>file</td>
<td>items</td>
<td>item_id</td>
<td>BOX ID、ユニーク</td>
</tr>
<tr>
<td>event</td>
<td>events</td>
<td>yyyymmdd</td>
<td>日付ベースの時系列アクセス</td>
</tr>
</tbody>
</table>
<h3 id="62">6.2 パーティションサイズ見積もり<a class="headerlink" href="#62" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "identity.users"
        U[1レコード ≈ 500B]
        U --> UT[総レコード: 10,000]
        UT --> US[総サイズ: ~5MB]
    end

    subgraph "audit.audit_set_items"
        ASI[1レコード ≈ 300B]
        ASI --> ASIT[平均100アイテム/セット]
        ASIT --> ASIS[パーティション: ~30KB]
    end

    subgraph "event.events"
        E[1レコード ≈ 800B]
        E --> ET[1日10,000イベント]
        ET --> ES[パーティション: ~8MB/日]
    end
</div>

<h3 id="63">6.3 ホットパーティション対策<a class="headerlink" href="#63" title="Permanent link">&para;</a></h3>
<p><strong>イベントテーブル:</strong>
- 日付パーティション（yyyymmdd）で自然分散
- 古いパーティションは読み取り専用</p>
<p><strong>監査セットアイテム:</strong>
- セットIDで分散
- 大規模セット（10,000+アイテム）はページング</p>
<hr />
<h2 id="7">7. インデックス設計<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 セカンダリインデックス一覧<a class="headerlink" href="#71" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Namespace</th>
<th>テーブル</th>
<th>インデックスカラム</th>
<th>用途</th>
</tr>
</thead>
<tbody>
<tr>
<td>identity</td>
<td>users</td>
<td>user_id</td>
<td>BOX ID検索</td>
</tr>
<tr>
<td>identity</td>
<td>users</td>
<td>org_id</td>
<td>組織別ユーザー検索</td>
</tr>
<tr>
<td>audit</td>
<td>audit_sets</td>
<td>owner_id</td>
<td>オーナー別検索</td>
</tr>
<tr>
<td>audit</td>
<td>audit_set_items</td>
<td>monitoring_status</td>
<td>ステータス別フィルタ</td>
</tr>
<tr>
<td>file</td>
<td>items</td>
<td>sha1_hash</td>
<td>重複ファイル検索</td>
</tr>
<tr>
<td>event</td>
<td>events</td>
<td>user_id</td>
<td>ユーザー別イベント検索</td>
</tr>
<tr>
<td>event</td>
<td>events</td>
<td>item_id</td>
<td>アイテム別イベント検索</td>
</tr>
</tbody>
</table>
<h3 id="72">7.2 複合クエリパターン<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">// パターン1: 監査セットのアイテム一覧（ステータスフィルタ）
Scan scan = Scan.newBuilder()
    .namespace(&quot;audit&quot;)
    .table(&quot;audit_set_items&quot;)
    .partitionKey(Key.ofText(&quot;audit_set_id&quot;, auditSetId))
    .orderings(Scan.Ordering.asc(&quot;item_id&quot;))
    .build();

// パターン2: 日付範囲のイベント検索
Scan scan = Scan.newBuilder()
    .namespace(&quot;event&quot;)
    .table(&quot;events&quot;)
    .partitionKey(Key.ofText(&quot;yyyymmdd&quot;, &quot;20250101&quot;))
    .start(Key.ofText(&quot;event_id&quot;, startEventId))
    .limit(100)
    .build();

// パターン3: SHA1によるファイル検索
Scan scan = Scan.newBuilder()
    .namespace(&quot;file&quot;)
    .table(&quot;items_by_sha1&quot;)
    .partitionKey(Key.ofText(&quot;sha1_hash&quot;, sha1Hash))
    .build();
</code></pre>

<hr />
<h2 id="8">8. データ型マッピング<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81-scalardb">8.1 現行モデル → ScalarDBマッピング<a class="headerlink" href="#81-scalardb" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Javaモデル型</th>
<th>現行DB型</th>
<th>ScalarDB型</th>
<th>備考</th>
</tr>
</thead>
<tbody>
<tr>
<td>String</td>
<td>VARCHAR</td>
<td>TEXT</td>
<td>-</td>
</tr>
<tr>
<td>Long</td>
<td>BIGINT</td>
<td>BIGINT</td>
<td>-</td>
</tr>
<tr>
<td>Integer</td>
<td>INT</td>
<td>INT</td>
<td>-</td>
</tr>
<tr>
<td>Boolean</td>
<td>BOOLEAN</td>
<td>BOOLEAN</td>
<td>-</td>
</tr>
<tr>
<td>Instant</td>
<td>TIMESTAMP</td>
<td>BIGINT</td>
<td>Epoch millis</td>
</tr>
<tr>
<td>LocalDate</td>
<td>DATE</td>
<td>TEXT</td>
<td>yyyyMMdd形式</td>
</tr>
<tr>
<td>JSON String</td>
<td>VARCHAR</td>
<td>TEXT</td>
<td>構造化データ</td>
</tr>
</tbody>
</table>
<h3 id="82-json">8.2 JSON列の正規化<a class="headerlink" href="#82-json" title="Permanent link">&para;</a></h3>
<p><strong>現行（非推奨）:</strong></p>
<pre class="codehilite"><code class="language-java">// AuditSet.aclJson - JSON文字列として保存
private String aclJson;
</code></pre>

<p><strong>目標（正規化）:</strong></p>
<pre class="codehilite"><code class="language-java">// audit_set_collaboratorsテーブルで正規化
// パーティションキー: audit_set_id
// クラスタリングキー: user_email
</code></pre>

<hr />
<h2 id="9">9. スキーマ作成スクリプト<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<h3 id="91">9.1 初期化コード<a class="headerlink" href="#91" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">public class SchemaInitializer {
    private final Admin admin;

    public void initializeSchema() throws Exception {
        // Namespaces
        admin.createNamespace(&quot;identity&quot;, true);
        admin.createNamespace(&quot;audit&quot;, true);
        admin.createNamespace(&quot;file&quot;, true);
        admin.createNamespace(&quot;event&quot;, true);

        // Identity tables
        createUsersTable();
        createUserTokensTable();
        createUserOtpsTable();
        createOrganizationsTable();
        createRoleUsersTable();

        // Audit tables
        createAuditSetsTable();
        createAuditSetItemsTable();
        createAuditSetCollaboratorsTable();
        createAuditGroupsTable();
        createAuditGroupMembersTable();
        createAuditGroupSetMappingsTable();

        // File tables
        createItemsTable();
        createItemMonitoringStatusTable();
        createItemsBySha1Table();
        createFileVersionsTable();

        // Event tables
        createEventsTable();
        createEventsByItemTable();
        createPositionTrackerTable();
        createAuditorLogsTable();
        createSystemEventDatesTable();
    }
}
</code></pre>

<h3 id="92">9.2 テーブル作成例<a class="headerlink" href="#92" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">private void createAuditSetsTable() throws Exception {
    TableMetadata metadata = TableMetadata.newBuilder()
        .addPartitionKey(&quot;audit_set_id&quot;)
        .addColumn(&quot;audit_set_id&quot;, DataType.TEXT)
        .addColumn(&quot;audit_set_name&quot;, DataType.TEXT)
        .addColumn(&quot;description&quot;, DataType.TEXT)
        .addColumn(&quot;owner_id&quot;, DataType.BIGINT)
        .addColumn(&quot;owner_email&quot;, DataType.TEXT)
        .addColumn(&quot;owner_name&quot;, DataType.TEXT)
        .addColumn(&quot;is_deleted&quot;, DataType.BOOLEAN)
        .addColumn(&quot;created_at&quot;, DataType.BIGINT)
        .addColumn(&quot;updated_at&quot;, DataType.BIGINT)
        .addSecondaryIndex(&quot;owner_id&quot;)
        .addSecondaryIndex(&quot;owner_email&quot;)
        .build();

    admin.createTable(&quot;audit&quot;, &quot;audit_sets&quot;, metadata, true);
}
</code></pre>

<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: scalar-event-log-fetcher-main</em>
<em>ScalarDB Version: 3.14.x</em></p>
</article>
<article id="design-scalardb-transaction">
<h1 id="scalardb">ScalarDB トランザクション設計<a class="headerlink" href="#scalardb" title="Permanent link">&para;</a></h1>
<h2 id="1">1. トランザクション概要<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 トランザクションパターン分類<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>パターン</th>
<th>適用場面</th>
<th>特徴</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>単一Namespace ACID</strong></td>
<td>同一コンテキスト内操作</td>
<td>Consensus Commit</td>
</tr>
<tr>
<td><strong>分散トランザクション</strong></td>
<td>複数Namespace横断</td>
<td>Two-Phase Commit</td>
</tr>
<tr>
<td><strong>Saga</strong></td>
<td>長時間・複雑なワークフロー</td>
<td>補償トランザクション</td>
</tr>
</tbody>
</table>
<h3 id="12">1.2 トランザクションマネージャ設定<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-properties"># ScalarDB Transaction設定
scalar.db.transaction_manager=consensus-commit
scalar.db.consensus_commit.isolation_level=SERIALIZABLE
scalar.db.consensus_commit.serializable_strategy=EXTRA_READ

# Coordinator設定
scalar.db.consensus_commit.coordinator.namespace=coordinator
scalar.db.consensus_commit.coordinator.group_commit.enabled=true
</code></pre>

<hr />
<h2 id="2-consensus-commit">2. Consensus Commitプロトコル<a class="headerlink" href="#2-consensus-commit" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 プロトコル概要<a class="headerlink" href="#21" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant App as Application
    participant TM as Transaction Manager
    participant Coord as Coordinator
    participant S1 as Storage 1
    participant S2 as Storage 2

    App->>TM: begin()
    TM->>TM: Generate TX ID

    App->>TM: get(key1)
    TM->>S1: read(key1)
    S1-->>TM: value1

    App->>TM: put(key2, value2)
    TM->>TM: Buffer write

    App->>TM: commit()

    Note over TM,S2: Prepare Phase
    TM->>S1: prepare(key1)
    TM->>S2: prepare(key2)
    S1-->>TM: prepared
    S2-->>TM: prepared

    Note over TM,Coord: Commit Phase
    TM->>Coord: commit(TX ID)
    Coord-->>TM: committed

    Note over TM,S2: Finalize Phase
    TM->>S1: commit(key1)
    TM->>S2: commit(key2)

    TM-->>App: success
</div>

<h3 id="22-consensus-commit">2.2 Consensus Commit状態遷移<a class="headerlink" href="#22-consensus-commit" title="Permanent link">&para;</a></h3>
<div class="mermaid">
stateDiagram-v2
    [*] --> Initialized: begin()
    Initialized --> Active: first operation
    Active --> Preparing: commit()
    Preparing --> Prepared: all prepared
    Prepared --> Committing: coordinator committed
    Committing --> Committed: all finalized
    Committed --> [*]

    Active --> Aborting: abort() or error
    Preparing --> Aborting: prepare failed
    Prepared --> Aborting: coordinator commit failed
    Aborting --> Aborted: rollback complete
    Aborted --> [*]
</div>

<hr />
<h2 id="3">3. ユースケース別トランザクション設計<a class="headerlink" href="#3" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 監査セット作成<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant C as Controller
    participant AS as AuditService
    participant TM as TransactionManager
    participant AuditDB as audit namespace
    participant IdentityDB as identity namespace

    C->>AS: createAuditSet(request)
    AS->>TM: begin()

    AS->>IdentityDB: get(user_email) // 作成者確認
    IdentityDB-->>AS: User

    AS->>AuditDB: put(audit_set)
    AS->>AuditDB: put(audit_set_collaborator) // オーナー登録

    AS->>TM: commit()
    TM->>TM: Consensus Commit
    TM-->>AS: success

    AS-->>C: AuditSetResponse
</div>

<p><strong>実装コード:</strong></p>
<pre class="codehilite"><code class="language-java">@Service
public class AuditSetService {
    private final DistributedTransactionManager manager;

    @Transactional
    public AuditSet createAuditSet(CreateAuditSetRequest request) {
        DistributedTransaction tx = manager.start();
        try {
            // 1. ユーザー存在確認
            Get getUser = Get.newBuilder()
                .namespace(&quot;identity&quot;)
                .table(&quot;users&quot;)
                .partitionKey(Key.ofText(&quot;user_email&quot;, request.getOwnerEmail()))
                .build();
            Optional&lt;Result&gt; userResult = tx.get(getUser);
            if (userResult.isEmpty()) {
                throw new UserNotFoundException(request.getOwnerEmail());
            }

            // 2. 監査セット作成
            String auditSetId = UUID.randomUUID().toString();
            Put putAuditSet = Put.newBuilder()
                .namespace(&quot;audit&quot;)
                .table(&quot;audit_sets&quot;)
                .partitionKey(Key.ofText(&quot;audit_set_id&quot;, auditSetId))
                .textValue(&quot;audit_set_name&quot;, request.getName())
                .textValue(&quot;description&quot;, request.getDescription())
                .bigIntValue(&quot;owner_id&quot;, userResult.get().getBigInt(&quot;user_id&quot;))
                .textValue(&quot;owner_email&quot;, request.getOwnerEmail())
                .booleanValue(&quot;is_deleted&quot;, false)
                .bigIntValue(&quot;created_at&quot;, Instant.now().toEpochMilli())
                .build();
            tx.put(putAuditSet);

            // 3. オーナーをコラボレーターとして登録
            Put putCollaborator = Put.newBuilder()
                .namespace(&quot;audit&quot;)
                .table(&quot;audit_set_collaborators&quot;)
                .partitionKey(Key.ofText(&quot;audit_set_id&quot;, auditSetId))
                .clusteringKey(Key.ofText(&quot;user_email&quot;, request.getOwnerEmail()))
                .textValue(&quot;collaborator_role&quot;, &quot;OWNER&quot;)
                .bigIntValue(&quot;created_at&quot;, Instant.now().toEpochMilli())
                .build();
            tx.put(putCollaborator);

            tx.commit();
            return mapToAuditSet(auditSetId, request);

        } catch (Exception e) {
            tx.abort();
            throw new TransactionException(&quot;Failed to create audit set&quot;, e);
        }
    }
}
</code></pre>

<h3 id="32">3.2 監査セットへのアイテム追加<a class="headerlink" href="#32" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant C as Controller
    participant AS as AuditItemService
    participant TM as TransactionManager
    participant AuditDB as audit namespace
    participant FileDB as file namespace
    participant EventDB as event namespace

    C->>AS: addItem(auditSetId, itemId)
    AS->>TM: begin()

    AS->>AuditDB: get(audit_set) // 存在確認
    AS->>AuditDB: get(collaborator) // 権限確認
    AS->>FileDB: get(item) // アイテム情報取得

    AS->>AuditDB: put(audit_set_item)
    AS->>FileDB: put(item_monitoring_status)
    AS->>EventDB: put(auditor_log) // 監査ログ

    AS->>TM: commit()
    TM->>TM: Consensus Commit (3 namespaces)
    TM-->>AS: success

    AS-->>C: AuditSetItemResponse
</div>

<p><strong>実装コード:</strong></p>
<pre class="codehilite"><code class="language-java">@Service
public class AuditItemService {
    private final DistributedTransactionManager manager;

    @Transactional
    public AuditSetItem addItemToAuditSet(String auditSetId, Long itemId, String userEmail) {
        DistributedTransaction tx = manager.start();
        try {
            // 1. 監査セット存在確認
            validateAuditSetExists(tx, auditSetId);

            // 2. 権限確認
            validateUserPermission(tx, auditSetId, userEmail, &quot;ADD_ITEM&quot;);

            // 3. アイテム情報取得
            Get getItem = Get.newBuilder()
                .namespace(&quot;file&quot;)
                .table(&quot;items&quot;)
                .partitionKey(Key.ofBigInt(&quot;item_id&quot;, itemId))
                .build();
            Result itemResult = tx.get(getItem)
                .orElseThrow(() -&gt; new ItemNotFoundException(itemId));

            // 4. 監査セットアイテム登録
            Put putItem = Put.newBuilder()
                .namespace(&quot;audit&quot;)
                .table(&quot;audit_set_items&quot;)
                .partitionKey(Key.ofText(&quot;audit_set_id&quot;, auditSetId))
                .clusteringKey(Key.ofBigInt(&quot;item_id&quot;, itemId))
                .textValue(&quot;item_name&quot;, itemResult.getText(&quot;item_name&quot;))
                .textValue(&quot;item_type&quot;, itemResult.getText(&quot;item_type&quot;))
                .textValue(&quot;monitoring_status&quot;, &quot;PENDING&quot;)
                .textValue(&quot;verification_status&quot;, &quot;NOT_VERIFIED&quot;)
                .bigIntValue(&quot;created_at&quot;, Instant.now().toEpochMilli())
                .build();
            tx.put(putItem);

            // 5. 監視ステータス更新
            Put putStatus = Put.newBuilder()
                .namespace(&quot;file&quot;)
                .table(&quot;item_monitoring_status&quot;)
                .partitionKey(Key.ofBigInt(&quot;item_id&quot;, itemId))
                .textValue(&quot;monitoring_status&quot;, &quot;MONITORING&quot;)
                .bigIntValue(&quot;updated_at&quot;, Instant.now().toEpochMilli())
                .build();
            tx.put(putStatus);

            // 6. 監査ログ記録
            recordAuditLog(tx, userEmail, &quot;ADD_ITEM&quot;, auditSetId, itemId.toString());

            tx.commit();
            return mapToAuditSetItem(auditSetId, itemId);

        } catch (CrudConflictException e) {
            tx.abort();
            throw new ConflictException(&quot;Item already exists in audit set&quot;, e);
        } catch (Exception e) {
            tx.abort();
            throw new TransactionException(&quot;Failed to add item&quot;, e);
        }
    }
}
</code></pre>

<h3 id="33">3.3 コラボレーター招待<a class="headerlink" href="#33" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant C as Controller
    participant CS as CollaboratorService
    participant TM as TransactionManager
    participant AuditDB as audit namespace
    participant IdentityDB as identity namespace

    C->>CS: inviteCollaborator(auditSetId, email, role)
    CS->>TM: begin()

    CS->>AuditDB: get(audit_set)
    CS->>AuditDB: get(inviter_collaborator) // 招待者権限確認
    CS->>IdentityDB: get(invitee_user) // 招待対象者確認

    alt ユーザー存在
        CS->>AuditDB: put(audit_set_collaborator)
        CS->>TM: commit()
        CS-->>C: CollaboratorResponse
    else ユーザー不在
        CS->>TM: abort()
        CS-->>C: UserNotFoundError
    end
</div>

<hr />
<h2 id="4-saga">4. Sagaパターン設計<a class="headerlink" href="#4-saga" title="Permanent link">&para;</a></h2>
<h3 id="41-saga">4.1 監査セット削除Saga<a class="headerlink" href="#41-saga" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant O as Orchestrator
    participant AS as AuditService
    participant IS as ItemService
    participant VS as VerificationService
    participant ES as EventService

    Note over O: Saga開始
    O->>AS: 1. markAuditSetDeleted(id)
    AS-->>O: success

    O->>IS: 2. removeItemMonitoring(items)
    IS-->>O: success

    O->>VS: 3. archiveVerificationRecords(items)
    VS-->>O: success

    O->>ES: 4. logDeletionEvent(auditSetId)
    ES-->>O: success

    Note over O: Saga完了

    Note over O: 補償トランザクション例
    alt Step 3 失敗時
        O->>IS: compensate: restoreItemMonitoring(items)
        O->>AS: compensate: unmarkAuditSetDeleted(id)
    end
</div>

<p><strong>Saga実装:</strong></p>
<pre class="codehilite"><code class="language-java">@Service
public class AuditSetDeletionSaga {
    private final AuditService auditService;
    private final ItemService itemService;
    private final VerificationService verificationService;
    private final EventService eventService;

    public void deleteAuditSet(String auditSetId, String userId) {
        SagaContext context = new SagaContext();

        try {
            // Step 1: 監査セット論理削除
            auditService.markDeleted(auditSetId);
            context.addCompensation(() -&gt; auditService.unmarkDeleted(auditSetId));

            // Step 2: アイテム一覧取得と監視解除
            List&lt;Long&gt; itemIds = auditService.getItemIds(auditSetId);
            itemService.removeMonitoring(itemIds);
            context.addCompensation(() -&gt; itemService.restoreMonitoring(itemIds));

            // Step 3: 検証記録アーカイブ
            verificationService.archiveRecords(auditSetId);
            context.addCompensation(() -&gt; verificationService.restoreRecords(auditSetId));

            // Step 4: 削除イベント記録
            eventService.logDeletion(auditSetId, userId);
            // イベント記録は補償不要

            // Saga完了
            context.complete();

        } catch (Exception e) {
            // 補償トランザクション実行
            context.compensate();
            throw new SagaFailedException(&quot;Audit set deletion failed&quot;, e);
        }
    }
}

public class SagaContext {
    private final List&lt;Runnable&gt; compensations = new ArrayList&lt;&gt;();
    private boolean completed = false;

    public void addCompensation(Runnable compensation) {
        compensations.add(0, compensation); // 逆順で実行
    }

    public void compensate() {
        if (!completed) {
            compensations.forEach(c -&gt; {
                try {
                    c.run();
                } catch (Exception e) {
                    log.error(&quot;Compensation failed&quot;, e);
                }
            });
        }
    }

    public void complete() {
        completed = true;
    }
}
</code></pre>

<h3 id="42-saga">4.2 改ざん検証Saga<a class="headerlink" href="#42-saga" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant O as Orchestrator
    participant FS as FileService
    participant VS as VerificationService
    participant SDL as ScalarDL
    participant AS as AuditService
    participant ES as EventService

    Note over O: 検証Saga開始
    O->>FS: 1. getFileSha1(itemId)
    FS-->>O: sha1Hash

    O->>SDL: 2. validateAsset(itemId, sha1)
    SDL-->>O: validationResult

    O->>VS: 3. updateVerificationStatus(itemId, result)
    VS-->>O: success

    O->>AS: 4. updateItemVerificationStatus(auditSetId, itemId)
    AS-->>O: success

    O->>ES: 5. logVerificationEvent(itemId, result)
    ES-->>O: success

    Note over O: Saga完了
</div>

<hr />
<h2 id="5">5. 例外処理戦略<a class="headerlink" href="#5" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 例外分類<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>例外タイプ</th>
<th>対応</th>
<th>例</th>
</tr>
</thead>
<tbody>
<tr>
<td><strong>Transient</strong></td>
<td>リトライ</td>
<td>CrudConflictException, CommitConflictException</td>
</tr>
<tr>
<td><strong>Non-Transient</strong></td>
<td>エラー返却</td>
<td>ValidationException, NotFoundException</td>
</tr>
<tr>
<td><strong>Unknown</strong></td>
<td>冪等性チェック</td>
<td>UnknownTransactionStatusException</td>
</tr>
</tbody>
</table>
<h3 id="52">5.2 リトライ戦略<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">@Component
public class TransactionRetryHandler {
    private static final int MAX_RETRIES = 3;
    private static final long INITIAL_BACKOFF_MS = 100;

    public &lt;T&gt; T executeWithRetry(Supplier&lt;T&gt; operation) {
        int attempt = 0;
        while (true) {
            try {
                return operation.get();
            } catch (CrudConflictException | CommitConflictException e) {
                attempt++;
                if (attempt &gt;= MAX_RETRIES) {
                    throw new RetryExhaustedException(&quot;Max retries exceeded&quot;, e);
                }
                backoff(attempt);
            }
        }
    }

    private void backoff(int attempt) {
        long sleepMs = INITIAL_BACKOFF_MS * (1L &lt;&lt; (attempt - 1));
        try {
            Thread.sleep(sleepMs + ThreadLocalRandom.current().nextLong(50));
        } catch (InterruptedException e) {
            Thread.currentThread().interrupt();
        }
    }
}
</code></pre>

<h3 id="53-unknowntransactionstatus">5.3 UnknownTransactionStatus処理<a class="headerlink" href="#53-unknowntransactionstatus" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">public class IdempotentTransactionHandler {
    private final DistributedTransactionManager manager;
    private final IdempotencyKeyStore keyStore;

    public &lt;T&gt; T executeIdempotent(String idempotencyKey, Supplier&lt;T&gt; operation) {
        // 1. 既存結果チェック
        Optional&lt;T&gt; existingResult = keyStore.get(idempotencyKey);
        if (existingResult.isPresent()) {
            return existingResult.get();
        }

        DistributedTransaction tx = manager.start();
        try {
            T result = operation.get();
            tx.commit();

            // 結果を保存
            keyStore.save(idempotencyKey, result);
            return result;

        } catch (UnknownTransactionStatusException e) {
            // トランザクション状態不明
            // コーディネーターをチェック
            TransactionState state = manager.getState(tx.getId());

            if (state == TransactionState.COMMITTED) {
                // コミット済み - 結果を再構築
                T result = reconstructResult(tx.getId());
                keyStore.save(idempotencyKey, result);
                return result;
            } else {
                // 未コミット - エラー返却
                throw new TransactionFailedException(&quot;Transaction status unknown&quot;, e);
            }
        } catch (Exception e) {
            tx.abort();
            throw new TransactionException(&quot;Transaction failed&quot;, e);
        }
    }
}
</code></pre>

<h3 id="54">5.4 例外ハンドラ<a class="headerlink" href="#54" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">@ControllerAdvice
public class ScalarDbExceptionHandler {

    @ExceptionHandler(CrudConflictException.class)
    public ResponseEntity&lt;ErrorResponse&gt; handleConflict(CrudConflictException e) {
        log.warn(&quot;CRUD conflict: {}&quot;, e.getMessage());
        return ResponseEntity
            .status(HttpStatus.CONFLICT)
            .body(new ErrorResponse(&quot;CONFLICT&quot;, &quot;Resource was modified by another transaction&quot;));
    }

    @ExceptionHandler(CommitConflictException.class)
    public ResponseEntity&lt;ErrorResponse&gt; handleCommitConflict(CommitConflictException e) {
        log.warn(&quot;Commit conflict: {}&quot;, e.getMessage());
        return ResponseEntity
            .status(HttpStatus.CONFLICT)
            .body(new ErrorResponse(&quot;COMMIT_CONFLICT&quot;, &quot;Transaction commit failed due to conflict&quot;));
    }

    @ExceptionHandler(UnknownTransactionStatusException.class)
    public ResponseEntity&lt;ErrorResponse&gt; handleUnknown(UnknownTransactionStatusException e) {
        log.error(&quot;Unknown transaction status: {}&quot;, e.getMessage());
        return ResponseEntity
            .status(HttpStatus.INTERNAL_SERVER_ERROR)
            .body(new ErrorResponse(&quot;UNKNOWN_STATUS&quot;, &quot;Transaction status is unknown. Please retry.&quot;));
    }

    @ExceptionHandler(PreparationConflictException.class)
    public ResponseEntity&lt;ErrorResponse&gt; handlePreparationConflict(PreparationConflictException e) {
        log.warn(&quot;Preparation conflict: {}&quot;, e.getMessage());
        return ResponseEntity
            .status(HttpStatus.CONFLICT)
            .body(new ErrorResponse(&quot;PREPARATION_CONFLICT&quot;, &quot;Transaction preparation failed&quot;));
    }
}
</code></pre>

<hr />
<h2 id="6-two-phase-commit">6. Two-Phase Commit設計<a class="headerlink" href="#6-two-phase-commit" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 サービス間トランザクション<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant App as Application
    participant TM1 as TX Manager (Audit)
    participant TM2 as TX Manager (File)
    participant Coord as Coordinator

    App->>TM1: beginTwoPhaseCommit()
    App->>TM2: join(tx.getId())

    App->>TM1: operations...
    App->>TM2: operations...

    App->>TM1: prepare()
    App->>TM2: prepare()

    TM1-->>App: prepared
    TM2-->>App: prepared

    App->>TM1: validate()
    App->>TM2: validate()

    TM1-->>App: validated
    TM2-->>App: validated

    App->>Coord: commit(tx.getId())
    Coord-->>App: committed

    App->>TM1: commit()
    App->>TM2: commit()
</div>

<h3 id="62-two-phase-commit">6.2 Two-Phase Commit実装<a class="headerlink" href="#62-two-phase-commit" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">@Service
public class CrossServiceTransactionManager {
    private final TwoPhaseCommitTransactionManager txManager;

    public void executeAcrossServices(CrossServiceOperation operation) {
        TwoPhaseCommitTransaction tx = txManager.begin();
        try {
            // 1. 各サービスの操作実行
            operation.execute(tx);

            // 2. Prepare Phase
            tx.prepare();

            // 3. Validation Phase
            tx.validate();

            // 4. Commit Phase
            tx.commit();

        } catch (PreparationConflictException e) {
            tx.rollback();
            throw new TransactionConflictException(&quot;Prepare failed&quot;, e);
        } catch (ValidationConflictException e) {
            tx.rollback();
            throw new TransactionConflictException(&quot;Validation failed&quot;, e);
        } catch (CommitConflictException e) {
            tx.rollback();
            throw new TransactionConflictException(&quot;Commit failed&quot;, e);
        }
    }
}
</code></pre>

<hr />
<h2 id="7">7. パフォーマンス最適化<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71-group-commit">7.1 Group Commit<a class="headerlink" href="#71-group-commit" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-properties"># Group Commit設定
scalar.db.consensus_commit.coordinator.group_commit.enabled=true
scalar.db.consensus_commit.coordinator.group_commit.slot_capacity=20
scalar.db.consensus_commit.coordinator.group_commit.group_size_fix_timeout_millis=40
scalar.db.consensus_commit.coordinator.group_commit.delayed_slot_move_timeout_millis=800
</code></pre>

<div class="mermaid">
graph LR
    subgraph "Without Group Commit"
        T1[TX1] --> C1[Commit]
        T2[TX2] --> C2[Commit]
        T3[TX3] --> C3[Commit]
        C1 --> DB1[(DB Write)]
        C2 --> DB2[(DB Write)]
        C3 --> DB3[(DB Write)]
    end

    subgraph "With Group Commit"
        GT1[TX1] --> GC[Group]
        GT2[TX2] --> GC
        GT3[TX3] --> GC
        GC --> GDB[(Single DB Write)]
    end
</div>

<h3 id="72">7.2 並列実行<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-properties"># Parallel Execution
scalar.db.consensus_commit.parallel_executor_count=32
scalar.db.consensus_commit.parallel_preparation_enabled=true
scalar.db.consensus_commit.parallel_validation_enabled=true
scalar.db.consensus_commit.parallel_commit_enabled=true
scalar.db.consensus_commit.parallel_rollback_enabled=true
</code></pre>

<h3 id="73">7.3 読み取り最適化<a class="headerlink" href="#73" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">// 複数キーの並列読み取り
public List&lt;Result&gt; batchGet(List&lt;Get&gt; gets) {
    return tx.get(gets); // 内部で並列化
}

// Scan最適化
Scan scan = Scan.newBuilder()
    .namespace(&quot;audit&quot;)
    .table(&quot;audit_set_items&quot;)
    .partitionKey(Key.ofText(&quot;audit_set_id&quot;, auditSetId))
    .limit(100)  // ページサイズ制限
    .projections(&quot;item_id&quot;, &quot;item_name&quot;, &quot;monitoring_status&quot;)  // 必要カラムのみ
    .build();
</code></pre>

<hr />
<h2 id="8">8. モニタリング<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 トランザクションメトリクス<a class="headerlink" href="#81" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-yaml">metrics:
  - name: scalardb_transaction_duration_seconds
    type: histogram
    labels: [operation, namespace, status]

  - name: scalardb_transaction_total
    type: counter
    labels: [namespace, status]

  - name: scalardb_conflict_total
    type: counter
    labels: [type, namespace]

  - name: scalardb_retry_total
    type: counter
    labels: [namespace]
</code></pre>

<h3 id="82">8.2 ログ設計<a class="headerlink" href="#82" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">@Aspect
@Component
public class TransactionLoggingAspect {

    @Around(&quot;@annotation(Transactional)&quot;)
    public Object logTransaction(ProceedingJoinPoint pjp) throws Throwable {
        String txId = UUID.randomUUID().toString();
        long start = System.currentTimeMillis();

        MDC.put(&quot;txId&quot;, txId);
        log.info(&quot;TX_START: method={}&quot;, pjp.getSignature().getName());

        try {
            Object result = pjp.proceed();
            long duration = System.currentTimeMillis() - start;
            log.info(&quot;TX_COMMIT: duration={}ms&quot;, duration);
            return result;
        } catch (Exception e) {
            long duration = System.currentTimeMillis() - start;
            log.error(&quot;TX_ABORT: duration={}ms, error={}&quot;, duration, e.getMessage());
            throw e;
        } finally {
            MDC.remove(&quot;txId&quot;);
        }
    }
}
</code></pre>

<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: scalar-event-log-fetcher-main</em>
<em>ScalarDB Version: 3.14.x</em></p>
</article>
<article id="design-scalardb-migration">
<h1 id="scalardb">ScalarDB マイグレーション計画<a class="headerlink" href="#scalardb" title="Permanent link">&para;</a></h1>
<h2 id="1">1. マイグレーション概要<a class="headerlink" href="#1" title="Permanent link">&para;</a></h2>
<h3 id="11">1.1 現状構成<a class="headerlink" href="#11" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "Current System"
        APP[Spring Boot App]
        SDB_CURRENT[(ScalarDB Cluster<br/>Single Storage)]
        SDL[(ScalarDL)]
    end

    APP --> SDB_CURRENT
    APP --> SDL
</div>

<h3 id="12">1.2 目標構成<a class="headerlink" href="#12" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "Target System"
        IS[Identity Service]
        AS[Audit Service]
        FS[File Service]
        ES[Event Service]
        VS[Verification Service]
    end

    subgraph "ScalarDB Cluster"
        LB[Load Balancer]
        SDB1[Node 1]
        SDB2[Node 2]
        SDB3[Node 3]
    end

    subgraph "Multi-Storage"
        PG[(PostgreSQL)]
        CS[(Cassandra)]
        SDL[(ScalarDL)]
    end

    IS --> LB
    AS --> LB
    FS --> LB
    ES --> LB
    VS --> LB

    LB --> SDB1
    LB --> SDB2
    LB --> SDB3

    SDB1 --> PG
    SDB1 --> CS
    VS --> SDL
</div>

<h3 id="13">1.3 マイグレーション戦略<a class="headerlink" href="#13" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>フェーズ</th>
<th>内容</th>
<th>期間</th>
<th>リスク</th>
</tr>
</thead>
<tbody>
<tr>
<td>Phase 0</td>
<td>準備・検証環境構築</td>
<td>2週間</td>
<td>低</td>
</tr>
<tr>
<td>Phase 1</td>
<td>スキーマ移行・並行書き込み</td>
<td>4週間</td>
<td>中</td>
</tr>
<tr>
<td>Phase 2</td>
<td>段階的切り替え</td>
<td>4週間</td>
<td>中</td>
</tr>
<tr>
<td>Phase 3</td>
<td>完全移行・旧環境廃止</td>
<td>2週間</td>
<td>低</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="2-phase-0-2">2. Phase 0: 準備（2週間）<a class="headerlink" href="#2-phase-0-2" title="Permanent link">&para;</a></h2>
<h3 id="21">2.1 環境構築<a class="headerlink" href="#21" title="Permanent link">&para;</a></h3>
<div class="mermaid">
gantt
    title Phase 0 スケジュール
    dateFormat YYYY-MM-DD
    section インフラ
    PostgreSQL Cluster構築     :p0-1, 2025-01-06, 3d
    Cassandra Cluster構築      :p0-2, 2025-01-06, 3d
    ScalarDB Cluster構築       :p0-3, after p0-1, 3d
    section 検証
    接続テスト                 :p0-4, after p0-3, 2d
    負荷テスト                 :p0-5, after p0-4, 3d
</div>

<h3 id="22">2.2 インフラ構成<a class="headerlink" href="#22" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-yaml"># Kubernetes構成例
---
# PostgreSQL StatefulSet
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: postgresql
spec:
  serviceName: postgresql
  replicas: 3
  selector:
    matchLabels:
      app: postgresql
  template:
    spec:
      containers:
      - name: postgresql
        image: postgres:15
        resources:
          requests:
            cpu: &quot;2&quot;
            memory: &quot;8Gi&quot;
          limits:
            cpu: &quot;4&quot;
            memory: &quot;16Gi&quot;
        volumeMounts:
        - name: data
          mountPath: /var/lib/postgresql/data
  volumeClaimTemplates:
  - metadata:
      name: data
    spec:
      accessModes: [&quot;ReadWriteOnce&quot;]
      resources:
        requests:
          storage: 100Gi
---
# ScalarDB Cluster Deployment
apiVersion: apps/v1
kind: Deployment
metadata:
  name: scalardb-cluster
spec:
  replicas: 3
  selector:
    matchLabels:
      app: scalardb-cluster
  template:
    spec:
      containers:
      - name: scalardb-cluster
        image: ghcr.io/scalar-labs/scalardb-cluster-node:3.14.0
        ports:
        - containerPort: 60053  # gRPC
        - containerPort: 9080   # GraphQL
        env:
        - name: SCALAR_DB_CLUSTER_MEMBERSHIP_TYPE
          value: &quot;KUBERNETES&quot;
        volumeMounts:
        - name: config
          mountPath: /scalardb-cluster/config
</code></pre>

<h3 id="23">2.3 スキーマ作成スクリプト<a class="headerlink" href="#23" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">public class MigrationSchemaCreator {
    private final Admin admin;

    public void createAllSchemas() throws Exception {
        // Phase 0: 新環境にスキーマ作成
        createNamespaces();
        createIdentityTables();
        createAuditTables();
        createFileTables();
        createEventTables();
    }

    private void createNamespaces() throws Exception {
        admin.createNamespace(&quot;identity&quot;, true);
        admin.createNamespace(&quot;audit&quot;, true);
        admin.createNamespace(&quot;file&quot;, true);
        admin.createNamespace(&quot;event&quot;, true);
        admin.createNamespace(&quot;coordinator&quot;, true);
    }

    private void createIdentityTables() throws Exception {
        // users table
        TableMetadata usersMetadata = TableMetadata.newBuilder()
            .addPartitionKey(&quot;user_email&quot;)
            .addColumn(&quot;user_email&quot;, DataType.TEXT)
            .addColumn(&quot;user_id&quot;, DataType.BIGINT)
            .addColumn(&quot;name&quot;, DataType.TEXT)
            .addColumn(&quot;password_hash&quot;, DataType.TEXT)
            .addColumn(&quot;role&quot;, DataType.TEXT)
            .addColumn(&quot;org_id&quot;, DataType.TEXT)
            .addColumn(&quot;is_deleted&quot;, DataType.BOOLEAN)
            .addColumn(&quot;created_at&quot;, DataType.BIGINT)
            .addColumn(&quot;updated_at&quot;, DataType.BIGINT)
            .addSecondaryIndex(&quot;user_id&quot;)
            .addSecondaryIndex(&quot;org_id&quot;)
            .build();
        admin.createTable(&quot;identity&quot;, &quot;users&quot;, usersMetadata, true);

        // 他のidentityテーブル...
    }
}
</code></pre>

<h3 id="24">2.4 検証項目<a class="headerlink" href="#24" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>項目</th>
<th>確認内容</th>
<th>合格基準</th>
</tr>
</thead>
<tbody>
<tr>
<td>接続テスト</td>
<td>各ストレージへの接続</td>
<td>全ノード接続成功</td>
</tr>
<tr>
<td>CRUD テスト</td>
<td>基本操作の動作確認</td>
<td>エラーなし</td>
</tr>
<tr>
<td>トランザクションテスト</td>
<td>Consensus Commit動作</td>
<td>整合性保持</td>
</tr>
<tr>
<td>負荷テスト</td>
<td>1000 TPS達成</td>
<td>レイテンシP99 &lt; 500ms</td>
</tr>
<tr>
<td>障害テスト</td>
<td>ノード障害時の動作</td>
<td>30秒以内に復旧</td>
</tr>
</tbody>
</table>
<hr />
<h2 id="3-phase-1-4">3. Phase 1: 並行書き込み（4週間）<a class="headerlink" href="#3-phase-1-4" title="Permanent link">&para;</a></h2>
<h3 id="31">3.1 アーキテクチャ<a class="headerlink" href="#31" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "Application"
        APP[Spring Boot App]
        DW[Dual Write Interceptor]
    end

    subgraph "Old System"
        OLD_SDB[(Current ScalarDB)]
    end

    subgraph "New System"
        NEW_SDB[(New ScalarDB Cluster)]
    end

    APP --> DW
    DW -->|Primary| OLD_SDB
    DW -->|Shadow| NEW_SDB
</div>

<h3 id="32-dual-write">3.2 Dual Write実装<a class="headerlink" href="#32-dual-write" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">@Component
public class DualWriteTransactionManager implements DistributedTransactionManager {
    private final DistributedTransactionManager primaryManager;  // 旧環境
    private final DistributedTransactionManager shadowManager;   // 新環境
    private final DualWriteConfig config;

    @Override
    public DistributedTransaction start() {
        return new DualWriteTransaction(
            primaryManager.start(),
            shadowManager.start(),
            config
        );
    }
}

public class DualWriteTransaction implements DistributedTransaction {
    private final DistributedTransaction primaryTx;
    private final DistributedTransaction shadowTx;
    private final DualWriteConfig config;
    private final List&lt;Mutation&gt; mutations = new ArrayList&lt;&gt;();

    @Override
    public Optional&lt;Result&gt; get(Get get) throws CrudException {
        // 読み取りはPrimaryのみ
        return primaryTx.get(get);
    }

    @Override
    public void put(Put put) throws CrudException {
        mutations.add(put);
        primaryTx.put(put);

        if (config.isShadowWriteEnabled()) {
            try {
                Put shadowPut = convertToNewSchema(put);
                shadowTx.put(shadowPut);
            } catch (Exception e) {
                log.error(&quot;Shadow write failed&quot;, e);
                // Shadow書き込み失敗は無視（ログのみ）
            }
        }
    }

    @Override
    public void commit() throws CommitException {
        // Primary優先でコミット
        primaryTx.commit();

        if (config.isShadowWriteEnabled()) {
            try {
                shadowTx.commit();
            } catch (Exception e) {
                log.error(&quot;Shadow commit failed, scheduling async sync&quot;, e);
                scheduleAsyncSync(mutations);
            }
        }
    }

    private Put convertToNewSchema(Put originalPut) {
        // 旧スキーマ → 新スキーマ変換
        String namespace = mapNamespace(originalPut.forNamespace().get());
        String table = mapTable(originalPut.forTable().get());

        return Put.newBuilder()
            .namespace(namespace)
            .table(table)
            .partitionKey(convertKey(originalPut.getPartitionKey()))
            .clusteringKey(convertClusteringKey(originalPut.getClusteringKey()))
            // ... 値のマッピング
            .build();
    }
}
</code></pre>

<h3 id="33">3.3 データ同期バッチ<a class="headerlink" href="#33" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">@Component
public class DataSyncBatch {
    private final DistributedTransactionManager oldManager;
    private final DistributedTransactionManager newManager;

    @Scheduled(cron = &quot;0 0 2 * * *&quot;)  // 毎日2:00
    public void syncData() {
        log.info(&quot;Starting data sync batch&quot;);

        // テーブルごとに同期
        syncUsers();
        syncAuditSets();
        syncAuditSetItems();
        syncEvents();

        log.info(&quot;Data sync batch completed&quot;);
    }

    private void syncUsers() {
        DistributedTransaction oldTx = oldManager.start();
        DistributedTransaction newTx = newManager.start();

        try {
            Scan scan = Scan.newBuilder()
                .namespace(&quot;events_log_tool&quot;)
                .table(&quot;user&quot;)
                .all()
                .build();

            List&lt;Result&gt; results = oldTx.scan(scan);

            for (Result result : results) {
                Put put = convertUserToNewSchema(result);
                newTx.put(put);
            }

            newTx.commit();
            log.info(&quot;Synced {} users&quot;, results.size());

        } catch (Exception e) {
            newTx.abort();
            throw new SyncException(&quot;User sync failed&quot;, e);
        } finally {
            oldTx.abort();  // 読み取り専用
        }
    }

    private Put convertUserToNewSchema(Result oldUser) {
        return Put.newBuilder()
            .namespace(&quot;identity&quot;)
            .table(&quot;users&quot;)
            .partitionKey(Key.ofText(&quot;user_email&quot;, oldUser.getText(&quot;userEmail&quot;)))
            .bigIntValue(&quot;user_id&quot;, oldUser.getBigInt(&quot;id&quot;))
            .textValue(&quot;name&quot;, oldUser.getText(&quot;name&quot;))
            .textValue(&quot;password_hash&quot;, oldUser.getText(&quot;password&quot;))
            .textValue(&quot;role&quot;, oldUser.getText(&quot;roleJson&quot;))
            .textValue(&quot;org_id&quot;, oldUser.getText(&quot;orgId&quot;))
            .booleanValue(&quot;is_deleted&quot;, oldUser.getBoolean(&quot;isDeleted&quot;))
            .bigIntValue(&quot;created_at&quot;, System.currentTimeMillis())
            .bigIntValue(&quot;updated_at&quot;, System.currentTimeMillis())
            .build();
    }
}
</code></pre>

<h3 id="34">3.4 検証クエリ<a class="headerlink" href="#34" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">@Component
public class DataVerifier {
    private final DistributedTransactionManager oldManager;
    private final DistributedTransactionManager newManager;

    public VerificationResult verify() {
        VerificationResult result = new VerificationResult();

        // ユーザー数比較
        long oldUserCount = countRecords(oldManager, &quot;events_log_tool&quot;, &quot;user&quot;);
        long newUserCount = countRecords(newManager, &quot;identity&quot;, &quot;users&quot;);
        result.addCheck(&quot;users&quot;, oldUserCount, newUserCount);

        // 監査セット数比較
        long oldAuditSetCount = countRecords(oldManager, &quot;events_log_tool&quot;, &quot;audit_set&quot;);
        long newAuditSetCount = countRecords(newManager, &quot;audit&quot;, &quot;audit_sets&quot;);
        result.addCheck(&quot;audit_sets&quot;, oldAuditSetCount, newAuditSetCount);

        // サンプルデータ整合性チェック
        verifyRandomSamples(result, 100);

        return result;
    }

    private void verifyRandomSamples(VerificationResult result, int sampleSize) {
        // ランダムサンプリングで詳細比較
        List&lt;String&gt; sampleEmails = getSampleUserEmails(sampleSize);

        for (String email : sampleEmails) {
            Result oldUser = getOldUser(email);
            Result newUser = getNewUser(email);

            if (!compareUserData(oldUser, newUser)) {
                result.addMismatch(&quot;user&quot;, email);
            }
        }
    }
}
</code></pre>

<h3 id="35-phase-1">3.5 Phase 1 チェックリスト<a class="headerlink" href="#35-phase-1" title="Permanent link">&para;</a></h3>
<ul>
<li>[ ] Dual Write Interceptor実装</li>
<li>[ ] スキーマ変換ロジック実装</li>
<li>[ ] 初期データ移行バッチ実行</li>
<li>[ ] 日次同期バッチ設定</li>
<li>[ ] データ整合性検証</li>
<li>[ ] パフォーマンス影響確認（レイテンシ+10%以内）</li>
<li>[ ] エラー監視設定</li>
</ul>
<hr />
<h2 id="4-phase-2-4">4. Phase 2: 段階的切り替え（4週間）<a class="headerlink" href="#4-phase-2-4" title="Permanent link">&para;</a></h2>
<h3 id="41">4.1 切り替え戦略<a class="headerlink" href="#41" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph LR
    subgraph "Week 1"
        W1[読み取り: 10% New<br/>書き込み: 100% Both]
    end

    subgraph "Week 2"
        W2[読み取り: 50% New<br/>書き込み: 100% Both]
    end

    subgraph "Week 3"
        W3[読み取り: 100% New<br/>書き込み: 100% Both]
    end

    subgraph "Week 4"
        W4[読み取り: 100% New<br/>書き込み: 100% New]
    end

    W1 --> W2 --> W3 --> W4
</div>

<h3 id="42-feature-flag">4.2 Feature Flag実装<a class="headerlink" href="#42-feature-flag" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">@Component
public class MigrationFeatureFlags {
    private final FeatureFlagClient client;

    // 読み取り先の制御
    public ReadSource getReadSource(String namespace) {
        int percentage = client.getIntValue(&quot;migration.read.new_percentage&quot;, 0);
        return ThreadLocalRandom.current().nextInt(100) &lt; percentage
            ? ReadSource.NEW
            : ReadSource.OLD;
    }

    // 書き込み先の制御
    public WriteMode getWriteMode() {
        String mode = client.getStringValue(&quot;migration.write.mode&quot;, &quot;DUAL&quot;);
        return WriteMode.valueOf(mode);
    }

    public enum ReadSource { OLD, NEW }
    public enum WriteMode { OLD_ONLY, DUAL, NEW_ONLY }
}

@Component
public class MigrationAwareTransactionManager {
    private final DistributedTransactionManager oldManager;
    private final DistributedTransactionManager newManager;
    private final MigrationFeatureFlags flags;

    public DistributedTransaction start() {
        WriteMode writeMode = flags.getWriteMode();

        return switch (writeMode) {
            case OLD_ONLY -&gt; new SingleTransaction(oldManager.start());
            case DUAL -&gt; new DualWriteTransaction(
                oldManager.start(),
                newManager.start()
            );
            case NEW_ONLY -&gt; new SingleTransaction(newManager.start());
        };
    }

    public Optional&lt;Result&gt; get(Get get) {
        ReadSource source = flags.getReadSource(get.forNamespace().get());

        return switch (source) {
            case OLD -&gt; oldManager.start().get(convertToOldSchema(get));
            case NEW -&gt; newManager.start().get(get);
        };
    }
}
</code></pre>

<h3 id="43">4.3 カナリアリリース<a class="headerlink" href="#43" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-yaml"># Kubernetes Canary Deployment
apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: auditor-app
spec:
  replicas: 10
  strategy:
    canary:
      steps:
      - setWeight: 10
      - pause: {duration: 1h}
      - setWeight: 30
      - pause: {duration: 1h}
      - setWeight: 50
      - pause: {duration: 1h}
      - setWeight: 100
      analysis:
        templates:
        - templateName: success-rate
        args:
        - name: service-name
          value: auditor-app
</code></pre>

<h3 id="44">4.4 ロールバック手順<a class="headerlink" href="#44" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">@Component
public class MigrationRollback {
    private final MigrationFeatureFlags flags;
    private final AlertService alertService;

    public void executeRollback(RollbackReason reason) {
        log.warn(&quot;Initiating rollback: {}&quot;, reason);

        // 1. Feature Flagを即座に変更
        flags.setWriteMode(WriteMode.OLD_ONLY);
        flags.setReadPercentage(0);

        // 2. 進行中のトランザクションの完了を待機
        waitForInFlightTransactions(Duration.ofSeconds(30));

        // 3. アラート送信
        alertService.sendCritical(&quot;Migration rollback executed: &quot; + reason);

        // 4. ログ記録
        log.info(&quot;Rollback completed&quot;);
    }

    public void executeEmergencyRollback() {
        // 即座にロールバック（待機なし）
        flags.setWriteMode(WriteMode.OLD_ONLY);
        flags.setReadPercentage(0);
        alertService.sendCritical(&quot;Emergency rollback executed&quot;);
    }
}
</code></pre>

<h3 id="45-phase-2">4.5 Phase 2 モニタリング<a class="headerlink" href="#45-phase-2" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-yaml"># Prometheus AlertRules
groups:
- name: migration
  rules:
  - alert: MigrationHighErrorRate
    expr: |
      rate(scalardb_transaction_total{status=&quot;error&quot;}[5m])
      / rate(scalardb_transaction_total[5m]) &gt; 0.01
    for: 5m
    labels:
      severity: warning
    annotations:
      summary: &quot;Migration error rate &gt; 1%&quot;

  - alert: MigrationDataMismatch
    expr: migration_data_mismatch_count &gt; 0
    for: 1m
    labels:
      severity: critical
    annotations:
      summary: &quot;Data mismatch detected between old and new systems&quot;

  - alert: MigrationLatencyIncrease
    expr: |
      histogram_quantile(0.99, rate(scalardb_transaction_duration_seconds_bucket[5m]))
      &gt; histogram_quantile(0.99, rate(scalardb_transaction_duration_seconds_bucket[5m] offset 1d)) * 1.5
    for: 10m
    labels:
      severity: warning
    annotations:
      summary: &quot;Transaction latency increased 50% compared to yesterday&quot;
</code></pre>

<hr />
<h2 id="5-phase-3-2">5. Phase 3: 完全移行（2週間）<a class="headerlink" href="#5-phase-3-2" title="Permanent link">&para;</a></h2>
<h3 id="51">5.1 最終切り替え<a class="headerlink" href="#51" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant OPS as Operations
    participant FF as Feature Flags
    participant APP as Application
    participant OLD as Old ScalarDB
    participant NEW as New ScalarDB

    OPS->>FF: Set write_mode = NEW_ONLY
    FF-->>APP: Configuration Updated

    Note over APP: 新環境のみに書き込み

    OPS->>OPS: Wait for stability (24h)

    OPS->>OLD: Disable write access
    OPS->>OPS: Final data verification

    OPS->>OLD: Archive and shutdown
</div>

<h3 id="52">5.2 旧環境廃止手順<a class="headerlink" href="#52" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-bash">#!/bin/bash
# decommission-old-env.sh

echo &quot;=== Phase 3: Old Environment Decommission ===&quot;

# 1. 最終データ検証
echo &quot;Step 1: Final data verification...&quot;
./verify-data.sh
if [ $? -ne 0 ]; then
    echo &quot;ERROR: Data verification failed&quot;
    exit 1
fi

# 2. 旧環境の読み取り専用化
echo &quot;Step 2: Setting old environment to read-only...&quot;
kubectl patch configmap scalardb-old-config \
    -p '{&quot;data&quot;:{&quot;read_only&quot;:&quot;true&quot;}}'

# 3. アプリケーションからの接続解除確認
echo &quot;Step 3: Verifying no active connections...&quot;
./check-connections.sh old-scalardb
if [ $? -ne 0 ]; then
    echo &quot;WARNING: Active connections detected&quot;
    read -p &quot;Continue? (y/n) &quot; -n 1 -r
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        exit 1
    fi
fi

# 4. データアーカイブ
echo &quot;Step 4: Archiving data...&quot;
./archive-data.sh old-scalardb s3://backup-bucket/scalardb-migration/

# 5. 旧環境停止
echo &quot;Step 5: Stopping old environment...&quot;
kubectl scale deployment old-scalardb --replicas=0

# 6. リソース削除（7日後に自動実行）
echo &quot;Step 6: Scheduling resource deletion in 7 days...&quot;
kubectl apply -f cleanup-job.yaml

echo &quot;=== Decommission completed ===&quot;
</code></pre>

<h3 id="53">5.3 クリーンアップ<a class="headerlink" href="#53" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">@Component
public class MigrationCleanup {

    public void cleanup() {
        // 1. Dual Write コード削除
        log.info(&quot;Removing dual write interceptor...&quot;);

        // 2. 旧スキーマ変換コード削除
        log.info(&quot;Removing old schema converters...&quot;);

        // 3. Feature Flag削除
        log.info(&quot;Removing migration feature flags...&quot;);

        // 4. 監視設定更新
        log.info(&quot;Updating monitoring configuration...&quot;);

        // 5. ドキュメント更新
        log.info(&quot;Documentation update reminder sent&quot;);
    }
}
</code></pre>

<hr />
<h2 id="6">6. データ移行詳細<a class="headerlink" href="#6" title="Permanent link">&para;</a></h2>
<h3 id="61">6.1 テーブル別移行マッピング<a class="headerlink" href="#61" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>旧テーブル</th>
<th>新Namespace</th>
<th>新テーブル</th>
<th>変換ロジック</th>
</tr>
</thead>
<tbody>
<tr>
<td>user</td>
<td>identity</td>
<td>users</td>
<td>userEmail → user_email (PK変更)</td>
</tr>
<tr>
<td>user_token</td>
<td>identity</td>
<td>user_tokens</td>
<td>構造変更なし</td>
</tr>
<tr>
<td>audit_set</td>
<td>audit</td>
<td>audit_sets</td>
<td>aclJson → 別テーブル化</td>
</tr>
<tr>
<td>audit_set_item</td>
<td>audit</td>
<td>audit_set_items</td>
<td>構造変更なし</td>
</tr>
<tr>
<td>audit_set_collaborators</td>
<td>audit</td>
<td>audit_set_collaborators</td>
<td>構造変更なし</td>
</tr>
<tr>
<td>events</td>
<td>event</td>
<td>events</td>
<td>Cassandraへ移行</td>
</tr>
</tbody>
</table>
<h3 id="62-json">6.2 JSON列正規化<a class="headerlink" href="#62-json" title="Permanent link">&para;</a></h3>
<p><strong>旧スキーマ (aclJson埋め込み):</strong></p>
<pre class="codehilite"><code class="language-java">// AuditSet.aclJson
{
  &quot;owner&quot;: {&quot;email&quot;: &quot;owner@example.com&quot;, &quot;role&quot;: &quot;OWNER&quot;},
  &quot;collaborators&quot;: [
    {&quot;email&quot;: &quot;user1@example.com&quot;, &quot;role&quot;: &quot;CO_OWNER&quot;},
    {&quot;email&quot;: &quot;user2@example.com&quot;, &quot;role&quot;: &quot;MEMBER&quot;}
  ]
}
</code></pre>

<p><strong>新スキーマ (正規化):</strong></p>
<pre class="codehilite"><code class="language-java">// audit_set_collaborators テーブル
// PK: audit_set_id, CK: user_email
{
  &quot;audit_set_id&quot;: &quot;uuid&quot;,
  &quot;user_email&quot;: &quot;owner@example.com&quot;,
  &quot;collaborator_role&quot;: &quot;OWNER&quot;
}
</code></pre>

<p><strong>変換ロジック:</strong></p>
<pre class="codehilite"><code class="language-java">public List&lt;Put&gt; convertAclJsonToCollaborators(String auditSetId, String aclJson) {
    List&lt;Put&gt; puts = new ArrayList&lt;&gt;();
    JsonNode acl = objectMapper.readTree(aclJson);

    // オーナー追加
    JsonNode owner = acl.get(&quot;owner&quot;);
    puts.add(createCollaboratorPut(auditSetId, owner.get(&quot;email&quot;).asText(), &quot;OWNER&quot;));

    // コラボレーター追加
    JsonNode collaborators = acl.get(&quot;collaborators&quot;);
    if (collaborators != null &amp;&amp; collaborators.isArray()) {
        for (JsonNode collab : collaborators) {
            puts.add(createCollaboratorPut(
                auditSetId,
                collab.get(&quot;email&quot;).asText(),
                collab.get(&quot;role&quot;).asText()
            ));
        }
    }

    return puts;
}
</code></pre>

<h3 id="63-postgresql-cassandra">6.3 イベントデータ移行（PostgreSQL → Cassandra）<a class="headerlink" href="#63-postgresql-cassandra" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">public class EventMigrationBatch {
    private final JdbcTemplate oldJdbc;
    private final DistributedTransactionManager newManager;

    public void migrateEvents(LocalDate startDate, LocalDate endDate) {
        LocalDate current = startDate;

        while (!current.isAfter(endDate)) {
            String yyyymmdd = current.format(DateTimeFormatter.BASIC_ISO_DATE);
            migrateEventsForDate(yyyymmdd);
            current = current.plusDays(1);
        }
    }

    private void migrateEventsForDate(String yyyymmdd) {
        log.info(&quot;Migrating events for {}&quot;, yyyymmdd);

        // 旧DBからイベント取得
        List&lt;Map&lt;String, Object&gt;&gt; oldEvents = oldJdbc.queryForList(
            &quot;SELECT * FROM events WHERE yyyyMMdd = ?&quot;, yyyymmdd
        );

        // バッチサイズで分割
        Lists.partition(oldEvents, 100).forEach(batch -&gt; {
            DistributedTransaction tx = newManager.start();
            try {
                for (Map&lt;String, Object&gt; event : batch) {
                    Put put = convertEventToNewSchema(event);
                    tx.put(put);
                }
                tx.commit();
            } catch (Exception e) {
                tx.abort();
                throw new MigrationException(&quot;Event migration failed for &quot; + yyyymmdd, e);
            }
        });

        log.info(&quot;Migrated {} events for {}&quot;, oldEvents.size(), yyyymmdd);
    }
}
</code></pre>

<hr />
<h2 id="7">7. 検証計画<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="71">7.1 検証フェーズ<a class="headerlink" href="#71" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>フェーズ</th>
<th>内容</th>
<th>期間</th>
<th>担当</th>
</tr>
</thead>
<tbody>
<tr>
<td>単体テスト</td>
<td>CRUD操作の動作確認</td>
<td>1日</td>
<td>Dev</td>
</tr>
<tr>
<td>結合テスト</td>
<td>トランザクション動作確認</td>
<td>2日</td>
<td>Dev</td>
</tr>
<tr>
<td>負荷テスト</td>
<td>パフォーマンス検証</td>
<td>3日</td>
<td>QA</td>
</tr>
<tr>
<td>障害テスト</td>
<td>フェイルオーバー確認</td>
<td>2日</td>
<td>Ops</td>
</tr>
<tr>
<td>UAT</td>
<td>ユーザー受入テスト</td>
<td>5日</td>
<td>User</td>
</tr>
</tbody>
</table>
<h3 id="72">7.2 テストケース<a class="headerlink" href="#72" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">@SpringBootTest
public class MigrationIntegrationTest {

    @Test
    void shouldCreateAuditSetInNewSchema() {
        // Given
        CreateAuditSetRequest request = new CreateAuditSetRequest(&quot;Test Set&quot;, &quot;owner@example.com&quot;);

        // When
        AuditSet result = auditService.createAuditSet(request);

        // Then
        assertThat(result.getId()).isNotNull();

        // 新環境でデータ確認
        Optional&lt;Result&gt; newData = newManager.start().get(
            Get.newBuilder()
                .namespace(&quot;audit&quot;)
                .table(&quot;audit_sets&quot;)
                .partitionKey(Key.ofText(&quot;audit_set_id&quot;, result.getId()))
                .build()
        );
        assertThat(newData).isPresent();
    }

    @Test
    void shouldMaintainDataConsistencyDuringDualWrite() {
        // Dual Write中のデータ整合性テスト
        // 両環境に同一データが存在することを確認
    }

    @Test
    void shouldHandleFailoverGracefully() {
        // ノード障害時のフェイルオーバーテスト
    }
}
</code></pre>

<h3 id="73">7.3 パフォーマンスベンチマーク<a class="headerlink" href="#73" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-java">@BenchmarkMode(Mode.Throughput)
@OutputTimeUnit(TimeUnit.SECONDS)
public class TransactionBenchmark {

    @Benchmark
    public void createAuditSetBenchmark(Blackhole bh) {
        AuditSet result = auditService.createAuditSet(createRandomRequest());
        bh.consume(result);
    }

    @Benchmark
    public void addItemToAuditSetBenchmark(Blackhole bh) {
        AuditSetItem result = auditService.addItem(auditSetId, randomItemId());
        bh.consume(result);
    }
}
</code></pre>

<hr />
<h2 id="8">8. ロールバック手順<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<h3 id="81">8.1 ロールバック判断基準<a class="headerlink" href="#81" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>指標</th>
<th>閾値</th>
<th>アクション</th>
</tr>
</thead>
<tbody>
<tr>
<td>エラー率</td>
<td>&gt; 5%</td>
<td>自動ロールバック</td>
</tr>
<tr>
<td>レイテンシP99</td>
<td>&gt; 2秒</td>
<td>警告→手動判断</td>
</tr>
<tr>
<td>データ不整合</td>
<td>&gt; 0件</td>
<td>即座にロールバック</td>
</tr>
<tr>
<td>ユーザー報告</td>
<td>重大障害</td>
<td>手動ロールバック</td>
</tr>
</tbody>
</table>
<h3 id="82">8.2 ロールバック実行<a class="headerlink" href="#82" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-bash">#!/bin/bash
# rollback.sh

echo &quot;=== Migration Rollback ===&quot;

# 1. Feature Flag変更
echo &quot;Step 1: Switching to old environment...&quot;
curl -X PUT http://feature-flag-service/flags/migration.write.mode \
    -d '{&quot;value&quot;: &quot;OLD_ONLY&quot;}'
curl -X PUT http://feature-flag-service/flags/migration.read.new_percentage \
    -d '{&quot;value&quot;: 0}'

# 2. 進行中トランザクション待機
echo &quot;Step 2: Waiting for in-flight transactions...&quot;
sleep 30

# 3. 確認
echo &quot;Step 3: Verifying rollback...&quot;
./verify-rollback.sh

echo &quot;=== Rollback completed ===&quot;
</code></pre>

<h3 id="83">8.3 ロールバック後の対応<a class="headerlink" href="#83" title="Permanent link">&para;</a></h3>
<ol>
<li><strong>原因分析</strong>: ログ・メトリクス確認</li>
<li><strong>修正</strong>: 問題の修正</li>
<li><strong>再テスト</strong>: ステージング環境で検証</li>
<li><strong>再移行</strong>: 修正後に再度移行実施</li>
</ol>
<hr />
<h2 id="9">9. タイムライン<a class="headerlink" href="#9" title="Permanent link">&para;</a></h2>
<div class="mermaid">
gantt
    title ScalarDB Migration Timeline
    dateFormat YYYY-MM-DD
    section Phase 0
    環境構築          :p0-1, 2025-01-06, 7d
    検証              :p0-2, after p0-1, 7d

    section Phase 1
    Dual Write実装    :p1-1, after p0-2, 7d
    初期データ移行    :p1-2, after p1-1, 7d
    並行運用          :p1-3, after p1-2, 14d

    section Phase 2
    10% New読み取り   :p2-1, after p1-3, 7d
    50% New読み取り   :p2-2, after p2-1, 7d
    100% New読み取り  :p2-3, after p2-2, 7d
    New書き込みのみ   :p2-4, after p2-3, 7d

    section Phase 3
    安定化確認        :p3-1, after p2-4, 7d
    旧環境廃止        :p3-2, after p3-1, 7d
</div>

<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: scalar-event-log-fetcher-main</em>
<em>ScalarDB Version: 3.14.x</em></p>
</article>
</section>
<section id="stories">
<h1>ドメインストーリー</h1>
<article id="stories-domain-stories">
<h1 id="_1">ドメインストーリー集<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h1>
<h2 id="_2">概要<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<p>本ドキュメントは、Scalar Auditor for BOXシステムの6つの境界づけられたコンテキストにおける主要なビジネスプロセスをドメインストーリーテリング形式で記述します。</p>
<h3 id="_3">表記法<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code>[アクター] が {ワークオブジェクト} を 《アクティビティ》 する
→ [次のアクター/システム] へ渡す
</code></pre>

<hr />
<h2 id="1-identity-access-context">1. Identity &amp; Access Context (認証・アクセス管理)<a class="headerlink" href="#1-identity-access-context" title="Permanent link">&para;</a></h2>
<h3 id="story-11">Story 1.1: ユーザー認証フロー<a class="headerlink" href="#story-11" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph LR
    subgraph "認証フロー"
        U[監査担当者] -->|1. ログイン要求| LP[ログインページ]
        LP -->|2. 認証情報送信| AS[AuthService]
        AS -->|3. 資格情報検証| DB[(UserDB)]
        DB -->|4. ユーザー情報| AS
        AS -->|5. JWTトークン発行| U
        U -->|6. 保護リソースアクセス| API[API Gateway]
        API -->|7. トークン検証| AS
    end
</div>

<p><strong>ナラティブ:</strong></p>
<ol>
<li><strong>[監査担当者]</strong> が {ログインフォーム} に《認証情報を入力》する</li>
<li><strong>[AuthService]</strong> が {認証情報} を《検証》する</li>
<li><strong>[AuthService]</strong> が {JWTトークン} を《発行》して [監査担当者] へ渡す</li>
<li><strong>[監査担当者]</strong> が {JWTトークン} を使用して《保護リソースにアクセス》する</li>
<li><strong>[API Gateway]</strong> が {JWTトークン} を《検証》して [バックエンドサービス] へ転送する</li>
</ol>
<p><strong>ビジネスルール:</strong>
- トークン有効期限: 8時間
- リフレッシュトークン: 7日間
- 3回連続失敗でアカウントロック</p>
<hr />
<h3 id="story-12">Story 1.2: ロール・権限管理<a class="headerlink" href="#story-12" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    actor Admin as システム管理者
    participant RS as RoleService
    participant PS as PermissionService
    participant DB as Database

    Admin->>RS: ロール作成要求
    RS->>PS: 権限セット取得
    PS-->>RS: 利用可能な権限一覧
    RS->>DB: ロール永続化
    DB-->>RS: 保存完了
    RS-->>Admin: ロール作成完了

    Admin->>RS: ユーザーにロール割当
    RS->>DB: ユーザーロール更新
    DB-->>RS: 更新完了
    RS-->>Admin: 割当完了
</div>

<p><strong>ナラティブ:</strong></p>
<ol>
<li><strong>[システム管理者]</strong> が {新規ロール} を《定義》する</li>
<li><strong>[RoleService]</strong> が {権限セット} を《ロールに紐付け》する</li>
<li><strong>[システム管理者]</strong> が {ユーザー} に《ロールを割り当て》る</li>
<li><strong>[PermissionService]</strong> が {アクセス要求} を《権限チェック》する</li>
</ol>
<p><strong>ビジネスルール:</strong>
- 最小権限の原則
- ロール階層: Admin &gt; Manager &gt; Auditor &gt; Viewer
- 権限の継承は上位ロールのみ</p>
<hr />
<h2 id="2-audit-management-context">2. Audit Management Context (監査管理)<a class="headerlink" href="#2-audit-management-context" title="Permanent link">&para;</a></h2>
<h3 id="story-21">Story 2.1: 監査セット作成<a class="headerlink" href="#story-21" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "監査セット作成フロー"
        A[監査担当者] -->|1. 作成要求| AS[AuditSetService]
        AS -->|2. 検証| VS[ValidationService]
        VS -->|3. OK| AS
        AS -->|4. 永続化| DB[(AuditDB)]
        DB -->|5. 作成完了| AS
        AS -->|6. イベント発行| EQ[EventQueue]
        EQ -->|7. 非同期処理| NS[NotificationService]
    end
</div>

<p><strong>ナラティブ:</strong></p>
<ol>
<li><strong>[監査担当者]</strong> が {監査セット名と説明} を《入力》する</li>
<li><strong>[AuditSetService]</strong> が {入力データ} を《バリデーション》する</li>
<li><strong>[AuditSetService]</strong> が {監査セット} を《作成》してDBに保存する</li>
<li><strong>[EventPublisher]</strong> が {AuditSetCreatedイベント} を《発行》する</li>
<li><strong>[NotificationService]</strong> が {関係者} に《通知》する</li>
</ol>
<p><strong>ビジネスルール:</strong>
- 監査セット名は一意である必要がある
- 作成者は自動的にオーナーとなる
- 監査セットには最低1つの監査アイテムが必要（後から追加可）</p>
<hr />
<h3 id="story-22">Story 2.2: 監査アイテム追加<a class="headerlink" href="#story-22" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    actor Auditor as 監査担当者
    participant UI as WebUI
    participant AIS as AuditItemService
    participant FS as FileService
    participant BoxAPI as BOX API
    participant DB as Database
    participant EQ as EventQueue

    Auditor->>UI: ファイル選択
    UI->>FS: ファイル情報取得
    FS->>BoxAPI: ファイルメタデータ取得
    BoxAPI-->>FS: メタデータ
    FS-->>UI: ファイル情報表示

    Auditor->>UI: 監査アイテム追加
    UI->>AIS: 追加要求
    AIS->>DB: アイテム作成
    DB-->>AIS: 作成完了
    AIS->>EQ: ItemAddedイベント
    AIS-->>UI: 追加完了
</div>

<p><strong>ナラティブ:</strong></p>
<ol>
<li><strong>[監査担当者]</strong> が {BOXファイル} を《選択》する</li>
<li><strong>[FileService]</strong> が {ファイルメタデータ} を《BOXから取得》する</li>
<li><strong>[監査担当者]</strong> が {監査アイテム} を《監査セットに追加》する</li>
<li><strong>[AuditItemService]</strong> が {監査アイテム} を《作成》してDBに保存する</li>
<li><strong>[EventPublisher]</strong> が {ItemAddedイベント} を《発行》する</li>
</ol>
<p><strong>ビジネスルール:</strong>
- 同一ファイルの重複追加は不可
- ファイルの現在バージョンがスナップショットとして保存される
- 監査アイテムステータス: Pending → InProgress → Completed</p>
<hr />
<h3 id="story-23-saga">Story 2.3: 監査セット削除（Saga）<a class="headerlink" href="#story-23-saga" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    actor Auditor as 監査担当者
    participant ASS as AuditSetService
    participant SAGA as SagaOrchestrator
    participant AIS as AuditItemService
    participant VS as VerificationService
    participant ES as EventService
    participant DB as Database

    Auditor->>ASS: 削除要求
    ASS->>SAGA: Saga開始

    SAGA->>VS: 検証データ削除
    VS-->>SAGA: 削除完了

    SAGA->>AIS: アイテム削除
    AIS-->>SAGA: 削除完了

    SAGA->>ES: 関連イベント削除
    ES-->>SAGA: 削除完了

    SAGA->>ASS: セット削除
    ASS->>DB: 論理削除
    DB-->>ASS: 完了
    ASS-->>SAGA: 削除完了

    SAGA-->>Auditor: 全削除完了
</div>

<p><strong>ナラティブ:</strong></p>
<ol>
<li><strong>[監査担当者]</strong> が {監査セット} の《削除を要求》する</li>
<li><strong>[SagaOrchestrator]</strong> が {削除Saga} を《開始》する</li>
<li><strong>[VerificationService]</strong> が {関連する検証データ} を《削除》する</li>
<li><strong>[AuditItemService]</strong> が {すべての監査アイテム} を《削除》する</li>
<li><strong>[EventService]</strong> が {関連イベント} を《アーカイブ》する</li>
<li><strong>[AuditSetService]</strong> が {監査セット} を《論理削除》する</li>
<li><strong>[SagaOrchestrator]</strong> が {完了ステータス} を《報告》する</li>
</ol>
<p><strong>補償トランザクション:</strong>
- 各ステップで失敗した場合、前のステップをロールバック
- 削除は論理削除で、30日後に物理削除</p>
<hr />
<h2 id="3-file-management-context">3. File Management Context (ファイル管理)<a class="headerlink" href="#3-file-management-context" title="Permanent link">&para;</a></h2>
<h3 id="story-31">Story 3.1: ファイル同期<a class="headerlink" href="#story-31" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "ファイル同期フロー"
        SCH[Scheduler] -->|1. 同期トリガー| SS[SyncService]
        SS -->|2. 差分取得| BOX[BOX API]
        BOX -->|3. 変更一覧| SS
        SS -->|4. ローカル更新| DB[(FileDB)]
        DB -->|5. 更新完了| SS
        SS -->|6. イベント発行| EQ[EventQueue]
        EQ -->|7. 監査影響チェック| AS[AuditService]
    end
</div>

<p><strong>ナラティブ:</strong></p>
<ol>
<li><strong>[Scheduler]</strong> が {同期ジョブ} を《定期実行》する（5分間隔）</li>
<li><strong>[SyncService]</strong> が {BOX} から《変更差分を取得》する</li>
<li><strong>[SyncService]</strong> が {ファイルメタデータ} を《ローカルDBに同期》する</li>
<li><strong>[EventPublisher]</strong> が {FileSyncedイベント} を《発行》する</li>
<li><strong>[AuditService]</strong> が {監査対象ファイルの変更} を《検出》して通知する</li>
</ol>
<p><strong>ビジネスルール:</strong>
- 削除されたファイルは論理削除として保持
- バージョン履歴は最大100世代保持
- ファイルサイズ上限: 5GB</p>
<hr />
<h3 id="story-32">Story 3.2: コラボレーター管理<a class="headerlink" href="#story-32" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    actor Admin as ファイル管理者
    participant CS as CollaboratorService
    participant BoxAPI as BOX API
    participant DB as Database
    participant NS as NotificationService

    Admin->>CS: コラボレーター追加要求
    CS->>BoxAPI: 権限設定API呼出
    BoxAPI-->>CS: 設定完了
    CS->>DB: ローカル記録
    DB-->>CS: 保存完了
    CS->>NS: 通知要求
    NS-->>Admin: 追加完了通知
</div>

<p><strong>ナラティブ:</strong></p>
<ol>
<li><strong>[ファイル管理者]</strong> が {ユーザー} を《コラボレーターとして追加》する</li>
<li><strong>[CollaboratorService]</strong> が {BOX API} 経由で《権限を設定》する</li>
<li><strong>[CollaboratorService]</strong> が {コラボレーター情報} を《ローカルDBに記録》する</li>
<li><strong>[NotificationService]</strong> が {新規コラボレーター} に《招待通知》する</li>
</ol>
<p><strong>ビジネスルール:</strong>
- 権限レベル: Owner &gt; Editor &gt; Viewer
- 継承権限のオーバーライドは明示的に行う
- 監査対象ファイルの権限変更はログ記録</p>
<hr />
<h2 id="4-event-tracking-context">4. Event Tracking Context (イベント追跡)<a class="headerlink" href="#4-event-tracking-context" title="Permanent link">&para;</a></h2>
<h3 id="story-41-box">Story 4.1: BOXイベント取得<a class="headerlink" href="#story-41-box" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "イベント取得フロー"
        WH[BOX Webhook] -->|1. イベント通知| EI[EventIngester]
        EI -->|2. 正規化| EP[EventProcessor]
        EP -->|3. 永続化| CS[(Cassandra)]
        CS -->|4. 保存完了| EP
        EP -->|5. 分析| EA[EventAnalyzer]
        EA -->|6. アラート| NS[NotificationService]
    end
</div>

<p><strong>ナラティブ:</strong></p>
<ol>
<li><strong>[BOX Webhook]</strong> が {イベント} を《システムに通知》する</li>
<li><strong>[EventIngester]</strong> が {生イベント} を《正規化》する</li>
<li><strong>[EventProcessor]</strong> が {正規化イベント} を《Cassandraに永続化》する</li>
<li><strong>[EventAnalyzer]</strong> が {イベントパターン} を《分析》する</li>
<li><strong>[NotificationService]</strong> が {異常検知時} に《アラート》する</li>
</ol>
<p><strong>ビジネスルール:</strong>
- イベントは追記のみ（不変）
- 保持期間: 監査イベント=7年、一般イベント=1年
- 毎秒1000イベントの処理能力</p>
<hr />
<h3 id="story-42">Story 4.2: イベント検索・フィルタリング<a class="headerlink" href="#story-42" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    actor Auditor as 監査担当者
    participant UI as WebUI
    participant ES as EventSearchService
    participant CS as Cassandra
    participant CACHE as Redis

    Auditor->>UI: 検索条件入力
    UI->>ES: 検索クエリ
    ES->>CACHE: キャッシュ確認
    alt キャッシュヒット
        CACHE-->>ES: キャッシュ結果
    else キャッシュミス
        ES->>CS: クエリ実行
        CS-->>ES: 検索結果
        ES->>CACHE: 結果キャッシュ
    end
    ES-->>UI: 検索結果
    UI-->>Auditor: 結果表示
</div>

<p><strong>ナラティブ:</strong></p>
<ol>
<li><strong>[監査担当者]</strong> が {検索条件（期間、ファイル、アクション）} を《入力》する</li>
<li><strong>[EventSearchService]</strong> が {キャッシュ} を《確認》する</li>
<li><strong>[EventSearchService]</strong> が {Cassandra} から《イベントを検索》する</li>
<li><strong>[EventSearchService]</strong> が {検索結果} を《フィルタリング・ソート》する</li>
<li><strong>[WebUI]</strong> が {イベント一覧} を《表示》する</li>
</ol>
<p><strong>ビジネスルール:</strong>
- 検索結果は最大10,000件まで
- ページネーション: 100件/ページ
- 頻繁なクエリは5分間キャッシュ</p>
<hr />
<h2 id="5-integrity-verification-context">5. Integrity Verification Context (整合性検証)<a class="headerlink" href="#5-integrity-verification-context" title="Permanent link">&para;</a></h2>
<h3 id="story-51">Story 5.1: ハッシュ計算と登録<a class="headerlink" href="#story-51" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "ハッシュ登録フロー"
        T[トリガー] -->|1. 検証要求| VS[VerificationService]
        VS -->|2. ファイル取得| FS[FileService]
        FS -->|3. ダウンロード| BOX[BOX API]
        BOX -->|4. ファイルデータ| FS
        FS -->|5. ファイル| VS
        VS -->|6. ハッシュ計算| HC[HashCalculator]
        HC -->|7. SHA-256| VS
        VS -->|8. 登録| SDL[ScalarDL]
        SDL -->|9. 改ざん防止記録| VS
    end
</div>

<p><strong>ナラティブ:</strong></p>
<ol>
<li><strong>[監査担当者/システム]</strong> が {ファイル} の《検証を要求》する</li>
<li><strong>[VerificationService]</strong> が {ファイル} を《BOXから取得》する</li>
<li><strong>[HashCalculator]</strong> が {ファイルコンテンツ} の《SHA-256ハッシュを計算》する</li>
<li><strong>[VerificationService]</strong> が {ハッシュ値} を《ScalarDLに登録》する</li>
<li><strong>[ScalarDL]</strong> が {登録証明} を《発行》する</li>
</ol>
<p><strong>ビジネスルール:</strong>
- ハッシュアルゴリズム: SHA-256
- 同一ファイルの再登録は新バージョンとして記録
- ScalarDLによる改ざん防止保証</p>
<hr />
<h3 id="story-52">Story 5.2: 整合性検証実行<a class="headerlink" href="#story-52" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    actor Auditor as 監査担当者
    participant VS as VerificationService
    participant FS as FileService
    participant BoxAPI as BOX API
    participant HC as HashCalculator
    participant SDL as ScalarDL
    participant DB as Database

    Auditor->>VS: 検証実行要求
    VS->>FS: 現在のファイル取得
    FS->>BoxAPI: ダウンロード
    BoxAPI-->>FS: ファイルデータ
    FS-->>VS: ファイル

    VS->>HC: ハッシュ計算
    HC-->>VS: 現在のハッシュ

    VS->>SDL: 登録ハッシュ取得
    SDL-->>VS: 登録時のハッシュ

    VS->>VS: ハッシュ比較

    alt 一致
        VS->>DB: 検証成功記録
        VS-->>Auditor: 整合性確認OK
    else 不一致
        VS->>DB: 検証失敗記録
        VS-->>Auditor: 改ざん検出アラート
    end
</div>

<p><strong>ナラティブ:</strong></p>
<ol>
<li><strong>[監査担当者]</strong> が {監査アイテム} の《整合性検証を実行》する</li>
<li><strong>[VerificationService]</strong> が {現在のファイル} を《BOXから取得》する</li>
<li><strong>[HashCalculator]</strong> が {現在のハッシュ} を《計算》する</li>
<li><strong>[VerificationService]</strong> が {登録時のハッシュ} を《ScalarDLから取得》する</li>
<li><strong>[VerificationService]</strong> が {ハッシュを比較} して《検証結果を判定》する</li>
<li><strong>[VerificationService]</strong> が {検証結果} を《記録》する</li>
<li>不一致の場合、<strong>[NotificationService]</strong> が《アラート》する</li>
</ol>
<p><strong>ビジネスルール:</strong>
- 検証結果: Verified / Tampered / NotRegistered / Error
- 改ざん検出時は即時アラート
- 検証履歴は永久保持</p>
<hr />
<h2 id="6-box-integration-context-box">6. BOX Integration Context (BOX連携)<a class="headerlink" href="#6-box-integration-context-box" title="Permanent link">&para;</a></h2>
<h3 id="story-61-oauth">Story 6.1: OAuth認証フロー<a class="headerlink" href="#story-61-oauth" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "OAuth認証フロー"
        U[ユーザー] -->|1. BOX連携要求| APP[Application]
        APP -->|2. 認可リダイレクト| BOX[BOX OAuth]
        BOX -->|3. ログイン/同意| U
        U -->|4. 認可コード| APP
        APP -->|5. トークン交換| BOX
        BOX -->|6. アクセストークン| APP
        APP -->|7. トークン保存| DB[(TokenDB)]
    end
</div>

<p><strong>ナラティブ:</strong></p>
<ol>
<li><strong>[ユーザー]</strong> が {BOX連携} を《開始》する</li>
<li><strong>[Application]</strong> が {認可リクエスト} を《BOXに送信》する</li>
<li><strong>[ユーザー]</strong> が {BOXログイン画面} で《認証・同意》する</li>
<li><strong>[BOX]</strong> が {認可コード} を《Applicationに返却》する</li>
<li><strong>[Application]</strong> が {認可コード} を《アクセストークンに交換》する</li>
<li><strong>[TokenService]</strong> が {トークン} を《暗号化して保存》する</li>
</ol>
<p><strong>ビジネスルール:</strong>
- アクセストークン有効期限: 60分
- リフレッシュトークン有効期限: 60日
- トークンはAES-256で暗号化保存</p>
<hr />
<h3 id="story-62-webhook">Story 6.2: Webhookイベント処理<a class="headerlink" href="#story-62-webhook" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant BoxPlatform as BOX Platform
    participant WH as WebhookHandler
    participant VAL as SignatureValidator
    participant EI as EventIngester
    participant QUEUE as EventQueue

    BoxPlatform->>WH: Webhookイベント
    WH->>VAL: 署名検証
    alt 署名有効
        VAL-->>WH: 検証OK
        WH->>EI: イベント正規化
        EI->>QUEUE: キューイング
        QUEUE-->>WH: 受付完了
        WH-->>BoxPlatform: 200 OK
    else 署名無効
        VAL-->>WH: 検証NG
        WH-->>BoxPlatform: 401 Unauthorized
    end
</div>

<p><strong>ナラティブ:</strong></p>
<ol>
<li><strong>[BOX Platform]</strong> が {Webhookイベント} を《エンドポイントに送信》する</li>
<li><strong>[WebhookHandler]</strong> が {リクエスト署名} を《検証》する</li>
<li><strong>[EventIngester]</strong> が {イベントペイロード} を《正規化》する</li>
<li><strong>[EventQueue]</strong> が {イベント} を《非同期処理キューに追加》する</li>
<li><strong>[WebhookHandler]</strong> が {200 OK} を《即座に返却》する</li>
</ol>
<p><strong>ビジネスルール:</strong>
- Webhook署名はHMAC-SHA256で検証
- 応答は3秒以内（タイムアウト対策）
- リトライ: 最大5回（指数バックオフ）</p>
<hr />
<h3 id="story-63-api">Story 6.3: API レート制限対応<a class="headerlink" href="#story-63-api" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "レート制限対応"
        REQ[APIリクエスト] --> RL[RateLimiter]
        RL -->|許可| BOX[BOX API]
        RL -->|制限中| QUEUE[待機キュー]
        QUEUE -->|遅延実行| RL
        BOX -->|429 Rate Limited| RL
        RL -->|バックオフ| QUEUE
    end
</div>

<p><strong>ナラティブ:</strong></p>
<ol>
<li><strong>[Application]</strong> が {APIリクエスト} を《発行》する</li>
<li><strong>[RateLimiter]</strong> が {レート制限状態} を《確認》する</li>
<li>制限内の場合、<strong>[RateLimiter]</strong> が {リクエスト} を《BOX APIに転送》する</li>
<li>429応答の場合、<strong>[RateLimiter]</strong> が {リクエスト} を《待機キューに追加》する</li>
<li><strong>[RateLimiter]</strong> が {指数バックオフ} で《リトライ》する</li>
</ol>
<p><strong>ビジネスルール:</strong>
- BOX APIレート: 1000リクエスト/分
- ローカルレート制限: 800リクエスト/分（バッファ）
- バックオフ: 1秒 → 2秒 → 4秒 → ... 最大60秒</p>
<hr />
<h2 id="7">7. クロスコンテキストシナリオ<a class="headerlink" href="#7" title="Permanent link">&para;</a></h2>
<h3 id="story-71">Story 7.1: 監査完了レポート生成<a class="headerlink" href="#story-71" title="Permanent link">&para;</a></h3>
<div class="mermaid">
graph TB
    subgraph "レポート生成フロー"
        A[監査担当者] -->|1. レポート要求| AS[AuditService]
        AS -->|2. アイテム取得| AIS[AuditItemService]
        AS -->|3. 検証結果取得| VS[VerificationService]
        AS -->|4. イベント取得| ES[EventService]
        AS -->|5. ファイル情報取得| FS[FileService]
        AS -->|6. レポート生成| RG[ReportGenerator]
        RG -->|7. PDF出力| A
    end
</div>

<p><strong>ナラティブ:</strong></p>
<ol>
<li><strong>[監査担当者]</strong> が {監査セット} の《レポート生成を要求》する</li>
<li><strong>[AuditService]</strong> が {各サービス} から《必要データを収集》する</li>
<li><strong>[ReportGenerator]</strong> が {収集データ} を《レポート形式に整形》する</li>
<li><strong>[ReportGenerator]</strong> が {PDF/Excel} として《エクスポート》する</li>
</ol>
<hr />
<h3 id="story-72">Story 7.2: ファイル変更検知と監査影響通知<a class="headerlink" href="#story-72" title="Permanent link">&para;</a></h3>
<div class="mermaid">
sequenceDiagram
    participant BoxWebhook as BOX Webhook
    participant EI as EventIngester
    participant ES as EventService
    participant AS as AuditService
    participant NS as NotificationService
    actor Auditor as 監査担当者

    BoxWebhook->>EI: ファイル更新イベント
    EI->>ES: イベント保存
    ES->>AS: 監査影響チェック
    AS->>AS: 対象監査セット検索

    alt 監査対象ファイル
        AS->>NS: 通知要求
        NS->>Auditor: メール/Slack通知
    end
</div>

<p><strong>ナラティブ:</strong></p>
<ol>
<li><strong>[BOX]</strong> が {ファイル更新イベント} を《Webhookで通知》する</li>
<li><strong>[EventService]</strong> が {イベント} を《記録》する</li>
<li><strong>[AuditService]</strong> が {監査対象かどうか} を《チェック》する</li>
<li>監査対象の場合、<strong>[NotificationService]</strong> が {担当者} に《通知》する</li>
</ol>
<hr />
<h2 id="8">8. ドメイン用語集<a class="headerlink" href="#8" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>用語</th>
<th>日本語</th>
<th>定義</th>
</tr>
</thead>
<tbody>
<tr>
<td>Audit Set</td>
<td>監査セット</td>
<td>監査対象ファイルをグループ化したコンテナ</td>
</tr>
<tr>
<td>Audit Item</td>
<td>監査アイテム</td>
<td>監査セット内の個別監査対象</td>
</tr>
<tr>
<td>Verification</td>
<td>検証</td>
<td>ファイルの整合性を確認するプロセス</td>
</tr>
<tr>
<td>Hash</td>
<td>ハッシュ</td>
<td>ファイルの一意識別子（SHA-256）</td>
</tr>
<tr>
<td>Collaborator</td>
<td>コラボレーター</td>
<td>ファイルへのアクセス権を持つユーザー</td>
</tr>
<tr>
<td>Webhook</td>
<td>ウェブフック</td>
<td>BOXからのリアルタイムイベント通知</td>
</tr>
<tr>
<td>ScalarDL</td>
<td>スカラーDL</td>
<td>改ざん防止ストレージ</td>
</tr>
</tbody>
</table>
<hr />
<p><em>Generated: 2025-12-26</em>
<em>Version: 1.0.0</em>
<em>Source: Scalar Auditor for BOX Domain Analysis</em></p>
</article>
</section>
<section id="graph">
<h1>ナレッジグラフ</h1>
<article id="graph-schema">
<h1 id="graphdb">GraphDB スキーマ<a class="headerlink" href="#graphdb" title="Permanent link">&para;</a></h1>
<h2 id="_1">概要<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>Scalar Auditor for BOXシステムのナレッジグラフスキーマです。</p>
<h2 id="_2">ノードテーブル<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<h3 id="ubiquitousterm">UbiquitousTerm (ユビキタス言語用語)<a class="headerlink" href="#ubiquitousterm" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>プロパティ</th>
<th>型</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>TEXT (PK)</td>
<td>英語名</td>
</tr>
<tr>
<td>name_ja</td>
<td>TEXT</td>
<td>日本語名</td>
</tr>
<tr>
<td>definition</td>
<td>TEXT</td>
<td>定義</td>
</tr>
<tr>
<td>domain</td>
<td>TEXT</td>
<td>所属ドメイン</td>
</tr>
</tbody>
</table>
<h3 id="domain">Domain (ドメイン)<a class="headerlink" href="#domain" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>プロパティ</th>
<th>型</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>TEXT (PK)</td>
<td>ドメイン名</td>
</tr>
<tr>
<td>type</td>
<td>TEXT</td>
<td>Core/Supporting/Integration</td>
</tr>
<tr>
<td>description</td>
<td>TEXT</td>
<td>説明</td>
</tr>
</tbody>
</table>
<h3 id="entity">Entity (エンティティ)<a class="headerlink" href="#entity" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>プロパティ</th>
<th>型</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>TEXT (PK)</td>
<td>クラス/インターフェース名</td>
</tr>
<tr>
<td>file_path</td>
<td>TEXT</td>
<td>ファイルパス</td>
</tr>
<tr>
<td>type</td>
<td>TEXT</td>
<td>class/interface</td>
</tr>
<tr>
<td>package</td>
<td>TEXT</td>
<td>パッケージ名</td>
</tr>
</tbody>
</table>
<h3 id="actor">Actor (アクター)<a class="headerlink" href="#actor" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>プロパティ</th>
<th>型</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>TEXT (PK)</td>
<td>アクター名</td>
</tr>
<tr>
<td>type</td>
<td>TEXT</td>
<td>internal/external</td>
</tr>
<tr>
<td>description</td>
<td>TEXT</td>
<td>説明</td>
</tr>
</tbody>
</table>
<h3 id="role">Role (ロール)<a class="headerlink" href="#role" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>プロパティ</th>
<th>型</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>name</td>
<td>TEXT (PK)</td>
<td>ロール名</td>
</tr>
<tr>
<td>level</td>
<td>TEXT</td>
<td>system/collaborator</td>
</tr>
<tr>
<td>permissions</td>
<td>TEXT</td>
<td>権限リスト</td>
</tr>
</tbody>
</table>
<h2 id="_3">リレーションテーブル<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<h3 id="belongs_to-entity-domain">BELONGS_TO (Entity → Domain)<a class="headerlink" href="#belongs_to-entity-domain" title="Permanent link">&para;</a></h3>
<p>エンティティがどのドメインに属するかを表す関係。</p>
<h3 id="has_term-entity-ubiquitousterm">HAS_TERM (Entity → UbiquitousTerm)<a class="headerlink" href="#has_term-entity-ubiquitousterm" title="Permanent link">&para;</a></h3>
<p>エンティティがユビキタス言語の用語と関連することを表す関係。</p>
<h3 id="has_role-actor-role">HAS_ROLE (Actor → Role)<a class="headerlink" href="#has_role-actor-role" title="Permanent link">&para;</a></h3>
<p>アクターが持つロールを表す関係。</p>
<h3 id="references-entity-entity">REFERENCES (Entity → Entity)<a class="headerlink" href="#references-entity-entity" title="Permanent link">&para;</a></h3>
<p>エンティティ間の参照関係。</p>
<table>
<thead>
<tr>
<th>プロパティ</th>
<th>型</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>relation_type</td>
<td>TEXT</td>
<td>owned_by/belongs_to/uses/references等</td>
</tr>
</tbody>
</table>
<h2 id="_4">グラフモデル図<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<div class="mermaid">
graph LR
    subgraph "ノード"
        T[UbiquitousTerm]
        D[Domain]
        E[Entity]
        A[Actor]
        R[Role]
    end

    subgraph "リレーション"
        E -->|BELONGS_TO| D
        E -->|HAS_TERM| T
        A -->|HAS_ROLE| R
        E -->|REFERENCES| E
    end
</div>

<h2 id="_5">クエリ例<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<h3 id="_6">ドメインに属するエンティティを取得<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-cypher">MATCH (e:Entity)-[:BELONGS_TO]-&gt;(d:Domain {name: 'Audit'})
RETURN e.name, e.file_path
</code></pre>

<h3 id="_7">用語に関連するエンティティを取得<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-cypher">MATCH (e:Entity)-[:HAS_TERM]-&gt;(t:UbiquitousTerm {name: 'AuditSet'})
RETURN e.name, t.name_ja
</code></pre>

<h3 id="_8">アクターのロールを取得<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-cypher">MATCH (a:Actor)-[:HAS_ROLE]-&gt;(r:Role)
RETURN a.name, r.name, r.permissions
</code></pre>

<h3 id="_9">エンティティの参照関係を取得<a class="headerlink" href="#_9" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-cypher">MATCH (e1:Entity)-[r:REFERENCES]-&gt;(e2:Entity)
WHERE e1.name = 'AuditSetService'
RETURN e1.name, r.relation_type, e2.name
</code></pre>

<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: Scalar Auditor for BOX</em></p>
</article>
<article id="graph-statistics">
<h1 id="graphdb">GraphDB統計情報<a class="headerlink" href="#graphdb" title="Permanent link">&para;</a></h1>
<h2 id="_1">生成日時<a class="headerlink" href="#_1" title="Permanent link">&para;</a></h2>
<p>2025-12-26 11:05:33</p>
<h2 id="_2">ノード統計<a class="headerlink" href="#_2" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>ノードタイプ</th>
<th>件数</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>UbiquitousTerm</td>
<td>26</td>
<td>ユビキタス言語の用語</td>
</tr>
<tr>
<td>Domain</td>
<td>7</td>
<td>ビジネスドメイン</td>
</tr>
<tr>
<td>Entity</td>
<td>60</td>
<td>クラス/インターフェース</td>
</tr>
<tr>
<td>Actor</td>
<td>6</td>
<td>システムアクター</td>
</tr>
<tr>
<td>Role</td>
<td>7</td>
<td>ロール定義</td>
</tr>
<tr>
<td><strong>合計</strong></td>
<td><strong>106</strong></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="_3">リレーション統計<a class="headerlink" href="#_3" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>リレーションタイプ</th>
<th>件数</th>
<th>説明</th>
</tr>
</thead>
<tbody>
<tr>
<td>BELONGS_TO</td>
<td>60</td>
<td>ドメイン所属</td>
</tr>
<tr>
<td>REFERENCES</td>
<td>39</td>
<td>エンティティ参照</td>
</tr>
<tr>
<td>HAS_TERM</td>
<td>23</td>
<td>用語関連</td>
</tr>
<tr>
<td>HAS_ROLE</td>
<td>8</td>
<td>ロール保持</td>
</tr>
<tr>
<td><strong>合計</strong></td>
<td><strong>130</strong></td>
<td></td>
</tr>
</tbody>
</table>
<h2 id="_4">ドメイン別エンティティ数<a class="headerlink" href="#_4" title="Permanent link">&para;</a></h2>
<table>
<thead>
<tr>
<th>ドメイン</th>
<th>エンティティ数</th>
</tr>
</thead>
<tbody>
<tr>
<td>Identity</td>
<td>12</td>
</tr>
<tr>
<td>Audit</td>
<td>15</td>
</tr>
<tr>
<td>AuditGroup</td>
<td>8</td>
</tr>
<tr>
<td>File</td>
<td>13</td>
</tr>
<tr>
<td>Event</td>
<td>11</td>
</tr>
<tr>
<td>Verification</td>
<td>2</td>
</tr>
<tr>
<td>BOXIntegration</td>
<td>-</td>
</tr>
</tbody>
</table>
<h2 id="_5">データソース<a class="headerlink" href="#_5" title="Permanent link">&para;</a></h2>
<ul>
<li>分析結果: あり (<code>reports/01_analysis/</code>)</li>
<li>コード解析: あり</li>
<li>対象ファイル数: 60+ クラス/インターフェース</li>
</ul>
<h2 id="_6">ファイル構成<a class="headerlink" href="#_6" title="Permanent link">&para;</a></h2>
<pre class="codehilite"><code>reports/graph/
├── data/
│   ├── terms.csv          (26件)
│   ├── domains.csv         (7件)
│   ├── entities.csv       (60件)
│   ├── actors.csv          (6件)
│   ├── roles.csv           (7件)
│   ├── belongs_to.csv     (60件)
│   ├── has_term.csv       (23件)
│   ├── has_role.csv        (8件)
│   └── references.csv     (39件)
├── schema.md
└── statistics.md

knowledge.ryugraph/        # RyuGraphデータベース
</code></pre>

<h2 id="_7">利用方法<a class="headerlink" href="#_7" title="Permanent link">&para;</a></h2>
<h3 id="_8">クエリ実行<a class="headerlink" href="#_8" title="Permanent link">&para;</a></h3>
<pre class="codehilite"><code class="language-bash"># インタラクティブモード
python scripts/query_graph.py --db-path ./knowledge.ryugraph --interactive

# 自然言語クエリ
python scripts/query_graph.py --db-path ./knowledge.ryugraph \
  --query &quot;監査セットに関連するクラスを教えて&quot;

# Cypherクエリ
python scripts/query_graph.py --db-path ./knowledge.ryugraph \
  --cypher &quot;MATCH (e:Entity)-[:BELONGS_TO]-&gt;(d:Domain) RETURN e.name, d.name LIMIT 10&quot;
</code></pre>

<hr />
<p><em>Generated: 2025-12-26</em>
<em>Source: Scalar Auditor for BOX</em></p>
</article>

<article id="graph-interactive">
<h2>インタラクティブグラフビューア</h2>
<p>ノードをドラッグして移動、マウスホイールでズーム、ノードにホバーで詳細表示できます。</p>
<div id="graph-container" style="width: 100%; height: 600px; border: 1px solid var(--border-color); border-radius: 8px; overflow: hidden; background: #1a1a2e;">
    <div id="graph-controls" style="position: absolute; padding: 10px; background: rgba(255,255,255,0.9); border-radius: 5px; margin: 10px; z-index: 100;">
        <input type="text" id="graph-search" placeholder="ノードを検索..." style="width: 180px; padding: 5px;">
        <div id="graph-stats" style="font-size: 12px; color: #666; margin-top: 5px;"></div>
    </div>
    <svg id="graph-svg"></svg>
</div>
<div id="graph-legend" style="margin-top: 15px; display: flex; gap: 20px; flex-wrap: wrap;">
    <span><span style="display: inline-block; width: 12px; height: 12px; background: #e74c3c; border-radius: 50%; margin-right: 5px;"></span>Domain</span>
    <span><span style="display: inline-block; width: 12px; height: 12px; background: #3498db; border-radius: 50%; margin-right: 5px;"></span>Entity</span>
    <span><span style="display: inline-block; width: 12px; height: 12px; background: #2ecc71; border-radius: 50%; margin-right: 5px;"></span>Term</span>
</div>
</article>
<script>
(function() {
    const data = {"nodes": [{"id": "domain_Identity", "name": "Identity", "type": "Domain", "group": "Supporting"}, {"id": "domain_Audit", "name": "Audit", "type": "Domain", "group": "Core"}, {"id": "domain_AuditGroup", "name": "AuditGroup", "type": "Domain", "group": "Supporting"}, {"id": "domain_File", "name": "File", "type": "Domain", "group": "Supporting"}, {"id": "domain_Event", "name": "Event", "type": "Domain", "group": "Core"}, {"id": "domain_Verification", "name": "Verification", "type": "Domain", "group": "Core"}, {"id": "domain_BOXIntegration", "name": "BOXIntegration", "type": "Domain", "group": "Integration"}, {"id": "entity_User", "name": "User", "type": "Entity", "group": "class"}, {"id": "entity_UserToken", "name": "UserToken", "type": "Entity", "group": "class"}, {"id": "entity_UserOtp", "name": "UserOtp", "type": "Entity", "group": "class"}, {"id": "entity_Organization", "name": "Organization", "type": "Entity", "group": "class"}, {"id": "entity_RoleUser", "name": "RoleUser", "type": "Entity", "group": "class"}, {"id": "entity_AuditSet", "name": "AuditSet", "type": "Entity", "group": "class"}, {"id": "entity_AuditSetItem", "name": "AuditSetItem", "type": "Entity", "group": "class"}, {"id": "entity_AuditSetCollaborators", "name": "AuditSetCollaborators", "type": "Entity", "group": "class"}, {"id": "entity_AuditGroup", "name": "AuditGroup", "type": "Entity", "group": "class"}, {"id": "entity_UserAuditGroup", "name": "UserAuditGroup", "type": "Entity", "group": "class"}, {"id": "entity_AuditGrpAuditSetMapping", "name": "AuditGrpAuditSetMapping", "type": "Entity", "group": "class"}, {"id": "entity_Item", "name": "Item", "type": "Entity", "group": "class"}, {"id": "entity_ItemStatus", "name": "ItemStatus", "type": "Entity", "group": "class"}, {"id": "entity_ItemEvents", "name": "ItemEvents", "type": "Entity", "group": "class"}, {"id": "entity_ItemsBySha1", "name": "ItemsBySha1", "type": "Entity", "group": "class"}, {"id": "entity_Events", "name": "Events", "type": "Entity", "group": "class"}, {"id": "entity_EnterpriseEventLogs", "name": "EnterpriseEventLogs", "type": "Entity", "group": "class"}, {"id": "entity_PositionTracker", "name": "PositionTracker", "type": "Entity", "group": "class"}, {"id": "entity_AuditorLogs", "name": "AuditorLogs", "type": "Entity", "group": "class"}, {"id": "entity_SystemEventDates", "name": "SystemEventDates", "type": "Entity", "group": "class"}, {"id": "entity_UserController", "name": "UserController", "type": "Entity", "group": "class"}, {"id": "entity_AuditSetController", "name": "AuditSetController", "type": "Entity", "group": "class"}, {"id": "entity_AuditSetItemController", "name": "AuditSetItemController", "type": "Entity", "group": "class"}, {"id": "entity_AuditSetCollaboratorController", "name": "AuditSetCollaboratorController", "type": "Entity", "group": "class"}, {"id": "entity_AuditGroupController", "name": "AuditGroupController", "type": "Entity", "group": "class"}, {"id": "entity_FileController", "name": "FileController", "type": "Entity", "group": "class"}, {"id": "entity_FolderController", "name": "FolderController", "type": "Entity", "group": "class"}, {"id": "entity_ItemController", "name": "ItemController", "type": "Entity", "group": "class"}, {"id": "entity_EventLogController", "name": "EventLogController", "type": "Entity", "group": "class"}, {"id": "entity_UserService", "name": "UserService", "type": "Entity", "group": "class"}, {"id": "entity_AuditSetService", "name": "AuditSetService", "type": "Entity", "group": "class"}, {"id": "entity_AuditSetItemService", "name": "AuditSetItemService", "type": "Entity", "group": "class"}, {"id": "entity_AuditSetCollaboratorService", "name": "AuditSetCollaboratorService", "type": "Entity", "group": "class"}, {"id": "entity_AuditGroupService", "name": "AuditGroupService", "type": "Entity", "group": "class"}, {"id": "entity_FileService", "name": "FileService", "type": "Entity", "group": "class"}, {"id": "entity_FolderService", "name": "FolderService", "type": "Entity", "group": "class"}, {"id": "entity_CommonService", "name": "CommonService", "type": "Entity", "group": "class"}, {"id": "entity_AssetService", "name": "AssetService", "type": "Entity", "group": "class"}, {"id": "entity_EventLogService", "name": "EventLogService", "type": "Entity", "group": "class"}, {"id": "entity_UserRepository", "name": "UserRepository", "type": "Entity", "group": "interface"}, {"id": "entity_UserTokenRepository", "name": "UserTokenRepository", "type": "Entity", "group": "interface"}, {"id": "entity_UserOptRepository", "name": "UserOptRepository", "type": "Entity", "group": "interface"}, {"id": "entity_OrganizationRepository", "name": "OrganizationRepository", "type": "Entity", "group": "interface"}, {"id": "entity_RoleUserRepository", "name": "RoleUserRepository", "type": "Entity", "group": "interface"}, {"id": "entity_AuditSetRepository", "name": "AuditSetRepository", "type": "Entity", "group": "interface"}, {"id": "entity_AuditSetItemRepository", "name": "AuditSetItemRepository", "type": "Entity", "group": "interface"}, {"id": "entity_AuditSetCollaboratorsRepository", "name": "AuditSetCollaboratorsRepository", "type": "Entity", "group": "interface"}, {"id": "entity_AuditGroupRepository", "name": "AuditGroupRepository", "type": "Entity", "group": "interface"}, {"id": "entity_UserAuditGroupRepository", "name": "UserAuditGroupRepository", "type": "Entity", "group": "interface"}, {"id": "entity_AuditGrpAuditSetMappingRepository", "name": "AuditGrpAuditSetMappingRepository", "type": "Entity", "group": "interface"}, {"id": "entity_ItemRepository", "name": "ItemRepository", "type": "Entity", "group": "interface"}, {"id": "entity_ItemStatusRepository", "name": "ItemStatusRepository", "type": "Entity", "group": "interface"}, {"id": "entity_ItemEventsRepository", "name": "ItemEventsRepository", "type": "Entity", "group": "interface"}, {"id": "entity_ItemsBySha1Repository", "name": "ItemsBySha1Repository", "type": "Entity", "group": "interface"}, {"id": "entity_EventsRepository", "name": "EventsRepository", "type": "Entity", "group": "interface"}, {"id": "entity_EnterpriseEventLogsRepository", "name": "EnterpriseEventLogsRepository", "type": "Entity", "group": "interface"}, {"id": "entity_PositionTrackerRepository", "name": "PositionTrackerRepository", "type": "Entity", "group": "interface"}, {"id": "entity_AuditorLogsRepository", "name": "AuditorLogsRepository", "type": "Entity", "group": "interface"}, {"id": "entity_SystemEventDatesRepository", "name": "SystemEventDatesRepository", "type": "Entity", "group": "interface"}, {"id": "entity_ScalardlRepository", "name": "ScalardlRepository", "type": "Entity", "group": "interface"}, {"id": "term_AuditSet", "name": "AuditSet (\u76e3\u67fb\u30bb\u30c3\u30c8)", "type": "Term", "group": "Audit"}, {"id": "term_AuditGroup", "name": "AuditGroup (\u76e3\u67fb\u30b0\u30eb\u30fc\u30d7)", "type": "Term", "group": "Audit"}, {"id": "term_Collaborator", "name": "Collaborator (\u30b3\u30e9\u30dc\u30ec\u30fc\u30bf\u30fc)", "type": "Term", "group": "Audit"}, {"id": "term_Reviewer", "name": "Reviewer (\u30ec\u30d3\u30e5\u30a2\u30fc)", "type": "Term", "group": "Audit"}, {"id": "term_AuditAdmin", "name": "AuditAdmin (\u76e3\u67fb\u7ba1\u7406\u8005)", "type": "Term", "group": "Audit"}, {"id": "term_GeneralUser", "name": "GeneralUser (\u4e00\u822c\u30e6\u30fc\u30b6\u30fc)", "type": "Term", "group": "Identity"}, {"id": "term_ExternalAuditor", "name": "ExternalAuditor (\u5916\u90e8\u76e3\u67fb\u4eba)", "type": "Term", "group": "Audit"}, {"id": "term_Item", "name": "Item (\u30a2\u30a4\u30c6\u30e0)", "type": "Term", "group": "File"}, {"id": "term_Asset", "name": "Asset (\u30a2\u30bb\u30c3\u30c8)", "type": "Term", "group": "Verification"}, {"id": "term_TamperingVerification", "name": "TamperingVerification (\u6539\u3056\u3093\u691c\u8a3c)", "type": "Term", "group": "Verification"}, {"id": "term_FileCopy", "name": "FileCopy (\u30d5\u30a1\u30a4\u30eb\u30b3\u30d4\u30fc)", "type": "Term", "group": "File"}, {"id": "term_FileVersion", "name": "FileVersion (\u30d5\u30a1\u30a4\u30eb\u30d0\u30fc\u30b8\u30e7\u30f3)", "type": "Term", "group": "File"}, {"id": "term_SHA1Hash", "name": "SHA1Hash (SHA1\u30cf\u30c3\u30b7\u30e5)", "type": "Term", "group": "File"}, {"id": "term_EventLog", "name": "EventLog (\u30a4\u30d9\u30f3\u30c8\u30ed\u30b0)", "type": "Term", "group": "Event"}, {"id": "term_EnterpriseEvent", "name": "EnterpriseEvent (\u30a8\u30f3\u30bf\u30fc\u30d7\u30e9\u30a4\u30ba\u30a4\u30d9\u30f3\u30c8)", "type": "Term", "group": "Event"}, {"id": "term_EventType", "name": "EventType (\u30a4\u30d9\u30f3\u30c8\u30bf\u30a4\u30d7)", "type": "Term", "group": "Event"}, {"id": "term_PositionTracker", "name": "PositionTracker (\u4f4d\u7f6e\u30c8\u30e9\u30c3\u30ab\u30fc)", "type": "Term", "group": "Event"}, {"id": "term_OTP", "name": "OTP (\u30ef\u30f3\u30bf\u30a4\u30e0\u30d1\u30b9\u30ef\u30fc\u30c9)", "type": "Term", "group": "Identity"}, {"id": "term_RefreshToken", "name": "RefreshToken (\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\u30c8\u30fc\u30af\u30f3)", "type": "Term", "group": "Identity"}, {"id": "term_AccessToken", "name": "AccessToken (\u30a2\u30af\u30bb\u30b9\u30c8\u30fc\u30af\u30f3)", "type": "Term", "group": "Identity"}, {"id": "term_Organization", "name": "Organization (\u7d44\u7e54)", "type": "Term", "group": "Identity"}, {"id": "term_BoxAdmin", "name": "BoxAdmin (Box\u7ba1\u7406\u8005)", "type": "Term", "group": "Identity"}, {"id": "term_AuditSetItem", "name": "AuditSetItem (\u76e3\u67fb\u30bb\u30c3\u30c8\u30a2\u30a4\u30c6\u30e0)", "type": "Term", "group": "Audit"}, {"id": "term_AuditSetCollaborator", "name": "AuditSetCollaborator (\u76e3\u67fb\u30bb\u30c3\u30c8\u30b3\u30e9\u30dc\u30ec\u30fc\u30bf\u30fc)", "type": "Term", "group": "Audit"}, {"id": "term_AuditorLog", "name": "AuditorLog (\u76e3\u67fb\u30ed\u30b0)", "type": "Term", "group": "Event"}, {"id": "term_ItemStatus", "name": "ItemStatus (\u30a2\u30a4\u30c6\u30e0\u30b9\u30c6\u30fc\u30bf\u30b9)", "type": "Term", "group": "File"}], "links": [{"source": "entity_User", "target": "domain_Identity", "type": "BELONGS_TO"}, {"source": "entity_UserToken", "target": "domain_Identity", "type": "BELONGS_TO"}, {"source": "entity_UserOtp", "target": "domain_Identity", "type": "BELONGS_TO"}, {"source": "term_Organization", "target": "domain_Identity", "type": "BELONGS_TO"}, {"source": "entity_RoleUser", "target": "domain_Identity", "type": "BELONGS_TO"}, {"source": "entity_UserController", "target": "domain_Identity", "type": "BELONGS_TO"}, {"source": "entity_UserService", "target": "domain_Identity", "type": "BELONGS_TO"}, {"source": "entity_UserRepository", "target": "domain_Identity", "type": "BELONGS_TO"}, {"source": "entity_UserTokenRepository", "target": "domain_Identity", "type": "BELONGS_TO"}, {"source": "entity_UserOptRepository", "target": "domain_Identity", "type": "BELONGS_TO"}, {"source": "entity_OrganizationRepository", "target": "domain_Identity", "type": "BELONGS_TO"}, {"source": "entity_RoleUserRepository", "target": "domain_Identity", "type": "BELONGS_TO"}, {"source": "term_AuditSet", "target": "domain_Audit", "type": "BELONGS_TO"}, {"source": "term_AuditSetItem", "target": "domain_Audit", "type": "BELONGS_TO"}, {"source": "entity_AuditSetCollaborators", "target": "domain_Audit", "type": "BELONGS_TO"}, {"source": "entity_AuditSetController", "target": "domain_Audit", "type": "BELONGS_TO"}, {"source": "entity_AuditSetItemController", "target": "domain_Audit", "type": "BELONGS_TO"}, {"source": "entity_AuditSetCollaboratorController", "target": "domain_Audit", "type": "BELONGS_TO"}, {"source": "entity_AuditSetService", "target": "domain_Audit", "type": "BELONGS_TO"}, {"source": "entity_AuditSetItemService", "target": "domain_Audit", "type": "BELONGS_TO"}, {"source": "entity_AuditSetCollaboratorService", "target": "domain_Audit", "type": "BELONGS_TO"}, {"source": "entity_AuditSetRepository", "target": "domain_Audit", "type": "BELONGS_TO"}, {"source": "entity_AuditSetItemRepository", "target": "domain_Audit", "type": "BELONGS_TO"}, {"source": "entity_AuditSetCollaboratorsRepository", "target": "domain_Audit", "type": "BELONGS_TO"}, {"source": "term_AuditGroup", "target": "term_AuditGroup", "type": "BELONGS_TO"}, {"source": "entity_UserAuditGroup", "target": "term_AuditGroup", "type": "BELONGS_TO"}, {"source": "entity_AuditGrpAuditSetMapping", "target": "term_AuditGroup", "type": "BELONGS_TO"}, {"source": "entity_AuditGroupController", "target": "term_AuditGroup", "type": "BELONGS_TO"}, {"source": "entity_AuditGroupService", "target": "term_AuditGroup", "type": "BELONGS_TO"}, {"source": "entity_AuditGroupRepository", "target": "term_AuditGroup", "type": "BELONGS_TO"}, {"source": "entity_UserAuditGroupRepository", "target": "term_AuditGroup", "type": "BELONGS_TO"}, {"source": "entity_AuditGrpAuditSetMappingRepository", "target": "term_AuditGroup", "type": "BELONGS_TO"}, {"source": "term_Item", "target": "domain_File", "type": "BELONGS_TO"}, {"source": "term_ItemStatus", "target": "domain_File", "type": "BELONGS_TO"}, {"source": "entity_ItemEvents", "target": "domain_File", "type": "BELONGS_TO"}, {"source": "entity_ItemsBySha1", "target": "domain_File", "type": "BELONGS_TO"}, {"source": "entity_FileController", "target": "domain_File", "type": "BELONGS_TO"}, {"source": "entity_FolderController", "target": "domain_File", "type": "BELONGS_TO"}, {"source": "entity_ItemController", "target": "domain_File", "type": "BELONGS_TO"}, {"source": "entity_FileService", "target": "domain_File", "type": "BELONGS_TO"}, {"source": "entity_FolderService", "target": "domain_File", "type": "BELONGS_TO"}, {"source": "entity_CommonService", "target": "domain_File", "type": "BELONGS_TO"}, {"source": "entity_ItemRepository", "target": "domain_File", "type": "BELONGS_TO"}, {"source": "entity_ItemStatusRepository", "target": "domain_File", "type": "BELONGS_TO"}, {"source": "entity_ItemEventsRepository", "target": "domain_File", "type": "BELONGS_TO"}, {"source": "entity_ItemsBySha1Repository", "target": "domain_File", "type": "BELONGS_TO"}, {"source": "entity_Events", "target": "domain_Event", "type": "BELONGS_TO"}, {"source": "entity_EnterpriseEventLogs", "target": "domain_Event", "type": "BELONGS_TO"}, {"source": "term_PositionTracker", "target": "domain_Event", "type": "BELONGS_TO"}, {"source": "entity_AuditorLogs", "target": "domain_Event", "type": "BELONGS_TO"}, {"source": "entity_SystemEventDates", "target": "domain_Event", "type": "BELONGS_TO"}, {"source": "entity_EventLogController", "target": "domain_Event", "type": "BELONGS_TO"}, {"source": "entity_EventLogService", "target": "domain_Event", "type": "BELONGS_TO"}, {"source": "entity_EventsRepository", "target": "domain_Event", "type": "BELONGS_TO"}, {"source": "entity_EnterpriseEventLogsRepository", "target": "domain_Event", "type": "BELONGS_TO"}, {"source": "entity_PositionTrackerRepository", "target": "domain_Event", "type": "BELONGS_TO"}, {"source": "entity_AuditorLogsRepository", "target": "domain_Event", "type": "BELONGS_TO"}, {"source": "entity_SystemEventDatesRepository", "target": "domain_Event", "type": "BELONGS_TO"}, {"source": "entity_AssetService", "target": "domain_Verification", "type": "BELONGS_TO"}, {"source": "entity_ScalardlRepository", "target": "domain_Verification", "type": "BELONGS_TO"}, {"source": "term_AuditSet", "target": "entity_User", "type": "owned_by"}, {"source": "term_AuditSetItem", "target": "term_AuditSet", "type": "belongs_to"}, {"source": "term_AuditSetItem", "target": "term_Item", "type": "references"}, {"source": "entity_AuditSetCollaborators", "target": "term_AuditSet", "type": "belongs_to"}, {"source": "entity_AuditSetCollaborators", "target": "entity_User", "type": "references"}, {"source": "term_AuditGroup", "target": "entity_User", "type": "owned_by"}, {"source": "entity_UserAuditGroup", "target": "entity_User", "type": "references"}, {"source": "entity_UserAuditGroup", "target": "term_AuditGroup", "type": "belongs_to"}, {"source": "entity_AuditGrpAuditSetMapping", "target": "term_AuditGroup", "type": "references"}, {"source": "entity_AuditGrpAuditSetMapping", "target": "term_AuditSet", "type": "references"}, {"source": "term_Item", "target": "term_ItemStatus", "type": "has"}, {"source": "term_Item", "target": "entity_ItemEvents", "type": "has"}, {"source": "term_Item", "target": "entity_ItemsBySha1", "type": "grouped_by"}, {"source": "entity_Events", "target": "entity_User", "type": "triggered_by"}, {"source": "entity_Events", "target": "term_Item", "type": "affects"}, {"source": "entity_AuditorLogs", "target": "entity_User", "type": "logged_for"}, {"source": "entity_UserController", "target": "entity_UserService", "type": "uses"}, {"source": "entity_AuditSetController", "target": "entity_AuditSetService", "type": "uses"}, {"source": "entity_AuditSetItemController", "target": "entity_AuditSetItemService", "type": "uses"}, {"source": "entity_AuditSetCollaboratorController", "target": "entity_AuditSetCollaboratorService", "type": "uses"}, {"source": "entity_AuditGroupController", "target": "entity_AuditGroupService", "type": "uses"}, {"source": "entity_FileController", "target": "entity_FileService", "type": "uses"}, {"source": "entity_FolderController", "target": "entity_FolderService", "type": "uses"}, {"source": "entity_EventLogController", "target": "entity_EventLogService", "type": "uses"}, {"source": "entity_UserService", "target": "entity_UserRepository", "type": "uses"}, {"source": "entity_UserService", "target": "entity_UserTokenRepository", "type": "uses"}, {"source": "entity_UserService", "target": "entity_UserOptRepository", "type": "uses"}, {"source": "entity_UserService", "target": "entity_OrganizationRepository", "type": "uses"}, {"source": "entity_AuditSetService", "target": "entity_AuditSetRepository", "type": "uses"}, {"source": "entity_AuditSetItemService", "target": "entity_AuditSetItemRepository", "type": "uses"}, {"source": "entity_AuditSetCollaboratorService", "target": "entity_AuditSetCollaboratorsRepository", "type": "uses"}, {"source": "entity_AuditGroupService", "target": "entity_AuditGroupRepository", "type": "uses"}, {"source": "entity_AuditGroupService", "target": "entity_UserAuditGroupRepository", "type": "uses"}, {"source": "entity_FileService", "target": "entity_ItemRepository", "type": "uses"}, {"source": "entity_FileService", "target": "entity_ItemStatusRepository", "type": "uses"}, {"source": "entity_EventLogService", "target": "entity_EventsRepository", "type": "uses"}, {"source": "entity_EventLogService", "target": "entity_EnterpriseEventLogsRepository", "type": "uses"}, {"source": "entity_EventLogService", "target": "entity_PositionTrackerRepository", "type": "uses"}, {"source": "entity_AssetService", "target": "entity_ScalardlRepository", "type": "uses"}]};

    const container = document.getElementById('graph-container');
    const width = container.clientWidth;
    const height = 600;

    const svg = d3.select("#graph-svg")
        .attr("width", width)
        .attr("height", height);

    const g = svg.append("g");

    // Zoom
    const zoom = d3.zoom()
        .scaleExtent([0.1, 4])
        .on("zoom", (event) => g.attr("transform", event.transform));
    svg.call(zoom);

    // Colors
    const color = d3.scaleOrdinal()
        .domain(["Domain", "Entity", "Term"])
        .range(["#e74c3c", "#3498db", "#2ecc71"]);

    // Simulation
    const simulation = d3.forceSimulation(data.nodes)
        .force("link", d3.forceLink(data.links).id(d => d.id).distance(80))
        .force("charge", d3.forceManyBody().strength(-200))
        .force("center", d3.forceCenter(width / 2, height / 2))
        .force("collision", d3.forceCollide().radius(25));

    // Links
    const link = g.append("g")
        .selectAll("line")
        .data(data.links)
        .join("line")
        .attr("stroke", "#666")
        .attr("stroke-opacity", 0.6)
        .attr("stroke-width", 1);

    // Nodes
    const node = g.append("g")
        .selectAll("g")
        .data(data.nodes)
        .join("g")
        .attr("cursor", "pointer")
        .call(d3.drag()
            .on("start", (event, d) => {
                if (!event.active) simulation.alphaTarget(0.3).restart();
                d.fx = d.x; d.fy = d.y;
            })
            .on("drag", (event, d) => { d.fx = event.x; d.fy = event.y; })
            .on("end", (event, d) => {
                if (!event.active) simulation.alphaTarget(0);
                d.fx = null; d.fy = null;
            }));

    node.append("circle")
        .attr("r", d => d.type === "Domain" ? 15 : 8)
        .attr("fill", d => color(d.type));

    node.append("text")
        .text(d => d.name.length > 15 ? d.name.substring(0, 15) + "..." : d.name)
        .attr("x", 12)
        .attr("y", 4)
        .attr("font-size", "10px")
        .attr("fill", "white");

    // Tooltip
    const tooltip = d3.select("body").append("div")
        .style("position", "absolute")
        .style("background", "rgba(0,0,0,0.8)")
        .style("color", "white")
        .style("padding", "10px")
        .style("border-radius", "5px")
        .style("font-size", "12px")
        .style("pointer-events", "none")
        .style("opacity", 0);

    node.on("mouseover", (event, d) => {
        tooltip.style("opacity", 1)
            .html(`<strong>${d.name}</strong><br/>Type: ${d.type}<br/>Group: ${d.group || 'N/A'}`)
            .style("left", (event.pageX + 10) + "px")
            .style("top", (event.pageY - 10) + "px");
    }).on("mouseout", () => { tooltip.style("opacity", 0); });

    simulation.on("tick", () => {
        link.attr("x1", d => d.source.x).attr("y1", d => d.source.y)
            .attr("x2", d => d.target.x).attr("y2", d => d.target.y);
        node.attr("transform", d => `translate(${d.x},${d.y})`);
    });

    // Stats
    document.getElementById("graph-stats").innerHTML =
        `Nodes: ${data.nodes.length} | Links: ${data.links.length}`;

    // Search
    document.getElementById("graph-search").addEventListener("input", (e) => {
        const query = e.target.value.toLowerCase();
        node.style("opacity", d =>
            query === "" || d.name.toLowerCase().includes(query) ? 1 : 0.2);
    });
})();
</script>

</section>
</main>
    <script>
        mermaid.initialize({
            startOnLoad: true,
            theme: 'default',
            securityLevel: 'loose'
        });
    </script>
</body>
</html>
