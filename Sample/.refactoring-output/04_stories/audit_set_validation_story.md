# ドメインストーリー: 監査セット検証

## 概要

**ドメイン**: Audit Set Management + File & Item
**ストーリータイプ**: ハッピーパス
**アクター**: 外部監査人（External Auditor）

## ストーリー

### シナリオ: 監査セットの改ざん検証

外部監査人が、共有された監査セット内のすべてのファイルに対して改ざん検証を実行する。

---

## ドメインストーリーテリング図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     監査セット検証ストーリー                              │
└─────────────────────────────────────────────────────────────────────────┘

    ┌──────────┐
    │ 外部監査人 │
    │ (Auditor)│
    └────┬─────┘
         │
         │ ① 監査セット詳細画面を開く
         ▼
    ┌──────────┐         ┌──────────────┐
    │ WebApp   │────────▶│ API Gateway  │
    └──────────┘         └──────┬───────┘
                                │
                                │ ② 監査セット情報を取得
                                ▼
                         ┌──────────────┐
                         │ Audit Set    │
                         │   Service    │
                         └──────┬───────┘
                                │
                                │ ③ アイテム一覧を返却
                                ▼
    ┌──────────┐         ┌──────────────┐
    │ 外部監査人 │◀────────│ WebApp       │
    └────┬─────┘         └──────────────┘
         │
         │ ④ 「検証実行」ボタンをクリック
         ▼
    ┌──────────┐         ┌──────────────┐
    │ WebApp   │────────▶│ API Gateway  │
    └──────────┘         └──────┬───────┘
                                │
                                │ ⑤ 検証リクエスト
                                ▼
                         ┌──────────────┐
                         │ Audit Set    │
                         │   Service    │
                         └──────┬───────┘
                                │
            ┌───────────────────┼───────────────────┐
            │                   │                   │
            ▼                   ▼                   ▼
     ┌──────────────┐   ┌──────────────┐   ┌──────────────┐
     │ File Item    │   │ File Item    │   │ File Item    │
     │ Service      │   │ Service      │   │ Service      │
     │ (Item 1)     │   │ (Item 2)     │   │ (Item N)     │
     └──────┬───────┘   └──────┬───────┘   └──────┬───────┘
            │                   │                   │
            │ ⑥ BOXからハッシュ取得               │
            ▼                   ▼                   ▼
     ┌──────────────┐   ┌──────────────┐   ┌──────────────┐
     │ BOX Integration│ │ BOX Integration│ │ BOX Integration│
     │   Service     │   │   Service     │   │   Service     │
     └──────┬───────┘   └──────┬───────┘   └──────┬───────┘
            │                   │                   │
            │ ⑦ ScalarDLで検証                    │
            ▼                   ▼                   ▼
     ┌──────────────┐   ┌──────────────┐   ┌──────────────┐
     │  ScalarDL    │   │  ScalarDL    │   │  ScalarDL    │
     │              │   │              │   │              │
     └──────┬───────┘   └──────┬───────┘   └──────┬───────┘
            │                   │                   │
            └───────────────────┼───────────────────┘
                                │
                                │ ⑧ 検証結果を集約
                                ▼
                         ┌──────────────┐
                         │ Audit Set    │
                         │   Service    │
                         └──────┬───────┘
                                │
                                │ ⑨ AuditSetValidated イベント発行
                                ▼
                         ┌──────────────┐
                         │ Message Queue│
                         └──────────────┘
                                │
                                │ ⑩ 検証結果を返却
                                ▼
    ┌──────────┐         ┌──────────────┐
    │ 外部監査人 │◀────────│ WebApp       │
    └──────────┘         └──────────────┘
         │
         │ ⑪ 検証レポートを確認
         ▼
    ┌──────────────────────────────────┐
    │         検証結果レポート           │
    │ ┌────────────────────────────┐  │
    │ │ 総ファイル数: 50            │  │
    │ │ 検証済み: 50               │  │
    │ │ 正常: 48                   │  │
    │ │ 改ざん検知: 2 ⚠️            │  │
    │ └────────────────────────────┘  │
    └──────────────────────────────────┘

```

---

## ステップ詳細

### ① 監査セット詳細画面を開く

**アクター**: 外部監査人
**アクション**: 共有された監査セットの詳細画面を開く

```
外部監査人 が WebApp で 監査セット詳細画面 を 開く
```

### ② 監査セット情報を取得

**サービス**: Audit Set Service
**API**: `GET /audit-sets/{id}`

```
WebApp が Audit Set Service から 監査セット情報 を 取得する
```

### ③ アイテム一覧を返却

**レスポンス内容**:
- 監査セット基本情報
- アイテム一覧（ファイル/フォルダ）
- 各アイテムの現在のステータス

```
Audit Set Service が アイテム一覧 を 返却する
```

### ④ 「検証実行」ボタンをクリック

**アクター**: 外部監査人
**確認事項**:
- 検証対象のファイル数
- 予想所要時間

```
外部監査人 が 「検証実行」ボタン を クリックする
```

### ⑤ 検証リクエスト

**サービス**: Audit Set Service
**API**: `POST /audit-sets/{id}/validate`

```
WebApp が Audit Set Service に 検証リクエスト を 送信する
```

### ⑥ BOXからハッシュ取得

**処理**:
- 各ファイルの現在のSHA1ハッシュを取得
- 並列処理で効率化

```
File Item Service が BOX Integration Service 経由で 各ファイル の 現在ハッシュ を 取得する
```

### ⑦ ScalarDLで検証

**処理**:
- 登録済みハッシュと現在ハッシュを比較
- ScalarDLの改ざん検知機能を使用

```
File Item Service が ScalarDL で 登録ハッシュ と 現在ハッシュ を 比較する
```

### ⑧ 検証結果を集約

**集約内容**:
- 各ファイルの検証結果
- 改ざん検知の有無
- 検証日時

```
Audit Set Service が 全ファイル の 検証結果 を 集約する
```

### ⑨ AuditSetValidatedイベント発行

**イベント**: `AuditSetValidated`
**ペイロード**:
```json
{
  "auditSetId": "as-001",
  "validatedBy": 456,
  "validatedAt": "2024-01-15T15:30:00Z",
  "totalItems": 50,
  "validItems": 48,
  "tamperedItems": 2,
  "tamperedItemIds": ["item-5", "item-23"]
}
```

```
Audit Set Service が AuditSetValidated イベント を 発行する
```

### ⑩ 検証結果を返却

**レスポンス**:
- 検証サマリー
- 詳細結果（各ファイル）
- 改ざん検知ファイルのハイライト

```
Audit Set Service が 検証結果 を WebApp に 返却する
```

### ⑪ 検証レポートを確認

**表示内容**:
- 総ファイル数
- 正常ファイル数
- 改ざん検知ファイル（あれば赤色ハイライト）
- 各ファイルの詳細ステータス

```
外部監査人 が 検証結果レポート を 確認する
```

---

## 検証ロジック詳細

### ハッシュ比較フロー

```
┌────────────────────────────────────────────────────┐
│                  ハッシュ比較                        │
├────────────────────────────────────────────────────┤
│                                                    │
│  登録時ハッシュ              現在ハッシュ            │
│  (ScalarDL)                 (BOX API)              │
│       │                         │                 │
│       │  a1b2c3d4e5f6...       │  a1b2c3d4e5f6... │
│       │                         │                 │
│       └──────────┬──────────────┘                 │
│                  │                                 │
│                  ▼                                 │
│            ┌──────────┐                           │
│            │  比較    │                           │
│            └────┬─────┘                           │
│                 │                                  │
│       ┌─────────┴─────────┐                       │
│       │                   │                       │
│       ▼                   ▼                       │
│  ┌─────────┐        ┌─────────┐                  │
│  │ 一致    │        │ 不一致  │                  │
│  │ (正常)  │        │ (改ざん)│                  │
│  └─────────┘        └─────────┘                  │
│                                                    │
└────────────────────────────────────────────────────┘
```

### ステータス遷移

```
[未登録] → [登録済み] → [検証済み:正常]
                     ↘
                       [検証済み:改ざん検知]
```

---

## ビジネスルール

| ルール | 説明 |
|-------|------|
| BR-101 | 検証はコラボレーター権限を持つユーザーのみ実行可能 |
| BR-102 | 削除されたファイルは「検証不可」となる |
| BR-103 | 改ざん検知時は管理者に通知される |
| BR-104 | 検証結果は監査ログとして永続保存される |

---

## 例外フロー

### E1: ファイルがBOXから削除されている

```
BOX API が 404 Not Found を 返した場合:
  → File Item Service が ステータスを「削除済み」に更新
  → 検証結果は「検証不可（ファイル削除）」
```

### E2: ScalarDL接続エラー

```
ScalarDL が 接続エラー を 返した場合:
  → File Item Service が リトライ（最大3回）
  → 失敗した場合、検証結果は「検証エラー」
  → 部分的な結果を返却
```

### E3: 大量ファイルによるタイムアウト

```
検証に 5分以上 かかる場合:
  → 非同期処理に切り替え
  → 進捗状況をポーリング可能に
  → 完了時に通知
```

---

## パフォーマンス考慮

| 項目 | 設計 |
|-----|------|
| 並列処理 | 最大10ファイル同時検証 |
| バッチサイズ | 100ファイル/バッチ |
| タイムアウト | 単一ファイル: 30秒 |
| キャッシュ | BOXファイル情報: 5分 |

---

## 監査ログ

検証実行時に以下を記録:

```json
{
  "action": "AUDIT_SET_VALIDATION",
  "auditSetId": "as-001",
  "performedBy": "auditor@example.com",
  "performedAt": "2024-01-15T15:30:00Z",
  "result": {
    "status": "COMPLETED_WITH_ISSUES",
    "totalItems": 50,
    "validItems": 48,
    "tamperedItems": 2
  }
}
```
