# ドメインストーリー: 監査セット作成

## 概要

**ドメイン**: Audit Set Management
**ストーリータイプ**: ハッピーパス
**アクター**: 監査管理者（Audit Admin）

## ストーリー

### シナリオ: 新規監査セットの作成

監査管理者が、BOX上のフォルダから監査対象ファイルを選択し、新しい監査セットを作成する。

---

## ドメインストーリーテリング図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     監査セット作成ストーリー                              │
└─────────────────────────────────────────────────────────────────────────┘

    ┌──────────┐
    │ 監査管理者 │
    │ (Admin)  │
    └────┬─────┘
         │
         │ ① 監査セット作成画面を開く
         ▼
    ┌──────────┐         ┌──────────────┐
    │ WebApp   │────────▶│ API Gateway  │
    └──────────┘         └──────┬───────┘
                                │
                                │ ② BOXフォルダ一覧を取得
                                ▼
                         ┌──────────────┐     ┌─────────┐
                         │ BOX Integration│────▶│ BOX API │
                         │   Service     │◀────│         │
                         └──────┬───────┘     └─────────┘
                                │
                                │ ③ フォルダ/ファイル一覧を返却
                                ▼
    ┌──────────┐         ┌──────────────┐
    │ 監査管理者 │◀────────│ WebApp       │
    └────┬─────┘         └──────────────┘
         │
         │ ④ 監査対象ファイルを選択
         │ ⑤ 監査セット名・説明を入力
         │ ⑥ 作成ボタンをクリック
         ▼
    ┌──────────┐         ┌──────────────┐
    │ WebApp   │────────▶│ API Gateway  │
    └──────────┘         └──────┬───────┘
                                │
                                │ ⑦ 認証確認
                                ▼
                         ┌──────────────┐
                         │ Identity     │
                         │   Service    │
                         └──────┬───────┘
                                │
                                │ ⑧ ユーザー権限確認OK
                                ▼
                         ┌──────────────┐
                         │ Audit Set    │
                         │   Service    │
                         └──────┬───────┘
                                │
                                │ ⑨ 監査セット作成
                                │ ⑩ アイテム登録
                                ▼
                         ┌──────────────┐     ┌─────────────┐
                         │ Audit Set DB │     │ Message Queue│
                         └──────────────┘     └──────┬──────┘
                                                     │
                                │ ⑪ AuditSetCreated  │
                                │    イベント発行     ◀──────────┘
                                ▼
                         ┌──────────────┐
                         │ File Item    │
                         │   Service    │
                         └──────┬───────┘
                                │
                                │ ⑫ ファイルステータス初期化
                                ▼
                         ┌──────────────┐
                         │ File Item DB │
                         └──────────────┘

```

---

## ステップ詳細

### ① 監査セット作成画面を開く

**アクター**: 監査管理者
**アクション**: WebAppの「監査セット作成」メニューをクリック

```
監査管理者 が WebApp で 監査セット作成画面 を 開く
```

### ② BOXフォルダ一覧を取得

**サービス**: BOX Integration Service
**API**: `GET /box/folders/{folderId}/items`

```
WebApp が API Gateway 経由で BOX Integration Service に フォルダ一覧 を 要求する
```

### ③ フォルダ/ファイル一覧を返却

**レスポンス**: BOXのフォルダ構造とファイル一覧

```
BOX Integration Service が BOX API から 取得した ファイル一覧 を WebApp に 返却する
```

### ④ 監査対象ファイルを選択

**アクター**: 監査管理者
**アクション**: チェックボックスでファイル/フォルダを選択

```
監査管理者 が 表示された ファイル一覧 から 監査対象 を 選択する
```

### ⑤ 監査セット名・説明を入力

**入力項目**:
- 監査セット名（必須）
- 説明（任意）
- 期限（任意）

```
監査管理者 が 監査セット の 名前 と 説明 を 入力する
```

### ⑥ 作成ボタンをクリック

**トリガー**: 「作成」ボタンクリック

```
監査管理者 が 作成ボタン を クリックする
```

### ⑦ 認証確認

**サービス**: Identity Service
**処理**: JWTトークンの検証

```
API Gateway が Identity Service に トークン検証 を 依頼する
```

### ⑧ ユーザー権限確認OK

**確認内容**:
- ユーザーが有効か
- 監査セット作成権限があるか
- 組織に所属しているか

```
Identity Service が ユーザー権限 を 確認し OK を 返却する
```

### ⑨ 監査セット作成

**サービス**: Audit Set Service
**API**: `POST /audit-sets`
**処理**:
- 監査セットエンティティ作成
- 作成者をオーナーとして設定
- ACL初期化

```
Audit Set Service が 新しい 監査セット を データベース に 保存する
```

### ⑩ アイテム登録

**処理**:
- 選択されたファイル/フォルダをAuditSetItemとして登録
- 部分選択の場合は選択されたアイテムのみ

```
Audit Set Service が 選択された ファイル を 監査セットアイテム として 登録する
```

### ⑪ AuditSetCreatedイベント発行

**イベント**: `AuditSetCreated`
**ペイロード**:
```json
{
  "auditSetId": "as-001",
  "ownerId": 123,
  "itemIds": ["item-1", "item-2", "item-3"],
  "createdAt": "2024-01-15T10:30:00Z"
}
```

```
Audit Set Service が AuditSetCreated イベント を Message Queue に 発行する
```

### ⑫ ファイルステータス初期化

**サービス**: File Item Service
**処理**:
- 各ファイルの改ざんステータスを「未検証」で初期化
- ScalarDLへの登録準備

```
File Item Service が イベント を 受信し ファイルステータス を 初期化する
```

---

## ビジネスルール

| ルール | 説明 |
|-------|------|
| BR-001 | 監査セット名は組織内で一意でなければならない |
| BR-002 | 1つの監査セットに追加できるアイテムは最大1,000件 |
| BR-003 | 作成者は自動的にオーナー権限を持つ |
| BR-004 | 削除済みファイルは選択できない |

---

## 例外フロー

### E1: BOX認証エラー

```
BOX API が 認証エラー を 返した場合:
  → BOX Integration Service が 再認証 を 試みる
  → 失敗した場合、ユーザー に BOX再ログイン を 要求する
```

### E2: 権限不足

```
Identity Service が 権限不足 を 検出した場合:
  → API Gateway が 403 Forbidden を 返却する
  → WebApp が 「権限がありません」 を 表示する
```

### E3: ファイル選択なし

```
監査管理者 が ファイルを選択せず に 作成ボタン を クリックした場合:
  → WebApp が バリデーションエラー を 表示する
  → 「少なくとも1つのファイルを選択してください」
```

---

## 用語集（このストーリー固有）

| 用語 | 定義 |
|-----|------|
| 監査セット | 監査対象ファイルのグループ |
| 監査管理者 | 監査セットを作成・管理する権限を持つユーザー |
| オーナー | 監査セットの所有者。全権限を持つ |
| 部分選択 | フォルダ内の一部のファイルのみを選択すること |
