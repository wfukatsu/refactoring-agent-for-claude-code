# ドメインストーリー: ユーザー認証

## 概要

**ドメイン**: Identity & Access
**ストーリータイプ**: ハッピーパス
**アクター**: 組織ユーザー（Organization User）

## ストーリー

### シナリオ: BOX OAuth連携によるログイン

組織ユーザーがBOXアカウントを使用してScalar Auditorにログインする。

---

## ドメインストーリーテリング図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     ユーザー認証ストーリー                               │
└─────────────────────────────────────────────────────────────────────────┘

    ┌──────────────┐
    │ 組織ユーザー   │
    │ (Org User)   │
    └──────┬───────┘
           │
           │ ① ログイン画面を開く
           ▼
    ┌──────────────┐
    │   WebApp     │
    │              │
    │ [BOXでログイン]│
    └──────┬───────┘
           │
           │ ② 「BOXでログイン」をクリック
           ▼
    ┌──────────────┐         ┌──────────────┐
    │   WebApp     │────────▶│ API Gateway  │
    └──────────────┘         └──────┬───────┘
                                    │
                                    │ ③ OAuth認証URL取得
                                    ▼
                             ┌──────────────┐
                             │ Identity     │
                             │   Service    │
                             └──────┬───────┘
                                    │
                                    │ ④ BOX OAuth URL生成
                                    ▼
                             ┌──────────────┐
                             │ BOX Integration│
                             │   Service     │
                             └──────┬───────┘
                                    │
                                    │ ⑤ OAuth URL を返却
                                    ▼
    ┌──────────────┐         ┌──────────────┐
    │ 組織ユーザー   │◀────────│   WebApp     │
    └──────┬───────┘         └──────────────┘
           │
           │ ⑥ BOX認証画面にリダイレクト
           ▼
    ┌─────────────────────────────────────────┐
    │              BOX ログイン画面             │
    │ ┌─────────────────────────────────────┐ │
    │ │                                     │ │
    │ │       BOX                          │ │
    │ │                                     │ │
    │ │   Email: [__________________]       │ │
    │ │   Password: [__________________]    │ │
    │ │                                     │ │
    │ │   [ ログイン ]                       │ │
    │ │                                     │ │
    │ └─────────────────────────────────────┘ │
    └──────────────┬──────────────────────────┘
                   │
                   │ ⑦ BOXにログイン
                   ▼
    ┌──────────────┐
    │   BOX API    │
    │              │
    │ 認証成功      │
    └──────┬───────┘
           │
           │ ⑧ 認可コードでリダイレクト
           ▼
    ┌──────────────┐         ┌──────────────┐
    │   WebApp     │────────▶│ API Gateway  │
    │ /callback    │         └──────┬───────┘
    └──────────────┘                │
                                    │ ⑨ 認可コードを送信
                                    ▼
                             ┌──────────────┐
                             │ Identity     │
                             │   Service    │
                             └──────┬───────┘
                                    │
                                    │ ⑩ アクセストークン取得
                                    ▼
                             ┌──────────────┐     ┌─────────────┐
                             │ BOX Integration│────▶│  BOX API    │
                             │   Service     │◀────│ /oauth2/token│
                             └──────┬───────┘     └─────────────┘
                                    │
                                    │ ⑪ ユーザー情報取得
                                    ▼
                             ┌──────────────┐     ┌─────────────┐
                             │ BOX Integration│────▶│  BOX API    │
                             │   Service     │◀────│ /users/me   │
                             └──────┬───────┘     └─────────────┘
                                    │
                                    │ ⑫ ユーザー登録/更新
                                    ▼
                             ┌──────────────┐
                             │ Identity     │
                             │   Service    │
                             └──────┬───────┘
                                    │
                                    │ ⑬ JWT発行
                                    ▼
                             ┌──────────────┐
                             │ JWT Token    │
                             │              │
                             │ {            │
                             │   userId: 123│
                             │   email:...  │
                             │   exp:...    │
                             │ }            │
                             └──────┬───────┘
                                    │
                                    │ ⑭ トークン保存
                                    ▼
                             ┌──────────────┐
                             │ UserToken DB │
                             └──────────────┘
                                    │
                                    │ ⑮ JWT を返却
                                    ▼
    ┌──────────────┐         ┌──────────────┐
    │ 組織ユーザー   │◀────────│   WebApp     │
    └──────┬───────┘         └──────────────┘
           │
           │ ⑯ ダッシュボードにリダイレクト
           ▼
    ┌─────────────────────────────────────────┐
    │           Scalar Auditor Dashboard       │
    │ ┌─────────────────────────────────────┐ │
    │ │ ようこそ、田中太郎さん               │ │
    │ │                                     │ │
    │ │ 監査セット一覧                       │ │
    │ │ - 2024年1月監査                     │ │
    │ │ - 2024年Q1レビュー                  │ │
    │ └─────────────────────────────────────┘ │
    └─────────────────────────────────────────┘

```

---

## ステップ詳細

### ① ログイン画面を開く

**アクター**: 組織ユーザー
**アクション**: Scalar AuditorのURLにアクセス

```
組織ユーザー が WebApp の ログイン画面 を 開く
```

### ② 「BOXでログイン」をクリック

**UI要素**: BOXログインボタン
**トリガー**: クリック

```
組織ユーザー が 「BOXでログイン」ボタン を クリックする
```

### ③ OAuth認証URL取得

**サービス**: Identity Service
**API**: `GET /auth/box/url`

```
WebApp が Identity Service から OAuth認証URL を 取得する
```

### ④ BOX OAuth URL生成

**処理**:
- client_id設定
- redirect_uri設定
- state生成（CSRF対策）
- scope設定

```
BOX Integration Service が OAuth認証URL を 生成する
```

### ⑤ OAuth URLを返却

**レスポンス**:
```json
{
  "authUrl": "https://account.box.com/api/oauth2/authorize?client_id=xxx&redirect_uri=xxx&state=xxx"
}
```

```
Identity Service が OAuth URL を WebApp に 返却する
```

### ⑥ BOX認証画面にリダイレクト

**処理**: ブラウザがBOXログイン画面にリダイレクト

```
WebApp が ユーザー を BOX認証画面 に リダイレクトする
```

### ⑦ BOXにログイン

**アクター**: 組織ユーザー
**入力**: BOXアカウントのメールアドレスとパスワード

```
組織ユーザー が BOX に メールアドレス と パスワード で ログインする
```

### ⑧ 認可コードでリダイレクト

**処理**: BOXが認可コードと共にコールバックURLにリダイレクト

```
BOX が 認可コード を 付与して WebApp に リダイレクトする
```

### ⑨ 認可コードを送信

**API**: `POST /auth/box/callback`
**パラメータ**: code, state

```
WebApp が Identity Service に 認可コード を 送信する
```

### ⑩ アクセストークン取得

**BOX API**: `POST /oauth2/token`
**交換**: 認可コード → アクセストークン + リフレッシュトークン

```
BOX Integration Service が 認可コード を アクセストークン と 交換する
```

### ⑪ ユーザー情報取得

**BOX API**: `GET /users/me`
**取得情報**: id, name, login（email）

```
BOX Integration Service が BOX から ユーザー情報 を 取得する
```

### ⑫ ユーザー登録/更新

**処理**:
- 既存ユーザー: 情報更新
- 新規ユーザー: 登録 + デフォルトロール付与

```
Identity Service が ユーザー を データベース に 登録または更新する
```

### ⑬ JWT発行

**ペイロード**:
```json
{
  "sub": "123",
  "email": "user@example.com",
  "name": "田中太郎",
  "roles": ["USER"],
  "iat": 1705312200,
  "exp": 1705398600
}
```

```
Identity Service が JWT を 発行する
```

### ⑭ トークン保存

**テーブル**: UserToken
**保存内容**: JWT, BOXアクセストークン, リフレッシュトークン

```
Identity Service が トークン を データベース に 保存する
```

### ⑮ JWTを返却

**レスポンス**:
```json
{
  "accessToken": "eyJhbGciOiJIUzI1NiIs...",
  "expiresIn": 86400,
  "tokenType": "Bearer"
}
```

```
Identity Service が JWT を WebApp に 返却する
```

### ⑯ ダッシュボードにリダイレクト

**処理**: JWTをlocalStorageに保存し、ダッシュボードに遷移

```
WebApp が ユーザー を ダッシュボード に リダイレクトする
```

---

## 外部監査人のログインフロー

### 代替シナリオ: パスワード認証

```
┌──────────────┐
│ 外部監査人    │
└──────┬───────┘
       │
       │ ① メールアドレス/パスワードでログイン
       ▼
┌──────────────┐         ┌──────────────┐
│   WebApp     │────────▶│ Identity     │
│              │         │   Service    │
└──────────────┘         └──────┬───────┘
                                │
                                │ ② パスワード検証
                                ▼
                         ┌──────────────┐
                         │ User DB      │
                         │              │
                         │ bcrypt       │
                         │ compare      │
                         └──────┬───────┘
                                │
                                │ ③ JWT発行
                                ▼
                         ┌──────────────┐
                         │ JWT Token    │
                         └──────────────┘
```

---

## ビジネスルール

| ルール | 説明 |
|-------|------|
| BR-301 | 組織ユーザーはBOX認証のみ使用可能 |
| BR-302 | 外部監査人はパスワード認証のみ使用可能 |
| BR-303 | JWTの有効期限は24時間 |
| BR-304 | リフレッシュトークンの有効期限は30日 |
| BR-305 | 5回連続ログイン失敗でアカウントロック |

---

## 例外フロー

### E1: BOX認証キャンセル

```
ユーザー が BOX認証 を キャンセルした場合:
  → BOXがerror=access_deniedでリダイレクト
  → WebAppがエラーメッセージを表示
  → ログイン画面に戻る
```

### E2: ユーザーが組織に所属していない

```
BOXユーザー が 許可された組織 に 所属していない場合:
  → Identity Serviceが認証を拒否
  → 「この組織のユーザーではありません」エラー
```

### E3: アカウントロック中

```
ユーザー が ロックされている場合:
  → 認証を拒否
  → 「アカウントがロックされています。管理者に連絡してください」
```

---

## セキュリティ考慮事項

| 項目 | 対策 |
|-----|------|
| CSRF | stateパラメータで検証 |
| XSS | トークンはhttpOnlyクッキーまたはメモリ保持 |
| トークン漏洩 | 短い有効期限 + リフレッシュトークン |
| ブルートフォース | レート制限 + アカウントロック |

---

## トークンリフレッシュフロー

```
┌──────────────┐
│ WebApp       │
│              │
│ JWT期限切れ   │
└──────┬───────┘
       │
       │ ① リフレッシュリクエスト
       ▼
┌──────────────┐
│ Identity     │
│   Service    │
└──────┬───────┘
       │
       │ ② リフレッシュトークン検証
       ▼
┌──────────────┐
│ UserToken DB │
└──────┬───────┘
       │
       │ ③ 新しいJWT発行
       ▼
┌──────────────┐
│ 新JWT        │
│ 新RefreshToken│
└──────────────┘
```

---

## 監査ログ

認証イベントとして以下を記録:

```json
{
  "action": "USER_LOGIN",
  "userId": "123",
  "email": "user@example.com",
  "authMethod": "BOX_OAUTH",
  "ipAddress": "192.168.1.1",
  "userAgent": "Mozilla/5.0...",
  "timestamp": "2024-01-15T10:00:00Z",
  "result": "SUCCESS"
}
```
